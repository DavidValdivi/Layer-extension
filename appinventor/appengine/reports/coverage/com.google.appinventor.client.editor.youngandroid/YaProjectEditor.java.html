<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>YaProjectEditor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.editor.youngandroid</a> &gt; <span class="el_source">YaProjectEditor.java</span></div><h1>YaProjectEditor.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2017 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.editor.youngandroid;

import static com.google.appinventor.client.Ode.MESSAGES;

import com.google.appinventor.client.DesignToolbar;
import com.google.appinventor.client.ErrorReporter;
import com.google.appinventor.client.Ode;
import com.google.appinventor.client.OdeAsyncCallback;
import com.google.appinventor.client.boxes.AssetListBox;
import com.google.appinventor.client.editor.EditorManager;
import com.google.appinventor.client.editor.FileEditor;
import com.google.appinventor.client.editor.ProjectEditor;
import com.google.appinventor.client.editor.ProjectEditorFactory;
import com.google.appinventor.client.editor.simple.SimpleComponentDatabase;
import com.google.appinventor.client.editor.simple.components.MockComponent;
import com.google.appinventor.client.editor.simple.components.MockFusionTablesControl;
import com.google.appinventor.client.editor.youngandroid.i18n.BlocklyMsg;
import com.google.appinventor.client.explorer.project.ComponentDatabaseChangeListener;
import com.google.appinventor.client.explorer.project.Project;
import com.google.appinventor.client.explorer.project.ProjectChangeListener;
import com.google.appinventor.client.output.OdeLog;
import com.google.appinventor.client.properties.json.ClientJsonParser;
import com.google.appinventor.common.utils.StringUtils;
import com.google.appinventor.shared.properties.json.JSONArray;
import com.google.appinventor.shared.properties.json.JSONObject;
import com.google.appinventor.shared.properties.json.JSONValue;
import com.google.appinventor.shared.rpc.project.ChecksumedFileException;
import com.google.appinventor.shared.rpc.project.ChecksumedLoadFile;
import com.google.appinventor.shared.rpc.project.ProjectNode;
import com.google.appinventor.shared.rpc.project.ProjectRootNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidBlocksNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidComponentsFolder;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidFormNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidProjectNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidSourceNode;
import com.google.appinventor.shared.storage.StorageUtil;
import com.google.appinventor.shared.youngandroid.YoungAndroidSourceAnalyzer;
import com.google.common.collect.Maps;
import com.google.gwt.core.client.Scheduler;
import com.google.gwt.core.client.Scheduler.RepeatingCommand;
import com.google.gwt.json.client.JSONException;
import com.google.gwt.user.client.Command;
import com.google.gwt.user.client.rpc.AsyncCallback;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

/**
 * Project editor for Young Android projects. Each instance corresponds to
 * one project that has been opened in this App Inventor session. 
 * Also responsible for managing screens list for this project in 
 * the DesignToolbar.
 *
 * @author lizlooney@google.com (Liz Looney)
 * @author sharon@google.com (Sharon Perl) - added logic for screens in  
 *     DesignToolbar
 */
public final class YaProjectEditor extends ProjectEditor implements ProjectChangeListener,
    ComponentDatabaseChangeListener {

  // FileEditors in a YA project come in sets. Every form in the project has 
  // a YaFormEditor for editing the UI, and a YaBlocksEditor for editing the 
  // blocks representation of the program logic. Some day it may also have an 
  // editor for the textual representation of the program logic.
<span class="nc" id="L77">  private class EditorSet {</span>
<span class="nc" id="L78">    YaFormEditor formEditor = null;</span>
<span class="nc" id="L79">    YaBlocksEditor blocksEditor = null;</span>
  }

  // Maps form name -&gt; editors for this form
<span class="nc" id="L83">  private final HashMap&lt;String, EditorSet&gt; editorMap = Maps.newHashMap();</span>
  
  // List of External Components
<span class="nc" id="L86">  private final List&lt;String&gt; externalComponents = new ArrayList&lt;String&gt;();</span>

  // Mapping of package names to extensions defined by the package (n &gt; 1)
<span class="nc" id="L89">  private final Map&lt;String, Set&lt;String&gt;&gt; externalCollections = new HashMap&lt;&gt;();</span>
<span class="nc" id="L90">  private final Map&lt;String, String&gt; extensionToNodeName = new HashMap&lt;&gt;();</span>
<span class="nc" id="L91">  private final Map&lt;String, Set&lt;String&gt;&gt; extensionsInNode = new HashMap&lt;&gt;();</span>

  // Number of external component descriptors loaded since there is no longer a 1-1 correspondence
<span class="nc" id="L94">  private volatile int numExternalComponentsLoaded = 0;</span>

  // List of ComponentDatabaseChangeListeners
<span class="nc" id="L97">  private final List&lt;ComponentDatabaseChangeListener&gt; componentDatabaseChangeListeners = new ArrayList&lt;ComponentDatabaseChangeListener&gt;();</span>

  //State variables to help determine whether we are ready to load Project
<span class="nc" id="L100">  private boolean externalComponentsLoaded = false;</span>

  // Database of component type descriptions
  private final SimpleComponentDatabase COMPONENT_DATABASE;

  // State variables to help determine whether we are ready to show Screen1  
  // Automatically select the Screen1 form editor when we have finished loading
  // both the form and blocks editors for Screen1 and we have added the 
  // screen to the DesignToolbar. Since the loading happens asynchronously,
  // there are multiple points when we may be ready to show the screen, and
  // we shouldn't try to show it before everything is ready.
<span class="nc" id="L111">  private boolean screen1FormLoaded = false;</span>
<span class="nc" id="L112">  private boolean screen1BlocksLoaded = false;</span>
<span class="nc" id="L113">  private boolean screen1Added = false;</span>

  /**
   * Returns a project editor factory for {@code YaProjectEditor}s.
   *
   * @return a project editor factory for {@code YaProjectEditor}s.
   */
  public static ProjectEditorFactory getFactory() {
<span class="nc" id="L121">    return new ProjectEditorFactory() {</span>
      @Override
      public ProjectEditor createProjectEditor(ProjectRootNode projectRootNode) {
<span class="nc" id="L124">        return new YaProjectEditor(projectRootNode);</span>
      }
    };
  }

  public YaProjectEditor(ProjectRootNode projectRootNode) {
<span class="nc" id="L130">    super(projectRootNode);</span>
<span class="nc" id="L131">    project.addProjectChangeListener(this);</span>
<span class="nc" id="L132">    COMPONENT_DATABASE = SimpleComponentDatabase.getInstance(projectId);</span>
<span class="nc" id="L133">  }</span>

  private void loadBlocksEditor(String formNamePassedIn) {

<span class="nc" id="L137">    final String formName = formNamePassedIn;</span>
<span class="nc" id="L138">    final YaBlocksEditor newBlocksEditor = editorMap.get(formName).blocksEditor;</span>
<span class="nc" id="L139">    newBlocksEditor.loadFile(new Command() {</span>
        @Override
        public void execute() {
<span class="nc" id="L142">          YaBlocksEditor newBlocksEditor = editorMap.get(formName).blocksEditor;</span>
<span class="nc" id="L143">          int pos = Collections.binarySearch(fileIds, newBlocksEditor.getFileId(),</span>
<span class="nc" id="L144">              getFileIdComparator());</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">          if (pos &lt; 0) {</span>
<span class="nc" id="L146">            pos = -pos - 1;</span>
          }
<span class="nc" id="L148">          insertFileEditor(newBlocksEditor, pos);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">          if (isScreen1(formName)) {</span>
<span class="nc" id="L150">            screen1BlocksLoaded = true;</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if (readyToShowScreen1()) {</span>
<span class="nc" id="L152">              OdeLog.log(&quot;YaProjectEditor.addBlocksEditor.loadFile.execute: switching to screen &quot;</span>
<span class="nc" id="L153">                  + formName + &quot; for project &quot; + newBlocksEditor.getProjectId());</span>
<span class="nc" id="L154">              Ode.getInstance().getDesignToolbar().switchToScreen(newBlocksEditor.getProjectId(),</span>
                  formName, DesignToolbar.View.FORM);
            }
          }
<span class="nc" id="L158">        }</span>
      });

<span class="nc" id="L161">  }</span>

  /**
   * Project process is completed before loadProject is started!
   * Currently Project process loads all External Components into Component Database
   */
  @Override
  public void processProject() {
<span class="nc" id="L169">    resetExternalComponents();</span>
<span class="nc" id="L170">    resetProjectWarnings();</span>
<span class="nc" id="L171">    loadExternalComponents();</span>
<span class="nc" id="L172">    callLoadProject();</span>
<span class="nc" id="L173">  }</span>

  // Note: When we add the blocks editors in the loop below we do not actually
  // have them load the blocks file. Instead we trigger the load of a blocks file
  // in the callback for the loading of its associated forms file. This is important
  // because we have to ensure that the component type data is available when the
  // blocks are loaded!

  private void loadProject() {
    // add form editors first, then blocks editors because the blocks editors
    // need access to their corresponding form editors to set up properly
<span class="nc bnc" id="L184" title="All 2 branches missed.">    for (ProjectNode source : projectRootNode.getAllSourceNodes()) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">      if (source instanceof YoungAndroidFormNode) {</span>
<span class="nc" id="L186">        addFormEditor((YoungAndroidFormNode) source);</span>
      } 
<span class="nc" id="L188">    }</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">    for (ProjectNode source : projectRootNode.getAllSourceNodes()) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">      if (source instanceof YoungAndroidBlocksNode) {</span>
<span class="nc" id="L191">        addBlocksEditor((YoungAndroidBlocksNode) source);</span>
      }
<span class="nc" id="L193">    }</span>
    // Add the screens to the design toolbar, along with their associated editors
<span class="nc" id="L195">    DesignToolbar designToolbar = Ode.getInstance().getDesignToolbar();</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">    for (String formName : editorMap.keySet()) {</span>
<span class="nc" id="L197">      EditorSet editors = editorMap.get(formName);</span>
<span class="nc bnc" id="L198" title="All 4 branches missed.">      if (editors.formEditor != null &amp;&amp; editors.blocksEditor != null) {</span>
<span class="nc" id="L199">        designToolbar.addScreen(projectRootNode.getProjectId(), formName, editors.formEditor, </span>
            editors.blocksEditor);
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (isScreen1(formName)) {</span>
<span class="nc" id="L202">          screen1Added = true;</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">          if (readyToShowScreen1()) {  // probably not yet but who knows?</span>
<span class="nc" id="L204">            OdeLog.log(&quot;YaProjectEditor.loadProject: switching to screen &quot; + formName </span>
<span class="nc" id="L205">                + &quot; for project &quot; + projectRootNode.getProjectId());</span>
<span class="nc" id="L206">            Ode.getInstance().getDesignToolbar().switchToScreen(projectRootNode.getProjectId(), </span>
                formName, DesignToolbar.View.FORM);
          }
        }
<span class="nc bnc" id="L210" title="All 2 branches missed.">      } else if (editors.formEditor == null) {</span>
<span class="nc" id="L211">        OdeLog.wlog(&quot;Missing form editor for &quot; + formName);</span>
      } else {
<span class="nc" id="L213">        OdeLog.wlog(&quot;Missing blocks editor for &quot; + formName);</span>
      }
<span class="nc" id="L215">    }</span>
<span class="nc" id="L216">  }</span>
  
  @Override
  protected void onShow() {
<span class="nc" id="L220">    OdeLog.log(&quot;YaProjectEditor got onShow() for project &quot; + projectId);</span>
    
<span class="nc" id="L222">    AssetListBox.getAssetListBox().getAssetList().refreshAssetList(projectId);</span>
    
<span class="nc" id="L224">    DesignToolbar designToolbar = Ode.getInstance().getDesignToolbar();</span>
<span class="nc" id="L225">    FileEditor selectedFileEditor = getSelectedFileEditor();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">    if (selectedFileEditor != null) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">      if (selectedFileEditor instanceof YaFormEditor) {</span>
<span class="nc" id="L228">        YaFormEditor formEditor = (YaFormEditor) selectedFileEditor;</span>
<span class="nc" id="L229">        designToolbar.switchToScreen(projectId, formEditor.getForm().getName(), </span>
            DesignToolbar.View.FORM);
<span class="nc bnc" id="L231" title="All 2 branches missed.">      } else if (selectedFileEditor instanceof YaBlocksEditor) {</span>
<span class="nc" id="L232">        YaBlocksEditor blocksEditor = (YaBlocksEditor) selectedFileEditor;</span>
<span class="nc" id="L233">        designToolbar.switchToScreen(projectId, blocksEditor.getForm().getName(), </span>
            DesignToolbar.View.BLOCKS);
<span class="nc" id="L235">      } else {</span>
        // shouldn't happen!
<span class="nc" id="L237">        OdeLog.elog(&quot;YaProjectEditor got onShow when selectedFileEditor&quot; </span>
            + &quot; is not a form editor or a blocks editor!&quot;);
<span class="nc" id="L239">        ErrorReporter.reportError(&quot;Internal error: can't switch file editors.&quot;);</span>
      }
    }
<span class="nc" id="L242">  }</span>

  @Override
  protected void onHide() {
<span class="nc" id="L246">    OdeLog.log(&quot;YaProjectEditor: got onHide&quot;);</span>
<span class="nc" id="L247">    AssetListBox.getAssetListBox().getAssetList().refreshAssetList(0);</span>

<span class="nc" id="L249">    FileEditor selectedFileEditor = getSelectedFileEditor();</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">    if (selectedFileEditor != null) {</span>
<span class="nc" id="L251">      selectedFileEditor.onHide();</span>
    }
<span class="nc" id="L253">  }</span>
  
  @Override
  protected void onUnload() {
<span class="nc" id="L257">    OdeLog.log(&quot;YaProjectEditor: got onUnload&quot;);</span>
<span class="nc" id="L258">    super.onUnload();</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">    for (EditorSet editors : editorMap.values()) {</span>
<span class="nc" id="L260">      editors.blocksEditor.prepareForUnload();</span>
<span class="nc" id="L261">    }</span>
<span class="nc" id="L262">  }</span>

  // ProjectChangeListener methods

  @Override
  public void onProjectLoaded(Project project) {
<span class="nc" id="L268">  }</span>

  @Override
  public void onProjectNodeAdded(Project project, ProjectNode node) {
<span class="nc" id="L272">    String formName = null;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">    if (node instanceof YoungAndroidFormNode) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">      if (getFileEditor(node.getFileId()) == null) {</span>
<span class="nc" id="L275">        addFormEditor((YoungAndroidFormNode) node);</span>
<span class="nc" id="L276">        formName = ((YoungAndroidFormNode) node).getFormName();</span>
      }
<span class="nc bnc" id="L278" title="All 2 branches missed.">    } else if (node instanceof YoungAndroidBlocksNode) {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">      if (getFileEditor(node.getFileId()) == null) {</span>
<span class="nc" id="L280">        addBlocksEditor((YoungAndroidBlocksNode) node);</span>
<span class="nc" id="L281">        formName = ((YoungAndroidBlocksNode) node).getFormName();</span>
      }
    }
<span class="nc bnc" id="L284" title="All 2 branches missed.">    if (formName != null) {</span>
      // see if we have both editors yet
<span class="nc" id="L286">      EditorSet editors = editorMap.get(formName);</span>
<span class="nc bnc" id="L287" title="All 4 branches missed.">      if (editors.formEditor != null &amp;&amp; editors.blocksEditor != null) {</span>
<span class="nc" id="L288">        Ode.getInstance().getDesignToolbar().addScreen(node.getProjectId(), formName, </span>
            editors.formEditor, editors.blocksEditor);
      }
    }
<span class="nc" id="L292">  }</span>


  @Override
  public void onProjectNodeRemoved(Project project, ProjectNode node) {
    // remove blocks and/or form editor if applicable. Remove screen from 
    // DesignToolbar. If the partner node to this one (blocks or form) was already 
    // removed, calling DesignToolbar.removeScreen a second time will be a no-op.
<span class="nc" id="L300">    OdeLog.log(&quot;YaProjectEditor: got onProjectNodeRemoved for project &quot;</span>
<span class="nc" id="L301">            + project.getProjectId() + &quot;, node &quot; + node.getFileId());</span>
<span class="nc" id="L302">    String formName = null;</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">    if (node instanceof YoungAndroidFormNode) {</span>
<span class="nc" id="L304">      formName = ((YoungAndroidFormNode) node).getFormName();</span>
<span class="nc" id="L305">      removeFormEditor(formName);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">    } else if (node instanceof YoungAndroidBlocksNode) {</span>
<span class="nc" id="L307">      formName = ((YoungAndroidBlocksNode) node).getFormName();</span>
<span class="nc" id="L308">      removeBlocksEditor(formName);</span>
    }
<span class="nc" id="L310">  }</span>
  
  /*
   * Returns the YaBlocksEditor for the given form name in this project
   */
  public YaBlocksEditor getBlocksFileEditor(String formName) {
<span class="nc bnc" id="L316" title="All 2 branches missed.">    if (editorMap.containsKey(formName)) {</span>
<span class="nc" id="L317">      return editorMap.get(formName).blocksEditor;</span>
    } else {
<span class="nc" id="L319">      return null;</span>
    }
  }

  /* 
   * Returns the YaFormEditor for the given form name in this project
   */
  public YaFormEditor getFormFileEditor(String formName) {
<span class="nc bnc" id="L327" title="All 2 branches missed.">    if (editorMap.containsKey(formName)) {</span>
<span class="nc" id="L328">      return editorMap.get(formName).formEditor;</span>
    } else {
<span class="nc" id="L330">      return null;</span>
    }
  }

  /**
   * @return a list of component instance names
   */
  public List&lt;String&gt; getComponentInstances(String formName) {
<span class="nc" id="L338">    List&lt;String&gt; components = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L339">    EditorSet editorSet = editorMap.get(formName);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">    if (editorSet == null) {</span>
<span class="nc" id="L341">      return components;</span>
    }
<span class="nc" id="L343">    components.addAll(editorSet.formEditor.getComponents().keySet());</span>
<span class="nc" id="L344">    return  components;</span>
  }

  public List&lt;String&gt; getComponentInstances() {
<span class="nc" id="L348">    List&lt;String&gt; components = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">    for (String formName : editorMap.keySet()) {</span>
<span class="nc" id="L350">      components.addAll(getComponentInstances(formName));</span>
<span class="nc" id="L351">    }</span>
<span class="nc" id="L352">    return components;</span>
  }

  public Set&lt;String&gt; getComponentTypes(String formName) {
<span class="nc" id="L356">    Set&lt;String&gt; types = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L357">    EditorSet editorSet = editorMap.get(formName);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">    if (editorSet == null) {</span>
<span class="nc" id="L359">      return types;</span>
    }
<span class="nc bnc" id="L361" title="All 2 branches missed.">    for(MockComponent m : editorSet.formEditor.getComponents().values()) {</span>
<span class="nc" id="L362">      types.add(m.getType());</span>
<span class="nc" id="L363">    }</span>
<span class="nc" id="L364">    return types;</span>
  }

  public Set&lt;String&gt; getUniqueComponentTypes() {
<span class="nc" id="L368">    Set&lt;String&gt; types = new HashSet&lt;String&gt;();</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">    for (String formName : editorMap.keySet()) {</span>
<span class="nc" id="L370">      types.addAll(getComponentTypes(formName));</span>
<span class="nc" id="L371">    }</span>
<span class="nc" id="L372">    return types;</span>
  }

  public Set&lt;String&gt; getUniqueBuiltInBlockTypes() {
<span class="nc" id="L376">    Set&lt;String&gt; types = new HashSet&lt;String&gt;();</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">    for (EditorSet ed : editorMap.values()) {</span>
<span class="nc" id="L378">      types.addAll(ed.blocksEditor.getBlockTypeSet());</span>
<span class="nc" id="L379">    }</span>
<span class="nc" id="L380">    return types;</span>
  }

  // Returns a hash of component names with the set of all component blocks (events, methods,
  // and properties) in use for all screens in the current project
  public HashMap&lt;String, Set&lt;String&gt;&gt; getUniqueComponentBlockTypes() {
<span class="nc" id="L386">    HashMap&lt;String, Set&lt;String&gt;&gt; componentBlocks = new HashMap&lt;String, Set&lt;String&gt;&gt;();</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">    for (EditorSet ed : editorMap.values()) {</span>
<span class="nc" id="L388">      componentBlocks = ed.blocksEditor.getComponentBlockTypeSet(componentBlocks);</span>
<span class="nc" id="L389">    }</span>
<span class="nc" id="L390">    return componentBlocks;</span>
  }


  // Private methods

  private static Comparator&lt;String&gt; getFileIdComparator() {
    // File editors (YaFormEditors and YaBlocksEditors) are sorted so that Screen1 always comes
    // first and others are in alphabetical order. Within each pair, the YaFormEditor is
    // immediately before the YaBlocksEditor.
<span class="nc" id="L400">    return new Comparator&lt;String&gt;() {</span>
      @Override
      public int compare(String fileId1, String fileId2) {
<span class="nc" id="L403">        boolean isForm1 = fileId1.endsWith(YoungAndroidSourceAnalyzer.FORM_PROPERTIES_EXTENSION);</span>
<span class="nc" id="L404">        boolean isForm2 = fileId2.endsWith(YoungAndroidSourceAnalyzer.FORM_PROPERTIES_EXTENSION);</span>

        // Give priority to screen1.
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if (YoungAndroidSourceNode.isScreen1(fileId1)) {</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">          if (YoungAndroidSourceNode.isScreen1(fileId2)) {</span>
            // They are both named screen1. The form editor should come before the blocks editor.
<span class="nc bnc" id="L410" title="All 2 branches missed.">            if (isForm1) {</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">              return isForm2 ? 0 : -1;</span>
            } else {
<span class="nc bnc" id="L413" title="All 2 branches missed.">              return isForm2 ? 1 : 0;</span>
            }
          } else {
            // Only fileId1 is named screen1.
<span class="nc" id="L417">            return -1;</span>
          }
<span class="nc bnc" id="L419" title="All 2 branches missed.">        } else if (YoungAndroidSourceNode.isScreen1(fileId2)) {</span>
          // Only fileId2 is named screen1.
<span class="nc" id="L421">          return 1;</span>
        }

<span class="nc" id="L424">        String fileId1WithoutExtension = StorageUtil.trimOffExtension(fileId1);</span>
<span class="nc" id="L425">        String fileId2WithoutExtension = StorageUtil.trimOffExtension(fileId2);</span>
<span class="nc" id="L426">        int compare = fileId1WithoutExtension.compareTo(fileId2WithoutExtension);</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (compare != 0) {</span>
<span class="nc" id="L428">          return compare;</span>
        }
        // They are both the same name without extension. The form editor should come before the
        // blocks editor.
<span class="nc bnc" id="L432" title="All 2 branches missed.">        if (isForm1) {</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">          return isForm2 ? 0 : -1;</span>
        } else {
<span class="nc bnc" id="L435" title="All 2 branches missed.">          return isForm2 ? 1 : 0;</span>
        }
      }
    };
  }
  
  private void addFormEditor(YoungAndroidFormNode formNode) {
<span class="nc" id="L442">    final YaFormEditor newFormEditor = new YaFormEditor(this, formNode);</span>
<span class="nc" id="L443">    final String formName = formNode.getFormName();</span>
<span class="nc" id="L444">    OdeLog.log(&quot;Adding form editor for &quot; + formName);</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">    if (editorMap.containsKey(formName)) {</span>
      // This happens if the blocks editor was already added.
<span class="nc" id="L447">      editorMap.get(formName).formEditor = newFormEditor;</span>
    } else {
<span class="nc" id="L449">      EditorSet editors = new EditorSet();</span>
<span class="nc" id="L450">      editors.formEditor = newFormEditor;</span>
<span class="nc" id="L451">      editorMap.put(formName, editors);</span>
    }
<span class="nc" id="L453">    final Command afterLoadCommand = new Command() {</span>
      @Override
      public void execute() {
<span class="nc" id="L456">        int pos = Collections.binarySearch(fileIds, newFormEditor.getFileId(),</span>
<span class="nc" id="L457">            getFileIdComparator());</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">        if (pos &lt; 0) {</span>
<span class="nc" id="L459">          pos = -pos - 1;</span>
        }
<span class="nc" id="L461">        insertFileEditor(newFormEditor, pos);</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">        if (isScreen1(formName)) {</span>
<span class="nc" id="L463">          screen1FormLoaded = true;</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">          if (readyToShowScreen1()) {</span>
<span class="nc" id="L465">            OdeLog.log(&quot;YaProjectEditor.addFormEditor.loadFile.execute: switching to screen &quot;</span>
<span class="nc" id="L466">                + formName + &quot; for project &quot; + newFormEditor.getProjectId());</span>
<span class="nc" id="L467">            Ode.getInstance().getDesignToolbar().switchToScreen(newFormEditor.getProjectId(),</span>
                formName, DesignToolbar.View.FORM);
          }
        }
<span class="nc" id="L471">        loadBlocksEditor(formName);</span>
<span class="nc" id="L472">      }</span>
    };
<span class="nc bnc" id="L474" title="All 4 branches missed.">    if (!isScreen1(formName) &amp;&amp; !screen1FormLoaded) {</span>
      // Defer loading other screens until Screen1 is loaded. Otherwise we can end up in an
      // inconsistent state during project upgrades with Screen1-only properties.
<span class="nc" id="L477">      Scheduler.get().scheduleFixedDelay(new RepeatingCommand() {</span>
        @Override
        public boolean execute() {
<span class="nc bnc" id="L480" title="All 2 branches missed.">          if (screen1FormLoaded) {</span>
<span class="nc" id="L481">            newFormEditor.loadFile(afterLoadCommand);</span>
<span class="nc" id="L482">            return false;</span>
          } else {
<span class="nc" id="L484">            return true;</span>
          }
        }
      }, 100);
    } else {
<span class="nc" id="L489">      newFormEditor.loadFile(afterLoadCommand);</span>
    }
<span class="nc" id="L491">  }</span>
    
  private boolean readyToShowScreen1() {
<span class="nc bnc" id="L494" title="All 6 branches missed.">    return screen1FormLoaded &amp;&amp; screen1BlocksLoaded &amp;&amp; screen1Added;</span>
  }

  private boolean readyToLoadProject() {
<span class="nc bnc" id="L498" title="All 4 branches missed.">    return BlocklyMsg.Loader.isTranslationLoaded() &amp;&amp; externalComponentsLoaded;</span>
  }

  private void addBlocksEditor(YoungAndroidBlocksNode blocksNode) {
<span class="nc" id="L502">    final YaBlocksEditor newBlocksEditor = new YaBlocksEditor(this, blocksNode);</span>
<span class="nc" id="L503">    final String formName = blocksNode.getFormName();</span>
<span class="nc" id="L504">    OdeLog.log(&quot;Adding blocks editor for &quot; + formName);</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">    if (editorMap.containsKey(formName)) {</span>
      // This happens if the form editor was already added.
<span class="nc" id="L507">      editorMap.get(formName).blocksEditor = newBlocksEditor;</span>
    } else {
<span class="nc" id="L509">      EditorSet editors = new EditorSet();</span>
<span class="nc" id="L510">      editors.blocksEditor = newBlocksEditor;</span>
<span class="nc" id="L511">      editorMap.put(formName, editors);</span>
    }
<span class="nc" id="L513">  }</span>
  
  private void removeFormEditor(String formName) {
<span class="nc bnc" id="L516" title="All 2 branches missed.">    if (editorMap.containsKey(formName)) {</span>
<span class="nc" id="L517">      EditorSet editors = editorMap.get(formName);</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">      if (editors.blocksEditor == null) {</span>
<span class="nc" id="L519">        editorMap.remove(formName);</span>
      } else {
<span class="nc" id="L521">        editors.formEditor = null;</span>
      }
    }
<span class="nc" id="L524">  }</span>
  
  private void removeBlocksEditor(String formName) {
<span class="nc bnc" id="L527" title="All 2 branches missed.">    if (editorMap.containsKey(formName)) {</span>
<span class="nc" id="L528">      EditorSet editors = editorMap.get(formName);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">      if (editors.formEditor == null) {</span>
<span class="nc" id="L530">        editorMap.remove(formName);</span>
      } else {
<span class="nc" id="L532">        editors.blocksEditor = null;</span>
      }
    }    
<span class="nc" id="L535">  }</span>
  
  public void addComponent(final ProjectNode node, final Command afterComponentAdded) {
<span class="nc" id="L538">    final String fileId = node.getFileId();</span>
<span class="nc" id="L539">    AsyncCallback&lt;ChecksumedLoadFile&gt; callback = new OdeAsyncCallback&lt;ChecksumedLoadFile&gt;(MESSAGES.loadError()) {</span>
      @Override
      public void onSuccess(ChecksumedLoadFile result) {
        String jsonFileContent;
        try {
<span class="nc" id="L544">          jsonFileContent = result.getContent();</span>
<span class="nc" id="L545">        } catch (ChecksumedFileException e) {</span>
<span class="nc" id="L546">          this.onFailure(e);</span>
<span class="nc" id="L547">          return;</span>
<span class="nc" id="L548">        }</span>
<span class="nc" id="L549">        JSONValue value = null;</span>
        try {
<span class="nc" id="L551">          value = new ClientJsonParser().parse(jsonFileContent);</span>
<span class="nc" id="L552">        } catch(JSONException e) {</span>
          // thrown if jsonFileContent is not valid JSON
<span class="nc" id="L554">          String[] parts = fileId.split(&quot;/&quot;);</span>
<span class="nc bnc" id="L555" title="All 4 branches missed.">          if (parts.length &gt; 3 &amp;&amp; fileId.endsWith(&quot;components.json&quot;)) {</span>
<span class="nc" id="L556">            ErrorReporter.reportError(Ode.MESSAGES.extensionDescriptorCorrupt(parts[2], project.getProjectName()));</span>
          } else {
<span class="nc" id="L558">            ErrorReporter.reportError(Ode.MESSAGES.invalidExtensionInProject(project.getProjectName()));</span>
          }
<span class="nc" id="L560">          numExternalComponentsLoaded++;</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">          if (afterComponentAdded != null) {</span>
<span class="nc" id="L562">            afterComponentAdded.execute();</span>
          }
<span class="nc" id="L564">          return;</span>
<span class="nc" id="L565">        }</span>
<span class="nc" id="L566">        COMPONENT_DATABASE.addComponentDatabaseListener(YaProjectEditor.this);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">        if (value instanceof JSONArray) {</span>
<span class="nc" id="L568">          JSONArray componentList = value.asArray();</span>
<span class="nc" id="L569">          COMPONENT_DATABASE.addComponents(componentList);</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">          for (JSONValue component : componentList.getElements()) {</span>
<span class="nc" id="L571">            String name = component.asObject().get(&quot;type&quot;).asString().getString();</span>
            // group new extensions by package name
<span class="nc" id="L573">            String packageName = name.substring(0, name.lastIndexOf('.'));</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">            if (!externalCollections.containsKey(packageName)) {</span>
<span class="nc" id="L575">              externalCollections.put(packageName, new HashSet&lt;String&gt;());</span>
            }
<span class="nc" id="L577">            externalCollections.get(packageName).add(name);</span>

<span class="nc bnc" id="L579" title="All 2 branches missed.">            if (!extensionsInNode.containsKey(fileId)) {</span>
<span class="nc" id="L580">              extensionsInNode.put(fileId, new HashSet&lt;String&gt;());</span>
            }
<span class="nc" id="L582">            extensionsInNode.get(fileId).add(name);</span>
<span class="nc" id="L583">            extensionToNodeName.put(name, fileId);</span>

<span class="nc" id="L585">            name = packageName;</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">            if (!externalComponents.contains(name)) {</span>
<span class="nc" id="L587">              externalComponents.add(name);</span>
            } else {
              // Upgraded an extension. Force a save to ensure version numbers are updated serverside.
<span class="nc" id="L590">              saveProject();</span>
            }
<span class="nc" id="L592">          }</span>
<span class="nc" id="L593">        } else {</span>
<span class="nc" id="L594">          JSONObject componentJSONObject = value.asObject();</span>
<span class="nc" id="L595">          COMPONENT_DATABASE.addComponent(componentJSONObject);</span>
          // In case of upgrade, we do not need to add entry
<span class="nc bnc" id="L597" title="All 2 branches missed.">          if (!externalComponents.contains(componentJSONObject.get(&quot;type&quot;).toString())) {</span>
<span class="nc" id="L598">            externalComponents.add(componentJSONObject.get(&quot;type&quot;).toString());</span>
          } else {
            // Upgraded an extension. Force a save to ensure version numbers are updated serverside.
<span class="nc" id="L601">            saveProject();</span>
          }
        }
<span class="nc" id="L604">        numExternalComponentsLoaded++;</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if (afterComponentAdded != null) {</span>
<span class="nc" id="L606">          afterComponentAdded.execute();</span>
        }
<span class="nc" id="L608">      }</span>
      @Override
      public void onFailure(Throwable caught) {
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (caught instanceof ChecksumedFileException) {</span>
<span class="nc" id="L612">          Ode.getInstance().recordCorruptProject(projectId, fileId, caught.getMessage());</span>
        }
<span class="nc" id="L614">        super.onFailure(caught);</span>
<span class="nc" id="L615">      }</span>
    };
<span class="nc" id="L617">    Ode.getInstance().getProjectService().load2(projectId, fileId, callback);</span>
<span class="nc" id="L618">  }</span>

  /**
   * To remove Component Files from the Project!
   * @param componentTypes
   */
  public  void removeComponent(Map&lt;String, String&gt; componentTypes) {
<span class="nc" id="L625">    final Ode ode = Ode.getInstance();</span>
<span class="nc" id="L626">    final YoungAndroidComponentsFolder componentsFolder = ((YoungAndroidProjectNode) project.getRootNode()).getComponentsFolder();</span>
<span class="nc" id="L627">    Set&lt;String&gt; externalCompFolders = new HashSet&lt;String&gt;();</span>
    // Old projects with old extensions will use FQCN for the directory name rather than the package
    // Prefer deleting com.foo.Bar over com.foo if com.foo.Bar exists.
<span class="nc bnc" id="L630" title="All 2 branches missed.">    for (ProjectNode child : componentsFolder.getChildren()) {</span>
<span class="nc" id="L631">      String[] parts = child.getFileId().split(&quot;/&quot;);</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">      if (parts.length &gt;= 3) {</span>
<span class="nc" id="L633">        externalCompFolders.add(parts[2]);</span>
      }
<span class="nc" id="L635">    }</span>
<span class="nc" id="L636">    Set&lt;String&gt; removedPackages = new HashSet&lt;String&gt;();</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">    for (String componentType : componentTypes.keySet()) {</span>
<span class="nc" id="L638">      String typeName = componentTypes.get(componentType);</span>
<span class="nc bnc" id="L639" title="All 4 branches missed.">      if (!externalCompFolders.contains(typeName) &amp;&amp; !externalComponents.contains(typeName)) {</span>
<span class="nc" id="L640">        typeName = typeName.substring(0, typeName.lastIndexOf('.'));</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">        if (removedPackages.contains(typeName)) {</span>
<span class="nc" id="L642">          continue;</span>
        }
<span class="nc" id="L644">        removedPackages.add(typeName);</span>
      }
<span class="nc" id="L646">      final String directory = componentsFolder.getFileId() + &quot;/&quot; + typeName + &quot;/&quot;;</span>
<span class="nc" id="L647">      ode.getProjectService().deleteFolder(ode.getSessionId(), this.projectId, directory,</span>
<span class="nc" id="L648">          new AsyncCallback&lt;Long&gt;() {</span>
            @Override
            public void onFailure(Throwable throwable) {

<span class="nc" id="L652">            }</span>
            @Override
            public void onSuccess(Long date) {
<span class="nc" id="L655">              Iterable&lt;ProjectNode&gt; nodes = componentsFolder.getChildren();</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">              for (ProjectNode node : nodes) {</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                if (node.getFileId().startsWith(directory)) {</span>
<span class="nc" id="L658">                  ode.getProjectManager().getProject(node).deleteNode(node);</span>
<span class="nc" id="L659">                  ode.updateModificationDate(node.getProjectId(), date);</span>
                }
<span class="nc" id="L661">              }</span>
              // Change in extensions requires companion refresh
<span class="nc" id="L663">              YaBlocksEditor.resendExtensionsList();</span>
<span class="nc" id="L664">            }</span>
          });
<span class="nc" id="L666">    }</span>
<span class="nc" id="L667">  }</span>

  private void callLoadProject() {
<span class="nc" id="L670">    Scheduler.get().scheduleDeferred(new Scheduler.ScheduledCommand() {</span>
      @Override
      public void execute() {
<span class="nc bnc" id="L673" title="All 2 branches missed.">        if (!readyToLoadProject()) { // wait till project is processed</span>
<span class="nc" id="L674">          Scheduler.get().scheduleDeferred(this);</span>
        } else {
<span class="nc" id="L676">          loadProject();</span>
        }
<span class="nc" id="L678">      }</span>
    });
<span class="nc" id="L680">  }</span>

  private void loadExternalComponents() {
    //Get the list of all ComponentNodes to be Added
<span class="nc" id="L684">    List&lt;ProjectNode&gt; componentNodes = new ArrayList&lt;ProjectNode&gt;();</span>
<span class="nc" id="L685">    YoungAndroidComponentsFolder componentsFolder = ((YoungAndroidProjectNode) project.getRootNode()).getComponentsFolder();</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">    if (componentsFolder != null) {</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">      for (ProjectNode node : componentsFolder.getChildren()) {</span>
        // Find all components that are json files.
<span class="nc" id="L689">        final String nodeName = node.getName();</span>
<span class="nc bnc" id="L690" title="All 4 branches missed.">        if (nodeName.endsWith(&quot;.json&quot;) &amp;&amp; StringUtils.countMatches(node.getFileId(), &quot;/&quot;) == 3 ) {</span>
<span class="nc" id="L691">          componentNodes.add(node);</span>
        }
<span class="nc" id="L693">      }</span>
    }
<span class="nc" id="L695">    final int componentCount = componentNodes.size();</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">    for (ProjectNode componentNode : componentNodes) {</span>
<span class="nc" id="L697">      addComponent(componentNode, new Command() {</span>
        @Override
        public void execute() {
<span class="nc bnc" id="L700" title="All 2 branches missed.">          if (componentCount == numExternalComponentsLoaded) { // true for the last component added</span>
<span class="nc" id="L701">            externalComponentsLoaded = true;</span>
          }
<span class="nc" id="L703">        }</span>
      });
<span class="nc" id="L705">    }</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">    if (componentCount == 0) {</span>
<span class="nc" id="L707">      externalComponentsLoaded = true; // to hint that we are ready to load</span>
    }
<span class="nc" id="L709">  }</span>

  // Resets any warnings that should be given when a project is loaded
  // For now this is just the deprecation warning for the
  // FusiontablesControl component.

  private void resetProjectWarnings() {
<span class="nc" id="L716">    MockFusionTablesControl.resetWarning();</span>
<span class="nc" id="L717">  }</span>

  private void resetExternalComponents() {
<span class="nc" id="L720">    COMPONENT_DATABASE.addComponentDatabaseListener(this);</span>
    try {
<span class="nc" id="L722">      COMPONENT_DATABASE.resetDatabase();</span>
<span class="nc" id="L723">    } catch(JSONException e) {</span>
      // thrown if any of the component/extension descriptions are not valid JSON
<span class="nc" id="L725">      ErrorReporter.reportError(Ode.MESSAGES.componentDatabaseCorrupt(project.getProjectName()));</span>
<span class="nc" id="L726">    }</span>
<span class="nc" id="L727">    externalComponents.clear();</span>
<span class="nc" id="L728">    extensionsInNode.clear();</span>
<span class="nc" id="L729">    extensionToNodeName.clear();</span>
<span class="nc" id="L730">    numExternalComponentsLoaded = 0;</span>
<span class="nc" id="L731">  }</span>

  private static boolean isScreen1(String formName) {
<span class="nc" id="L734">    return formName.equals(YoungAndroidSourceNode.SCREEN1_FORM_NAME);</span>
  }

  public void addComponentDatbaseListener(ComponentDatabaseChangeListener cdbChangeListener) {
<span class="nc" id="L738">    componentDatabaseChangeListeners.add(cdbChangeListener);</span>
<span class="nc" id="L739">  }</span>

  public void removeComponentDatbaseListener(ComponentDatabaseChangeListener cdbChangeListener) {
<span class="nc" id="L742">    componentDatabaseChangeListeners.remove(cdbChangeListener);</span>
<span class="nc" id="L743">  }</span>

  public void clearComponentDatabaseListeners() {
<span class="nc" id="L746">    componentDatabaseChangeListeners.clear();</span>
<span class="nc" id="L747">  }</span>

  @Override
  public void onComponentTypeAdded(List&lt;String&gt; componentTypes) {
<span class="nc" id="L751">    COMPONENT_DATABASE.removeComponentDatabaseListener(this);</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">    for (ComponentDatabaseChangeListener cdbChangeListener : componentDatabaseChangeListeners) {</span>
<span class="nc" id="L753">      cdbChangeListener.onComponentTypeAdded(componentTypes);</span>
<span class="nc" id="L754">    }</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">    for (String formName : editorMap.keySet()) {</span>
<span class="nc" id="L756">      EditorSet editors = editorMap.get(formName);</span>
<span class="nc" id="L757">      editors.formEditor.onComponentTypeAdded(componentTypes);</span>
<span class="nc" id="L758">      editors.blocksEditor.onComponentTypeAdded(componentTypes);</span>
<span class="nc" id="L759">    }</span>
    // Change of extensions...
<span class="nc" id="L761">    YaBlocksEditor.resendAssetsAndExtensions();</span>
<span class="nc" id="L762">  }</span>

  @Override
  public boolean beforeComponentTypeRemoved(List&lt;String&gt; componentTypes) {
<span class="nc" id="L766">    boolean result = true;</span>
<span class="nc" id="L767">    Set&lt;String&gt; removedTypes = new HashSet&lt;&gt;(componentTypes);</span>
    // aggregate types in the same package
<span class="nc bnc" id="L769" title="All 2 branches missed.">    for (String type : removedTypes) {</span>
<span class="nc" id="L770">      Set&lt;String&gt; siblings = extensionsInNode.get(extensionToNodeName.get(COMPONENT_DATABASE.getComponentType(type)));</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">      if (siblings != null) {</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">        for (String siblingType : siblings) {</span>
<span class="nc" id="L773">          String siblingName = siblingType.substring(siblingType.lastIndexOf('.') + 1);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">          if (!removedTypes.contains(siblingName)) {</span>
<span class="nc" id="L775">            componentTypes.add(siblingName);</span>
          }
<span class="nc" id="L777">        }</span>
      }
<span class="nc" id="L779">    }</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">    for (ComponentDatabaseChangeListener cdbChangeListener : componentDatabaseChangeListeners) {</span>
<span class="nc" id="L781">      result = result &amp; cdbChangeListener.beforeComponentTypeRemoved(componentTypes);</span>
<span class="nc" id="L782">    }</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">    for (String formName : editorMap.keySet()) {</span>
<span class="nc" id="L784">      EditorSet editors = editorMap.get(formName);</span>
<span class="nc" id="L785">      result = result &amp; editors.formEditor.beforeComponentTypeRemoved(componentTypes);</span>
<span class="nc" id="L786">      result = result &amp; editors.blocksEditor.beforeComponentTypeRemoved(componentTypes);</span>
<span class="nc" id="L787">    }</span>
<span class="nc" id="L788">    return result;</span>
  }

  @Override
  public void onComponentTypeRemoved(Map&lt;String, String&gt; componentTypes) {
<span class="nc" id="L793">    COMPONENT_DATABASE.removeComponentDatabaseListener(this);</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">    for (ComponentDatabaseChangeListener cdbChangeListener : componentDatabaseChangeListeners) {</span>
<span class="nc" id="L795">      cdbChangeListener.onComponentTypeRemoved(componentTypes);</span>
<span class="nc" id="L796">    }</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">    for (String formName : editorMap.keySet()) {</span>
<span class="nc" id="L798">      EditorSet editors = editorMap.get(formName);</span>
<span class="nc" id="L799">      editors.formEditor.onComponentTypeRemoved(componentTypes);</span>
<span class="nc" id="L800">      editors.blocksEditor.onComponentTypeRemoved(componentTypes);</span>
<span class="nc" id="L801">    }</span>
<span class="nc" id="L802">    removeComponent(componentTypes);</span>
<span class="nc" id="L803">  }</span>

  @Override
  public void onResetDatabase() {
<span class="nc" id="L807">    COMPONENT_DATABASE.removeComponentDatabaseListener(this);</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">    for (ComponentDatabaseChangeListener cdbChangeListener : componentDatabaseChangeListeners) {</span>
<span class="nc" id="L809">      cdbChangeListener.onResetDatabase();</span>
<span class="nc" id="L810">    }</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">    for (String formName : editorMap.keySet()) {</span>
<span class="nc" id="L812">      EditorSet editors = editorMap.get(formName);</span>
<span class="nc" id="L813">      editors.formEditor.onResetDatabase();</span>
<span class="nc" id="L814">      editors.blocksEditor.onResetDatabase();</span>
<span class="nc" id="L815">    }</span>
<span class="nc" id="L816">  }</span>

  /**
   * Save all editors in the project.
   */
  public void saveProject() {
<span class="nc" id="L822">    EditorManager manager = Ode.getInstance().getEditorManager();</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">    for (EditorSet editors : editorMap.values()) {</span>
      // It would be more efficient to check if the editors use the component in question,
      // but we are conservative and save everything, for now.
<span class="nc" id="L826">      manager.scheduleAutoSave(editors.formEditor);</span>
<span class="nc" id="L827">      manager.scheduleAutoSave(editors.blocksEditor);</span>
<span class="nc" id="L828">    }</span>
<span class="nc" id="L829">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>