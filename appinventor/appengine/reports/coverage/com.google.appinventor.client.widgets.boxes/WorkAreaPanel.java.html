<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WorkAreaPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.widgets.boxes</a> &gt; <span class="el_source">WorkAreaPanel.java</span></div><h1>WorkAreaPanel.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2012 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.widgets.boxes;

import com.google.appinventor.client.output.OdeLog;
import com.google.appinventor.client.properties.json.ClientJsonParser;
import com.google.appinventor.client.widgets.boxes.Box.BoxDescriptor;
import com.google.appinventor.shared.properties.json.JSONArray;
import com.google.appinventor.shared.properties.json.JSONObject;
import com.google.appinventor.shared.properties.json.JSONValue;
import com.google.gwt.user.client.ui.AbsolutePanel;
import com.google.gwt.user.client.ui.SimplePanel;
import com.google.gwt.user.client.ui.Widget;

import com.allen_sauer.gwt.dnd.client.PickupDragController;

import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;

/**
 * Desktop-like container for boxes.
 *
 * &lt;p&gt;Implements a panel which arranges boxes in columns. Boxes can be dragged
 * from one column to another or to a different position within the same
 * column.
 *
 * @see Box
 *
 */
public final class WorkAreaPanel extends SimplePanel implements LayoutChangeListener {

  // Field names for JSON object encoding of work area state
  private static final String NAME_ACTIVE_LAYOUT = &quot;ActiveLayout&quot;;
  private static final String NAME_LAYOUTS = &quot;Layouts&quot;;

  // Box registry for creating boxes
  private final BoxRegistry boxRegistry;

  // Active layout for work area
  private Layout layout;

  // List of available layouts
  private final Map&lt;String, Layout&gt; layouts;

  // Base panel of work area
  private final AbsolutePanel boundaryPanel;

  // Drag and drop controllers
  private final PickupDragController widgetDragController;

  // Last resize width and height
  private int width;
  private int height;

  /**
   * Creates a new work area.
   *
   * @param boxRegistry  box registry for creating boxes
   * @param layout  initial layout for work area
   */
<span class="nc" id="L66">  public WorkAreaPanel(BoxRegistry boxRegistry, Layout layout) {</span>
<span class="nc" id="L67">    this.boxRegistry = boxRegistry;</span>
<span class="nc" id="L68">    this.layout = layout;</span>

<span class="nc" id="L70">    layouts = new HashMap&lt;String, Layout&gt;();</span>
<span class="nc" id="L71">    layouts.put(layout.getName(), layout);</span>

<span class="nc" id="L73">    boundaryPanel = new AbsolutePanel();</span>
<span class="nc" id="L74">    boundaryPanel.setSize(&quot;100%&quot;, &quot;100%&quot;);</span>
<span class="nc" id="L75">    setWidget(boundaryPanel);</span>
<span class="nc" id="L76">    setSize(&quot;100%&quot;, &quot;100%&quot;);</span>

<span class="nc" id="L78">    widgetDragController = new PickupDragController(boundaryPanel, false);</span>
<span class="nc" id="L79">    widgetDragController.setBehaviorMultipleSelection(false);</span>

<span class="nc" id="L81">    switchLayout(layout.getName());</span>
<span class="nc" id="L82">  }</span>

  @Override
  public void clear() {
<span class="nc" id="L86">    boundaryPanel.clear();</span>
<span class="nc" id="L87">  }</span>

  @Override
  public void add(Widget widget) {
<span class="nc" id="L91">    boundaryPanel.add(widget);</span>
<span class="nc" id="L92">  }</span>

  /**
   * Must be invoked upon resizing of the work area panel.
   *
   * @param width  new work width in pixel
   * @param height  new work height in pixel
   */
  public void onResize(int width, int height) {
<span class="nc" id="L101">    this.width = width;</span>
<span class="nc" id="L102">    this.height = height;</span>

<span class="nc" id="L104">    layout.onResize(width, height);</span>
<span class="nc" id="L105">  }</span>

  /**
   * Create a new box from the definition by the given box descriptor.
   *
   * @param bd  box descriptor describing box to be created
   * @return  new box
   */
  public Box createBox(BoxDescriptor bd) {
<span class="nc" id="L114">    String boxType = bd.getType();</span>
<span class="nc" id="L115">    Box box = boxRegistry.getBox(boxType);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">    if (box == null) {</span>
<span class="nc" id="L117">      OdeLog.wlog(&quot;Unknown box type: &quot; + boxType);</span>
    } else {
<span class="nc" id="L119">      widgetDragController.makeDraggable(box, box.getHeader());</span>
    }
<span class="nc" id="L121">    return box;</span>
  }

  /**
   * Returns work area's drag controller.
   *
   * @return drag controller
   */
  public PickupDragController getWidgetDragController() {
<span class="nc" id="L130">    return widgetDragController;</span>
  }

  /**
   * Returns a map of the layouts for the work area.
   *
   * @return  map of layouts for work area
   */
  public Map&lt;String, Layout&gt; getLayouts() {
<span class="nc" id="L139">    return layouts;</span>
  }

  /**
   * Return state of work area and its layouts converted into JSON format.
   *
   * @return  work area state in JSON format
   */
  public String toJson() {
<span class="nc" id="L148">    StringBuilder sb =  new StringBuilder();</span>
<span class="nc" id="L149">    sb.append(&quot;{\&quot;&quot; + NAME_ACTIVE_LAYOUT + &quot;\&quot;:\&quot;&quot;);</span>
<span class="nc" id="L150">    sb.append(layout.getName());</span>
<span class="nc" id="L151">    sb.append(&quot;\&quot;,\&quot;&quot; + NAME_LAYOUTS + &quot;\&quot;:[&quot;);</span>
<span class="nc" id="L152">    String separator = &quot;&quot;;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">    for (Layout layout : layouts.values()) {</span>
<span class="nc" id="L154">      sb.append(separator);</span>
<span class="nc" id="L155">      sb.append(layout.toJson());</span>
<span class="nc" id="L156">      separator = &quot;,&quot;;</span>
<span class="nc" id="L157">    }</span>
<span class="nc" id="L158">    sb.append(&quot;]}&quot;);</span>
<span class="nc" id="L159">    return sb.toString();</span>
  }

  /**
   * Restores state of work area and its layouts from JSON.
   *
   * @param encodedState  work area state in JSON format
   */
  public void fromJson(String encodedState) {
<span class="nc bnc" id="L168" title="All 2 branches missed.">    if (!encodedState.isEmpty()) {</span>
<span class="nc" id="L169">      JSONObject state = new ClientJsonParser().parse(encodedState).asObject();</span>
<span class="nc" id="L170">      Map&lt;String, JSONValue&gt; properties = state.getProperties();</span>

<span class="nc" id="L172">      JSONArray layoutArray = properties.get(NAME_LAYOUTS).asArray();</span>

      // check if boxes encoded in JSON is the same set as in the registry
<span class="nc" id="L175">      HashSet&lt;String&gt; boxTypes = new HashSet&lt;String&gt;();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">      for (JSONValue layoutObject : layoutArray.getElements()) {</span>
<span class="nc" id="L177">        ColumnLayout.boxTypesFromJson(layoutObject.asObject(), boxTypes);</span>
<span class="nc" id="L178">      }</span>

      // only restore state if the saved boxes match expected boxes
<span class="nc bnc" id="L181" title="All 2 branches missed.">      if (boxTypes.equals(boxRegistry.getBoxTypes())) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">         for (JSONValue layoutObject : layoutArray.getElements()) {</span>
           // TODO(user): Should we decide to support multiple layouts we
           //                 should select the layout type from a registry
<span class="nc" id="L185">           Layout layout = ColumnLayout.fromJson(layoutObject.asObject(), this);</span>
<span class="nc" id="L186">           layouts.put(layout.getName(), layout);</span>
<span class="nc" id="L187">         }</span>

<span class="nc" id="L189">         switchLayout(properties.get(NAME_ACTIVE_LAYOUT).asString().getString());</span>
      }
    }
<span class="nc" id="L192">  }</span>

  private void switchLayout(String layoutName) {
<span class="nc bnc" id="L195" title="All 2 branches missed.">    if (layout != null) {</span>
<span class="nc" id="L196">      layout.removeLayoutChangeListener(this);</span>
    }

<span class="nc" id="L199">    layout = layouts.get(layoutName);</span>
<span class="nc" id="L200">    layout.apply(this);</span>
<span class="nc" id="L201">    layout.addLayoutChangeListener(this);</span>

    // To ensure all boxes are appropriately sized
<span class="nc" id="L204">    onResize(width, height);</span>
<span class="nc" id="L205">  }</span>

  // LayoutChangeListener

  @Override
  public void onLayoutChange(Layout layout) {
<span class="nc" id="L211">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>