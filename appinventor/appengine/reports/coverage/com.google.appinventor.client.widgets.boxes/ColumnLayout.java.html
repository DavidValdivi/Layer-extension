<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ColumnLayout.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.widgets.boxes</a> &gt; <span class="el_source">ColumnLayout.java</span></div><h1>ColumnLayout.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2012 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.widgets.boxes;

import com.google.appinventor.client.widgets.boxes.Box.BoxDescriptor;
import com.google.appinventor.common.utils.StringUtils;
import com.google.appinventor.shared.properties.json.JSONObject;
import com.google.appinventor.shared.properties.json.JSONUtil;
import com.google.appinventor.shared.properties.json.JSONValue;
import com.google.gwt.user.client.ui.HorizontalPanel;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.VerticalPanel;
import com.google.gwt.user.client.ui.Widget;

import com.allen_sauer.gwt.dnd.client.DragEndEvent;
import com.allen_sauer.gwt.dnd.client.DragHandler;
import com.allen_sauer.gwt.dnd.client.DragStartEvent;
import com.allen_sauer.gwt.dnd.client.drop.IndexedDropController;

import java.util.ArrayList;
import java.util.Set;
import java.util.List;
import java.util.Map;

/**
 * Defines a column-based layout for the boxes on a work area panel.
 *
 */
public final class ColumnLayout extends Layout {

  /**
   * Drag handler for detecting changes to the layout.
   */
<span class="nc" id="L38">  public class ChangeDetector implements DragHandler {</span>

    @Override
    public void onDragEnd(DragEndEvent event) {
<span class="nc" id="L42">      fireLayoutChange();</span>
<span class="nc" id="L43">    }</span>

    @Override
    public void onDragStart(DragStartEvent event) {
<span class="nc" id="L47">    }</span>

    @Override
    public void onPreviewDragEnd(DragEndEvent event) {
<span class="nc" id="L51">    }</span>

    @Override
    public void onPreviewDragStart(DragStartEvent event) {
<span class="nc" id="L55">    }</span>
  }

  /**
   * Represents a column in the layout.
   */
  public static final class Column extends IndexedDropController {

    // Field names for JSON object encoding of layout
    private static final String NAME_WIDTH = &quot;width&quot;;
    private static final String NAME_BOXES = &quot;boxes&quot;;

    // Associated column container (this is the state of the layout when it is active)
    private final VerticalPanel columnPanel;

    // Relative column width (in percent of work area width)
    private int relativeWidth;

    // Absolute width (in pixel)
    private int absoluteWidth;

    // List of box description (this is the state of the layout when it is inactive)
    private final List&lt;BoxDescriptor&gt; boxes;

    /**
     * Creates new column.
     */
    private Column(int relativeWidth) {
<span class="nc" id="L83">      this(new VerticalPanel(), relativeWidth);</span>
<span class="nc" id="L84">    }</span>

    /**
     * Creates new column.
     */
    private Column(VerticalPanel columnPanel, int relativeWidth) {
<span class="nc" id="L90">      super(columnPanel);</span>

<span class="nc" id="L92">      boxes = new ArrayList&lt;BoxDescriptor&gt;();</span>

<span class="nc" id="L94">      this.columnPanel = columnPanel;</span>
<span class="nc" id="L95">      this.relativeWidth = relativeWidth;</span>

<span class="nc" id="L97">      columnPanel.setWidth(relativeWidth + &quot;%&quot;);</span>
<span class="nc" id="L98">      columnPanel.setSpacing(SPACING);</span>
<span class="nc" id="L99">    }</span>

    @Override
    protected void insert(Widget widget, int beforeIndex) {
      // columnPanel always contains at least one widget: the 'invisible' end marker. Therefore
      // beforeIndex cannot become negative.
<span class="nc bnc" id="L105" title="All 2 branches missed.">      if (beforeIndex == columnPanel.getWidgetCount()) {</span>
<span class="nc" id="L106">        beforeIndex--;</span>
      }

<span class="nc" id="L109">      super.insert(widget, beforeIndex);</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">      if (widget instanceof Box) {</span>
<span class="nc" id="L112">        ((Box) widget).onResize(absoluteWidth);</span>
      }
<span class="nc" id="L114">    }</span>

    /**
     * Invoked upon resizing of the work area panel.
     *
     * @see WorkAreaPanel#onResize(int, int)
     *
     * @param width column width in pixel
     */
    public void onResize(int width) {
<span class="nc" id="L124">      absoluteWidth = width * relativeWidth / 100;</span>
<span class="nc" id="L125">      columnPanel.setWidth(absoluteWidth + &quot;px&quot;);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">      for (Widget w : columnPanel) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (w instanceof Box) {</span>
<span class="nc" id="L128">          ((Box) w).onResize(absoluteWidth);</span>
        } else {
          // Top-of-column marker (otherwise invisible widget)
<span class="nc" id="L131">          w.setWidth(absoluteWidth + &quot;px&quot;);</span>
        }
<span class="nc" id="L133">      }</span>
<span class="nc" id="L134">    }</span>

    /**
     * Add a new box to the column.
     *
     * @param type  type of box
     * @param height  height of box in pixels if not minimized
     * @param minimized  indicates whether box is minimized
     */
    public void add(Class&lt;? extends Box&gt; type, int height, boolean minimized) {
<span class="nc" id="L144">      boxes.add(new BoxDescriptor(type, absoluteWidth, height, minimized));</span>
<span class="nc" id="L145">    }</span>

    /**
     * Updates the box descriptors for the boxes in the column.
     */
    private void updateBoxDescriptors() {
<span class="nc" id="L151">      boxes.clear();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">      for (Widget w : columnPanel) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (w instanceof Box) {</span>
<span class="nc" id="L154">          boxes.add(((Box) w).getLayoutSettings());</span>
        }
<span class="nc" id="L156">      }</span>
<span class="nc" id="L157">    }</span>

    /**
     * Returns JSON encoding for the boxes in a column.
     */
    private String toJson() {
<span class="nc" id="L163">      List&lt;String&gt; jsonBoxes = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">      for (int i = 0; i &lt; columnPanel.getWidgetCount(); i++) {</span>
<span class="nc" id="L165">        Widget w = columnPanel.getWidget(i);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (w instanceof Box) {</span>
<span class="nc" id="L167">          jsonBoxes.add(((Box) w).getLayoutSettings().toJson());</span>
        }
      }

<span class="nc" id="L171">      return &quot;{&quot; +</span>
<span class="nc" id="L172">            &quot;\&quot;&quot; + NAME_WIDTH + &quot;\&quot;:&quot; + JSONUtil.toJson(relativeWidth) + &quot;,&quot; +</span>
<span class="nc" id="L173">            &quot;\&quot;&quot; + NAME_BOXES + &quot;\&quot;:[&quot; + StringUtils.join(&quot;,&quot;, jsonBoxes) + &quot;]&quot; +</span>
          &quot;}&quot;;
    }

    /**
     * Creates a new column from a JSON encoded layout.
     *
     * @param columnIndex  index of column
     * @param object  column in JSON format
     */
    private static Column fromJson(int columnIndex, JSONObject object) {
<span class="nc" id="L184">      Column column = new Column(columnIndex);</span>

<span class="nc" id="L186">      Map&lt;String, JSONValue&gt; properties = object.getProperties();</span>
<span class="nc" id="L187">      column.relativeWidth = JSONUtil.intFromJsonValue(properties.get(NAME_WIDTH));</span>

<span class="nc bnc" id="L189" title="All 2 branches missed.">      for (JSONValue boxObject : properties.get(NAME_BOXES).asArray().getElements()) {</span>
<span class="nc" id="L190">        column.boxes.add(BoxDescriptor.fromJson(boxObject.asObject()));</span>
<span class="nc" id="L191">      }</span>

<span class="nc" id="L193">      return column;</span>
    }

    /**
     * Collects box types encoded in the JSON.
     *
     * @param object    column in JSON format
     * @param boxTypes  set of box types encountered so far
     */
    private static void boxTypesFromJson(JSONObject object,
                                         Set&lt;String&gt; boxTypes) {
<span class="nc" id="L204">      Map&lt;String, JSONValue&gt; properties = object.getProperties();</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">      for (JSONValue boxObject : properties.get(NAME_BOXES).asArray().getElements()) {</span>
<span class="nc" id="L207">        boxTypes.add(BoxDescriptor.boxTypeFromJson(boxObject.asObject()));</span>
<span class="nc" id="L208">      }</span>
<span class="nc" id="L209">    }</span>

  }

  // Spacing between columns in pixels
  private static final int SPACING = 5;

  // Field names for JSON object encoding of layout
  private static final String NAME_NAME = &quot;name&quot;;
  private static final String NAME_COLUMNS = &quot;columns&quot;;

  // List of columns
  private final List&lt;Column&gt; columns;

  // Drag handler for detecting changes to the layout
  private final DragHandler changeDetector;

  /**
   * Creates a new layout.
   */
  public ColumnLayout(String name) {
<span class="nc" id="L230">    super(name);</span>

<span class="nc" id="L232">    columns = new ArrayList&lt;Column&gt;();</span>
<span class="nc" id="L233">    changeDetector = new ChangeDetector();</span>
<span class="nc" id="L234">  }</span>

  /**
   * Clears the layout (removes all existing columns etc).
   */
  private void clear(WorkAreaPanel workArea) {
<span class="nc bnc" id="L240" title="All 2 branches missed.">    for (Column column : columns) {</span>
<span class="nc" id="L241">      workArea.getWidgetDragController().unregisterDropController(column);</span>
<span class="nc" id="L242">    }</span>
<span class="nc" id="L243">    workArea.getWidgetDragController().removeDragHandler(changeDetector);</span>
<span class="nc" id="L244">    columns.clear();</span>
<span class="nc" id="L245">  }</span>

  /**
   * Adds a new column to the layout.
   *
   * @param relativeWidth  relative width of column (width of all columns
   *                        should add up to 100)
   * @return  new layout column
   */
  public Column addColumn(int relativeWidth) {
<span class="nc" id="L255">    Column column = new Column(relativeWidth);</span>
<span class="nc" id="L256">    columns.add(column);</span>
<span class="nc" id="L257">    return column;</span>
  }

  @Override
  public void apply(WorkAreaPanel workArea) {

    // Clear base panel
<span class="nc" id="L264">    workArea.clear();</span>

    // Horizontal panel to hold columns
<span class="nc" id="L267">    HorizontalPanel horizontalPanel = new HorizontalPanel();</span>
<span class="nc" id="L268">    horizontalPanel.setSize(&quot;100%&quot;, &quot;100%&quot;);</span>
<span class="nc" id="L269">    workArea.add(horizontalPanel);</span>

    // Initialize columns
<span class="nc bnc" id="L272" title="All 2 branches missed.">    for (Column column : columns) {</span>
<span class="nc" id="L273">      horizontalPanel.add(column.columnPanel);</span>
<span class="nc" id="L274">      workArea.getWidgetDragController().registerDropController(column);</span>

      // Add invisible dummy widget to prevent column from collapsing when it contains no boxes
<span class="nc" id="L277">      column.columnPanel.add(new Label());</span>

      // Add boxes from layout
<span class="nc" id="L280">      List&lt;BoxDescriptor&gt; boxes = column.boxes;</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">      for (int index = 0; index &lt; boxes.size(); index++) {</span>
<span class="nc" id="L282">        BoxDescriptor bd = boxes.get(index);</span>
<span class="nc" id="L283">        Box box = workArea.createBox(bd);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (box != null) {</span>
<span class="nc" id="L285">          column.insert(box, index);</span>
<span class="nc" id="L286">          box.restoreLayoutSettings(bd);</span>
        }
      }
<span class="nc" id="L289">    }</span>

<span class="nc" id="L291">    workArea.getWidgetDragController().addDragHandler(changeDetector);</span>
<span class="nc" id="L292">  }</span>

  @Override
  public void onResize(int width, int height) {
    // Calculate the usable width for the columns (which is the width of the browser client area
    // minus the spacing on each side of the boxes).
<span class="nc" id="L298">    int usableWidth = (width - ((columns.size() + 1) * SPACING));</span>

    // On startup it can happen that we receive a window resize event before the boxes are attached
    // to the DOM. In that case, width and height are 0, we can safely ignore because there will
    // soon be another resize event after the boxes are attached to the DOM.
<span class="nc bnc" id="L303" title="All 2 branches missed.">    if (width &gt; 0) {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">      for (Column column : columns) {</span>
<span class="nc" id="L305">        column.onResize(usableWidth);</span>
<span class="nc" id="L306">      }</span>
    }
<span class="nc" id="L308">  }</span>

  @Override
  public String toJson() {
<span class="nc" id="L312">    List&lt;String&gt; jsonColumns = new ArrayList&lt;String&gt;(columns.size());</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">    for (Column column : columns) {</span>
<span class="nc" id="L314">      jsonColumns.add(column.toJson());</span>
<span class="nc" id="L315">    }</span>

<span class="nc" id="L317">    return &quot;{&quot; +</span>
<span class="nc" id="L318">          &quot;\&quot;&quot; + NAME_NAME + &quot;\&quot;:&quot; + JSONUtil.toJson(getName()) + &quot;,&quot; +</span>
<span class="nc" id="L319">          &quot;\&quot;&quot; + NAME_COLUMNS + &quot;\&quot;:[&quot; + StringUtils.join(&quot;,&quot;, jsonColumns) + &quot;]&quot; +</span>
        &quot;}&quot;;
  }

  /**
   * Creates a new layout from a JSON encoded layout.
   *
   * @param object  layout in JSON format
   */
  public static Layout fromJson(JSONObject object, WorkAreaPanel workArea) {

<span class="nc" id="L330">    Map&lt;String, JSONValue&gt; properties = object.getProperties();</span>

<span class="nc" id="L332">    String name = properties.get(NAME_NAME).asString().getString();</span>
<span class="nc" id="L333">    ColumnLayout layout = (ColumnLayout) workArea.getLayouts().get(name);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">    if (layout == null) {</span>
<span class="nc" id="L335">      layout = new ColumnLayout(name);</span>
    }

<span class="nc" id="L338">    layout.clear(workArea);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">    for (JSONValue columnObject : properties.get(NAME_COLUMNS).asArray().getElements()) {</span>
<span class="nc" id="L340">      layout.columns.add(Column.fromJson(layout.columns.size(), columnObject.asObject()));</span>
<span class="nc" id="L341">    }</span>

<span class="nc" id="L343">    return layout;</span>
  }

  /**
   * Collects box types encoded in the JSON.
   *
   * @param object    layout in JSON format
   * @param boxTypes  box types encountered so far
   */
  public static void boxTypesFromJson(JSONObject object, Set&lt;String&gt; boxTypes) {

<span class="nc" id="L354">    Map&lt;String, JSONValue&gt; properties = object.getProperties();</span>

<span class="nc bnc" id="L356" title="All 2 branches missed.">    for (JSONValue columnObject : properties.get(NAME_COLUMNS).asArray().getElements()) {</span>
<span class="nc" id="L357">      Column.boxTypesFromJson(columnObject.asObject(), boxTypes);</span>
<span class="nc" id="L358">    }</span>

<span class="nc" id="L360">  }</span>

  @Override
  protected void fireLayoutChange() {
    // Need to update box descriptors before firing change event.
    // It is easier (maintenance-wise) to do this here instead of doing this in multiple places.
<span class="nc bnc" id="L366" title="All 2 branches missed.">    for (Column column : columns) {</span>
<span class="nc" id="L367">      column.updateBoxDescriptors();</span>
<span class="nc" id="L368">    }</span>

<span class="nc" id="L370">    super.fireLayoutChange();</span>
<span class="nc" id="L371">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>