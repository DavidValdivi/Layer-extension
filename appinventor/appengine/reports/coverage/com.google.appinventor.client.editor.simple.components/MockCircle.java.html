<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MockCircle.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.editor.simple.components</a> &gt; <span class="el_source">MockCircle.java</span></div><h1>MockCircle.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2016-2017 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.editor.simple.components;

import com.google.appinventor.client.editor.simple.SimpleEditor;
import com.google.appinventor.client.editor.simple.components.utils.SVGPanel;
import com.google.appinventor.components.common.ComponentConstants;
import com.google.gwt.core.client.JavaScriptObject;
import com.google.gwt.json.client.JSONObject;

public class MockCircle extends MockMapFeatureBaseWithFill {
  public static final String TYPE = &quot;Circle&quot;;

  private static final String PROPERTY_NAME_RADIUS = &quot;Radius&quot;;

  public MockCircle(SimpleEditor editor) {
<span class="nc" id="L20">    super(editor, TYPE, images.circle());</span>

<span class="nc" id="L22">    SVGPanel svgpanel = new SVGPanel();</span>
<span class="nc" id="L23">    final int diameter = ComponentConstants.CIRCLE_PREFERRED_RADIUS * 2;</span>
<span class="nc" id="L24">    final int center = ComponentConstants.CIRCLE_PREFERRED_RADIUS + 1;</span>
<span class="nc" id="L25">    svgpanel.setPixelSize(diameter + 2, diameter + 2);</span>
<span class="nc" id="L26">    svgpanel.setInnerSVG(&quot;&lt;circle cx=\&quot;&quot; + center + &quot;\&quot; cy=\&quot;&quot; + center + &quot;\&quot; r=\&quot;&quot; +</span>
        ComponentConstants.CIRCLE_PREFERRED_RADIUS + &quot;\&quot; stroke-width=\&quot;1\&quot; stroke=\&quot;black\&quot; fill=\&quot;red\&quot; /&gt;&quot;);
<span class="nc" id="L28">    panel.setWidget(svgpanel);</span>
<span class="nc" id="L29">    panel.setWidth((diameter + 2) + &quot;px&quot;);</span>
<span class="nc" id="L30">    panel.setHeight((diameter + 2) + &quot;px&quot;);</span>

<span class="nc" id="L32">    initCircle();</span>
<span class="nc" id="L33">  }</span>

  static MockCircle fromGeoJSON(MockFeatureCollection parent, JSONObject properties, JavaScriptObject layer) {
<span class="nc" id="L36">    MockCircle circle = new MockCircle(parent.editor);</span>
<span class="nc" id="L37">    circle.feature = layer;</span>
    // TODO(ewpatton): Process properties
<span class="nc" id="L39">    return circle;</span>
  }

  @Override
  public boolean onDrop(MockMap map, int x, int y, int offsetX, int offsetY) {
<span class="nc" id="L44">    final int radius = ComponentConstants.CIRCLE_PREFERRED_RADIUS + 1;</span>
    // Unfortunately due to the mercator web projection there is no way to ensure the circle projected matches the
    // flat circle dragged from the palette. It will be most approximate at high zoom levels and closer to the equator.
<span class="nc" id="L47">    MockMap.LatLng point = map.projectFromXY(x - offsetX + radius, y - offsetY);</span>
<span class="nc" id="L48">    MockMap.LatLng center = map.projectFromXY(x - offsetX + radius, y - offsetY + radius);</span>
<span class="nc" id="L49">    final double radiusInM = distanceBetweenPoints(map.getMapInstance(), center, point);</span>
<span class="nc" id="L50">    setCenterAndRadius(center.toNative(), radiusInM);</span>
<span class="nc" id="L51">    getProperties().changePropertyValue(PROPERTY_NAME_LATITUDE, Double.toString(center.latitude));</span>
<span class="nc" id="L52">    getProperties().changePropertyValue(PROPERTY_NAME_LONGITUDE, Double.toString(center.longitude));</span>
<span class="nc" id="L53">    getProperties().changePropertyValue(PROPERTY_NAME_RADIUS, Double.toString(radiusInM));</span>
<span class="nc" id="L54">    return true;</span>
  }

  @Override
  public void onPropertyChange(String propertyName, String newValue) {
<span class="nc" id="L59">    super.onPropertyChange(propertyName, newValue);</span>

<span class="nc bnc" id="L61" title="All 2 branches missed.">    if (propertyName.equals(PROPERTY_NAME_LATITUDE)) {</span>
<span class="nc" id="L62">      setLatitudeProperty(newValue);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_LONGITUDE)) {</span>
<span class="nc" id="L64">      setLongitudeProperty(newValue);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_RADIUS)) {</span>
<span class="nc" id="L66">      setRadiusProperty(newValue);</span>
    }
<span class="nc" id="L68">  }</span>

  @Override
  public int getPreferredWidth() {
<span class="nc" id="L72">    return ComponentConstants.CIRCLE_PREFERRED_RADIUS;</span>
  }

  @Override
  public int getPreferredHeight() {
<span class="nc" id="L77">    return ComponentConstants.CIRCLE_PREFERRED_RADIUS;</span>
  }

  @Override
  protected boolean isPropertyVisible(String propertyName) {
<span class="nc bnc" id="L82" title="All 2 branches missed.">    if (propertyName.equals(PROPERTY_NAME_WIDTH) ||</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        propertyName.equals(PROPERTY_NAME_HEIGHT)) {</span>
<span class="nc" id="L84">      return false;</span>
    }

<span class="nc" id="L87">    return super.isPropertyVisible(propertyName);</span>
  }

  private void setLatitudeProperty(String newValue) {
    try {
<span class="nc" id="L92">      double latitude = Double.parseDouble(newValue);</span>
<span class="nc" id="L93">      setCenter(latitude, getLongitude());</span>
<span class="nc" id="L94">    } catch(NumberFormatException e) {</span>
      // pass
<span class="nc" id="L96">    }</span>
<span class="nc" id="L97">  }</span>

  private void setLongitudeProperty(String newValue) {
    try {
<span class="nc" id="L101">      double longitude = Double.parseDouble(newValue);</span>
<span class="nc" id="L102">      setCenter(getLatitude(), longitude);</span>
<span class="nc" id="L103">    } catch(NumberFormatException e) {</span>
      // pass
<span class="nc" id="L105">    }</span>
<span class="nc" id="L106">  }</span>

  private void setRadiusProperty(String newValue) {
<span class="nc bnc" id="L109" title="All 4 branches missed.">    if (newValue == null || newValue.equals(&quot;&quot;)) {</span>
<span class="nc" id="L110">      return;  // invalid value set in the MockComponent constructor</span>
    }
    try {
<span class="nc" id="L113">      double radius = Double.parseDouble(newValue);</span>
<span class="nc" id="L114">      setRadius(radius);</span>
<span class="nc" id="L115">    } catch(NumberFormatException e) {</span>
      // pass
<span class="nc" id="L117">    }</span>
<span class="nc" id="L118">  }</span>

  @SuppressWarnings(&quot;unused&quot;)  // called from JSNI
  private void updateCenter(double latitude, double longitude) {
<span class="nc" id="L122">    getProperties().changePropertyValue(PROPERTY_NAME_LATITUDE, Double.toString(latitude));</span>
<span class="nc" id="L123">    getProperties().changePropertyValue(PROPERTY_NAME_LONGITUDE, Double.toString(longitude));</span>
<span class="nc" id="L124">    super.onPropertyChange(PROPERTY_NAME_LATITUDE, Double.toString(latitude));</span>
<span class="nc" id="L125">    super.onPropertyChange(PROPERTY_NAME_LONGITUDE, Double.toString(longitude));</span>
<span class="nc" id="L126">  }</span>

  @SuppressWarnings(&quot;unused&quot;)  // called from JSNI
  private void updateRadius(double radius) {
<span class="nc" id="L130">    getProperties().changePropertyValue(PROPERTY_NAME_RADIUS, Double.toString(radius));</span>
<span class="nc" id="L131">    super.onPropertyChange(PROPERTY_NAME_RADIUS, Double.toString(radius));</span>
<span class="nc" id="L132">  }</span>

  // JSNI Methods
  private native void initCircle()/*-{
    this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature =
      // Fix for https://github.com/mit-cml/appinventor-sources/issues/1379: Initial coordinate
      // should match default property values for Latitude and Longitude (i.e., (0, 0)) otherwise
      // Leaflet throws an exception when we later add the Circle to the Map.
      top.L.circle([0, 0], @com.google.appinventor.components.common.ComponentConstants::CIRCLE_PREFERRED_RADIUS, {
        className: 'leaflet-interactive',
        weight: 1,
        color: '#000',
        fillColor: '#f00',
        fillOpacity: 1,
        draggable: true,
        pointerEvents: 'auto'
      });
  }-*/;

  private native void setCenterAndRadius(JavaScriptObject center, double radius)/*-{
    var circle = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (circle) {
      circle.setLatLng(center);
      circle.setRadius(radius);
      if (circle.editor) circle.editor.reset();  // reset vertices of the editor
    }
  }-*/;

  private native void setCenter(double latitude, double longitude)/*-{
    var circle = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (circle) {
      circle.setLatLng([latitude, longitude]);
      if (circle.editor) circle.editor.reset();  // reset vertices of the editor
    }
  }-*/;

  private native void setRadius(double radius)/*-{
    var circle = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (circle) {
      circle.setRadius(radius);
      if (circle.editor) circle.editor.reset();  // reset vertices of the editor
    }
  }-*/;

  private native double getLatitude()/*-{
    var circle = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (circle &amp;&amp; circle.getLatLng()) {
      return circle.getLatLng().lat;
    } else {
      return 0;
    }
  }-*/;

  private native double getLongitude()/*-{
    var circle = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (circle &amp;&amp; circle.getLatLng()) {
      return circle.getLatLng().lng;
    } else {
      return 0;
    }
  }-*/;

  protected native void addToMap(JavaScriptObject map)/*-{
    var el = this.@com.google.appinventor.client.editor.simple.components.MockCircle::getElement()();
    var circle = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    map.addLayer(circle);
    if (!circle.clickHandler) {
      while (el.lastChild) el.removeChild(el.lastChild);  // clear the div
      circle.clickHandler = function(e) {
        this.@com.google.appinventor.client.editor.simple.components.MockCircle::select(*)(e);
        if (e.originalEvent) e.originalEvent.stopPropagation();
      };
      circle.dragHandler = function(e) {
        var center = circle.getLatLng();
        var radius = circle.getRadius();
        this.@com.google.appinventor.client.editor.simple.components.MockCircle::updateCenter(DD)(center.lat, center.lng);
        this.@com.google.appinventor.client.editor.simple.components.MockCircle::updateRadius(D)(radius);
        if (e.originalEvent) e.originalEvent.stopPropagation();
      };
      circle.on('dragend editable:dragend editable:vertex:dragend editable:vertex:deleted editable:drawing:commit',
        circle.dragHandler, this);
      circle.on('click dragstart editable:dragstart editable:vertex:dragstart editable:vertex:clicked editable:drawing:click editable:drawing:clicked dragend editable:dragend',
        circle.clickHandler, this);
    }
    el = circle.getElement();
    el.style['pointer-events'] = 'auto';
    el.style['cursor'] = 'pointer';
    this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::setNativeTooltip(*)(
      this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::getTooltip()()
    );
    var isVisible = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::getVisibleProperty()();
    if (!isVisible) {
      map.removeLayer(circle);
    }
  }-*/;

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>