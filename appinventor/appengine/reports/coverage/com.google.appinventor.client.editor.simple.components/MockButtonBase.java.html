<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MockButtonBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.editor.simple.components</a> &gt; <span class="el_source">MockButtonBase.java</span></div><h1>MockButtonBase.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2017 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.editor.simple.components;

import static com.google.appinventor.client.Ode.MESSAGES;
import com.google.appinventor.client.editor.simple.SimpleEditor;
import com.google.appinventor.client.editor.youngandroid.YaFormEditor;
import com.google.appinventor.client.output.OdeLog;
import com.google.gwt.event.dom.client.ErrorEvent;
import com.google.gwt.event.dom.client.ErrorHandler;
import com.google.gwt.event.dom.client.LoadEvent;
import com.google.gwt.event.dom.client.LoadHandler;
import com.google.gwt.resources.client.ImageResource;
import com.google.gwt.user.client.DOM;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.DeckPanel;
import com.google.gwt.user.client.ui.Image;

/**
 * Abstract superclass for button based mock components.
 *
 * @author lizlooney@google.com (Liz Looney)
 */
abstract class MockButtonBase extends MockVisibleComponent implements FormChangeListener {
  // Property names
  private static final String PROPERTY_NAME_IMAGE = &quot;Image&quot;;

  // GWT widget used to mock a Simple Button
  private final Button buttonWidget;
  private int[] preferredSizeOfButton;
  private final Image image;
  private String imagePropValue;
  private boolean hasImage;

  // We need to maintain these so we can show color and shape only when
  // there is no image.
  private String backgroundColor;
  // Legal values for shape are defined in
  // com.google.appinventor.components.runtime.Component.java.
  private int shape;

  /**
   * Creates a new MockButtonBase component.
   *
   * @param editor  editor of source file the component belongs to
   */
  MockButtonBase(SimpleEditor editor, String type, ImageResource icon) {
<span class="nc" id="L52">    super(editor, type, icon);</span>

    // Initialize mock button UI
<span class="nc" id="L55">    buttonWidget = new Button();</span>
<span class="nc" id="L56">    buttonWidget.addStyleName(&quot;ode-SimpleMockButton&quot;);</span>
<span class="nc" id="L57">    image = new Image();</span>
<span class="nc" id="L58">    image.addErrorHandler(new ErrorHandler() {</span>
      @Override
      public void onError(ErrorEvent event) {
<span class="nc bnc" id="L61" title="All 4 branches missed.">        if (imagePropValue != null &amp;&amp; !imagePropValue.isEmpty()) {</span>
<span class="nc" id="L62">          OdeLog.elog(&quot;Error occurred while loading image &quot; + imagePropValue);</span>
        }
<span class="nc" id="L64">        refreshForm();</span>
<span class="nc" id="L65">      }</span>
    });
<span class="nc" id="L67">    image.addLoadHandler(new LoadHandler() {</span>
      @Override
      public void onLoad(LoadEvent event) {
<span class="nc" id="L70">        refreshForm();</span>
<span class="nc" id="L71">      }</span>
    });
<span class="nc" id="L73">    DeckPanel deckPanel = new DeckPanel();</span>
<span class="nc" id="L74">    deckPanel.setStylePrimaryName(&quot;ode-SimpleMockComponent&quot;);</span>
<span class="nc" id="L75">    deckPanel.add(buttonWidget);</span>
<span class="nc" id="L76">    deckPanel.add(image);</span>
<span class="nc" id="L77">    deckPanel.showWidget(0);</span>
<span class="nc" id="L78">    initComponent(deckPanel);</span>

<span class="nc" id="L80">  }</span>

  @Override
  protected void onAttach() {
<span class="nc" id="L84">    super.onAttach();</span>
<span class="nc" id="L85">    ((YaFormEditor) editor).getForm().addFormChangeListener(this);</span>
<span class="nc" id="L86">  }</span>

  @Override
  protected void onDetach() {
<span class="nc" id="L90">    super.onDetach();</span>
<span class="nc" id="L91">    ((YaFormEditor) editor).getForm().removeFormChangeListener(this);</span>
<span class="nc" id="L92">  }</span>

  /**
   * Class that extends Button so we can use a protected constructor.
   *
   * &lt;p/&gt;The purpose of this class is to create a clone of the Button passed to
   * the constructor. It will be used to determine the preferred size of the
   * Button, without having the size constrained by its parent, since the
   * cloned Button won't have a parent.
   */
  static class ClonedButton extends Button {
    ClonedButton(Button b) {
      // Get the Element from the Button.
      // Call DOM.clone to make a deep clone of that element.
      // Pass that cloned element to the super constructor.
<span class="nc" id="L107">      super(DOM.clone(b.getElement(), true)); // true for a deep clone</span>
<span class="nc" id="L108">    }</span>
  }

  private Button createClonedButton() {
<span class="nc" id="L112">    return new ClonedButton(buttonWidget);</span>
  }

  @Override
  public void onCreateFromPalette() {
    // Change button caption to component name
<span class="nc" id="L118">    changeProperty(PROPERTY_NAME_TEXT, MESSAGES.textPropertyValue(getName()));</span>
<span class="nc" id="L119">  }</span>

  /*
   * Sets the button's TextAlignment property to a new value.
   */
  private void setTextAlignmentProperty(String text) {
<span class="nc" id="L125">    MockComponentsUtil.setWidgetTextAlign(buttonWidget, text);</span>
<span class="nc" id="L126">  }</span>

  /*
   * Sets the button's Shape property to a new value.
   */
  private void setShapeProperty(String text) {
<span class="nc" id="L132">    shape = Integer.parseInt(text);</span>
    // Android Buttons with images take the shape of the image and do not
    // use one of the defined Shapes.
<span class="nc bnc" id="L135" title="All 2 branches missed.">    if (hasImage) {</span>
<span class="nc" id="L136">      return;</span>
    }
<span class="nc bnc" id="L138" title="All 5 branches missed.">    switch(shape) {</span>
      case 0:
        // Default Button
<span class="nc" id="L141">        buttonWidget.getElement().getStyle().clearBorderStyle();</span>
<span class="nc" id="L142">        break;</span>
      case 1:
        // Rounded Button.
        // The corners of the Button are rounded by 10 px.
        // The value 10 px was chosen strictly for style.
        // 10 px is the same as ROUNDED_CORNERS_RADIUS defined in
        // com.google.appinventor.components.runtime.ButtonBase.
<span class="nc" id="L149">        DOM.setStyleAttribute(buttonWidget.getElement(), &quot;borderRadius&quot;, &quot;10px&quot;);</span>
<span class="nc" id="L150">        break;</span>
      case 2:
        // Rectangular Button
<span class="nc" id="L153">        DOM.setStyleAttribute(buttonWidget.getElement(), &quot;borderRadius&quot;, &quot;0px&quot;);</span>
<span class="nc" id="L154">        break;</span>
      case 3:
        // Oval Button
<span class="nc" id="L157">        String height = DOM.getStyleAttribute(buttonWidget.getElement(), &quot;height&quot;);</span>
<span class="nc" id="L158">        DOM.setStyleAttribute(buttonWidget.getElement(), &quot;borderRadius&quot;, height);</span>
<span class="nc" id="L159">        break;</span>
      default:
        // This should never happen
<span class="nc" id="L162">        throw new IllegalArgumentException(&quot;shape:&quot; + shape);</span>
    }
<span class="nc" id="L164">  }</span>

  /*
   * Sets the button's BackgroundColor property to a new value.
   */
  private void setBackgroundColorProperty(String text) {
<span class="nc" id="L170">    backgroundColor = text;</span>
    // Android Buttons do not show a background color if they have an image.
<span class="nc bnc" id="L172" title="All 2 branches missed.">    if (hasImage) {</span>
<span class="nc" id="L173">      return;</span>
    }
<span class="nc bnc" id="L175" title="All 2 branches missed.">    if (MockComponentsUtil.isDefaultColor(text)) {</span>
<span class="nc" id="L176">      MockForm form = ((YaFormEditor) editor).getForm();</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">      if (form != null &amp;&amp; form.getPropertyValue(&quot;HighContrast&quot;).equals(&quot;True&quot;)) {</span>
<span class="nc" id="L178">        MockComponentsUtil.setWidgetBackgroundColor(buttonWidget, &quot;&amp;HFF000000&quot;);</span>
      } else {
<span class="nc" id="L180">        MockComponentsUtil.resetWidgetBackgroundColor(buttonWidget);</span>
      }
<span class="nc" id="L182">    } else {</span>
<span class="nc" id="L183">      MockComponentsUtil.setWidgetBackgroundColor(buttonWidget, text);</span>
    }
<span class="nc" id="L185">  }</span>

  /*
   * Sets the button's Enabled property to a new value.
   */
  private void setEnabledProperty(String text) {
<span class="nc" id="L191">    MockComponentsUtil.setEnabled(this, text);</span>
<span class="nc" id="L192">  }</span>

  /*
   * Sets the button's FontBold property to a new value.
   */
  private void setFontBoldProperty(String text) {
<span class="nc" id="L198">    MockComponentsUtil.setWidgetFontBold(buttonWidget, text);</span>
<span class="nc" id="L199">    updatePreferredSizeOfButton();</span>
<span class="nc" id="L200">  }</span>

  /*
   * Sets the button's FontItalic property to a new value.
   */
  private void setFontItalicProperty(String text) {
<span class="nc" id="L206">    MockComponentsUtil.setWidgetFontItalic(buttonWidget, text);</span>
<span class="nc" id="L207">    updatePreferredSizeOfButton();</span>
<span class="nc" id="L208">  }</span>

  /*
   * Sets the button's FontSize property to a new value.
   */
  private void setFontSizeProperty(String text) {
<span class="nc" id="L214">    float convertedText = Float.parseFloat(text);</span>
<span class="nc" id="L215">    MockForm form = ((YaFormEditor) editor).getForm();</span>
<span class="nc bnc" id="L216" title="All 4 branches missed.">    if (convertedText == FONT_DEFAULT_SIZE &amp;&amp; form != null</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        &amp;&amp; form.getPropertyValue(&quot;BigDefaultText&quot;).equals(&quot;True&quot;)) {</span>
<span class="nc" id="L218">      MockComponentsUtil.setWidgetFontSize(buttonWidget, &quot;24&quot;);</span>
    } else {
<span class="nc" id="L220">      MockComponentsUtil.setWidgetFontSize(buttonWidget, text);</span>
    }
<span class="nc" id="L222">    updatePreferredSizeOfButton();</span>
<span class="nc" id="L223">  }</span>

  /*
   * Sets the button's FontTypeface property to a new value.
   */
  private void setFontTypefaceProperty(String text) {
<span class="nc" id="L229">    MockComponentsUtil.setWidgetFontTypeface(this.editor, buttonWidget, text);</span>
<span class="nc" id="L230">    updatePreferredSizeOfButton();</span>
<span class="nc" id="L231">  }</span>

  /*
   * Sets the button's Image property to a new value.
   */
  private void setImageProperty(String text) {
<span class="nc" id="L237">    imagePropValue = text;</span>
<span class="nc" id="L238">    String url = convertImagePropertyValueToUrl(text);</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">    if (url == null) {</span>
<span class="nc" id="L240">      hasImage = false;</span>
<span class="nc" id="L241">      url = &quot;&quot;;</span>
<span class="nc" id="L242">      setBackgroundColorProperty(backgroundColor);</span>
<span class="nc" id="L243">      setShapeProperty(Integer.toString(shape));</span>
    } else {
<span class="nc" id="L245">      hasImage = true;</span>
      // Android Buttons do not show a background color if they have an image.
      // The container's background color shows through any transparent
      // portions of the Image, an effect we can get in the browser by
      // setting the widget's background color to COLOR_NONE.
<span class="nc" id="L250">      MockComponentsUtil.setWidgetBackgroundColor(buttonWidget,</span>
          &quot;&amp;H&quot; + COLOR_NONE);
<span class="nc" id="L252">      DOM.setStyleAttribute(buttonWidget.getElement(), &quot;borderRadius&quot;, &quot;0px&quot;);</span>
    }
<span class="nc" id="L254">    MockComponentsUtil.setWidgetBackgroundImage(buttonWidget, url);</span>
<span class="nc" id="L255">    image.setUrl(url);</span>
<span class="nc" id="L256">  }</span>

  /*
   * Sets the button's Text property to a new value.
   */
  private void setTextProperty(String text) {
<span class="nc" id="L262">    buttonWidget.setText(text);</span>
<span class="nc" id="L263">    updatePreferredSizeOfButton();</span>
<span class="nc" id="L264">  }</span>

  /*
   * Sets the button's TextColor property to a new value.
   */
  private void setTextColorProperty(String text) {
<span class="nc bnc" id="L270" title="All 2 branches missed.">    if (MockComponentsUtil.isDefaultColor(text)) {</span>
<span class="nc" id="L271">      MockForm form = ((YaFormEditor) editor).getForm();</span>
<span class="nc bnc" id="L272" title="All 4 branches missed.">      if (form != null &amp;&amp; form.getPropertyValue(&quot;HighContrast&quot;).equals(&quot;True&quot;)) {</span>
<span class="nc" id="L273">        MockComponentsUtil.setWidgetTextColor(buttonWidget, &quot;&amp;HFFFFFFFF&quot;);</span>
      } else {
<span class="nc" id="L275">        MockComponentsUtil.resetWidgetTextColor(buttonWidget);</span>
      }
<span class="nc" id="L277">    } else {</span>
<span class="nc" id="L278">      MockComponentsUtil.setWidgetTextColor(buttonWidget, text);</span>
    }
<span class="nc" id="L280">  }</span>

  private final void updatePreferredSizeOfButton() {
<span class="nc" id="L283">    preferredSizeOfButton = MockComponentsUtil.getPreferredSizeOfDetachedWidget(</span>
<span class="nc" id="L284">        createClonedButton());</span>
<span class="nc" id="L285">  }</span>

  @Override
  public int getPreferredWidth() {
    // The superclass uses getOffsetWidth of the DeckPanel, which won't work for us.
<span class="nc bnc" id="L290" title="All 2 branches missed.">    if (preferredSizeOfButton == null) {</span>
<span class="nc" id="L291">      updatePreferredSizeOfButton();</span>
    }
<span class="nc" id="L293">    int width = preferredSizeOfButton[0];</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">    if (hasImage) {</span>
<span class="nc" id="L295">      int imageWidth = image.getWidth();</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">      if (imageWidth &gt; width) {</span>
<span class="nc" id="L297">        width = imageWidth;</span>
      }
    }
<span class="nc" id="L300">    return width;</span>
  }

  @Override
  public int getPreferredHeight() {
    // The superclass uses getOffsetHeight of the DeckPanel, which won't work for us.
<span class="nc bnc" id="L306" title="All 2 branches missed.">    if (preferredSizeOfButton == null) {</span>
<span class="nc" id="L307">      updatePreferredSizeOfButton();</span>
    }
<span class="nc" id="L309">    int height = preferredSizeOfButton[1];</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">    if (hasImage) {</span>
<span class="nc" id="L311">      int imageHeight = image.getHeight();</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">      if (imageHeight &gt; height) {</span>
<span class="nc" id="L313">        height = imageHeight;</span>
      }
    }
<span class="nc" id="L316">    return height;</span>
  }

  /*
   * Update widget's text content appearances according to width property value.
   */
  private void updateTextAppearances(String width) {
<span class="nc bnc" id="L323" title="All 2 branches missed.">    if (width.equals(&quot;-1&quot;)) {</span>
      // for width = Automatic
<span class="nc" id="L325">      DOM.setStyleAttribute(buttonWidget.getElement(), &quot;whiteSpace&quot;, &quot;nowrap&quot;);</span>
    } else {
      // for width = Fill Parent, Pixels or Percentage
<span class="nc" id="L328">      DOM.setStyleAttribute(buttonWidget.getElement(), &quot;whiteSpace&quot;, &quot;normal&quot;);</span>
    }
<span class="nc" id="L330">  }</span>

  // PropertyChangeListener implementation

  @Override
  public void onPropertyChange(String propertyName, String newValue) {
<span class="nc" id="L336">    super.onPropertyChange(propertyName, newValue);</span>

    // Apply changed properties to the mock component
<span class="nc bnc" id="L339" title="All 2 branches missed.">    if (propertyName.equals(PROPERTY_NAME_TEXTALIGNMENT)) {</span>
<span class="nc" id="L340">      setTextAlignmentProperty(newValue);</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_BACKGROUNDCOLOR)) {</span>
<span class="nc" id="L342">      setBackgroundColorProperty(newValue);</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_ENABLED)) {</span>
<span class="nc" id="L344">      setEnabledProperty(newValue);</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_FONTBOLD)) {</span>
<span class="nc" id="L346">      setFontBoldProperty(newValue);</span>
<span class="nc" id="L347">      refreshForm();</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_FONTITALIC)) {</span>
<span class="nc" id="L349">      setFontItalicProperty(newValue);</span>
<span class="nc" id="L350">      refreshForm();</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_FONTSIZE)) {</span>
<span class="nc" id="L352">      setFontSizeProperty(newValue);</span>
<span class="nc" id="L353">      refreshForm();</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_FONTTYPEFACE)) {</span>
<span class="nc" id="L355">      setFontTypefaceProperty(newValue);</span>
<span class="nc" id="L356">      refreshForm();</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_IMAGE)) {</span>
<span class="nc" id="L358">      setImageProperty(newValue);</span>
<span class="nc" id="L359">      refreshForm();</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_TEXT)) {</span>
<span class="nc" id="L361">      setTextProperty(newValue);</span>
<span class="nc" id="L362">      refreshForm();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_TEXTCOLOR)) {</span>
<span class="nc" id="L364">      setTextColorProperty(newValue);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_BUTTONSHAPE)){</span>
<span class="nc" id="L366">      setShapeProperty(newValue);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_WIDTH)) {</span>
<span class="nc" id="L368">      updateTextAppearances(newValue);</span>
<span class="nc" id="L369">      refreshForm();</span>
    }
<span class="nc" id="L371">  }</span>

  @Override
  public void onComponentPropertyChanged(MockComponent component, String propertyName, String propertyValue) {
<span class="nc bnc" id="L375" title="All 4 branches missed.">    if (component.getType().equals(MockForm.TYPE) &amp;&amp; propertyName.equals(&quot;HighContrast&quot;)) {</span>
<span class="nc" id="L376">      setBackgroundColorProperty(getPropertyValue(PROPERTY_NAME_BACKGROUNDCOLOR));</span>
<span class="nc" id="L377">      setTextColorProperty(getPropertyValue(PROPERTY_NAME_TEXTCOLOR));</span>
<span class="nc" id="L378">      updatePreferredSizeOfButton();</span>
<span class="nc" id="L379">      refreshForm();</span>
    }
<span class="nc bnc" id="L381" title="All 4 branches missed.">    else if (component.getType().equals(MockForm.TYPE) &amp;&amp; propertyName.equals(&quot;BigDefaultText&quot;)) {</span>
<span class="nc" id="L382">      setFontSizeProperty(getPropertyValue(PROPERTY_NAME_FONTSIZE));</span>
<span class="nc" id="L383">      updatePreferredSizeOfButton();</span>
<span class="nc" id="L384">      refreshForm();</span>
    }

<span class="nc" id="L387">    }</span>

  @Override
  public void onComponentRemoved(MockComponent component, boolean permanentlyDeleted) {

<span class="nc" id="L392">  }</span>

  @Override
  public void onComponentAdded(MockComponent component) {

<span class="nc" id="L397">  }</span>

  @Override
  public void onComponentRenamed(MockComponent component, String oldName) {

<span class="nc" id="L402">  }</span>

  @Override
  public void onComponentSelectionChange(MockComponent component, boolean selected) {

<span class="nc" id="L407">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>