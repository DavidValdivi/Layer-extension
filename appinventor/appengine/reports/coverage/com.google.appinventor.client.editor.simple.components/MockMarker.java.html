<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MockMarker.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.editor.simple.components</a> &gt; <span class="el_source">MockMarker.java</span></div><h1>MockMarker.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2016-2017 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.editor.simple.components;

import java.util.Collections;
import java.util.List;

import com.google.appinventor.client.Ode;
import com.google.appinventor.client.editor.simple.SimpleEditor;
import com.google.appinventor.client.output.OdeLog;
import com.google.appinventor.components.common.ComponentConstants;
import com.google.appinventor.shared.rpc.project.FileDescriptor;
import com.google.appinventor.shared.rpc.project.FileDescriptorWithContent;
import com.google.gwt.core.client.JavaScriptObject;
import com.google.gwt.core.shared.GWT;
import com.google.gwt.json.client.JSONObject;
import com.google.gwt.json.client.JSONValue;
import com.google.gwt.user.client.Event;
import com.google.gwt.user.client.rpc.AsyncCallback;
import com.google.gwt.user.client.ui.Image;

public class MockMarker extends MockMapFeatureBaseWithFill {
  public static final String TYPE = &quot;Marker&quot;;
  public static final String PROPERTY_NAME_IMAGE_ASSET = &quot;ImageAsset&quot;;
  public static final String PROPERTY_NAME_ANCHORHORIZONTAL = &quot;AnchorHorizontal&quot;;
  public static final String PROPERTY_NAME_ANCHORVERTICAL = &quot;AnchorVertical&quot;;
<span class="nc" id="L30">  private String imageAsset = null;</span>
<span class="nc" id="L31">  private String svgContent = null;</span>
<span class="nc" id="L32">  private int width = LENGTH_PREFERRED;</span>
<span class="nc" id="L33">  private int height = LENGTH_PREFERRED;</span>
<span class="nc" id="L34">  private int srcWidth = ComponentConstants.MARKER_PREFERRED_WIDTH;</span>
<span class="nc" id="L35">  private int srcHeight = ComponentConstants.MARKER_PREFERRED_HEIGHT;</span>
<span class="nc" id="L36">  private double anchorU = 0.5;</span>
<span class="nc" id="L37">  private double anchorV = 1.0;</span>
  private JavaScriptObject nativeIcon;
  private boolean needsSizeUpdate;

  public MockMarker(SimpleEditor editor) {
<span class="nc" id="L42">    super(editor, TYPE, images.marker());</span>
<span class="nc" id="L43">    Image image = new Image();</span>
<span class="nc" id="L44">    image.setResource(Ode.getImageBundle().marker());</span>
<span class="nc" id="L45">    image.setWidth(&quot;30&quot;);</span>
<span class="nc" id="L46">    image.setHeight(&quot;50&quot;);</span>
<span class="nc" id="L47">    panel.setWidget(image);</span>
<span class="nc" id="L48">    this.unsinkEvents(Event.MOUSEEVENTS);</span>
<span class="nc" id="L49">    initIcon();</span>
<span class="nc" id="L50">    initMarker(0, 0);</span>
<span class="nc" id="L51">  }</span>

  static MockMarker fromGeoJSON(MockFeatureCollection parent, JSONObject properties, JavaScriptObject layer) {
<span class="nc" id="L54">    MockMarker marker = new MockMarker(parent.editor);</span>
<span class="nc" id="L55">    marker.feature = layer;</span>
<span class="nc" id="L56">    marker.preserveLayerData();</span>
<span class="nc" id="L57">    marker.processFromGeoJSON(parent, properties);</span>
<span class="nc" id="L58">    return marker;</span>
  }

  protected void processFromGeoJSON(MockFeatureCollection parent, JSONObject properties) {
<span class="nc" id="L62">    setImageAsset(null);</span>
<span class="nc" id="L63">    super.processFromGeoJSON(parent, properties);</span>
<span class="nc" id="L64">  }</span>

  protected void processPropertyFromGeoJSON(String key, JSONValue value) {
<span class="nc bnc" id="L67" title="All 2 branches missed.">    if (key.equalsIgnoreCase(PROPERTY_NAME_ANCHORHORIZONTAL)) {</span>
<span class="nc" id="L68">      String v = value.isString().stringValue();</span>
<span class="nc" id="L69">      changeProperty(PROPERTY_NAME_ANCHORHORIZONTAL, v);</span>
<span class="nc" id="L70">      onPropertyChange(PROPERTY_NAME_ANCHORHORIZONTAL, v);</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">    } else if (key.equalsIgnoreCase(PROPERTY_NAME_ANCHORVERTICAL)) {</span>
<span class="nc" id="L72">      String v = value.isString().stringValue();</span>
<span class="nc" id="L73">      changeProperty(PROPERTY_NAME_ANCHORVERTICAL, v);</span>
<span class="nc" id="L74">      onPropertyChange(PROPERTY_NAME_ANCHORVERTICAL, v);</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">    } else if (key.equalsIgnoreCase(PROPERTY_NAME_HEIGHT)) {</span>
<span class="nc" id="L76">      String v = value.isString().stringValue();</span>
<span class="nc" id="L77">      changeProperty(PROPERTY_NAME_HEIGHT, v);</span>
<span class="nc" id="L78">      onPropertyChange(PROPERTY_NAME_HEIGHT, v);</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">    } else if (key.equalsIgnoreCase(PROPERTY_NAME_WIDTH)) {</span>
<span class="nc" id="L80">      String v = value.isString().stringValue();</span>
<span class="nc" id="L81">      changeProperty(PROPERTY_NAME_WIDTH, v);</span>
<span class="nc" id="L82">      onPropertyChange(PROPERTY_NAME_WIDTH, v);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">    } else if (key.equalsIgnoreCase(PROPERTY_NAME_IMAGE_ASSET)) {</span>
<span class="nc" id="L84">      String v = value.isString().stringValue();</span>
<span class="nc" id="L85">      changeProperty(PROPERTY_NAME_IMAGE_ASSET, v);</span>
<span class="nc" id="L86">      onPropertyChange(PROPERTY_NAME_IMAGE_ASSET, v);</span>
<span class="nc" id="L87">    } else {</span>
<span class="nc" id="L88">      super.processPropertyFromGeoJSON(key, value);</span>
    }
<span class="nc" id="L90">  }</span>

  @Override
  public void addToMap(MockMap map) {
<span class="nc bnc" id="L94" title="All 2 branches missed.">    if (panel.getWidget() != null) {</span>
      // remove the marker image for dragging
<span class="nc" id="L96">      panel.remove(panel.getWidget());</span>
    }
<span class="nc" id="L98">    panel.setVisible(false);</span>
<span class="nc" id="L99">    this.map = map;</span>
<span class="nc" id="L100">    updateSizeIfNeeded();</span>
<span class="nc" id="L101">    addToMap(map.getMapInstance());</span>
<span class="nc" id="L102">  }</span>

  @Override
  public boolean onDrop(MockMap map, int x, int y, int offsetX, int offsetY) {
<span class="nc" id="L106">    y += ComponentConstants.MARKER_PREFERRED_HEIGHT / 2 + 1;</span>
<span class="nc" id="L107">    MockMap.LatLng point = map.projectFromXY(x, y);</span>
<span class="nc" id="L108">    changeProperty(MockMapFeature.PROPERTY_NAME_LATITUDE, Double.toString(point.latitude));</span>
<span class="nc" id="L109">    changeProperty(MockMapFeature.PROPERTY_NAME_LONGITUDE, Double.toString(point.longitude));</span>
<span class="nc" id="L110">    return true;</span>
  }

  @Override
  public void onRemoved() {
<span class="nc" id="L115">    setNativeVisible(map.getMapInstance(), false);</span>
<span class="nc" id="L116">  }</span>

  private void setLatitudeProperty(String newValue) {
<span class="nc" id="L119">    double latitude = Double.parseDouble(newValue);</span>
<span class="nc" id="L120">    setLatLng(latitude, getLongitude());</span>
<span class="nc" id="L121">  }</span>

  private void setLongitudeProperty(String newValue) {
<span class="nc" id="L124">    double longitude = Double.parseDouble(newValue);</span>
<span class="nc" id="L125">    setLatLng(getLatitude(), longitude);</span>
<span class="nc" id="L126">  }</span>

  private void setWidthProperty(String text) {
    try {
<span class="nc" id="L130">      int newWidth = Integer.parseInt(text);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">      if (newWidth == LENGTH_FILL_PARENT) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (isMapInitialized()) {</span>
<span class="nc" id="L133">          width = map.getLayout().getLayoutWidth();</span>
        } else {
<span class="nc" id="L135">          needsSizeUpdate = true;</span>
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">      } else if (newWidth &lt;= LENGTH_PERCENT_TAG) {</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (isMapInitialized()) {</span>
<span class="nc" id="L139">          width = (int) ((-newWidth - 1000) / 100.0 * map.getLayout().getLayoutWidth());</span>
        } else {
<span class="nc" id="L141">          needsSizeUpdate = true;</span>
        }
<span class="nc bnc" id="L143" title="All 2 branches missed.">      } else if (newWidth == LENGTH_PREFERRED) {</span>
<span class="nc" id="L144">        width = srcWidth;</span>
      } else {
<span class="nc" id="L146">        width = newWidth;</span>
      }
<span class="nc" id="L148">      setMarkerWidth(width);</span>
<span class="nc" id="L149">    } catch(NumberFormatException e) {</span>
<span class="nc" id="L150">      OdeLog.elog(&quot;Received bad value for MockMarker.setWidthProperty&quot;);</span>
<span class="nc" id="L151">      OdeLog.xlog(e);</span>
<span class="nc" id="L152">    }</span>
<span class="nc" id="L153">  }</span>

  private void setHeightProperty(String text) {
    try {
<span class="nc" id="L157">      int newHeight = Integer.parseInt(text);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">      if (newHeight == LENGTH_FILL_PARENT) {</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (isMapInitialized()) {</span>
<span class="nc" id="L160">          height = map.getLayout().getLayoutHeight();</span>
        } else {
<span class="nc" id="L162">          needsSizeUpdate = true;</span>
        }
<span class="nc bnc" id="L164" title="All 2 branches missed.">      } else if (newHeight &lt;= LENGTH_PERCENT_TAG) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (isMapInitialized()) {</span>
<span class="nc" id="L166">          height = (int) ((-newHeight - 1000) / 100.0 * map.getLayout().getLayoutHeight());</span>
        } else {
<span class="nc" id="L168">          needsSizeUpdate = true;</span>
        }
<span class="nc bnc" id="L170" title="All 2 branches missed.">      } else if (newHeight == LENGTH_PREFERRED) {</span>
<span class="nc" id="L171">        height = srcHeight;</span>
      } else {
<span class="nc" id="L173">        height = newHeight;</span>
      }
<span class="nc" id="L175">      setMarkerHeight(height);</span>
<span class="nc" id="L176">    } catch(NumberFormatException e) {</span>
<span class="nc" id="L177">      OdeLog.elog(&quot;Received bad value for MockMarker.setHeightProperty&quot;);</span>
<span class="nc" id="L178">      OdeLog.xlog(e);</span>
<span class="nc" id="L179">    }</span>
<span class="nc" id="L180">  }</span>

  private void setAnchorHorizontal(String text) {
    try {
<span class="nc" id="L184">      int newAlignment = Integer.parseInt(text);</span>
<span class="nc bnc" id="L185" title="All 4 branches missed.">      if (newAlignment &lt; 1 || newAlignment &gt; 3) {</span>
<span class="nc" id="L186">        OdeLog.elog(&quot;Received invalid value of &quot; + newAlignment + &quot; in MockMarker.setAnchorHorizontal&quot;);</span>
<span class="nc" id="L187">        return;</span>
      }
<span class="nc" id="L189">      setMarkerAnchorHorizontal(newAlignment);</span>
<span class="nc" id="L190">    } catch(NumberFormatException e) {</span>
<span class="nc" id="L191">      OdeLog.elog(&quot;Received bad value for MockMarker.setAnchorHorizontal&quot;);</span>
<span class="nc" id="L192">      OdeLog.xlog(e);</span>
<span class="nc" id="L193">    }</span>
<span class="nc" id="L194">  }</span>

  private void setAnchorVertical(String text) {
    try {
<span class="nc" id="L198">      int newAlignment  = Integer.parseInt(text);</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">      if (newAlignment &lt; 1 || newAlignment &gt; 3) {</span>
<span class="nc" id="L200">        OdeLog.elog(&quot;Received inalid value of &quot; + newAlignment + &quot; in MockMarker.setAnchorVertical&quot;);</span>
<span class="nc" id="L201">        return;</span>
      }
<span class="nc" id="L203">      setMarkerAnchorVertical(newAlignment);</span>
<span class="nc" id="L204">    } catch(NumberFormatException e) {</span>
<span class="nc" id="L205">      OdeLog.elog(&quot;Received bad value for MockMarker.setAnchorVertical&quot;);</span>
<span class="nc" id="L206">      OdeLog.xlog(e);</span>
<span class="nc" id="L207">    }</span>
<span class="nc" id="L208">  }</span>

  private void setImageAsset(String assetPath) {
<span class="nc bnc" id="L211" title="All 2 branches missed.">    if (editor.getProjectId() == 0) {</span>
      // not ready to set image assets
<span class="nc" id="L213">      return;</span>
    }
<span class="nc bnc" id="L215" title="All 4 branches missed.">    if (assetPath == null || assetPath.length() == 0) {</span>
<span class="nc" id="L216">      svgContent = null;</span>
<span class="nc" id="L217">      setMarkerAsset(null);</span>
<span class="nc" id="L218">      return;</span>
    }
<span class="nc" id="L220">    FileDescriptor descriptor = new FileDescriptor(editor.getProjectId(), &quot;assets/&quot; + assetPath);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">    if (assetPath.endsWith(&quot;.svg&quot;)) {</span>
<span class="nc" id="L222">      Ode.getInstance().getProjectService().load(Collections.singletonList(descriptor), new AsyncCallback&lt;List&lt;FileDescriptorWithContent&gt;&gt;() {</span>
        @Override
        public void onFailure(Throwable arg0) {
<span class="nc" id="L225">          GWT.log(&quot;Error occurred loading image asset&quot;, arg0);</span>
<span class="nc" id="L226">        }</span>

        @Override
        public void onSuccess(List&lt;FileDescriptorWithContent&gt; arg0) {
<span class="nc" id="L230">          FileDescriptorWithContent fd = arg0.get(0);</span>
<span class="nc" id="L231">          svgContent = fd.getContent();</span>
<span class="nc" id="L232">          setMarkerAsset(svgContent);</span>
<span class="nc" id="L233">        }</span>
      });
    } else {
<span class="nc" id="L236">      svgContent = null;</span>
<span class="nc" id="L237">      String url = convertImagePropertyValueToUrl(assetPath);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">      if (url != null) {</span>
<span class="nc" id="L239">        setMarkerAssetUrl(url);</span>
      } else {
<span class="nc" id="L241">        setMarkerAsset(null);</span>
      }
    }
<span class="nc" id="L244">  }</span>

  private void setAnchor(double latitude, double longitude) {
<span class="nc" id="L247">    getProperties().changePropertyValue(PROPERTY_NAME_LATITUDE, Double.toString(latitude));</span>
<span class="nc" id="L248">    getProperties().changePropertyValue(PROPERTY_NAME_LONGITUDE, Double.toString(longitude));</span>
<span class="nc" id="L249">    super.onPropertyChange(PROPERTY_NAME_LATITUDE, Double.toString(latitude));</span>
<span class="nc" id="L250">    super.onPropertyChange(PROPERTY_NAME_LONGITUDE, Double.toString(longitude));</span>
<span class="nc" id="L251">  }</span>

  @Override
  public void onPropertyChange(String propertyName, String newValue) {
<span class="nc" id="L255">    super.onPropertyChange(propertyName, newValue);</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">    if (propertyName.equals(PROPERTY_NAME_LATITUDE)) {</span>
<span class="nc" id="L258">      setLatitudeProperty(newValue);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_LONGITUDE)) {</span>
<span class="nc" id="L260">      setLongitudeProperty(newValue);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_IMAGE_ASSET)) {</span>
<span class="nc" id="L262">      setImageAsset(newValue);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_WIDTH)) {</span>
<span class="nc" id="L264">      setWidthProperty(newValue);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_HEIGHT)) {</span>
<span class="nc" id="L266">      setHeightProperty(newValue);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_ANCHORHORIZONTAL)) {</span>
<span class="nc" id="L268">      setAnchorHorizontal(newValue);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_ANCHORVERTICAL)) {</span>
<span class="nc" id="L270">      setAnchorVertical(newValue);</span>
    }
<span class="nc" id="L272">  }</span>

  @Override
  public int getPreferredWidth() {
<span class="nc" id="L276">    return ComponentConstants.MARKER_PREFERRED_WIDTH;</span>
  }

  @Override
  public int getPreferredHeight() {
<span class="nc" id="L281">    return ComponentConstants.MARKER_PREFERRED_HEIGHT;</span>
  }

  private boolean isMapInitialized() {
<span class="nc bnc" id="L285" title="All 4 branches missed.">    return map != null &amp;&amp; map.getLayout() != null;</span>
  }

  private void updateSizeIfNeeded() {
<span class="nc bnc" id="L289" title="All 2 branches missed.">    if (needsSizeUpdate) {</span>
<span class="nc" id="L290">      setWidthProperty(getPropertyValue(PROPERTY_NAME_WIDTH));</span>
<span class="nc" id="L291">      setHeightProperty(getPropertyValue(PROPERTY_NAME_HEIGHT));</span>
<span class="nc" id="L292">      needsSizeUpdate = false;</span>
    }
<span class="nc" id="L294">  }</span>

  // JSNI methods
  native void initIcon()/*-{
    var width = this.@com.google.appinventor.client.editor.simple.components.MockMarker::width,
      height = this.@com.google.appinventor.client.editor.simple.components.MockMarker::height,
      anchorU = this.@com.google.appinventor.client.editor.simple.components.MockMarker::anchorU,
      anchorV = this.@com.google.appinventor.client.editor.simple.components.MockMarker::anchorV,
      content = this.@com.google.appinventor.client.editor.simple.components.MockMarker::svgContent,
      opts = {
        icon: null,
        title: this.@com.google.appinventor.client.editor.simple.components.MockComponent::getName()(),
        className: &quot;vector-marker ode-SimpleMockMapFeature leaflet-clickable&quot;,
        markerColor: this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBaseWithFill::fillColor,
        markerStroke: this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::strokeColor,
        iconSize: [width, height],
        iconAnchor: [width * anchorU, height * anchorV]
      };
    if (!content) {
      opts.map_pin = 'M25 0c-8.284 0-15 6.656-15 14.866 0 8.211 15 35.135 15 35.135s15-26.924 15-35.135c0-8.21-6.716-14.866-15-14.866zm-.049 19.312c-2.557 0-4.629-2.055-4.629-4.588 0-2.535 2.072-4.589 4.629-4.589 2.559 0 4.631 2.054 4.631 4.589 0 2.533-2.072 4.588-4.631 4.588z';
      opts.viewBox = [9, 0, 31, 50];
      opts.iconSize = [30, 50];
      opts.iconAnchor = [14, 49];
    } else {
      opts.svg = content;
    }
    this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon =
      $wnd.top.L.VectorMarkers.icon(opts);
  }-*/;

  native void initMarker(double latitude, double longitude)/*-{
    var icon = this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon;
    this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature =
      $wnd.top.L.marker([latitude, longitude], {
        icon: icon,
        draggable: true,
        keyboard: false,
        alt: 'Marker'
      }).on('add', function() {
        if (this._icon) {
          var svg = this._icon.querySelector('svg');
          if (svg &amp;&amp; !svg.getAttribute('preserveAspectRatio')) {
            svg.setAttribute('preserveAspectRatio', 'none');
          }
        }
      });
  }-*/;

  @Override
  protected native void setEditing(boolean editing)/*-{
    // Markers cannot be edited
  }-*/;

  protected native void setNativeTooltip(String tooltip)/*-{
    var icon = this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon;
    if (icon) {
      icon.options.title = tooltip;
      var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
      if (marker &amp;&amp; marker._icon) {
        marker._icon.style['title'] = tooltip;
      }
    }
  }-*/;

  protected native void setFillColor(String color)/*-{
    var icon = this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon;
    if (icon) {
      icon.options.markerColor = color;
      var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
      if (marker &amp;&amp; marker._icon) {
        marker._icon.style['fill'] = color;
      }
    }
  }-*/;

  protected native void setStrokeColor(String color)/*-{
    var icon = this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon;
    if (icon) {
      icon.options.markerStroke = color;
      var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
      if (marker &amp;&amp; marker._icon) {
        marker._icon.style['stroke'] = color;
      }
    }
  }-*/;

  protected native void setStrokeWidth(int weight)/*-{
    var icon = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (icon) {
      icon.options.markerWeight = weight;
      var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
      if (marker &amp;&amp; marker._icon) {
        var svg = marker._icon.querySelector('svg');
        if (svg) {  // Attempt to scale the SVG stroke-width based on the Width/Height properties.
          try {
            var origWidth = this.@com.google.appinventor.client.editor.simple.components.MockMarker::srcWidth,
              origHeight = this.@com.google.appinventor.client.editor.simple.components.MockMarker::srcHeight,
              newWidth = this.@com.google.appinventor.client.editor.simple.components.MockMarker::width,
              newHeight = this.@com.google.appinventor.client.editor.simple.components.MockMarker::height,
              scale = 1;
            if (newWidth &gt; 0) {
              scale = Math.min(scale, newWidth / origWidth);
            }
            if (newHeight &gt; 0) {
              scale = Math.min(scale, newHeight / origHeight);
            }
            weight = weight / scale;
          } catch(e) {
            // Nothing to do here.
          }
        }
        marker._icon.style['stroke-width'] = weight + 'px';
      }
    }
  }-*/;

  native void setLatLng(double latitude, double longitude)/*-{
    var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (marker) {
      marker.setLatLng([latitude, longitude]);
    }
  }-*/;

  protected native void addToMap(JavaScriptObject map)/*-{
    var self = this;
    var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    map.addLayer(marker);
    if (!marker.clickHandler) {
      marker.clickHandler = function(e) {
        self.@com.google.appinventor.client.editor.simple.components.MockMarker::select(*)(e);
        if (e.originalEvent) e.originalEvent.stopPropagation();
      };
      marker.dragHandler = function(e) {
        var pt = marker.getLatLng();
        self.@com.google.appinventor.client.editor.simple.components.MockMarker::setAnchor(DD)(pt.lat, pt.lng);
      };
      marker.on('click dragstart', marker.clickHandler);
      marker.on('dragend', marker.dragHandler);
    }
    var isVisible = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::getVisibleProperty()();
    if (!isVisible) {
      map.removeLayer(marker);
    }
  }-*/;

  native double getLatitude()/*-{
    var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (marker) {
      return marker.getLatLng().lat;
    } else {
      return undefined;
    }
  }-*/;

  native double getLongitude()/*-{
    var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (marker) {
      return marker.getLatLng().lng;
    } else {
      return undefined;
    }
  }-*/;

  protected native void setNativeVisible(JavaScriptObject map, boolean visible)/*-{
    var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (visible) {
      map.addLayer(marker);
      // Fix for #1137: Icon size info seems to be reset when we remove a marker from the map. This
      // code will force recreating the marker from the icon, which should grab the 'real' iconSize info.
      var icon = this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon;
      if (icon) {
        marker.setIcon(icon);
      }
    } else {
      map.removeLayer(marker);
    }
  }-*/;

  native void setMarkerAsset(String content)/*-{
    var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (!content) {
      this.@com.google.appinventor.client.editor.simple.components.MockMarker::initIcon()();
      var icon = this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon;
      if (marker &amp;&amp; icon) {
        marker.setIcon(icon);
      }
    } else {
      var selected = this.@com.google.appinventor.client.editor.simple.components.MockComponent::isSelected()();
      var newW = this.@com.google.appinventor.client.editor.simple.components.MockMarker::width;
      if (newW === -1) {
        newW = this.@com.google.appinventor.client.editor.simple.components.MockMarker::srcWidth;
      }
      var newH = this.@com.google.appinventor.client.editor.simple.components.MockMarker::height;
      if (newH === -1) {
        newH = this.@com.google.appinventor.client.editor.simple.components.MockMarker::srcHeight;
      }
      var anchorU = this.@com.google.appinventor.client.editor.simple.components.MockMarker::anchorU;
      var anchorV = this.@com.google.appinventor.client.editor.simple.components.MockMarker::anchorV;
      var strokeWidth = selected ? 2 : this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::strokeWidth;
      var iconSize = [newW + 2 * strokeWidth, newH + 2 * strokeWidth];
      var newIcon = $wnd.top.L.VectorMarkers.icon({
        icon: null,
        svg: content,
        title: this.@com.google.appinventor.client.editor.simple.components.MockComponent::getName()(),
        className: selected ? &quot;vector-marker ode-SimpleMockMapFeature-selected&quot; : &quot;vector-marker ode-SimpleMockMapFeature&quot;,
        markerColor: this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBaseWithFill::fillColor,
        markerStroke: this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::strokeColor,
        iconSize: iconSize,
        iconAnchor: [iconSize[0] * anchorU, iconSize[1] * anchorV],
        shadowSize: [iconSize[0] + 24, iconSize[1] + 1],
        shadowAnchor: [iconSize[0] * 0.5, iconSize[1]]
      });
      this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon = newIcon;
      if (marker) {
        marker.setIcon(newIcon);
        if (marker._icon) {
          var svg = marker._icon.querySelector('svg');
          var srcW = parseInt(svg.getAttribute('width'));
          var srcH = parseInt(svg.getAttribute('height'));
          // Makes the SVG icon scale like an img icon
          if (!svg.getAttribute('preserveAspectRatio')) {
            svg.setAttribute('preserveAspectRatio', 'none');
          }
          this.@com.google.appinventor.client.editor.simple.components.MockMarker::srcWidth = srcW;
          this.@com.google.appinventor.client.editor.simple.components.MockMarker::srcHeight = srcH;
          var resize = false;
          if (this.@com.google.appinventor.client.editor.simple.components.MockMarker::width === -1) {
            newW = srcW;
            resize = true;
          }
          if (this.@com.google.appinventor.client.editor.simple.components.MockMarker::height === -1) {
            newH = srcH;
            resize = true;
          }
          if (resize) {
            iconSize = [newW + 2 * strokeWidth, newH + 2 * strokeWidth];
            newIcon.options.iconSize = iconSize;
            newIcon.options.iconAnchor = [iconSize[0] * anchorU, iconSize[1] * anchorV];
            marker.setIcon(newIcon);
          }
          var scale = Math.min(newW / srcW, newH / srcH);
          marker._icon.style['stroke-width'] = (strokeWidth / scale) + 'px';
        }
      }
    }
  }-*/;

  native void setMarkerAssetUrl(String url)/*-{
    try {
      this.@com.google.appinventor.client.editor.simple.components.MockMarker::imageAsset = url;
      var L = $wnd.top.L;
      var self = this;
      var newIcon = new L.ImageIcon({
        iconUrl: url,
        className: 'ode-SimpleMockMapFeature',
        title: this.@com.google.appinventor.client.editor.simple.components.MockComponent::getName()(),
        iconSize: [0, 0],  // Will be filled in during onLoad
        iconAnchor: [0, 0],  // Will be filled in during onLoad
        onLoad: function(w, h) {
          // adjust w, h for selection border
          self.@com.google.appinventor.client.editor.simple.components.MockMarker::srcWidth = w;
          self.@com.google.appinventor.client.editor.simple.components.MockMarker::srcHeight = h;
          var newW = self.@com.google.appinventor.client.editor.simple.components.MockMarker::width;
          if (newW === -1) {
            newW = self.@com.google.appinventor.client.editor.simple.components.MockMarker::srcWidth;
          }
          var newH = self.@com.google.appinventor.client.editor.simple.components.MockMarker::height;
          if (newH === -1) {
            newH = self.@com.google.appinventor.client.editor.simple.components.MockMarker::srcHeight;
          }
          var anchorU = self.@com.google.appinventor.client.editor.simple.components.MockMarker::anchorU;
          var anchorV = self.@com.google.appinventor.client.editor.simple.components.MockMarker::anchorV;
          var strokeWidth = self.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::strokeWidth;
          newIcon.options.iconSize = [newW + 2 * strokeWidth, newH + 2 * strokeWidth];
          newIcon.options.iconAnchor = [newIcon.options.iconSize[0] * anchorU, newIcon.options.iconSize[1] * anchorV];
          newIcon.options.shadowAnchor = [0.5 * newIcon.options.iconSize[0], newIcon.options.iconSize[1]];
          var marker = self.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
          if (marker) {
            marker.setIcon(newIcon);
          }
        }
      });
      this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon = newIcon;
      var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
      if (marker) {
        marker.setIcon(newIcon);
      }
    } catch(e) {
      console.log(e);
    }
  }-*/;

  protected native void setSelected(boolean selected)/*-{
    var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    marker.options.icon.options.className = selected?&quot;vector-marker ode-SimpleMockMapFeature-selected leaflet-clickable&quot; : &quot;vector-marker ode-SimpleMockMapFeature leaflet-clickable&quot;;
    marker.setIcon(marker.options.icon);
    if (marker._icon) {
      var svg = marker._icon.querySelector('svg');
      if (svg &amp;&amp; !svg.getAttribute('preserveAspectRatio')) {
        svg.setAttribute('preserveAspectRatio', 'none');
      }
    }
  }-*/;

  native void setMarkerWidth(int width)/*-{
    var icon = this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon;
    if (icon) {
      if (width === -1) {
        width = this.@com.google.appinventor.client.editor.simple.components.MockMarker::getIconPreferredSize()()[0];
      }
      icon.options.iconSize[0] = width;
      icon.options.iconAnchor[0] = this.@com.google.appinventor.client.editor.simple.components.MockMarker::anchorU * width;
      var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
      if (marker) {
        marker.setIcon(icon);
      }
    }
  }-*/;

  native void setMarkerHeight(int height)/*-{
    var icon = this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon;
    if (icon) {
      if (height === -1) {
        height = this.@com.google.appinventor.client.editor.simple.components.MockMarker::getIconPreferredSize()()[1];
      }
      icon.options.iconSize[1] = height;
      icon.options.iconAnchor[1] = this.@com.google.appinventor.client.editor.simple.components.MockMarker::anchorV * height;
      var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
      if (marker) {
        marker.setIcon(icon);
      }
    }
  }-*/;

  native void setMarkerAnchorHorizontal(int align)/*-{
    var icon = this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon;
    if (icon) {
      var adjust = 1.0;
      switch(align) {
      case 1:
        adjust = 0.0;
        break;
      case 2:
        adjust = 1.0;
        break;
      case 3:
        adjust = 0.5;
        break;
      }
      this.@com.google.appinventor.client.editor.simple.components.MockMarker::anchorU = adjust;
      icon.options.iconAnchor[0] = adjust * icon.options.iconSize[0];
      icon.options.shadowAnchor[0] = (adjust * icon.options.iconSize[0]) + 18;
      var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
      if (marker) {
        marker.setIcon(icon);
      }
    }
  }-*/;

  native void setMarkerAnchorVertical(int align)/*-{
    var icon = this.@com.google.appinventor.client.editor.simple.components.MockMarker::nativeIcon;
    if (icon) {
      var adjust = 0.5;
      switch(align) {
      case 1:
        adjust = 0.0;
        break;
      case 2:
        adjust = 0.5;
        break;
      case 3:
        adjust = 1.0;
        break;
      }
      this.@com.google.appinventor.client.editor.simple.components.MockMarker::anchorV = adjust;
      icon.options.iconAnchor[1] = adjust * icon.options.iconSize[1];
      icon.options.shadowAnchor[1] = (adjust * icon.options.iconSize[1]) - 5;
      var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
      if (marker) {
        marker.setIcon(icon);
      }
    }
  }-*/;

  native JavaScriptObject getIconPreferredSize()/*-{
    var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (marker) {
      var img = marker._icon &amp;&amp; marker._icon.querySelector('svg');
      if (img) {
        return [parseInt(img.getAttribute('width')), parseInt(img.getAttribute('height'))];
      }
      img = marker._icon &amp;&amp; marker._icon.querySelector('img');
      if (img) {
        return [img.naturalWidth, img.naturalHeight];
      }
    }
    return [-1, -1];  // this is only called for when the width/height is -1, so this is idempotent.
  }-*/;

  private native void preserveLayerData()/*-{
    var marker = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (marker) {
      var pt = marker.getLatLng();
      this.@com.google.appinventor.client.editor.simple.components.MockMarker::setAnchor(DD)(pt.lat, pt.lng);
    }
  }-*/;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>