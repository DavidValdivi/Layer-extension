<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MockChartData.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.editor.simple.components</a> &gt; <span class="el_source">MockChartData.java</span></div><h1>MockChartData.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2019-2022 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.editor.simple.components;

import com.google.appinventor.client.editor.simple.SimpleEditor;
import com.google.appinventor.client.editor.youngandroid.properties.YoungAndroidDataColumnSelectorProperty;
import com.google.appinventor.client.widgets.properties.EditableProperty;
import com.google.appinventor.components.common.LineType;
import com.google.appinventor.components.common.PointStyle;
import com.google.gwt.resources.client.ImageResource;
import com.google.gwt.user.client.ui.Image;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

/**
 * Base class for MockChartData components, providing base functionality
 * for property setters, adding the component to a Mock Chart
 * as a child, and showing/hiding properties.
 *
 * &lt;p&gt;The component acts as an invisible visible component, and was not chosen
 * to be a NonVisibleComponent so that it would appear in the Chart hierarchy
 * instead of the non-visible component bar.
 */
public abstract class MockChartData extends MockVisibleComponent implements DataFileChangeListener {
  private static final String PROPERTY_COLOR = &quot;Color&quot;;
  private static final String PROPERTY_LABEL = &quot;Label&quot;;
  private static final String PROPERTY_POINT_SHAPE = &quot;PointShape&quot;;
  private static final String PROPERTY_LINE_TYPE = &quot;LineType&quot;;
  private static final String PROPERTY_PAIRS = &quot;ElementsFromPairs&quot;;
  private static final String PROPERTY_CHART_SOURCE = &quot;Source&quot;;
  private static final String PROPERTY_CHART_SOURCE_VALUE = &quot;DataSourceKey&quot;;
  private static final String PROPERTY_DATA_FILE_X_COLUMN = &quot;DataFileXColumn&quot;;
  private static final String PROPERTY_DATA_FILE_Y_COLUMN = &quot;DataFileYColumn&quot;;
  private static final String PROPERTY_SPREADSHEET_HEADERS = &quot;SpreadsheetUseHeaders&quot;;
  private static final String PROPERTY_SPREADSHEET_X_COLUMN = &quot;SpreadsheetXColumn&quot;;
  private static final String PROPERTY_SPREADSHEET_Y_COLUMN = &quot;SpreadsheetYColumn&quot;;
  private static final String PROPERTY_WEB_X_COLUMN = &quot;WebXColumn&quot;;
  private static final String PROPERTY_WEB_Y_COLUMN = &quot;WebYColumn&quot;;

  /**
   * The HashMap contains properties that should be hidden by default.
   * Height and Width properties should be hidden since they do not matter
   * for the Chart Data component.
   * Chart Source related properties should be hidden by default,
   * as they are only shown upon certain conditions (e.g. DataFileColumn
   * properties are only shown when the Source component is a DataFile)
   * The Point Shape property should be hidden by default since only a
   * subset of Chart Data types support point shape settings.
   */
  private static final Set&lt;String&gt; hiddenProperties;

  static {
<span class="nc" id="L58">    Set&lt;String&gt; propertyNames = new HashSet&lt;String&gt;() {{</span>
<span class="nc" id="L59">        add(PROPERTY_NAME_HEIGHT);</span>
<span class="nc" id="L60">        add(PROPERTY_NAME_WIDTH);</span>
<span class="nc" id="L61">        add(PROPERTY_DATA_FILE_X_COLUMN);</span>
<span class="nc" id="L62">        add(PROPERTY_DATA_FILE_Y_COLUMN);</span>
<span class="nc" id="L63">        add(PROPERTY_CHART_SOURCE_VALUE);</span>
<span class="nc" id="L64">        add(PROPERTY_SPREADSHEET_HEADERS);</span>
<span class="nc" id="L65">        add(PROPERTY_SPREADSHEET_X_COLUMN);</span>
<span class="nc" id="L66">        add(PROPERTY_SPREADSHEET_Y_COLUMN);</span>
<span class="nc" id="L67">        add(PROPERTY_WEB_X_COLUMN);</span>
<span class="nc" id="L68">        add(PROPERTY_WEB_Y_COLUMN);</span>
<span class="nc" id="L69">        add(PROPERTY_POINT_SHAPE);</span>
<span class="nc" id="L70">      }};</span>

    // Set Hidden Properties map to an immutable set so that
    // the contents could not be modified.
<span class="nc" id="L74">    hiddenProperties = Collections.unmodifiableSet(propertyNames);</span>
<span class="nc" id="L75">  }</span>

  // Represents the Chart data icon
  private final Image iconWidget;

  protected MockChart chart;
  protected MockChartDataModel&lt;?, ?&gt; chartDataModel;
  protected MockComponent dataSource;

  // Stores the DataFileColumn properties (in order) to import from
  protected List&lt;String&gt; dataFileColumns;

<span class="nc" id="L87">  private String currentElements = &quot;&quot;;</span>

  /**
   * Creates a new instance of a Mock Chart Data component.
   *
   * @param editor editor of source file the component belongs to
   * @param type   type string of the component
   * @param icon   icon of the component
   */
  MockChartData(SimpleEditor editor, String type, ImageResource icon) {
<span class="nc" id="L97">    super(editor, type, icon);</span>

<span class="nc" id="L99">    iconWidget = new Image(icon);</span>
<span class="nc" id="L100">    iconWidget.setHeight(&quot;100&quot;);</span>
<span class="nc" id="L101">    iconWidget.setWidth(&quot;60&quot;);</span>

<span class="nc" id="L103">    initComponent(iconWidget);</span>
<span class="nc" id="L104">  }</span>

  /**
   * Adds the Mock Chart Data component to the specified Mock Chart component.
   *
   * @param chart Chart Mock component to add the data to
   */
  public void addToChart(MockChart chart) {
    // Hide widget (MockChartData component handled by Chart)
<span class="nc" id="L113">    iconWidget.setVisible(false);</span>
<span class="nc" id="L114">    iconWidget.setHeight(&quot;0&quot;);</span>
<span class="nc" id="L115">    iconWidget.setWidth(&quot;0&quot;);</span>

    // Set references for Chart view and Chart model
<span class="nc" id="L118">    this.chart = chart;</span>
<span class="nc" id="L119">    this.chartDataModel = chart.createDataModel();</span>

    // Set the properties to the Data Series
<span class="nc" id="L122">    setDataSeriesProperties();</span>

    // Change the visibilities of the styling properties
    // according to Chart type
<span class="nc" id="L126">    changeStylingPropertiesVisibility();</span>

    // Refresh the Chart view
<span class="nc" id="L129">    refreshChart();</span>
<span class="nc" id="L130">  }</span>

  @Override
  protected boolean isPropertyVisible(String propertyName) {
    // If the set of properties to hide contains the specified
    // property, then hide the property.
<span class="nc bnc" id="L136" title="All 2 branches missed.">    if (hiddenProperties.contains(propertyName)) {</span>
<span class="nc" id="L137">      return false;</span>
    }

<span class="nc" id="L140">    return super.isPropertyVisible(propertyName);</span>
  }

  @Override
  protected void onSelectedChange(boolean selected) {
<span class="nc" id="L145">    super.onSelectedChange(selected);</span>
<span class="nc" id="L146">    removeStyleDependentName(&quot;selected&quot;); // Force remove styling</span>
<span class="nc" id="L147">  }</span>

  @Override
  public void onRemoved() {
<span class="nc" id="L151">    super.onRemoved();</span>
<span class="nc" id="L152">    setSourceProperty(&quot;&quot;); // Unset the Source property to remove listener references</span>
<span class="nc" id="L153">    chartDataModel.removeDataSeriesFromChart(); // Remove the Data Series from the Chart</span>
<span class="nc" id="L154">    refreshChart();</span>
<span class="nc" id="L155">  }</span>

  /**
   * Sets the current elements of the Chart Data component.
   *
   * @param text new elements text
   */
  private void setElementsFromPairsProperty(String text) {
<span class="nc" id="L163">    currentElements = text;</span>

<span class="nc" id="L165">    chartDataModel.setElements(currentElements);</span>
<span class="nc" id="L166">  }</span>

  /**
   * Sets the Source property of the Chart Data component.
   * Responsible for showing/hiding properties according to the
   * attached Source component type.
   *
   * @param source Name of the new Source component attached
   */
  private void setSourceProperty(String source) {
    // If a Data Source was previously assigned and is of type DataFile,
    // de-attach this Data component from it
<span class="nc bnc" id="L178" title="All 2 branches missed.">    if (dataSource instanceof MockDataFile) {</span>
<span class="nc" id="L179">      ((MockDataFile) dataSource).removeDataFileChangeListener(this);</span>
    }

    // Get the newly attached Source component
<span class="nc" id="L183">    dataSource = editor.getComponents().getOrDefault(source, null);</span>

<span class="nc" id="L185">    changeSourcePropertiesVisibility();</span>

    // If the Data Source is now null, set back the
    // currentElements property.
<span class="nc bnc" id="L189" title="All 2 branches missed.">    if (dataSource == null) {</span>
<span class="nc" id="L190">      onPropertyChange(PROPERTY_PAIRS, currentElements);</span>
    }

    // If the component is currently selected, re-select it to refresh
    // the Properties panel.
<span class="nc bnc" id="L195" title="All 2 branches missed.">    if (isSelected()) {</span>
<span class="nc" id="L196">      onSelectedChange(true);</span>
    }
<span class="nc" id="L198">  }</span>

  /**
   * Sets the Data File X Column property of the Chart Data component.
   * After setting the property, the data is then re-imported
   * (if possible)
   *
   * @param column new column name
   */
  private void setDataFileXColumnProperty(String column) {
    // The X column is the first element of the dataFileColumns list
<span class="nc" id="L209">    dataFileColumns.set(0, column);</span>
<span class="nc" id="L210">    updateDataFileData();</span>
<span class="nc" id="L211">  }</span>

  /**
   * Sets the Point Shape property to the Chart Data component,
   * provided that the Data Model is a ScatterChartDataModel.
   * If that is indeed the case, the point shape of the Scatter
   * Chart Data Model is then changed.
   *
   * @param newValue New value of the Point Shape (String)
   */
  private void setPointShapeProperty(String newValue) {
<span class="nc" id="L222">    PointStyle pointShape = PointStyle.fromUnderlyingValue(Integer.parseInt(newValue));</span>

    // Only change the point shape of the Model if it is of
    // type ScatterChartDataModel (since only that model supports
    // the changing of the Point Shape)
<span class="nc bnc" id="L227" title="All 2 branches missed.">    if (chartDataModel instanceof MockPointChartDataModel) {</span>
<span class="nc" id="L228">      ((MockPointChartDataModel&lt;?&gt;) chartDataModel).changePointShape(pointShape);</span>
    }
<span class="nc" id="L230">  }</span>

  /**
   * Sets the Line Type property to the Chart Data component,
   * provided that the Data Model is a LineChartBaseDataModel.
   * If that is indeed the case, the line type of the Line
   * Chart Data Model is then changed.
   *
   * @param newValue New value of the Line Type (String)
   */
  private void setLineTypeProperty(String newValue) {
<span class="nc" id="L241">    LineType lineType = LineType.fromUnderlyingValue(Integer.parseInt(newValue));</span>

    // Only change the line type of the Model if it is of
    // type lineChartBaseDataModel (since only that model
    // supports the changing of the Line Type)
<span class="nc bnc" id="L246" title="All 2 branches missed.">    if (chartDataModel instanceof MockLineChartBaseDataModel) {</span>
<span class="nc" id="L247">      ((MockLineChartBaseDataModel&lt;?&gt;) chartDataModel).setLineType(lineType);</span>
    }
<span class="nc" id="L249">  }</span>

  /**
   * Sets the DataFile Y Column property of the Chart Data component.
   * After setting the property, the data is then re-imported
   * (if possible)
   *
   * @param column new column name
   */
  private void setDataFileYColumnProperty(String column) {
    // The Y column is the second element of the dataFileColumns list
<span class="nc" id="L260">    dataFileColumns.set(1, column);</span>
<span class="nc" id="L261">    updateDataFileData();</span>
<span class="nc" id="L262">  }</span>

  /**
   * Imports data into the Chart from the attached DataFile source
   * based on the current DataFile column properties.
   */
  protected void updateDataFileData() {
    // DataSource is not of instance MockDataFile. Ignore event call
<span class="nc bnc" id="L270" title="All 2 branches missed.">    if (!(dataSource instanceof MockDataFile)) {</span>
<span class="nc" id="L271">      return;</span>
    }

    // Get the columns from the MockDataFile using the local DataFile Column properties (safe cast)
<span class="nc" id="L275">    List&lt;List&lt;String&gt;&gt; columns = ((MockDataFile) (dataSource)).getColumns(dataFileColumns);</span>

    // Import the data to the Data Series
<span class="nc" id="L278">    chartDataModel.setElementsFromColumns(columns);</span>
<span class="nc" id="L279">    refreshChart();</span>
<span class="nc" id="L280">  }</span>

  /**
   * Changes the visibilities of Chart Data Source related properties according
   * to the current attached Data Source.
   */
  private void changeSourcePropertiesVisibility() {
    // Hide Elements from Pairs property if a Data Source has been set
<span class="nc bnc" id="L288" title="All 2 branches missed.">    showProperty(PROPERTY_PAIRS, (dataSource == null));</span>

    // Hide or show the Web column properties depending on condition
<span class="nc bnc" id="L291" title="All 4 branches missed.">    boolean showWebColumns = (dataSource != null &amp;&amp; dataSource.getType().equals(&quot;Web&quot;));</span>
<span class="nc" id="L292">    showProperty(PROPERTY_WEB_X_COLUMN, showWebColumns);</span>
<span class="nc" id="L293">    showProperty(PROPERTY_WEB_Y_COLUMN, showWebColumns);</span>

<span class="nc bnc" id="L295" title="All 4 branches missed.">    boolean showSheetsColumns = (dataSource != null &amp;&amp; dataSource.getType().equals(&quot;Spreadsheet&quot;));</span>
<span class="nc" id="L296">    showProperty(PROPERTY_SPREADSHEET_HEADERS, showSheetsColumns);</span>
<span class="nc" id="L297">    showProperty(PROPERTY_SPREADSHEET_X_COLUMN, showSheetsColumns);</span>
<span class="nc" id="L298">    showProperty(PROPERTY_SPREADSHEET_Y_COLUMN, showSheetsColumns);</span>

    // Handle DataFile-related property responses
<span class="nc" id="L301">    handleDataFilePropertySetting();</span>

    // Show Data Source Value only if the Data Source is non-null
    // and not of type MockDataFile or Web
<span class="nc bnc" id="L305" title="All 8 branches missed.">    boolean showDataSourceValue = (dataSource != null</span>
        &amp;&amp; !(dataSource instanceof MockDataFile || showWebColumns || showSheetsColumns));

<span class="nc" id="L308">    showProperty(PROPERTY_CHART_SOURCE_VALUE, showDataSourceValue);</span>
<span class="nc" id="L309">  }</span>

  /**
   * Change the visibility of styling related properties which
   * only apply to limited Data Models, rather than all of them.
   *
   * &lt;p&gt;This method should be invoked upon changing the type of the
   * Data Model.
   */
  private void changeStylingPropertiesVisibility() {
    // Handle Scatter Chart related property hiding
<span class="nc" id="L320">    boolean showScatterChartProperties =</span>
        chartDataModel instanceof MockScatterChartDataModel;

<span class="nc" id="L323">    showProperty(PROPERTY_POINT_SHAPE, showScatterChartProperties);</span>

    // Handle Line Chart Base related property hiding
<span class="nc" id="L326">    boolean showLineBaseChartProperties =</span>
        chartDataModel instanceof MockLineChartBaseDataModel;

<span class="nc" id="L329">    showProperty(PROPERTY_LINE_TYPE, showLineBaseChartProperties);</span>

    // Handle Pie Chart related property hiding
<span class="nc" id="L332">    boolean showPieChartProperties =</span>
        chartDataModel instanceof MockPieChartDataModel;

    // The Label property has no effect on Pie Chart Data Series;
    // Hide the property instead.
<span class="nc bnc" id="L337" title="All 2 branches missed.">    showProperty(PROPERTY_LABEL, !showPieChartProperties);</span>
<span class="nc" id="L338">  }</span>

  /**
   * Handles properties with regards to a DataFile source upon
   * changing the Data Source of the Data component.
   *
   * &lt;p&gt;The method shows/hides the DataFile X and Y Column properties
   * depending on the attached Source (if it's a DataFile, then
   * the properties will be shown, and hidden otherwise)
   * If the properties are shown, the Column selectors
   * are updated to track the new data source, and the
   * data in the Data Series is updated.
   */
  private void handleDataFilePropertySetting() {
    // Show the DataFileColumns property only if the attached Source component is of type DataFile
<span class="nc" id="L353">    boolean showDataFileColumns = (dataSource instanceof MockDataFile);</span>

    // Hide or show the DataFileColumns property depending on condition
<span class="nc" id="L356">    showProperty(PROPERTY_DATA_FILE_X_COLUMN, showDataFileColumns);</span>
<span class="nc" id="L357">    showProperty(PROPERTY_DATA_FILE_Y_COLUMN, showDataFileColumns);</span>

    // Get the Column property selectors
<span class="nc" id="L360">    YoungAndroidDataColumnSelectorProperty xeditor =</span>
        (YoungAndroidDataColumnSelectorProperty)
<span class="nc" id="L362">            properties.getProperty(PROPERTY_DATA_FILE_X_COLUMN).getEditor();</span>

<span class="nc" id="L364">    YoungAndroidDataColumnSelectorProperty yeditor =</span>
        (YoungAndroidDataColumnSelectorProperty)
<span class="nc" id="L366">            properties.getProperty(PROPERTY_DATA_FILE_Y_COLUMN).getEditor();</span>

<span class="nc bnc" id="L368" title="All 2 branches missed.">    if (showDataFileColumns) {</span>
      // Add the current Data component as a DataFileChangeListener to the DataFile
<span class="nc" id="L370">      ((MockDataFile) dataSource).addDataFileChangeListener(this);</span>

      // Update the data of the Data component to represent the DataFile
<span class="nc" id="L373">      onColumnsChange((MockDataFile) dataSource);</span>

      // Update the Source of the column selectors
<span class="nc" id="L376">      xeditor.changeSource((MockDataFile) dataSource);</span>
<span class="nc" id="L377">      yeditor.changeSource((MockDataFile) dataSource);</span>
    } else {
      // Remove data sources from the property editors (since Data Source
      // is not a DataFile)
<span class="nc" id="L381">      xeditor.changeSource(null);</span>
<span class="nc" id="L382">      yeditor.changeSource(null);</span>
    }
<span class="nc" id="L384">  }</span>

  @Override
  public void onPropertyChange(String propertyName, String newValue) {
<span class="nc" id="L388">    super.onPropertyChange(propertyName, newValue);</span>

    // No Chart Model exists (Data not yet added to Chart), simply
    // return from the method without processing property adding.
<span class="nc bnc" id="L392" title="All 2 branches missed.">    if (chartDataModel == null) {</span>
<span class="nc" id="L393">      return;</span>
    }

<span class="nc bnc" id="L396" title="All 2 branches missed.">    if (propertyName.equals(PROPERTY_COLOR)) {</span>
<span class="nc" id="L397">      chartDataModel.changeColor(newValue);</span>
<span class="nc" id="L398">      refreshChart();</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_LABEL)) {</span>
<span class="nc" id="L400">      chartDataModel.changeLabel(newValue);</span>
<span class="nc" id="L401">      refreshChart();</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_PAIRS)) {</span>
<span class="nc" id="L403">      setElementsFromPairsProperty(newValue);</span>
<span class="nc" id="L404">      refreshChart();</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_POINT_SHAPE)) {</span>
<span class="nc" id="L406">      setPointShapeProperty(newValue);</span>
<span class="nc" id="L407">      refreshChart();</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_LINE_TYPE)) {</span>
<span class="nc" id="L409">      setLineTypeProperty(newValue);</span>
<span class="nc" id="L410">      refreshChart();</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_CHART_SOURCE)) {</span>
<span class="nc" id="L412">      setSourceProperty(newValue);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_DATA_FILE_X_COLUMN)) {</span>
<span class="nc" id="L414">      setDataFileXColumnProperty(newValue);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_DATA_FILE_Y_COLUMN)) {</span>
<span class="nc" id="L416">      setDataFileYColumnProperty(newValue);</span>
    }
<span class="nc" id="L418">  }</span>

  /**
   * Refreshes the Chart view.
   */
  protected void refreshChart() {
<span class="nc" id="L424">    chart.refreshChart();</span>
<span class="nc" id="L425">  }</span>

  /**
   * Sets the properties for the Chart Data component.
   *
   * &lt;p&gt;The need for this method is the fact that the component's
   * properties can only be set after the Data component has been added to
   * the Chart.
   */
  protected void setDataSeriesProperties() {
    // Re-set all Chart Data properties to provide effect on
    // attached Chart component.
<span class="nc bnc" id="L437" title="All 2 branches missed.">    for (EditableProperty property : properties) {</span>
<span class="nc" id="L438">      onPropertyChange(property.getName(), property.getValue());</span>
<span class="nc" id="L439">    }</span>
<span class="nc" id="L440">  }</span>

  @Override
  public void onColumnsChange(MockDataFile dataFile) {
<span class="nc bnc" id="L444" title="All 2 branches missed.">    if (!dataSource.equals(dataFile)) {</span>
<span class="nc" id="L445">      return;</span>
    }

<span class="nc" id="L448">    updateDataFileData();</span>
<span class="nc" id="L449">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>