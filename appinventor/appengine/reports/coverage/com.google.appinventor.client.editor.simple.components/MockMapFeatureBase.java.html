<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MockMapFeatureBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.editor.simple.components</a> &gt; <span class="el_source">MockMapFeatureBase.java</span></div><h1>MockMapFeatureBase.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2017 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.editor.simple.components;

import com.google.appinventor.client.ComponentsTranslation;
import com.google.appinventor.client.editor.simple.SimpleEditor;
import com.google.gwt.core.client.JavaScriptObject;
import com.google.gwt.json.client.JSONObject;
import com.google.gwt.json.client.JSONValue;
import com.google.gwt.resources.client.ImageResource;
import com.google.gwt.user.client.Event;
import com.google.gwt.user.client.ui.SimplePanel;
import com.google.gwt.widgetideas.graphics.client.Color;

import java.util.Collection;
import java.util.HashSet;

@SuppressWarnings(&quot;WeakerAccess&quot;)
public abstract class MockMapFeatureBase extends MockVisibleComponent implements MockMapFeature {
  public static final String PROPERTY_NAME_DESCRIPTION = &quot;Description&quot;;
  public static final String PROPERTY_NAME_STROKEWIDTH = &quot;StrokeWidth&quot;;
  public static final String PROPERTY_NAME_STROKECOLOR = &quot;StrokeColor&quot;;
  public static final String PROPERTY_NAME_TITLE = &quot;Title&quot;;
  public static final String CSS_PROPERTY_STROKEWIDTH = &quot;stroke-width&quot;;
  public static final String CSS_PROPERTY_STROKE = &quot;stroke&quot;;
  public static final String DEFAULT_STROKE_WIDTH = &quot;1&quot;;
  public static final String DEFAULT_STROKE_COLOR = &quot;&amp;HFF000000&quot;;

  protected final SimplePanel panel;
<span class="nc" id="L33">  protected MockMap map = null;</span>
<span class="nc" id="L34">  protected JavaScriptObject feature = null;</span>
<span class="nc" id="L35">  protected String strokeColor = &quot;#000000&quot;;</span>
<span class="nc" id="L36">  protected int strokeWidth = 1;</span>

  MockMapFeatureBase(SimpleEditor editor, String type, ImageResource icon) {
<span class="nc" id="L39">    super(editor, type, icon);</span>
<span class="nc" id="L40">    panel = new SimplePanel();</span>
<span class="nc" id="L41">    panel.setStylePrimaryName(&quot;ode-SimpleMockComponent&quot;);</span>
<span class="nc" id="L42">    initComponent(panel);</span>
<span class="nc" id="L43">    this.unsinkEvents(Event.MOUSEEVENTS);</span>
<span class="nc" id="L44">  }</span>

  @Override
  public void addToMap(MockMap map) {
<span class="nc bnc" id="L48" title="All 2 branches missed.">    if (panel.getWidget() != null) {</span>
<span class="nc" id="L49">      panel.remove(panel.getWidget());</span>
    }
<span class="nc" id="L51">    panel.setVisible(false);</span>
<span class="nc" id="L52">    panel.setWidth(&quot;0&quot;);</span>
<span class="nc" id="L53">    panel.setHeight(&quot;0&quot;);</span>
<span class="nc" id="L54">    this.map = map;</span>
<span class="nc" id="L55">    addToMap(map.getMapInstance());</span>
<span class="nc" id="L56">  }</span>

  @Override
  public void onPropertyChange(String propertyName, String newValue) {
<span class="nc" id="L60">    super.onPropertyChange(propertyName, newValue);</span>

<span class="nc bnc" id="L62" title="All 2 branches missed.">    if (propertyName.equals(PROPERTY_NAME_STROKEWIDTH)) {</span>
<span class="nc" id="L63">      setStrokeWidthProperty(newValue);</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_STROKECOLOR)) {</span>
<span class="nc" id="L65">      setStrokeColorProperty(newValue);</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_VISIBLE)) {</span>
<span class="nc" id="L67">      setVisibleProperty(newValue);</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">    } else if (propertyName.equals(PROPERTY_NAME_NAME)) {</span>
<span class="nc" id="L69">      setNativeTooltip(newValue);</span>
    }
<span class="nc" id="L71">  }</span>

  @Override
  protected void onSelectedChange(boolean selected) {
<span class="nc" id="L75">    super.onSelectedChange(selected);</span>
<span class="nc" id="L76">    setSelected(selected);</span>
<span class="nc" id="L77">    boolean isVisible = getVisibleProperty();</span>
<span class="nc bnc" id="L78" title="All 4 branches missed.">    setEditing(isVisible &amp;&amp; selected);</span>
<span class="nc" id="L79">  }</span>
  
  boolean getVisibleProperty() {
<span class="nc" id="L82">    return Boolean.parseBoolean(getPropertyValue(PROPERTY_NAME_VISIBLE));</span>
  }

  @Override
  public void onRemoved() {
<span class="nc" id="L87">    super.onRemoved();</span>
<span class="nc" id="L88">    setNativeVisible(map.getMapInstance(), false);</span>
<span class="nc" id="L89">  }</span>

  String getTooltip() {
<span class="nc" id="L92">    return getPropertyValue(PROPERTY_NAME_NAME);</span>
  }

  protected void setVisibleProperty(String text) {
<span class="nc bnc" id="L96" title="All 2 branches missed.">    if (map == null) {</span>
      // cannot change marker visibility if there is no map
<span class="nc" id="L98">      return;</span>
    }
<span class="nc" id="L100">    boolean isVisible = Boolean.parseBoolean(text);</span>
<span class="nc" id="L101">    setNativeVisible(map.getMapInstance(), isVisible);</span>
<span class="nc" id="L102">  }</span>

  protected void setStrokeWidthProperty(String text) {
    try {
<span class="nc" id="L106">      int width = Integer.parseInt(text);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">      if (width &lt; 0) {</span>
<span class="nc" id="L108">        width = 0;</span>
<span class="nc" id="L109">        getProperties().changePropertyValue(PROPERTY_NAME_STROKEWIDTH, &quot;0&quot;);</span>
<span class="nc" id="L110">        super.onPropertyChange(PROPERTY_NAME_STROKEWIDTH, &quot;0&quot;);</span>
      }
<span class="nc" id="L112">      strokeWidth = width;</span>
<span class="nc" id="L113">    } catch(NumberFormatException e) {</span>
      // pass
<span class="nc" id="L115">      getProperties().changePropertyValue(PROPERTY_NAME_STROKEWIDTH, &quot;1&quot;);</span>
<span class="nc" id="L116">      super.onPropertyChange(PROPERTY_NAME_STROKEWIDTH, &quot;1&quot;);</span>
<span class="nc" id="L117">      strokeWidth = 1;</span>
<span class="nc" id="L118">    }</span>
<span class="nc" id="L119">    setStrokeWidth(strokeWidth);</span>
<span class="nc" id="L120">  }</span>

  protected void setStrokeColorProperty(String text) {
<span class="nc bnc" id="L123" title="All 2 branches missed.">    if (MockComponentsUtil.isDefaultColor(text)) {</span>
<span class="nc" id="L124">      text = &quot;&amp;HFF000000&quot;;</span>
    }
<span class="nc" id="L126">    Color color = MockComponentsUtil.getColor(text);</span>
<span class="nc" id="L127">    strokeColor = color.toString();</span>
<span class="nc" id="L128">    setStrokeColor(strokeColor);</span>
<span class="nc" id="L129">  }</span>

  protected static String ensureUniqueName(String name, Collection&lt;String&gt; names) {
<span class="nc" id="L132">    names = new HashSet&lt;String&gt;(names);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">    if (!names.contains(name)) {</span>
<span class="nc" id="L134">      return name;</span>
    }
<span class="nc" id="L136">    int i = name.length() - 1;</span>
<span class="nc bnc" id="L137" title="All 4 branches missed.">    while (name.charAt(i) &gt;= '0' &amp;&amp; name.charAt(i) &lt;= '9') i--;</span>
<span class="nc" id="L138">    String base = name.substring(0, i + 1);</span>
<span class="nc" id="L139">    int counter = 1;</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">    if (i &lt; name.length() - 1) {</span>
<span class="nc" id="L141">      counter = Integer.parseInt(name.substring(i + 1)) + 1;</span>
    }
<span class="nc bnc" id="L143" title="All 2 branches missed.">    while (names.contains(base + counter)) counter++;</span>
<span class="nc" id="L144">    return base + counter;</span>
  }

  protected static void processFeatureName(MockMapFeatureBase feature, MockFeatureCollection parent,
      String name) {
<span class="nc bnc" id="L149" title="All 2 branches missed.">    if (name == null) {</span>
<span class="nc" id="L150">      name = feature.getPropertyValue(PROPERTY_NAME_TITLE);</span>
    }
<span class="nc" id="L152">    name = name.replaceAll(&quot;[ \t]+&quot;, &quot;_&quot;);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">    if (name.equalsIgnoreCase(&quot;&quot;)) {</span>
<span class="nc" id="L154">      name = ComponentsTranslation.getComponentName(feature.getType()) + &quot;1&quot;;</span>
    }
<span class="nc" id="L156">    name = ensureUniqueName(name, parent.editor.getComponentNames());</span>
<span class="nc" id="L157">    parent.addVisibleComponent(feature, -1);</span>
<span class="nc" id="L158">    final String oldName = feature.getPropertyValue(PROPERTY_NAME_NAME);</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">    if (oldName == null || !oldName.equals(name)) {</span>
<span class="nc" id="L160">      feature.changeProperty(PROPERTY_NAME_NAME, name);</span>
<span class="nc" id="L161">      feature.onPropertyChange(PROPERTY_NAME_NAME, name);</span>
<span class="nc" id="L162">      feature.getForm().fireComponentRenamed(feature, oldName);</span>
    }
<span class="nc" id="L164">  }</span>

  /**
   * Process the information from the feature's GeoJSON properties field. Subclasses may override
   * this function to set default values, but _must_ call super.processFromGeoJSON() otherwise
   * properties defined in superclasses will not get set.
   *
   * @param parent the mock feature collection that will contain the feature
   * @param properties the properties object from the GeoJSON
   */
  protected void processFromGeoJSON(MockFeatureCollection parent, JSONObject properties) {
<span class="nc" id="L175">    setStrokeWidthProperty(DEFAULT_STROKE_COLOR);</span>
<span class="nc" id="L176">    setStrokeColorProperty(DEFAULT_STROKE_WIDTH);</span>
<span class="nc" id="L177">    String name = null;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">    for (String key : properties.keySet()) {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">      if (key.equalsIgnoreCase(PROPERTY_NAME_NAME)) {</span>
<span class="nc" id="L180">        name = properties.get(key).isString().stringValue();</span>
      } else {
<span class="nc" id="L182">        processPropertyFromGeoJSON(key, properties.get(key));</span>
      }
<span class="nc" id="L184">    }</span>
<span class="nc" id="L185">    processFeatureName(this, parent, name);</span>
    // Use the name as the title if the properties did not include one (issue #1425)
<span class="nc bnc" id="L187" title="All 2 branches missed.">    if (getPropertyValue(PROPERTY_NAME_TITLE).isEmpty()) {</span>
<span class="nc" id="L188">      changeProperty(PROPERTY_NAME_TITLE, getPropertyValue(PROPERTY_NAME_NAME));</span>
    }
<span class="nc" id="L190">  }</span>

  /**
   * Process a key-value pair from the feature's GeoJSON properties field. Subclasses may override
   * this function to process properties specific to their implementation, but _must_ call
   * super.processPropertyFromGeoJSON() otherwise properties defined in superclasses will not
   * get set.
   * @param key a JSON key from the GeoJSON properties
   * @param value the corresponding value for &lt;code&gt;key&lt;/code&gt; in the properties
   */
  protected void processPropertyFromGeoJSON(String key, JSONValue value) {
<span class="nc bnc" id="L201" title="All 2 branches missed.">    if (key.equalsIgnoreCase(PROPERTY_NAME_STROKEWIDTH) ||</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        key.equalsIgnoreCase(CSS_PROPERTY_STROKEWIDTH)) {</span>
<span class="nc" id="L203">      String v = value.isString().stringValue();</span>
<span class="nc" id="L204">      changeProperty(PROPERTY_NAME_STROKEWIDTH, v);</span>
<span class="nc" id="L205">      onPropertyChange(PROPERTY_NAME_STROKEWIDTH, v);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">    } else if (key.equalsIgnoreCase(PROPERTY_NAME_STROKECOLOR) ||</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">               key.equalsIgnoreCase(CSS_PROPERTY_STROKE)) {</span>
<span class="nc" id="L208">      String v = value.isString().stringValue();</span>
<span class="nc" id="L209">      changeProperty(PROPERTY_NAME_STROKECOLOR, v);</span>
<span class="nc" id="L210">      onPropertyChange(PROPERTY_NAME_STROKECOLOR, v);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">    } else if (key.equalsIgnoreCase(PROPERTY_NAME_VISIBLE)) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">      String v = value.toString().equalsIgnoreCase(&quot;false&quot;) ? &quot;False&quot; : &quot;True&quot;;</span>
<span class="nc" id="L213">      changeProperty(PROPERTY_NAME_VISIBLE, v);</span>
<span class="nc" id="L214">      onPropertyChange(PROPERTY_NAME_VISIBLE, v);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">    } else if (key.equalsIgnoreCase(PROPERTY_NAME_TITLE)) {</span>
<span class="nc" id="L216">      String v = value.isString().stringValue();</span>
<span class="nc" id="L217">      changeProperty(PROPERTY_NAME_TITLE, v);</span>
<span class="nc" id="L218">      onPropertyChange(PROPERTY_NAME_TITLE, v);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">    } else if (key.equalsIgnoreCase(PROPERTY_NAME_DESCRIPTION)) {</span>
<span class="nc" id="L220">      String v = value.isString().stringValue();</span>
<span class="nc" id="L221">      changeProperty(PROPERTY_NAME_DESCRIPTION, v);</span>
<span class="nc" id="L222">      onPropertyChange(PROPERTY_NAME_DESCRIPTION, v);</span>
    }
<span class="nc" id="L224">  }</span>

  // JSNI Methods
  public static native double distanceBetweenPoints(JavaScriptObject map, MockMap.LatLng point1, MockMap.LatLng point2)/*-{
    var pt1 = [point1.@com.google.appinventor.client.editor.simple.components.MockMap.LatLng::latitude,
          point1.@com.google.appinventor.client.editor.simple.components.MockMap.LatLng::longitude],
        pt2 = [point2.@com.google.appinventor.client.editor.simple.components.MockMap.LatLng::latitude,
          point2.@com.google.appinventor.client.editor.simple.components.MockMap.LatLng::longitude];
    return map.distance(pt1, pt2);
  }-*/;

  protected native void setEditing(boolean editing)/*-{
    var feature = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (feature) {
      if (editing) {
        feature.bringToFront();
        if (feature.editor) {
          feature.editor.enable();
        } else {
          feature.enableEdit();
        }
      } else if (feature.editor) {
        feature.editor.disable();
      }
    }
  }-*/;

  protected native void setNativeVisible(JavaScriptObject map, boolean visible)/*-{
    var feature = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (feature) {
      if (visible) {
        map.addLayer(feature);
        feature.getElement().style['pointer-events'] = 'auto';
        feature.getElement().style['cursor'] = 'pointer';
      } else {
        map.removeLayer(feature);
      }
    }
  }-*/;

  protected native void setSelected(boolean selected)/*-{
    var feature = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (!feature) return;
    var el = feature.getElement();
    if (!el) return;

    var classes = el.getAttribute('class').split(/\s+/);
    /// @type {?number}
    var index = null;
    for (var i = 0; i &lt; classes.length; i++) {
      if (classes[i] === 'ode-SimpleMockMapFeature-selected') {
        if (selected) {
          return;  // nothing to change
        } else {
          index = i;
        }
      }
    }
    if (index !== null) {
      classes.splice(index, 1);  // remove selected class
    } else if (selected) {
      classes.push('ode-SimpleMockMapFeature-selected');
    } else {
      return;  // no change, so don't trigger a superfluous redraw
    }
    el.setAttribute('class', classes.join(' '));
  }-*/;

  protected native void setNativeTooltip(String tooltip)/*-{
    var feature = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (feature &amp;&amp; feature.getElement()) {
      var el = feature.getElement(),
          text = document.createTextNode(tooltip),
          titleEl;
      if (el.firstElementChild &amp;&amp; el.firstElementChild.tagName.toLowerCase() === 'title') {
        titleEl = el.firstElementChild;
        while(titleEl.lastChild) {
          titleEl.removeChild(titleEl.lastChild);
        }
      } else {
        titleEl = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        el.appendChild(titleEl);
      }
      titleEl.appendChild(text);
    }
  }-*/;

  protected native void setStrokeColor(String color)/*-{
    var feature = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (feature) {
      feature.options.color = color;
      if (feature.getElement()) {
        feature.getElement().setAttribute('stroke', color);
      }
    }
  }-*/;

  protected native void setStrokeWidth(int weight)/*-{
    var feature = this.@com.google.appinventor.client.editor.simple.components.MockMapFeatureBase::feature;
    if (feature) {
      feature.options.weight = weight;
      if (feature.getElement()) {
        feature.getElement().setAttribute('stroke-width', weight.toString());
      }
    }
  }-*/;

  protected abstract void addToMap(JavaScriptObject map);

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>