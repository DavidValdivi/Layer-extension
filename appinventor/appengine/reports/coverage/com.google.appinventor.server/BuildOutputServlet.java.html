<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BuildOutputServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.server</a> &gt; <span class="el_source">BuildOutputServlet.java</span></div><h1>BuildOutputServlet.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2019 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.server;

import com.google.appinventor.common.utils.StringUtils;
import com.google.appinventor.server.storage.StorageIo;
import com.google.appinventor.server.storage.StorageIoInstanceHolder;
import com.google.appinventor.server.util.CacheHeaders;
import com.google.appinventor.server.util.CacheHeadersImpl;
import com.google.appinventor.shared.rpc.Nonce;
import com.google.appinventor.shared.rpc.ServerLayout;
import com.google.appinventor.shared.rpc.project.ProjectSourceZip;
import com.google.appinventor.shared.rpc.project.RawFile;
import com.google.appinventor.shared.storage.StorageUtil;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.Date;
import java.util.NoSuchElementException;
import java.util.logging.Logger;

/**
 * Servlet for downloading project source and output files.
 *
 */
<span class="nc" id="L33">public class BuildOutputServlet extends OdeServlet {</span>

  /*
   * URIs for Build Output requests are structured as follows:
   *    /&lt;baseurl&gt;/&lt;nonce&gt;
   */

  // Logging support
<span class="nc" id="L41">  private static final Logger LOG = Logger.getLogger(BuildOutputServlet.class.getName());</span>

  // Object used to safely set cache headers in responses
<span class="nc" id="L44">  private static final CacheHeaders CACHE_HEADERS = new CacheHeadersImpl();</span>

  // Content type for response header (to avoid security vulnerabilities)
  private static final String CONTENT_TYPE = &quot;text/html; charset=utf-8&quot;;

<span class="nc" id="L49">  private final FileExporter fileExporter = new FileExporterImpl();</span>

<span class="nc" id="L51">  private final StorageIo storageIo = StorageIoInstanceHolder.getInstance();</span>

  @Override
  public void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
    // Set a default http header to avoid security vulnerabilities.
<span class="nc" id="L56">    CACHE_HEADERS.setNotCacheable(resp);</span>
<span class="nc" id="L57">    resp.setContentType(CONTENT_TYPE);</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">    if (&quot;store=1&quot;.equals(req.getQueryString())) {  // Play Store companion adds this for Chrome to</span>
                                                   // do the right thing w.r.t. the download
<span class="nc" id="L60">      String body = &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=\&quot;refresh\&quot; content=\&quot;0; url=&quot; +</span>
<span class="nc" id="L61">          req.getRequestURI() + &quot;\&quot; /&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<span class="nc" id="L62">      resp.setContentLength(body.length());</span>
<span class="nc" id="L63">      ServletOutputStream os = resp.getOutputStream();</span>
<span class="nc" id="L64">      os.write(body.getBytes());</span>
<span class="nc" id="L65">      os.close();</span>
<span class="nc" id="L66">      return;</span>
    }

    RawFile downloadableFile;

<span class="nc" id="L71">    String userId = null;</span>
<span class="nc" id="L72">    String nonceValue = null;</span>

    try {
<span class="nc" id="L75">      String uri = req.getRequestURI();</span>
      // First, call split with no limit parameter.
<span class="nc" id="L77">      String[] uriComponents = uri.split(&quot;/&quot;);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">      if (uriComponents.length &lt; 3) {</span>
<span class="nc" id="L79">        resp.setStatus(HttpServletResponse.SC_BAD_REQUEST);</span>
<span class="nc" id="L80">        return;</span>
      }
<span class="nc" id="L82">      nonceValue = uriComponents[2];</span>

<span class="nc" id="L84">      storageIo.cleanupNonces(); // This removes expired Nonce objects</span>
                                 // (10 at a time so we don't spend too
                                 // much time doing it)

<span class="nc" id="L88">      Nonce nonce = storageIo.getNoncebyValue(nonceValue);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">      if (nonce == null) {</span>
<span class="nc" id="L90">        resp.sendError(resp.SC_NOT_FOUND, &quot;Invalid Link&quot;);</span>
<span class="nc" id="L91">        return;</span>
      }
<span class="nc" id="L93">      Date now = new Date();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">      if ((now.getTime() - nonce.getTimeStamp().getTime()) &gt; 7200*1024) {</span>
<span class="nc" id="L95">        resp.sendError(resp.SC_NOT_FOUND, &quot;Link has timed out&quot;);</span>
<span class="nc" id="L96">        return;</span>
      }
<span class="nc" id="L98">      downloadableFile = fileExporter.exportProjectOutputFile(nonce.getUserId(), nonce.getProjectId(), null);</span>

<span class="nc" id="L100">    } catch (FileNotFoundException e) {</span>
      // This can happen if a new build is running while an attempt is made to download
      // a previous built version of the project
<span class="nc" id="L103">      resp.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L104">      return;</span>
<span class="nc" id="L105">    }</span>

<span class="nc" id="L107">    String fileName = downloadableFile.getFileName();</span>
<span class="nc" id="L108">    byte[] content = downloadableFile.getContent();</span>

    // Set http response information
<span class="nc" id="L111">    resp.setStatus(HttpServletResponse.SC_OK);</span>
<span class="nc" id="L112">    resp.setHeader(&quot;content-disposition&quot;, &quot;attachment; filename=\&quot;&quot; + fileName + &quot;\&quot;&quot;);</span>
<span class="nc" id="L113">    resp.setContentType(StorageUtil.getContentTypeForFilePath(fileName));</span>
<span class="nc" id="L114">    resp.setContentLength(content.length);</span>

    // Attach download data
<span class="nc" id="L117">    ServletOutputStream out = resp.getOutputStream();</span>
<span class="nc" id="L118">    out.write(content);</span>
<span class="nc" id="L119">    out.close();</span>
<span class="nc" id="L120">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>