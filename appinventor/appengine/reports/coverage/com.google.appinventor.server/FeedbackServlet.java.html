<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FeedbackServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.server</a> &gt; <span class="el_source">FeedbackServlet.java</span></div><h1>FeedbackServlet.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2019 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.server;

import com.google.appinventor.server.storage.StorageIo;
import com.google.appinventor.server.storage.StorageIoInstanceHolder;

import com.google.appinventor.shared.rpc.user.User;
import com.google.appinventor.shared.rpc.user.UserInfoProvider;

import java.io.IOException;
import java.io.PrintWriter;

import java.util.logging.Logger;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.owasp.html.HtmlPolicyBuilder;
import org.owasp.html.PolicyFactory;

/**
 * Servlet to record feedback when an error occurs in the client.
 *
 * @date 20/10/2013
 * @author jis@mit.edu (Jeffrey I Schiller)
 */
<span class="nc" id="L32">public class FeedbackServlet extends OdeServlet {</span>

  // Logging support
<span class="nc" id="L35">  private static final Logger LOG = Logger.getLogger(ReceiveBuildServlet.class.getName());</span>

<span class="nc" id="L37">  private final OdeAuthFilter odeFilter = new OdeAuthFilter();</span>
<span class="nc" id="L38">  private final transient StorageIo storageIo = StorageIoInstanceHolder.getInstance();</span>

  @Override
  public void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
<span class="nc" id="L42">    PolicyFactory policy = new HtmlPolicyBuilder()</span>
<span class="nc" id="L43">      .allowElements(&quot;p&quot;).toFactory();</span>
<span class="nc" id="L44">    String query = req.getQueryString();</span>
<span class="nc" id="L45">    String notes = req.getParameter(&quot;notes&quot;);</span>
<span class="nc" id="L46">    String foundIn = req.getParameter(&quot;foundIn&quot;);</span>
<span class="nc" id="L47">    String faultData = req.getParameter(&quot;faultData&quot;);</span>
<span class="nc" id="L48">    String projectId = req.getParameter(&quot;projectId&quot;);</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">    if (notes == null) notes = &quot;&quot;;</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">    if (foundIn == null) foundIn = &quot;&quot;;</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">    if (faultData == null) faultData = &quot;&quot;;</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">    if (projectId == null) projectId = &quot;-1&quot;;</span>
<span class="nc" id="L53">    notes = policy.sanitize(notes);</span>
<span class="nc" id="L54">    foundIn = policy.sanitize(foundIn);</span>
<span class="nc" id="L55">    projectId = policy.sanitize(projectId);</span>
<span class="nc" id="L56">    PrintWriter out = new PrintWriter(resp.getWriter());</span>
<span class="nc" id="L57">    out.println(String.format(template, notes, foundIn, faultData, projectId));</span>
<span class="nc" id="L58">  }</span>

  @Override
  public void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
<span class="nc" id="L62">    String query = req.getQueryString();</span>
<span class="nc" id="L63">    String notes = req.getParameter(&quot;notes&quot;);</span>
<span class="nc" id="L64">    String foundIn = req.getParameter(&quot;foundIn&quot;);</span>
<span class="nc" id="L65">    String faultData = req.getParameter(&quot;faultData&quot;);</span>
<span class="nc" id="L66">    String comments = req.getParameter(&quot;comments&quot;);</span>
<span class="nc" id="L67">    String projectId = req.getParameter(&quot;projectId&quot;);</span>
<span class="nc" id="L68">    String datestamp = new java.util.Date().toGMTString();</span>
<span class="nc" id="L69">    String email = userInfoProvider.getUserEmail();</span>

<span class="nc bnc" id="L71" title="All 2 branches missed.">    if (notes == null) notes = &quot;&quot;;</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">    if (foundIn == null) foundIn = &quot;&quot;;</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">    if (faultData == null) faultData = &quot;&quot;;</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">    if (projectId == null) projectId = &quot;-1&quot;;</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">    if (comments == null) comments = &quot;&quot;;</span>
<span class="nc" id="L76">    storageIo.storeFeedback(notes, foundIn, faultData, comments, datestamp, email, projectId);</span>
<span class="nc" id="L77">    PrintWriter out = new PrintWriter(resp.getWriter());</span>
<span class="nc" id="L78">    out.println(thanks);</span>
<span class="nc" id="L79">  }</span>

  private static final String template = &quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Ooops&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Ooops! We tripped on a Bug!&lt;/h1&gt;\n&lt;p&gt;Please help us by telling us what you were doing at the time this happend.\nWe have already included some technical data with this report. If you do not\nsubmit this report, nothing will be reported to us. If you do submit a report,\nyour comments along with the technical data will be sent to us.&lt;/p&gt;\n&lt;p&gt;\nThank you for your help in making MIT App Inventor better!\n&lt;/p&gt;\n&lt;form method=POST action=\&quot;/ode/feedback\&quot;&gt;\n&lt;input type=hidden name=notes value=\&quot;%1$s\&quot;&gt;\n&lt;input type=hidden name=foundIn value=\&quot;%2$s\&quot;&gt;\n&lt;input type=hidden name=faultData value=\&quot;%3$s\&quot;&gt;\n&lt;input type=hidden name=projectId value=\&quot;%4$s\&quot;&gt;\n&lt;textarea cols=75 rows=5 name=comments&gt;\n&lt;/textarea&gt;\n&lt;p&gt;Technical Data to be Submitted:&lt;/p&gt;\n&lt;pre&gt;\nnotes = %1$s\nfoundIn = %2$s\nfaultData = %3$s\nprojectId = %4$s\n&lt;/pre&gt;\n&lt;input type=submit value=\&quot;Send Report\&quot;&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n&quot;;

  private static final String thanks = &quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Ooops&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Thanks!&lt;/h1&gt;\n&lt;p&gt;Your feedback has been recorded. Thanks again for contributing to MIT\nApp Inventor.&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n&quot;;

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>