<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReceiveBuildServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.server</a> &gt; <span class="el_source">ReceiveBuildServlet.java</span></div><h1>ReceiveBuildServlet.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2019 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.server;

import com.google.appinventor.server.encryption.EncryptionException;
import com.google.appinventor.server.project.utils.Security;
import com.google.appinventor.server.storage.StorageIo;
import com.google.appinventor.server.storage.StorageIoInstanceHolder;
import com.google.appinventor.shared.storage.StorageUtil;
import com.google.common.io.ByteStreams;

import java.io.IOException;
import java.util.logging.Logger;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * Servlet for receiving build output files and build error information from a Build Server.
 *
 * &lt;p&gt;This needs to be done from a servlet that does not require login because
 * posts from the Build Server do not contain login information. To ensure
 * safety they contain an encrypted user and project ID as part of
 * their URL.
 *
 * @author markf@google.com (Mark Friedman)
 */
<span class="nc" id="L34">public class ReceiveBuildServlet extends OdeServlet {</span>

  // Logging support
<span class="nc" id="L37">  private static final Logger LOG = Logger.getLogger(ReceiveBuildServlet.class.getName());</span>

<span class="nc" id="L39">  private final OdeAuthFilter odeFilter = new OdeAuthFilter();</span>
<span class="nc" id="L40">  private final transient StorageIo storageIo = StorageIoInstanceHolder.getInstance();</span>

  @Override
  public void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
    // URIs for receivebuild requests are structured as follows:
    //   /&lt;baseurl&gt;/receivebuild/encryptedUserAndProjectId/fileId
<span class="nc" id="L46">    String uriComponents[] = req.getRequestURI().split(&quot;/&quot;, 5);</span>

    // TODO(lizlooney,user) If the URI doesn't contain enough components, the following lines
    // will throw an ArrayIndexOutOfBoundsException. We could deal with that outcome more cleanly
    // by returning an HTTP error code. This applies to all of our servlets.

    String userId;
    long projectId;
    try {
<span class="nc" id="L55">      userId = Security.decryptUserId(uriComponents[3]);</span>
<span class="nc" id="L56">      projectId = Security.decryptProjectId(uriComponents[3]);</span>
<span class="nc" id="L57">    } catch (EncryptionException e) {</span>
<span class="nc" id="L58">      throw CrashReport.createAndLogError(LOG, req, null, e);</span>
<span class="nc" id="L59">    }</span>

    // Set the user in the OdeFilter, which is used everywhere as the UserInfoProvider.
<span class="nc" id="L62">    odeFilter.setUserFromUserId(userId, false, false);</span>
    try {
<span class="nc" id="L64">      String buildFileDirPath = uriComponents[4];</span>
<span class="nc" id="L65">      ZipInputStream zipInputStream = new ZipInputStream(req.getInputStream());</span>
      while (true) {
<span class="nc" id="L67">        ZipEntry zipEntry = zipInputStream.getNextEntry();</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (zipEntry == null) {</span>
<span class="nc" id="L69">          break;</span>
        }
<span class="nc" id="L71">        String fileName = zipEntry.getName();</span>
<span class="nc" id="L72">        byte[] fileBytes = ByteStreams.toByteArray(zipInputStream);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (StorageUtil.ANDROID_KEYSTORE_FILENAME.equals(fileName)) {</span>
<span class="nc" id="L74">          LOG.info(&quot;Saving android.keystore for user: &quot; + userId);</span>
<span class="nc" id="L75">          storageIo.addFilesToUser(userId, StorageUtil.ANDROID_KEYSTORE_FILENAME);</span>
<span class="nc" id="L76">          storageIo.uploadRawUserFile(userId, fileName, fileBytes);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        } else if (fileName.equals(&quot;build.status&quot;)) {</span>
<span class="nc" id="L78">          int progress = Integer.parseInt((new String(fileBytes)).trim());</span>
<span class="nc" id="L79">          LOG.info(&quot;Received a build.status file contents = &quot; + progress);</span>
<span class="nc" id="L80">          storageIo.storeBuildStatus(userId, projectId, progress);</span>
<span class="nc" id="L81">        } else {</span>
<span class="nc" id="L82">          String filePath = buildFileDirPath + &quot;/&quot; + fileName;</span>
<span class="nc" id="L83">          LOG.info(&quot;Saving build output files: &quot; + filePath);</span>
<span class="nc" id="L84">          storageIo.addOutputFilesToProject(userId, projectId, filePath);</span>
<span class="nc" id="L85">          storageIo.uploadRawFileForce(projectId, filePath, userId, fileBytes);</span>
<span class="nc" id="L86">          storageIo.storeBuildStatus(userId, projectId, 0); // Reset for the next build</span>
        }
<span class="nc" id="L88">      }</span>
    } finally {
<span class="nc" id="L90">      odeFilter.removeUser();</span>
    }
<span class="nc" id="L92">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>