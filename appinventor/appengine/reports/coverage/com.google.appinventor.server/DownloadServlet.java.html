<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DownloadServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.server</a> &gt; <span class="el_source">DownloadServlet.java</span></div><h1>DownloadServlet.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2019 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.server;

import com.google.appinventor.common.utils.StringUtils;

import com.google.appinventor.server.storage.StorageIo;
import com.google.appinventor.server.storage.StorageIoInstanceHolder;

import com.google.appinventor.server.util.CacheHeaders;
import com.google.appinventor.server.util.CacheHeadersImpl;

import com.google.appinventor.shared.rpc.ServerLayout;
import com.google.appinventor.shared.rpc.project.ProjectSourceZip;
import com.google.appinventor.shared.rpc.project.RawFile;

import com.google.appinventor.shared.storage.StorageUtil;

import java.io.File;
import java.io.IOException;

import java.nio.file.Files;
import java.nio.file.Path;

import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

import java.util.ArrayList;
import java.util.Formatter;
import java.util.List;
import java.util.NoSuchElementException;
import java.util.logging.Logger;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;


/**
 * Servlet for downloading project source and output files.
 *
 */
<span class="nc" id="L47">public class DownloadServlet extends OdeServlet {</span>

  /*
   * URIs for download requests are structured as follows:
   *    /&lt;baseurl&gt;/download/project-output/&lt;projectId&gt;/{&lt;target&gt;}
   *    /&lt;baseurl&gt;/download/project-source/&lt;projectId&gt;/{&lt;title&gt;}
   *    /&lt;baseurl&gt;/download/user-project-source/&lt;projectIdOrName&gt;/&lt;userIdOrEmail&gt;
   *    /&lt;baseurl&gt;/download/all-projects-source
   *    /&lt;baseurl&gt;/download/file/&lt;projectId&gt;/&lt;file-path&gt;
   *    /&lt;baseurl&gt;/download/userfile/&lt;file-path&gt;
   */

  // Constants for accessing split URI
  /*
   * Download kind can be: &quot;project-output&quot;, &quot;project-source&quot;,
   * &quot;selected-projects-source&quot;, &quot;all-projects-source&quot;, &quot;file&quot;, or &quot;userfile&quot;.
   * Constants for these are defined in ServerLayout.
   */
  private static final int DOWNLOAD_KIND_INDEX = 3;

  // PROJECT_ID_INDEX is used for more than one download kind
  private static final int PROJECT_ID_INDEX = 4;

  // Constants used when download kind is &quot;project-output&quot;.
  // PROJECT_ID_INDEX = 4 (declared above)
  private static final int TARGET_INDEX = 5;
  private static final int SPLIT_LIMIT_PROJECT_OUTPUT = 6;

  // Constants used when download kind is &quot;project-source&quot;.
  // Since the project title may contain slashes, it must be the last component in the URI.
  // PROJECT_ID_INDEX = 4 (declared above)
  private static final int PROJECT_TITLE_INDEX = 5;
  private static final int SPLIT_LIMIT_PROJECT_SOURCE = 6;

  // Constants used when download kind is &quot;user-project-source&quot;.
  private static final int USER_PROJECT_USERID_INDEX = 5;
  private static final int SPLIT_LIMIT_USER_PROJECT_SOURCE = 6;

  // Constants used when download kind is &quot;file&quot;.
  // Since the file path may contain slashes, it must be the last component in the URI.
  // PROJECT_ID_INDEX = 4 (declared above)
  private static final int FILE_PATH_INDEX = 5;
  private static final int SPLIT_LIMIT_FILE = 6;

  // Constants used when download kind is &quot;userfile&quot;.
  // Since the file path may contain slashes, it must be the last component in the URI.
  private static final int USERFILE_PATH_INDEX = 4;
  private static final int SPLIT_LIMIT_USERFILE = 5;


  // Logging support
<span class="nc" id="L98">  private static final Logger LOG = Logger.getLogger(DownloadServlet.class.getName());</span>

  // Object used to safely set cache headers in responses
<span class="nc" id="L101">  private static final CacheHeaders CACHE_HEADERS = new CacheHeadersImpl();</span>

  // Content type for response header (to avoid security vulnerabilities)
  private static final String CONTENT_TYPE = &quot;text/html; charset=utf-8&quot;;

<span class="nc" id="L106">  private final FileExporter fileExporter = new FileExporterImpl();</span>

  @Override
  public void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
    // Set a default http header to avoid security vulnerabilities.
<span class="nc" id="L111">    CACHE_HEADERS.setNotCacheable(resp);</span>
<span class="nc" id="L112">    resp.setContentType(CONTENT_TYPE);</span>

<span class="nc" id="L114">    RawFile downloadableFile = null;</span>

<span class="nc" id="L116">    String userId = null;</span>

<span class="nc" id="L118">    int statusCode = HttpServletResponse.SC_OK;</span>

    try {
<span class="nc" id="L121">      String uri = req.getRequestURI();</span>
      // First, call split with no limit parameter.
<span class="nc" id="L123">      String[] uriComponents = uri.split(&quot;/&quot;);</span>
<span class="nc" id="L124">      String downloadKind = uriComponents[DOWNLOAD_KIND_INDEX];</span>

<span class="nc" id="L126">      userId = userInfoProvider.getUserId();</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">      if (downloadKind.equals(ServerLayout.DOWNLOAD_PROJECT_OUTPUT)) {</span>
        // Download project output file.
<span class="nc" id="L130">        uriComponents = uri.split(&quot;/&quot;, SPLIT_LIMIT_PROJECT_OUTPUT);</span>
<span class="nc" id="L131">        long projectId = Long.parseLong(uriComponents[PROJECT_ID_INDEX]);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        String target = (uriComponents.length &gt; TARGET_INDEX) ? uriComponents[TARGET_INDEX] : null;</span>
<span class="nc" id="L133">        downloadableFile = fileExporter.exportProjectOutputFile(userId, projectId, target);</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">      } else if (downloadKind.equals(ServerLayout.DOWNLOAD_PROJECT_SOURCE)) {</span>
        // Download project source files as a zip.
<span class="nc" id="L137">        long projectId = Long.parseLong(uriComponents[PROJECT_ID_INDEX]);</span>
<span class="nc" id="L138">        uriComponents = uri.split(&quot;/&quot;, SPLIT_LIMIT_PROJECT_SOURCE);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        String projectTitle = (uriComponents.length &gt; PROJECT_TITLE_INDEX) ?</span>
            uriComponents[PROJECT_TITLE_INDEX] : null;
<span class="nc" id="L141">        final boolean includeProjectHistory = true;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        String zipName = (projectTitle == null) ? null :</span>
<span class="nc" id="L143">            StringUtils.normalizeForFilename(projectTitle) + &quot;.aia&quot;;</span>
        // If the requester is an Admin, we include any Yail files in the
        // project in the export
<span class="nc" id="L146">        boolean includeYail = userInfoProvider.getIsAdmin();</span>
<span class="nc" id="L147">        boolean includeScreenShots = includeYail;</span>
<span class="nc" id="L148">        StorageIoInstanceHolder.getInstance().assertUserHasProject(userId, projectId);</span>
<span class="nc" id="L149">        ProjectSourceZip zipFile = fileExporter.exportProjectSourceZip(userId,</span>
          projectId, includeProjectHistory, false, zipName, includeYail,
          includeScreenShots, false, false);
<span class="nc" id="L152">        downloadableFile = zipFile.getRawFile();</span>

<span class="nc bnc" id="L154" title="All 2 branches missed.">      } else if (downloadKind.equals(ServerLayout.DOWNLOAD_USER_PROJECT_SOURCE)) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (!userInfoProvider.getIsAdmin()) {</span>
<span class="nc" id="L156">          throw new IllegalArgumentException(&quot;Unauthorized.&quot;);</span>
        }

        // Download project source files for the specified user project as a zip.
<span class="nc" id="L160">        uriComponents = uri.split(&quot;/&quot;, SPLIT_LIMIT_USER_PROJECT_SOURCE);</span>

<span class="nc" id="L162">        String userIdOrEmail = uriComponents[USER_PROJECT_USERID_INDEX];</span>
        String projectUserId;
<span class="nc" id="L164">        StorageIo storageIo = StorageIoInstanceHolder.getInstance();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (userIdOrEmail.contains(&quot;@&quot;)) {</span>
          // email address
          try {
<span class="nc" id="L168">            projectUserId = storageIo.findUserByEmail(userIdOrEmail);</span>
<span class="nc" id="L169">          } catch (NoSuchElementException e) {</span>
<span class="nc" id="L170">            throw new IllegalArgumentException(e.getMessage());</span>
<span class="nc" id="L171">          }</span>
        } else {
<span class="nc" id="L173">          projectUserId = userIdOrEmail;</span>
        }

<span class="nc" id="L176">        String projectIdOrName = uriComponents[PROJECT_ID_INDEX];</span>
        String projectName;
<span class="nc" id="L178">        long projectId = 0;</span>
        try {
          // try to parse the projectIdOrName as a number, since project names
          // must start with a letter.
<span class="nc" id="L182">          projectId = Long.parseLong(projectIdOrName);</span>
<span class="nc" id="L183">          projectName = storageIo.getProjectName(projectUserId, projectId);</span>
<span class="nc" id="L184">        } catch (NumberFormatException e) {</span>
          // assume we got a name instead
<span class="nc bnc" id="L186" title="All 2 branches missed.">          for (Long pid : storageIo.getProjects(projectUserId)) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (storageIo.getProjectName(projectUserId, pid).equals(projectIdOrName)) {</span>
<span class="nc" id="L188">              projectId = pid;</span>
            }
<span class="nc" id="L190">          }</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">          if (projectId == 0) {</span>
            // didn't find project by name
<span class="nc" id="L193">            throw new IllegalArgumentException(&quot;Can't find a project named &quot;</span>
                + projectIdOrName + &quot; for user id &quot; + projectUserId);
          } else {
<span class="nc" id="L196">            projectName = projectIdOrName;</span>
          }
<span class="nc" id="L198">        }</span>
        String zipName;
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (!projectName.isEmpty()) {</span>
<span class="nc" id="L201">          zipName = projectName + &quot;_&quot; + projectUserId + &quot;.aia&quot;;</span>
        } else {
<span class="nc" id="L203">          zipName = &quot;u&quot; + projectUserId + &quot;_p&quot; + projectId + &quot;.aia&quot;;</span>
        }
<span class="nc" id="L205">        ProjectSourceZip zipFile = fileExporter.exportProjectSourceZip(projectUserId,</span>
          projectId, /* include history*/ true, /* include keystore */ true, zipName, true, true, false, false);
<span class="nc" id="L207">        downloadableFile = zipFile.getRawFile();</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">      } else if (downloadKind.equals(ServerLayout.DOWNLOAD_SELECTED_PROJECTS_SOURCE)) {</span>
<span class="nc" id="L209">        String[] projectIdStrings = uriComponents[PROJECT_ID_INDEX].split(&quot;-&quot;);</span>
<span class="nc" id="L210">        List&lt;Long&gt; projectIds = new ArrayList&lt;Long&gt;();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        for (String projectId : projectIdStrings) {</span>
<span class="nc" id="L212">          projectIds.add(Long.valueOf(projectId));</span>
        }
<span class="nc" id="L214">        ProjectSourceZip zipFile = fileExporter.exportSelectedProjectsSourceZip(</span>
          userId, &quot;selected-projects.zip&quot;, projectIds);
<span class="nc" id="L216">        downloadableFile = zipFile.getRawFile();</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">      } else if (downloadKind.equals(ServerLayout.DOWNLOAD_ALL_PROJECTS_SOURCE)) {</span>
        // Download all project source files as a zip of zips.
<span class="nc" id="L219">        ProjectSourceZip zipFile = fileExporter.exportAllProjectsSourceZip(</span>
            userId, &quot;all-projects.zip&quot;);
<span class="nc" id="L221">        downloadableFile = zipFile.getRawFile();</span>

<span class="nc bnc" id="L223" title="All 2 branches missed.">      } else if (downloadKind.equals(ServerLayout.DOWNLOAD_FILE)) {</span>
        // Download a specific file.
        // compute the hash and check if the hash matches the header coming in
        // (HttpServerRequest req has the header)
<span class="nc" id="L227">        uriComponents = uri.split(&quot;/&quot;, SPLIT_LIMIT_FILE);</span>
<span class="nc" id="L228">        long projectId = Long.parseLong(uriComponents[PROJECT_ID_INDEX]);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">        String filePath = (uriComponents.length &gt; FILE_PATH_INDEX) ?</span>
          uriComponents[FILE_PATH_INDEX] : null;
<span class="nc" id="L231">        StorageIoInstanceHolder.getInstance().assertUserHasProject(userId, projectId);</span>
<span class="nc" id="L232">        downloadableFile = fileExporter.exportFile(userId, projectId, filePath);</span>
<span class="nc" id="L233">        byte[] fileContent = downloadableFile.getContent();</span>

<span class="nc" id="L235">        MessageDigest md = MessageDigest.getInstance(&quot;SHA-1&quot;);</span>
        // Note: We put quotes around the hash to confirm with RFC7232
<span class="nc" id="L237">        String fileHash = &quot;\&quot;&quot; + byteArray2Hex(md.digest(fileContent)) + &quot;\&quot;&quot;;</span>
        // if equal, return 304
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (fileHash.equals(req.getHeader(&quot;If-None-Match&quot;))) {</span>
<span class="nc" id="L240">          statusCode = HttpServletResponse.SC_NOT_MODIFIED;</span>
        }
<span class="nc" id="L242">        resp.setHeader(&quot;ETag&quot;, fileHash);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">      } else if (downloadKind.equals(ServerLayout.DOWNLOAD_USERFILE)) {</span>
        // Download a specific user file, such as android.keystore
<span class="nc" id="L245">        uriComponents = uri.split(&quot;/&quot;, SPLIT_LIMIT_USERFILE);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (uriComponents.length &gt; USERFILE_PATH_INDEX) {</span>
<span class="nc" id="L247">          String filePath = uriComponents[USERFILE_PATH_INDEX];</span>
<span class="nc" id="L248">          downloadableFile = fileExporter.exportUserFile(userId, filePath);</span>
<span class="nc" id="L249">        } else {</span>
<span class="nc" id="L250">          throw new IllegalArgumentException(&quot;Missing user file path.&quot;);</span>
        }

      } else {
<span class="nc" id="L254">        throw new IllegalArgumentException(&quot;Unknown download kind: &quot; + downloadKind);</span>
      }
<span class="nc" id="L256">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L257">      throw CrashReport.createAndLogError(LOG, req, &quot;user=&quot; + userId, e);</span>
<span class="nc" id="L258">    } catch (SecurityException e) {</span>
      // Not having appropriate permission is akin to not being able to find the project anyway,
      // so we use 404 here to not leak that the project may exist.
<span class="nc" id="L261">      final String message = &quot;404 Not Found&quot;;</span>
<span class="nc" id="L262">      resp.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L263">      resp.setContentType(&quot;text/plain&quot;);</span>
<span class="nc" id="L264">      resp.setContentLength(message.length());</span>
<span class="nc" id="L265">      ServletOutputStream out = resp.getOutputStream();</span>
<span class="nc" id="L266">      out.write(message.getBytes());</span>
<span class="nc" id="L267">      out.close();</span>
<span class="nc" id="L268">      return;</span>
<span class="nc" id="L269">    } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L270">      throw CrashReport.createAndLogError(LOG, req, &quot;user=&quot; + userId, e);</span>
<span class="nc" id="L271">    }</span>

<span class="nc" id="L273">    resp.setStatus(statusCode);</span>

<span class="nc bnc" id="L275" title="All 2 branches missed.">    if (statusCode == HttpServletResponse.SC_OK) {</span>
<span class="nc" id="L276">      LOG.fine(&quot;Sending File!&quot;);</span>
<span class="nc" id="L277">      String fileName = downloadableFile.getFileName();</span>
<span class="nc" id="L278">      byte[] content = downloadableFile.getContent();</span>
      // Set http response information
<span class="nc" id="L280">      resp.setHeader(</span>
        &quot;content-disposition&quot;,
<span class="nc bnc" id="L282" title="All 2 branches missed.">        req.getParameter(&quot;inline&quot;) != null ? &quot;inline&quot; : &quot;attachment&quot; + &quot;; filename=\&quot;&quot; + fileName + &quot;\&quot;&quot;);</span>
<span class="nc" id="L283">      resp.setContentType(StorageUtil.getContentTypeForFilePath(fileName));</span>
<span class="nc" id="L284">      resp.setContentLength(content.length);</span>

      // Attach download data
<span class="nc" id="L287">      ServletOutputStream out = resp.getOutputStream();</span>
<span class="nc" id="L288">      out.write(content);</span>
<span class="nc" id="L289">      out.close();</span>
<span class="nc" id="L290">    } else {                    // Not sure this is needed... we are not sending any data</span>
<span class="nc" id="L291">      LOG.fine(&quot;File Cached, not sending File!&quot;);</span>
<span class="nc" id="L292">      resp.setContentLength(0);</span>
<span class="nc" id="L293">      ServletOutputStream out = resp.getOutputStream();</span>
<span class="nc" id="L294">      out.close();</span>
    }
<span class="nc" id="L296">  }</span>

  private static String byteArray2Hex(final byte[] hash) {
<span class="nc" id="L299">    Formatter formatter = new Formatter();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">    for (byte b : hash) {</span>
<span class="nc" id="L301">      formatter.format(&quot;%02x&quot;, b);</span>
    }
<span class="nc" id="L303">    return formatter.toString();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>