<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminInfoServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.server</a> &gt; <span class="el_source">AdminInfoServiceImpl.java</span></div><h1>AdminInfoServiceImpl.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2015-2019 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.server;

import java.security.NoSuchAlgorithmException;
import java.security.spec.InvalidKeySpecException;
import java.util.List;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpSession;

import com.google.appinventor.server.flags.Flag;
import com.google.appinventor.server.OdeAuthFilter;
import com.google.appinventor.server.storage.StorageIo;
import com.google.appinventor.server.storage.StorageIoInstanceHolder;
import com.google.appinventor.shared.rpc.AdminInterfaceException;
import com.google.appinventor.shared.rpc.user.Config;
import com.google.appinventor.shared.rpc.admin.AdminUser;
import com.google.appinventor.shared.rpc.admin.AdminInfoService;
import com.google.appinventor.server.util.PasswordHash;

/**
 * Implementation of the user information service.
 *
 * &lt;p&gt;Note that this service must be state-less so that it can be run on
 * multiple servers.
 *
 */
<span class="nc" id="L32">public class AdminInfoServiceImpl extends OdeRemoteServiceServlet implements AdminInfoService {</span>

  // Storage of user settings
<span class="nc" id="L35">  private final transient StorageIo storageIo = StorageIoInstanceHolder.getInstance();</span>

  /**
   * Returns a list of AdminUsers, up to 20, based on the starting
   * point.
   */

  @Override
  public List&lt;AdminUser&gt; searchUsers(String startingPoint) {
<span class="nc bnc" id="L44" title="All 2 branches missed.">    if (!userInfoProvider.getIsAdmin()) {</span>
<span class="nc" id="L45">      throw new IllegalArgumentException(&quot;Unauthorized.&quot;);</span>
    }
<span class="nc" id="L47">    return storageIo.searchUsers(startingPoint);</span>
  }

  @Override
  public void storeUser(AdminUser user) throws AdminInterfaceException {
<span class="nc bnc" id="L52" title="All 2 branches missed.">    if (!userInfoProvider.getIsAdmin()) {</span>
<span class="nc" id="L53">      throw new IllegalArgumentException(&quot;Unauthorized.&quot;);</span>
    }
    // This is a bit of a kludge
    // We hash the password here, replacing it in place
<span class="nc" id="L57">    String password = user.getPassword();</span>
<span class="nc" id="L58">    String hashedPassword = &quot;&quot;;</span>
<span class="nc bnc" id="L59" title="All 4 branches missed.">    if (password != null &amp;&amp; !password.equals(&quot;&quot;)) {</span>
      try {
<span class="nc" id="L61">        hashedPassword = PasswordHash.createHash(password);</span>
<span class="nc" id="L62">        user.setPassword(hashedPassword);</span>
<span class="nc" id="L63">      } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L64">        throw new IllegalArgumentException(&quot;Error hashing password&quot;);</span>
<span class="nc" id="L65">      } catch (InvalidKeySpecException e) {</span>
<span class="nc" id="L66">        throw new IllegalArgumentException(&quot;Error hashing password&quot;);</span>
<span class="nc" id="L67">      }</span>
    }
<span class="nc" id="L69">    storageIo.storeUser(user);</span>
<span class="nc" id="L70">  }</span>

  @Override
  public void switchUser(AdminUser user) throws AdminInterfaceException {
<span class="nc bnc" id="L74" title="All 2 branches missed.">    if (!userInfoProvider.getIsAdmin()) {</span>
<span class="nc" id="L75">      throw new IllegalArgumentException(&quot;Unauthorized.&quot;);</span>
    }

    // BEWARE THIS IS A HACK
    // We are going to switch users and set the readOnly flag
    // When this call returns we depend on the client side doing a complete
    // reload. It will then get a new User object based on these updated
    // session fields.

    // OLD CODE
    // HttpSession session = localSession.getSession();
    // session.setAttribute(&quot;userid&quot;, user.getId());
    // session.setAttribute(&quot;readonly&quot;, true);

<span class="nc" id="L89">    OdeAuthFilter.UserInfo nuser = new OdeAuthFilter.UserInfo(user.getId(),</span>
      false);
<span class="nc" id="L91">    nuser.setReadOnly(true);</span>
<span class="nc" id="L92">    String newCookie = nuser.buildCookie(false);</span>
<span class="nc" id="L93">    Cookie cook = new Cookie(&quot;AppInventor&quot;, newCookie);</span>
<span class="nc" id="L94">    cook.setPath(&quot;/&quot;);</span>
<span class="nc" id="L95">    getThreadLocalResponse().addCookie(cook);</span>

<span class="nc" id="L97">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>