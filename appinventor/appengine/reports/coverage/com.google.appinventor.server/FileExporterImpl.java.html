<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileExporterImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.server</a> &gt; <span class="el_source">FileExporterImpl.java</span></div><h1>FileExporterImpl.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2019 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.server;

import com.google.appinventor.server.storage.StorageIo;
import com.google.appinventor.server.storage.StorageIoInstanceHolder;
import com.google.appinventor.shared.rpc.project.ProjectSourceZip;
import com.google.appinventor.shared.rpc.project.RawFile;
import com.google.appinventor.shared.storage.StorageUtil;

import java.io.ByteArrayOutputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import javax.annotation.Nullable;

/**
 * Implementation of {@link FileExporter} based on {@link StorageIo}
 *
 */
<span class="fc" id="L29">public final class FileExporterImpl implements FileExporter {</span>

<span class="fc" id="L31">  private final StorageIo storageIo = StorageIoInstanceHolder.getInstance();</span>

  @Override
  public RawFile exportProjectOutputFile(String userId, long projectId, @Nullable String target)
      throws IOException {
    // Download project output file.
<span class="fc" id="L37">    List&lt;String&gt; files = storageIo.getProjectOutputFiles(userId, projectId);</span>
<span class="pc bpc" id="L38" title="1 of 2 branches missed.">    if (target != null) {</span>
      // Target given - filter file list
<span class="fc" id="L40">      files = filterByFilePrefix(files, &quot;build/&quot; + target + '/');</span>
    }

    // We expect the files List to contain:
    //   build/Android/&lt;project&gt;.apk
    //   build/Android/build.out
    //   build/Android/build.err
    // There should never be more than one .apk file.

<span class="fc bfc" id="L49" title="All 2 branches covered.">    for (String fileName : files) {</span>
<span class="pc bpc" id="L50" title="3 of 4 branches missed.">      if (fileName.endsWith(&quot;.apk&quot;) || fileName.endsWith(&quot;.aab&quot;)) {</span>
<span class="fc" id="L51">        byte[] content = storageIo.downloadRawFile(userId, projectId, fileName);</span>
<span class="fc" id="L52">        return new RawFile(StorageUtil.basename(fileName), content);</span>
      }
<span class="nc" id="L54">    }</span>

<span class="fc" id="L56">    throw new FileNotFoundException(&quot;No files to download&quot;);</span>
  }

  @Override
  public ProjectSourceZip exportProjectSourceZip(String userId, long projectId,
    boolean includeProjectHistory,
    boolean includeAndroidKeystore,
    @Nullable String zipName,
    boolean includeYail,
    boolean includeScreenShots,
    boolean fatalError,
    boolean forGallery) throws IOException {
    // Download project source files as a zip.
<span class="fc" id="L69">    return storageIo.exportProjectSourceZip(userId, projectId,</span>
      includeProjectHistory, includeAndroidKeystore, zipName, includeYail, includeScreenShots, forGallery, fatalError);
  }

  @Override
  public ProjectSourceZip exportSelectedProjectsSourceZip(String userId,
      String zipName, List&lt;Long&gt; projectIds) throws IOException {
      // Create a zip file for each project's sources.
<span class="nc bnc" id="L77" title="All 2 branches missed.">    if (projectIds.size() == 0) {</span>
<span class="nc" id="L78">      throw new IllegalArgumentException(&quot;No projects to download&quot;);</span>
    }

<span class="nc" id="L81">    ByteArrayOutputStream zipFile = new ByteArrayOutputStream();</span>
<span class="nc" id="L82">    ZipOutputStream out = new ZipOutputStream(zipFile);</span>
<span class="nc" id="L83">    int count = 0;</span>
<span class="nc" id="L84">    String metadata = &quot;&quot;;</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">    for (Long projectId : projectIds) {</span>
      try {
<span class="nc" id="L87">        ProjectSourceZip projectSourceZip =</span>
<span class="nc" id="L88">            exportProjectSourceZip(userId, projectId, false, false, null, false, false, false, false);</span>
<span class="nc" id="L89">        byte[] data = projectSourceZip.getContent();</span>
<span class="nc" id="L90">        String name = projectSourceZip.getFileName();</span>

        // If necessary, renae duplicate projects
        while (true) {
          try {
<span class="nc" id="L95">            out.putNextEntry(new ZipEntry(name));</span>
<span class="nc" id="L96">            break;</span>
<span class="nc" id="L97">          } catch (IOException e) {</span>
<span class="nc" id="L98">            name = &quot;duplicate-&quot; + name;</span>
<span class="nc" id="L99">          }</span>
        }
<span class="nc" id="L101">        metadata += projectSourceZip.getMetadata() + &quot;\n&quot;;</span>

<span class="nc" id="L103">        out.write(data, 0, data.length);</span>
<span class="nc" id="L104">        out.closeEntry();</span>
<span class="nc" id="L105">        count++;</span>
<span class="nc" id="L106">      } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L107">        System.err.println(&quot;No files found for userid: &quot; + userId +</span>
            &quot; for projectid: &quot; + projectId);
<span class="nc" id="L109">      } catch (IOException e) {</span>
<span class="nc" id="L110">        System.err.println(&quot;IOException while reading files found for userid: &quot; +</span>
            userId + &quot; for projectid: &quot; + projectId);
<span class="nc" id="L112">        continue;</span>
<span class="nc" id="L113">      }</span>
<span class="nc" id="L114">    }</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">    if (count == 0) {</span>
<span class="nc" id="L116">      throw new IllegalArgumentException(&quot;No files to download&quot;);</span>
    }

<span class="nc" id="L119">    List&lt;String&gt; userFiles = storageIo.getUserFiles(userId);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">    if (userFiles.contains(StorageUtil.ANDROID_KEYSTORE_FILENAME)) {</span>
<span class="nc" id="L121">      byte[] androidKeystoreBytes =</span>
<span class="nc" id="L122">          storageIo.downloadRawUserFile(userId, StorageUtil.ANDROID_KEYSTORE_FILENAME);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">      if (androidKeystoreBytes.length &gt; 0) {</span>
<span class="nc" id="L124">        out.putNextEntry(new ZipEntry(StorageUtil.ANDROID_KEYSTORE_FILENAME));</span>
<span class="nc" id="L125">        out.write(androidKeystoreBytes, 0, androidKeystoreBytes.length);</span>
<span class="nc" id="L126">        out.closeEntry();</span>
<span class="nc" id="L127">        count++;</span>
      }
    }

<span class="nc" id="L131">    out.close();</span>

    // Package the big zip file up as a ProjectSourceZip and return it.
<span class="nc" id="L134">    byte[] content = zipFile.toByteArray();</span>
<span class="nc" id="L135">    ProjectSourceZip projectSourceZip = new ProjectSourceZip(zipName, content, count);</span>
<span class="nc" id="L136">    projectSourceZip.setMetadata(metadata);</span>
<span class="nc" id="L137">    return projectSourceZip;</span>
  }

  @Override
  public ProjectSourceZip exportAllProjectsSourceZip(String userId,
      String zipName) throws IOException {
    // Create a zip file for each project's sources.
<span class="nc" id="L144">    List&lt;Long&gt; projectIds = storageIo.getProjects(userId);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">    if (projectIds.size() == 0) {</span>
<span class="nc" id="L146">      throw new IllegalArgumentException(&quot;No projects to download&quot;);</span>
    }

<span class="nc" id="L149">    ByteArrayOutputStream zipFile = new ByteArrayOutputStream();</span>
<span class="nc" id="L150">    ZipOutputStream out = new ZipOutputStream(zipFile);</span>
<span class="nc" id="L151">    int count = 0;</span>
<span class="nc" id="L152">    String metadata = &quot;&quot;;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">    for (Long projectId : projectIds) {</span>
      try {
        // Note: We never include Yail files when exporting all source projects
        // even for Admins. If you are an admin and want to debug a project, download
        // it explicitly.
<span class="nc" id="L158">        ProjectSourceZip projectSourceZip =</span>
<span class="nc" id="L159">          exportProjectSourceZip(userId, projectId, false, false, null, false, false, false, false);</span>
<span class="nc" id="L160">        byte[] data = projectSourceZip.getContent();</span>
<span class="nc" id="L161">        String name = projectSourceZip.getFileName();</span>

        // If necessary, rename duplicate projects
        while (true) {
          try {
<span class="nc" id="L166">            out.putNextEntry(new ZipEntry(name));</span>
<span class="nc" id="L167">            break;</span>
<span class="nc" id="L168">          } catch (IOException e) {</span>
<span class="nc" id="L169">            name = &quot;duplicate-&quot; + name;</span>
<span class="nc" id="L170">          }</span>
        }
<span class="nc" id="L172">        metadata += projectSourceZip.getMetadata() + &quot;\n&quot;;</span>

<span class="nc" id="L174">        out.write(data, 0, data.length);</span>
<span class="nc" id="L175">        out.closeEntry();</span>
<span class="nc" id="L176">        count++;</span>
<span class="nc" id="L177">      } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L178">        System.err.println(&quot;No files found for userid: &quot; + userId +</span>
            &quot; for projectid: &quot; + projectId);
<span class="nc" id="L180">        continue;</span>
<span class="nc" id="L181">      } catch (IOException e) {</span>
<span class="nc" id="L182">        System.err.println(&quot;IOException while reading files found for userid: &quot; +</span>
            userId + &quot; for projectid: &quot; + projectId);
<span class="nc" id="L184">        continue;</span>
<span class="nc" id="L185">      }</span>
<span class="nc" id="L186">    }</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">    if (count == 0) {</span>
<span class="nc" id="L188">      throw new IllegalArgumentException(&quot;No files to download&quot;);</span>
    }

<span class="nc" id="L191">    List&lt;String&gt; userFiles = storageIo.getUserFiles(userId);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">    if (userFiles.contains(StorageUtil.ANDROID_KEYSTORE_FILENAME)) {</span>
<span class="nc" id="L193">      byte[] androidKeystoreBytes =</span>
<span class="nc" id="L194">          storageIo.downloadRawUserFile(userId, StorageUtil.ANDROID_KEYSTORE_FILENAME);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">      if (androidKeystoreBytes.length &gt; 0) {</span>
<span class="nc" id="L196">        out.putNextEntry(new ZipEntry(StorageUtil.ANDROID_KEYSTORE_FILENAME));</span>
<span class="nc" id="L197">        out.write(androidKeystoreBytes, 0, androidKeystoreBytes.length);</span>
<span class="nc" id="L198">        out.closeEntry();</span>
<span class="nc" id="L199">        count++;</span>
      }
    }

<span class="nc" id="L203">    out.close();</span>

    // Package the big zip file up as a ProjectSourceZip and return it.
<span class="nc" id="L206">    byte[] content = zipFile.toByteArray();</span>
<span class="nc" id="L207">    ProjectSourceZip projectSourceZip = new ProjectSourceZip(zipName, content, count);</span>
<span class="nc" id="L208">    projectSourceZip.setMetadata(metadata);</span>
<span class="nc" id="L209">    return projectSourceZip;</span>
  }

  @Override
  public RawFile exportFile(String userId, long projectId, String filePath) throws IOException {
    // Download a specific project file.
    try {
<span class="fc" id="L216">      byte[] content = storageIo.downloadRawFile(userId, projectId, filePath);</span>
<span class="fc" id="L217">      return new RawFile(StorageUtil.basename(filePath), content);</span>
<span class="fc" id="L218">    } catch (RuntimeException e) {</span>
      
<span class="fc" id="L220">      throw new RuntimeException(&quot;Error downloading project file: &quot; + filePath</span>
          + &quot;user=&quot; + userId + &quot;, project=&quot; + projectId, e);
    }
  }

  @Override
  public RawFile exportUserFile(String userId, String filePath) throws IOException {
    // Download a specific user file.
    try {
<span class="nc" id="L229">      byte[] content = storageIo.downloadRawUserFile(userId, filePath);</span>
<span class="nc" id="L230">      return new RawFile(StorageUtil.basename(filePath), content);</span>
<span class="nc" id="L231">    } catch (RuntimeException e) {</span>
<span class="nc" id="L232">      throw new RuntimeException(&quot;Error downloading user file: &quot; + filePath</span>
          + &quot;user=&quot; + userId, e);
    }
  }

  /*
   * Filters a list of file names, removing those that don't start with the given prefix.
   */
  private List&lt;String&gt; filterByFilePrefix(List&lt;String&gt; files, String prefix) {
<span class="fc" id="L241">    List&lt;String&gt; filteredFiles = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">    for (String file : files) {</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">      if (file.startsWith(prefix)) {</span>
<span class="fc" id="L244">        filteredFiles.add(file);</span>
      }
<span class="fc" id="L246">    }</span>
<span class="fc" id="L247">    return filteredFiles;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>