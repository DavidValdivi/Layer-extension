<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>YoungAndroidPalettePanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.editor.youngandroid.palette</a> &gt; <span class="el_source">YoungAndroidPalettePanel.java</span></div><h1>YoungAndroidPalettePanel.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2014 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.editor.youngandroid.palette;

import com.google.appinventor.client.ComponentsTranslation;
import com.google.appinventor.client.editor.simple.SimpleComponentDatabase;
import com.google.appinventor.client.editor.simple.components.MockComponent;
import com.google.appinventor.client.editor.simple.components.utils.PropertiesUtil;
import com.google.appinventor.client.editor.simple.palette.DropTargetProvider;
import com.google.appinventor.client.editor.simple.palette.SimpleComponentDescriptor;
import com.google.appinventor.client.editor.simple.palette.SimplePaletteItem;
import com.google.appinventor.client.editor.simple.palette.SimplePalettePanel;
import com.google.appinventor.client.editor.youngandroid.YaFormEditor;
import com.google.appinventor.client.explorer.project.ComponentDatabaseChangeListener;
import com.google.appinventor.client.wizards.ComponentImportWizard;
import com.google.appinventor.common.version.AppInventorFeatures;
import com.google.appinventor.components.common.ComponentCategory;
import com.google.gwt.core.client.JsArrayString;
import com.google.gwt.core.client.Scheduler;
import com.google.gwt.event.dom.client.BlurEvent;
import com.google.gwt.event.dom.client.BlurHandler;
import com.google.gwt.event.dom.client.ChangeEvent;
import com.google.gwt.event.dom.client.ChangeHandler;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.user.client.ui.Anchor;
import com.google.gwt.user.client.ui.Composite;
import com.google.gwt.user.client.ui.HasHorizontalAlignment;
import com.google.gwt.user.client.ui.StackPanel;
import com.google.gwt.user.client.ui.VerticalPanel;
import com.google.gwt.user.client.ui.TextBox;
import com.google.gwt.event.dom.client.KeyPressEvent;
import com.google.gwt.event.dom.client.KeyUpEvent;
import com.google.gwt.event.dom.client.KeyDownEvent;
import com.google.gwt.event.dom.client.KeyCodes;
import com.google.gwt.event.dom.client.KeyPressHandler;
import com.google.gwt.event.dom.client.KeyUpHandler;
import com.google.gwt.event.dom.client.KeyDownHandler;

import jsinterop.annotations.JsOverlay;
import jsinterop.annotations.JsType;

import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.*;

import static com.google.appinventor.client.Ode.MESSAGES;

/**
 * Panel showing Simple components which can be dropped onto the Young Android
 * visual designer panel.
 *
 * @author lizlooney@google.com (Liz Looney)
 */
public class YoungAndroidPalettePanel extends Composite implements SimplePalettePanel, ComponentDatabaseChangeListener {

  // Component database: information about components (including their properties and events)
  private final SimpleComponentDatabase COMPONENT_DATABASE;

  // Associated editor
  private final YaFormEditor editor;

  private final Map&lt;ComponentCategory, PaletteHelper&gt; paletteHelpers;

  private final StackPanel stackPalette;
  private final Map&lt;ComponentCategory, VerticalPanel&gt; categoryPanels;
  // store Component Type along with SimplePaleteItem to enable removal of components
  private final Map&lt;String, SimplePaletteItem&gt; simplePaletteItems;

  private DropTargetProvider dropTargetProvider;
  private List&lt;Integer&gt; categoryOrder;

  // panel that holds all palette items
  final VerticalPanel panel;
  // Map translated component names to English names
  private final Map&lt;String, String&gt; translationMap;

  private final TextBox searchText; 
  private final VerticalPanel searchResults;
<span class="nc" id="L87">  private JsArrayString arrayString = (JsArrayString) JsArrayString.createArray();</span>
<span class="nc" id="L88">  private String lastSearch = &quot;&quot;;</span>
<span class="nc" id="L89">  private Map&lt;String, SimplePaletteItem&gt; searchSimplePaletteItems =</span>
      new HashMap&lt;String, SimplePaletteItem&gt;();

  @SuppressWarnings(&quot;checkstyle:LineLength&quot;)
  private native NativeArray filter(String match)/*-{
    return this.@com.google.appinventor.client.editor.youngandroid.palette.YoungAndroidPalettePanel::arrayString.filter(function(x) { return x.indexOf(match) &gt;= 0 });
  }-*/;

  @SuppressWarnings(&quot;checkstyle:LineLength&quot;)
  private native void sort()/*-{
    this.@com.google.appinventor.client.editor.youngandroid.palette.YoungAndroidPalettePanel::arrayString.sort();
  }-*/;

<span class="nc" id="L102">  private Scheduler.ScheduledCommand rebuild = null;</span>

  private void requestRebuildList() {
<span class="nc bnc" id="L105" title="All 2 branches missed.">    if (rebuild != null) {</span>
<span class="nc" id="L106">      return;</span>
    }

<span class="nc" id="L109">    rebuild = new Scheduler.ScheduledCommand() {</span>
      @Override
      public void execute() {
<span class="nc" id="L112">        arrayString.setLength(0);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">        for (String s : translationMap.keySet()) {</span>
<span class="nc" id="L114">          arrayString.push(s);</span>
<span class="nc" id="L115">        }</span>
<span class="nc" id="L116">        sort();</span>
        // Refresh the list by repeating the search
<span class="nc" id="L118">        doSearch(true);</span>
<span class="nc" id="L119">        rebuild = null;</span>
<span class="nc" id="L120">      }</span>
    };
<span class="nc" id="L122">    Scheduler.get().scheduleDeferred(rebuild);</span>
<span class="nc" id="L123">  }</span>

  @JsType
  public static class NativeArray extends JsArrayString implements Iterable&lt;String&gt; {
<span class="nc" id="L127">    protected NativeArray() {</span>
<span class="nc" id="L128">    }</span>

    @Override
    @JsOverlay
    public final Iterator&lt;String&gt; iterator() {
<span class="nc" id="L133">      return new Iterator&lt;String&gt;() {</span>
<span class="nc" id="L134">        int index = 0;</span>

        @Override
        public boolean hasNext() {
<span class="nc bnc" id="L138" title="All 2 branches missed.">          return index &lt; NativeArray.this.length();</span>
        }

        @Override
        public String next() {
<span class="nc" id="L143">          return NativeArray.this.get(index++);</span>
        }
      };
    }
  }

  /**
   * Creates a new component palette panel.
   *
   * @param editor parent editor of this panel
   */
<span class="nc" id="L154">  public YoungAndroidPalettePanel(YaFormEditor editor) {</span>
<span class="nc" id="L155">    this.editor = editor;</span>
<span class="nc" id="L156">    COMPONENT_DATABASE = SimpleComponentDatabase.getInstance(editor.getProjectId());</span>

<span class="nc" id="L158">    stackPalette = new StackPanel();</span>

<span class="nc" id="L160">    paletteHelpers = new HashMap&lt;ComponentCategory, PaletteHelper&gt;();</span>
    // If a category has a palette helper, add it to the paletteHelpers map here.
<span class="nc" id="L162">    paletteHelpers.put(ComponentCategory.LEGOMINDSTORMS, new LegoPaletteHelper());</span>

<span class="nc" id="L164">    categoryPanels = new HashMap&lt;ComponentCategory, VerticalPanel&gt;();</span>
<span class="nc" id="L165">    simplePaletteItems = new HashMap&lt;String, SimplePaletteItem&gt;();</span>
<span class="nc" id="L166">    categoryOrder = new ArrayList&lt;Integer&gt;();</span>

<span class="nc" id="L168">    translationMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L169">    panel = new VerticalPanel();</span>
<span class="nc" id="L170">    panel.setWidth(&quot;100%&quot;);</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">    for (String component : COMPONENT_DATABASE.getComponentNames()) {</span>
<span class="nc" id="L173">      String translationName = ComponentsTranslation.getComponentName(component).toLowerCase();</span>
<span class="nc" id="L174">      arrayString.push(translationName);</span>
<span class="nc" id="L175">      translationMap.put(translationName, component);</span>
<span class="nc" id="L176">    }</span>

<span class="nc" id="L178">    searchText = new TextBox();</span>
<span class="nc" id="L179">    searchText.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L180">    searchText.getElement().setPropertyString(&quot;placeholder&quot;, MESSAGES.searchComponents());</span>
<span class="nc" id="L181">    searchText.getElement().setAttribute(&quot;style&quot;, &quot;width: 100%; box-sizing: border-box;&quot;);</span>

<span class="nc" id="L183">    searchText.addKeyUpHandler(new SearchKeyUpHandler());</span>
<span class="nc" id="L184">    searchText.addKeyPressHandler(new ReturnKeyHandler());</span>
<span class="nc" id="L185">    searchText.addKeyDownHandler(new EscapeKeyDownHandler());</span>
<span class="nc" id="L186">    searchText.addBlurHandler(new BlurHandler() {</span>
      @Override
      public void onBlur(BlurEvent event) {
<span class="nc" id="L189">        doSearch();</span>
<span class="nc" id="L190">      }</span>
    });
<span class="nc" id="L192">    searchText.addChangeHandler(new ChangeHandler() {</span>
      @Override
      public void onChange(ChangeEvent event) {
<span class="nc" id="L195">        doSearch();</span>
<span class="nc" id="L196">      }</span>
    });

<span class="nc" id="L199">    panel.setSpacing(3);</span>
<span class="nc" id="L200">    panel.add(searchText);</span>
<span class="nc" id="L201">    panel.setWidth(&quot;100%&quot;);</span>

<span class="nc" id="L203">    searchResults = new VerticalPanel();</span>
<span class="nc" id="L204">    searchResults.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L205">    stackPalette.setWidth(&quot;100%&quot;);</span>

<span class="nc" id="L207">    initWidget(panel);</span>
<span class="nc" id="L208">    panel.add(searchResults);</span>
<span class="nc" id="L209">    panel.add(stackPalette);</span>

<span class="nc bnc" id="L211" title="All 2 branches missed.">    for (ComponentCategory category : ComponentCategory.values()) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">      if (showCategory(category)) {</span>
<span class="nc" id="L213">        VerticalPanel categoryPanel = new VerticalPanel();</span>
<span class="nc" id="L214">        categoryPanel.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L215">        categoryPanels.put(category, categoryPanel);</span>
        // The production version will not include a mapping for Extension because
        // only compile-time categories are included. This allows us to i18n the
        // Extension title for the palette.
<span class="nc bnc" id="L219" title="All 2 branches missed.">        String title = ComponentCategory.EXTENSION.equals(category) ?</span>
<span class="nc" id="L220">          MESSAGES.extensionComponentPallette() :</span>
<span class="nc" id="L221">          ComponentsTranslation.getCategoryName(category.getName());</span>
<span class="nc" id="L222">        stackPalette.add(categoryPanel, title);</span>
      }
    }

<span class="nc" id="L226">    initExtensionPanel();</span>
<span class="nc" id="L227">  }</span>

   /**
   *  Automatic search and list results as users input the string
   */
<span class="nc" id="L232">  private class SearchKeyUpHandler implements KeyUpHandler {</span>
    @Override
    public void onKeyUp(KeyUpEvent event) {
<span class="nc" id="L235">      doSearch();</span>
<span class="nc" id="L236">    }</span>
  }

  /**
   *  Users press escape button, results and searchText will be cleared
   */
<span class="nc" id="L242">  private class EscapeKeyDownHandler implements KeyDownHandler {</span>
    @Override
    public void onKeyDown(KeyDownEvent event) {
<span class="nc bnc" id="L245" title="All 2 branches missed.">      if (event.getNativeKeyCode() == KeyCodes.KEY_ESCAPE) {</span>
<span class="nc" id="L246">        searchResults.clear();</span>
<span class="nc" id="L247">        searchText.setText(&quot;&quot;);</span>
      }
<span class="nc" id="L249">    }</span>
  }

  /**
   *  Users press enter button, results will be added to searchResults panel
   */
<span class="nc" id="L255">  private class ReturnKeyHandler implements KeyPressHandler {</span>
     @Override
      public void onKeyPress(KeyPressEvent event) {
<span class="nc bnc" id="L258" title="All 2 branches missed.">        switch (event.getCharCode()) {</span>
          case KeyCodes.KEY_END:
          case KeyCodes.KEY_DELETE:
          case KeyCodes.KEY_BACKSPACE:
<span class="nc" id="L262">            doSearch();</span>
            break;
        }
<span class="nc" id="L265">      }</span>
  }

  private void doSearch() {
<span class="nc" id="L269">    doSearch(false);</span>
<span class="nc" id="L270">  }</span>

  /**
   *  User clicks on searchButton and results will be added to searchResults panel
   */
  private void doSearch(boolean force) {
<span class="nc" id="L276">    String search_str = searchText.getText().trim().toLowerCase();</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">    if (search_str.equals(lastSearch) &amp;&amp; !force) {</span>
      // nothing to do here.
<span class="nc" id="L279">      return;</span>
    }
    // Empty strings will return nothing
<span class="nc bnc" id="L282" title="All 2 branches missed.">    if (search_str.length() != 0) {</span>
<span class="nc" id="L283">      long start = System.currentTimeMillis();</span>
      // Remove previous search results
<span class="nc" id="L285">      searchResults.clear();</span>
<span class="nc" id="L286">      Iterable&lt;String&gt; allComponents = filter(search_str);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">      for (String name : allComponents) {</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (translationMap.containsKey(name)) {</span>
<span class="nc" id="L289">          final String codeName = translationMap.get(name);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">          if (simplePaletteItems.containsKey(codeName)) {</span>
<span class="nc" id="L291">            searchResults.add(searchSimplePaletteItems.get(codeName));</span>
          }
        }
<span class="nc" id="L294">      }</span>
<span class="nc" id="L295">    } else {</span>
<span class="nc" id="L296">      searchResults.clear();</span>
    }
<span class="nc" id="L298">    lastSearch = search_str;</span>
<span class="nc" id="L299">  }</span>

  private static boolean showCategory(ComponentCategory category) {
<span class="nc bnc" id="L302" title="All 2 branches missed.">    if (category == ComponentCategory.UNINITIALIZED) {</span>
<span class="nc" id="L303">      return false;</span>
    }
    // We should only show FUTURE components if the future feature flag is enabled...
<span class="nc bnc" id="L306" title="All 2 branches missed.">    if (category == ComponentCategory.FUTURE &amp;&amp;</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">        !AppInventorFeatures.enableFutureFeatures()) {</span>
<span class="nc" id="L308">      return false;</span>
    }
<span class="nc bnc" id="L310" title="All 2 branches missed.">    if (category == ComponentCategory.INTERNAL &amp;&amp;</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">        !AppInventorFeatures.showInternalComponentsCategory()) {</span>
<span class="nc" id="L312">      return false;</span>
    }
<span class="nc" id="L314">    return true;</span>
  }

  /**
   * Loads all components to be shown on this palette.  Specifically, for
   * each component (except for those whose category is UNINITIALIZED, or
   * whose category is INTERNAL and we're running on a production server,
   * or who are specifically marked as not to be shown on the palette),
   * this creates a corresponding {@link SimplePaletteItem} with the passed
   * {@link DropTargetProvider} and adds it to the panel corresponding to
   * its category.
   *
   * @param dropTargetProvider provider of targets that palette items can be
   *                           dropped on
   */
  @Override
  public void loadComponents(DropTargetProvider dropTargetProvider) {
<span class="nc" id="L331">    this.dropTargetProvider = dropTargetProvider;</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">    for (String component : COMPONENT_DATABASE.getComponentNames()) {</span>
<span class="nc" id="L333">      this.addComponent(component);</span>
<span class="nc" id="L334">    }</span>
<span class="nc" id="L335">  }</span>

  public void loadComponents() {
<span class="nc bnc" id="L338" title="All 2 branches missed.">    for (String component : COMPONENT_DATABASE.getComponentNames()) {</span>
<span class="nc" id="L339">      this.addComponent(component);</span>
<span class="nc" id="L340">    }</span>
<span class="nc" id="L341">  }</span>

  @Override
  public void configureComponent(MockComponent mockComponent) {
<span class="nc" id="L345">    String componentType = mockComponent.getType();</span>
<span class="nc" id="L346">    PropertiesUtil.populateProperties(mockComponent,</span>
<span class="nc" id="L347">        COMPONENT_DATABASE.getPropertyDefinitions(componentType), editor);</span>
<span class="nc" id="L348">  }</span>

  /**
   *  Loads a single Component to Palette. Used for adding Components.
   */
  @Override
  public void addComponent(String componentTypeName) {
<span class="nc bnc" id="L355" title="All 2 branches missed.">    if (simplePaletteItems.containsKey(componentTypeName)) { // We are upgrading</span>
<span class="nc" id="L356">      removeComponent(componentTypeName);</span>
    }
<span class="nc" id="L358">    int version = COMPONENT_DATABASE.getComponentVersion(componentTypeName);</span>
<span class="nc" id="L359">    String versionName = COMPONENT_DATABASE.getComponentVersionName(componentTypeName);</span>
<span class="nc" id="L360">    String dateBuilt = COMPONENT_DATABASE.getComponentBuildDate(componentTypeName);</span>
<span class="nc" id="L361">    String helpString = COMPONENT_DATABASE.getHelpString(componentTypeName);</span>
<span class="nc" id="L362">    String helpUrl = COMPONENT_DATABASE.getHelpUrl(componentTypeName);</span>
<span class="nc" id="L363">    String categoryDocUrlString = COMPONENT_DATABASE.getCategoryDocUrlString(componentTypeName);</span>
<span class="nc" id="L364">    String categoryString = COMPONENT_DATABASE.getCategoryString(componentTypeName);</span>
<span class="nc" id="L365">    Boolean showOnPalette = COMPONENT_DATABASE.getShowOnPalette(componentTypeName);</span>
<span class="nc" id="L366">    Boolean nonVisible = COMPONENT_DATABASE.getNonVisible(componentTypeName);</span>
<span class="nc" id="L367">    Boolean external = COMPONENT_DATABASE.getComponentExternal(componentTypeName);</span>
<span class="nc" id="L368">    ComponentCategory category = ComponentCategory.valueOf(categoryString);</span>
<span class="nc bnc" id="L369" title="All 4 branches missed.">    if (showOnPalette &amp;&amp; showCategory(category)) {</span>
<span class="nc" id="L370">      SimplePaletteItem item = new SimplePaletteItem(</span>
          new SimpleComponentDescriptor(componentTypeName, editor, version, versionName, dateBuilt, helpString, helpUrl,
<span class="nc" id="L372">              categoryDocUrlString, showOnPalette, nonVisible, external),</span>
            dropTargetProvider);
<span class="nc" id="L374">      simplePaletteItems.put(componentTypeName, item);</span>
<span class="nc" id="L375">      addPaletteItem(item, category);</span>

      // Make a second copy for the search mechanism
<span class="nc" id="L378">      item = new SimplePaletteItem(</span>
          new SimpleComponentDescriptor(componentTypeName, editor, version, versionName, dateBuilt,
<span class="nc" id="L380">              helpString, helpUrl, categoryDocUrlString, showOnPalette, nonVisible, external),</span>
          dropTargetProvider);
      // Handle extensions
<span class="nc bnc" id="L383" title="All 2 branches missed.">      if (external) {</span>
<span class="nc" id="L384">        translationMap.put(componentTypeName.toLowerCase(), componentTypeName);</span>
<span class="nc" id="L385">        requestRebuildList();</span>
      }
<span class="nc" id="L387">      searchSimplePaletteItems.put(componentTypeName, item);</span>
    }
<span class="nc" id="L389">  }</span>

  public void removeComponent(String componentTypeName) {
<span class="nc" id="L392">    String categoryString = COMPONENT_DATABASE.getCategoryString(componentTypeName);</span>
<span class="nc" id="L393">    ComponentCategory category = ComponentCategory.valueOf(categoryString);</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">    if (simplePaletteItems.containsKey(componentTypeName)) {</span>
<span class="nc" id="L395">      removePaletteItem(simplePaletteItems.get(componentTypeName), category);</span>
<span class="nc" id="L396">      simplePaletteItems.remove(componentTypeName);</span>
    }
<span class="nc bnc" id="L398" title="All 2 branches missed.">    if (category == ComponentCategory.EXTENSION) {</span>
<span class="nc" id="L399">      searchSimplePaletteItems.remove(componentTypeName);</span>
<span class="nc" id="L400">      translationMap.remove(componentTypeName);</span>
<span class="nc" id="L401">      requestRebuildList();</span>
    }
<span class="nc" id="L403">  }</span>

  /*
   * Adds a component entry to the palette.
   */
  private void addPaletteItem(SimplePaletteItem component, ComponentCategory category) {
<span class="nc" id="L409">    VerticalPanel panel = categoryPanels.get(category);</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">    if (panel == null) {</span>
<span class="nc" id="L411">      panel = addComponentCategory(category);</span>
    }
<span class="nc" id="L413">    PaletteHelper paletteHelper = paletteHelpers.get(category);</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">    if (paletteHelper != null) {</span>
<span class="nc" id="L415">      paletteHelper.addPaletteItem(panel, component);</span>
    } else {
<span class="nc" id="L417">      panel.add(component);</span>
    }
<span class="nc" id="L419">  }</span>

  private VerticalPanel addComponentCategory(ComponentCategory category) {
<span class="nc" id="L422">    VerticalPanel panel = new VerticalPanel();</span>
<span class="nc" id="L423">    panel.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L424">    categoryPanels.put(category, panel);</span>
    // The production version will not include a mapping for Extension because
    // only compile-time categories are included. This allows us to i18n the
    // Extension title for the palette.
<span class="nc" id="L428">    int insert_index = Collections.binarySearch(categoryOrder, category.ordinal());</span>
<span class="nc" id="L429">    insert_index = - insert_index - 1;</span>
<span class="nc" id="L430">    stackPalette.insert(panel, insert_index);</span>
<span class="nc" id="L431">    String title = &quot;&quot;;</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">    if (ComponentCategory.EXTENSION.equals(category)) {</span>
<span class="nc" id="L433">      title = MESSAGES.extensionComponentPallette();</span>
<span class="nc" id="L434">      initExtensionPanel();</span>
    } else {
<span class="nc" id="L436">      title = ComponentsTranslation.getCategoryName(category.getName());</span>
    }
<span class="nc" id="L438">    stackPalette.setStackText(insert_index, title);</span>
<span class="nc" id="L439">    categoryOrder.add(insert_index, category.ordinal());</span>
    // When the categories are loaded, we want the first one open, which will almost always be User Interface
<span class="nc" id="L441">    stackPalette.showStack(0);</span>
<span class="nc" id="L442">    return panel;</span>
  }

  private void removePaletteItem(SimplePaletteItem component, ComponentCategory category) {
<span class="nc" id="L446">    VerticalPanel panel = categoryPanels.get(category);</span>
<span class="nc" id="L447">    panel.remove(component);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">    if (panel.getWidgetCount() &lt; 1) {</span>
<span class="nc" id="L449">      stackPalette.remove(panel);</span>
<span class="nc" id="L450">      categoryPanels.remove(category);</span>
    }
<span class="nc" id="L452">  }</span>

  private void initExtensionPanel() {
<span class="nc" id="L455">    Anchor addComponentAnchor = new Anchor(MESSAGES.importExtensionMenuItem());</span>
<span class="nc" id="L456">    addComponentAnchor.setStylePrimaryName(&quot;ode-ExtensionAnchor&quot;);</span>
<span class="nc" id="L457">    addComponentAnchor.addClickHandler(new ClickHandler() {</span>
      @Override
      public void onClick(ClickEvent event) {
<span class="nc" id="L460">        new ComponentImportWizard().center();</span>
<span class="nc" id="L461">      }</span>
    });

<span class="nc" id="L464">    categoryPanels.get(ComponentCategory.EXTENSION).add(addComponentAnchor);</span>
<span class="nc" id="L465">    categoryPanels.get(ComponentCategory.EXTENSION).setCellHorizontalAlignment(</span>
        addComponentAnchor, HasHorizontalAlignment.ALIGN_CENTER);
<span class="nc" id="L467">  }</span>

  @Override
  public void onComponentTypeAdded(List&lt;String&gt; componentTypes) {
<span class="nc bnc" id="L471" title="All 2 branches missed.">    for (String componentType : componentTypes) {</span>
<span class="nc" id="L472">      this.addComponent(componentType);</span>
<span class="nc" id="L473">    }</span>
<span class="nc" id="L474">  }</span>

  @Override
  public boolean beforeComponentTypeRemoved(List&lt;String&gt; componentTypes) {
<span class="nc" id="L478">    boolean result = true;</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">    for (String componentType : componentTypes) {</span>
<span class="nc" id="L480">      this.removeComponent(componentType);</span>
<span class="nc" id="L481">    }</span>
<span class="nc" id="L482">    return result;</span>
  }

  @Override
  public void onComponentTypeRemoved(Map&lt;String, String&gt; componentTypes) {

<span class="nc" id="L488">  }</span>

  @Override
  public void onResetDatabase() {
<span class="nc" id="L492">    reloadComponents();</span>
<span class="nc" id="L493">  }</span>

  @Override
  public void clearComponents() {
<span class="nc bnc" id="L497" title="All 2 branches missed.">    for (ComponentCategory category : categoryPanels.keySet()) {</span>
<span class="nc" id="L498">      VerticalPanel panel = categoryPanels.get(category);</span>
<span class="nc" id="L499">      panel.clear();</span>
<span class="nc" id="L500">      stackPalette.remove(panel);</span>
<span class="nc" id="L501">    }</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">    for (PaletteHelper pal : paletteHelpers.values()) {</span>
<span class="nc" id="L503">      pal.clear();</span>
<span class="nc" id="L504">    }</span>
<span class="nc" id="L505">    categoryPanels.clear();</span>
<span class="nc" id="L506">    paletteHelpers.clear();</span>
<span class="nc" id="L507">    categoryOrder.clear();</span>
<span class="nc" id="L508">    simplePaletteItems.clear();</span>
<span class="nc" id="L509">  }</span>

  // Intended for use by Blocks Toolkit, which needs to be able to refresh without
  // bothering the loaded extensions
  public void clearComponentsExceptExtension() {
<span class="nc bnc" id="L514" title="All 2 branches missed.">    for (ComponentCategory category : categoryPanels.keySet()) {</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">      if (!ComponentCategory.EXTENSION.equals(category)) {</span>
<span class="nc" id="L516">        VerticalPanel panel = categoryPanels.get(category);</span>
<span class="nc" id="L517">        panel.clear();</span>
<span class="nc" id="L518">        stackPalette.remove(panel);</span>
      }
<span class="nc" id="L520">    }</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">    for (PaletteHelper pal : paletteHelpers.values()) {</span>
<span class="nc" id="L522">      pal.clear();</span>
<span class="nc" id="L523">    }</span>
<span class="nc" id="L524">    categoryPanels.clear();</span>
<span class="nc" id="L525">    paletteHelpers.clear();</span>
<span class="nc" id="L526">    categoryOrder.clear();</span>
<span class="nc" id="L527">    simplePaletteItems.clear();</span>
<span class="nc" id="L528">  }</span>


  @Override
  public void reloadComponents() {
<span class="nc" id="L533">    clearComponents();</span>
<span class="nc" id="L534">    loadComponents();</span>
<span class="nc" id="L535">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>