<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AssetManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client</a> &gt; <span class="el_source">AssetManager.java</span></div><h1>AssetManager.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2019 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client;

import com.google.appinventor.client.explorer.project.Project;
import com.google.appinventor.client.explorer.project.ProjectChangeListener;

import com.google.appinventor.client.output.OdeLog;

import com.google.appinventor.common.utils.StringUtils;

import com.google.appinventor.shared.rpc.project.ProjectNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidAssetNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidAssetsFolder;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidComponentNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidComponentsFolder;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidProjectNode;

import com.google.appinventor.shared.util.Base64Util;

import com.google.gwt.core.client.JavaScriptObject;
import com.google.gwt.core.client.JsArrayString;

import com.google.gwt.user.client.rpc.AsyncCallback;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import static com.google.appinventor.client.Ode.MESSAGES;

/**
 * Manage known assets and components for a project and arrange to send them to the
 * attached phone as necessary.
 *
 * @author jis@mit.edu (Jeffrey I. Schiller)
 */

public final class AssetManager implements ProjectChangeListener {

  private static class AssetInfo { // Describes one asset
    String fileId;
    byte [] fileContent;
    boolean loaded;         // true if already loaded to the repl (phone)
    boolean transferred;           // true if asset received on phone
  }

<span class="nc" id="L52">  private HashMap&lt;String, AssetInfo&gt; assets = null;</span>
  private long projectId;
  private Project project;
  private YoungAndroidAssetsFolder assetsFolder;
  private YoungAndroidComponentsFolder componentsFolder;
  private JavaScriptObject assetsTransferredCallback;
<span class="nc" id="L58">  private List&lt;String&gt; extensions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L59">  private int retryCount = 0;</span>
<span class="nc" id="L60">  private volatile int assetTransferProgress = 0;</span>

  private static AssetManager INSTANCE;
<span class="nc" id="L63">  private static boolean DEBUG = false;</span>
  private static final String ASSETS_FOLDER = &quot;assets&quot;;
  private static final String EXTERNAL_COMPS_FOLDER = &quot;external_comps&quot;;

<span class="nc" id="L67">  private AssetManager() {</span>
<span class="nc" id="L68">    exportMethodsToJavascript();</span>
<span class="nc" id="L69">  }</span>

  public static AssetManager getInstance() {
<span class="nc bnc" id="L72" title="All 2 branches missed.">    if (INSTANCE == null)</span>
<span class="nc" id="L73">      INSTANCE = new AssetManager();</span>
<span class="nc" id="L74">    return INSTANCE;</span>
  }

  public void loadAssets(long projectId) {

<span class="nc bnc" id="L79" title="All 2 branches missed.">    if (project != null) {    // In case we are changing projects, we toss old project listener</span>
<span class="nc" id="L80">      project.removeProjectChangeListener(this);</span>
    }

<span class="nc" id="L83">    this.projectId = projectId;</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">    if (DEBUG)</span>
<span class="nc" id="L85">      OdeLog.log(&quot;AssetManager: Loading assets for &quot; + projectId);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">    if (projectId != 0) {</span>
<span class="nc" id="L87">      project = Ode.getInstance().getProjectManager().getProject(projectId);</span>
<span class="nc" id="L88">      assetsFolder = ((YoungAndroidProjectNode) project.getRootNode()).getAssetsFolder();</span>
<span class="nc" id="L89">      componentsFolder = ((YoungAndroidProjectNode) project.getRootNode()).getComponentsFolder();</span>
<span class="nc" id="L90">      project.addProjectChangeListener(this);</span>
<span class="nc" id="L91">      assets = new HashMap&lt;String,AssetInfo&gt;();</span>
<span class="nc" id="L92">      extensions.clear();</span>
      // Add Asset Files
<span class="nc bnc" id="L94" title="All 2 branches missed.">      for (ProjectNode node : assetsFolder.getChildren()) {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (nodeFilter(node)) {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">          if (node.getChildren().iterator().hasNext()) {</span>
<span class="nc" id="L97">            loadAssets(node);</span>
<span class="nc" id="L98">            continue;</span>
          }
          else {
<span class="nc" id="L101">            assetSetup(node);</span>
          }
        }
<span class="nc" id="L104">      }</span>
      // Add Component Files
<span class="nc bnc" id="L106" title="All 2 branches missed.">      for (ProjectNode node : componentsFolder.getChildren()) {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (nodeFilter(node)) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">          if (node.getChildren().iterator().hasNext()) {</span>
<span class="nc" id="L109">            loadAssets(node);</span>
<span class="nc" id="L110">            continue;</span>
          }
          else {
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (node.getName().equals(&quot;classes.jar&quot;)) {</span>
<span class="nc" id="L114">              extensions.add(node.getFileId().split(&quot;/&quot;)[2]);</span>
            }
<span class="nc" id="L116">            assetSetup(node);</span>
          }
        }
<span class="nc" id="L119">      }</span>
    } else {
<span class="nc" id="L121">      project = null;</span>
<span class="nc" id="L122">      assetsFolder = null;</span>
<span class="nc" id="L123">      assetsTransferredCallback = null;</span>
<span class="nc" id="L124">      assets = null;</span>
    }
<span class="nc" id="L126">  }</span>

  /**
   * Recursively add
   * @param nodeFolder
   */
  public void loadAssets(ProjectNode nodeFolder) {
<span class="nc" id="L133">    long targetProjectId = nodeFolder.getProjectId();</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">    if (this.projectId != targetProjectId) { // We are on a different project so stop and change project</span>
<span class="nc" id="L135">      loadAssets(targetProjectId); // redo</span>
<span class="nc" id="L136">      return;</span>
    }
<span class="nc bnc" id="L138" title="All 2 branches missed.">    for (ProjectNode node : nodeFolder.getChildren()) {</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">      if (node.getChildren().iterator().hasNext()) {  // is a directory</span>
<span class="nc" id="L140">        loadAssets(node); // setup files inside it</span>
<span class="nc" id="L141">        continue;</span>
      }
<span class="nc" id="L143">      assetSetup(node); // is a file</span>
<span class="nc" id="L144">    }</span>
<span class="nc" id="L145">  }</span>

  private void assetSetup(ProjectNode node) {
<span class="nc" id="L148">    String fileId = node.getFileId();</span>
<span class="nc" id="L149">    AssetInfo assetInfo = new AssetInfo();</span>
<span class="nc" id="L150">    assetInfo.fileId = fileId;</span>
<span class="nc" id="L151">    assetInfo.loaded = false; // Set to true when it is loaded to the repl</span>
<span class="nc" id="L152">    assetInfo.transferred = false; // Set to true when asset is received on phone</span>
<span class="nc" id="L153">    assets.put(fileId, assetInfo);</span>
<span class="nc" id="L154">  }</span>

  /**
   * Filter that allows only specific nodes to be sent to AssetManager for Transfer
   * @param node
   * @return true to allow transfer
   */
  private boolean nodeFilter(ProjectNode node) {
<span class="nc" id="L162">    boolean allowAll = false; // Set to true to allow all Asset and Component Files!</span>
<span class="nc" id="L163">    boolean allow = false;</span>
<span class="nc" id="L164">    String name = node.getName();</span>
<span class="nc" id="L165">    String fileId = node.getFileId();</span>
    // Filter : For files in ASSETS_FOLDER
<span class="nc bnc" id="L167" title="All 2 branches missed.">    if (fileId.startsWith(ASSETS_FOLDER)) {</span>
<span class="nc" id="L168">      allow = true;</span>

      // Filter : For files in EXTERNAL_COMPS_FOLDER
<span class="nc bnc" id="L171" title="All 2 branches missed.">      if (fileId.startsWith(ASSETS_FOLDER + '/' + EXTERNAL_COMPS_FOLDER + '/')) {</span>
<span class="nc" id="L172">        allow = false;</span>

        // Filter : For files in directly in EXTERNAL_COMPS_FOLDER/COMP_FOLDER
<span class="nc" id="L175">        int depth = StringUtils.countMatches(fileId, &quot;/&quot;);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (depth == 3) {</span>

          // Filter : For classes.jar File
<span class="nc bnc" id="L179" title="All 2 branches missed.">          if (name.equals(&quot;classes.jar&quot;)) {</span>
<span class="nc" id="L180">            allow = true;</span>

          }
<span class="nc bnc" id="L183" title="All 2 branches missed.">        } else if (depth &gt; 3) {</span>
<span class="nc" id="L184">          String[] parts = fileId.split(&quot;/&quot;);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">          if (ASSETS_FOLDER.equals(parts[3])) {</span>
<span class="nc" id="L186">            return true;</span>
          }
        }
      }
    }
<span class="nc" id="L191">    return allow | allowAll;</span>
  }

  private void readIn(final AssetInfo assetInfo) {
<span class="nc" id="L195">    Ode.getInstance().getProjectService().loadraw2(projectId, assetInfo.fileId,</span>
<span class="nc" id="L196">      new AsyncCallback&lt;String&gt;() {</span>
        @Override
          public void onSuccess(String data) {
<span class="nc" id="L199">            assetTransferProgress++;</span>
<span class="nc" id="L200">            assetInfo.fileContent = Base64Util.decodeLines(data);</span>
<span class="nc" id="L201">            assetInfo.loaded = false; // Set to true when it is loaded to the repl</span>
<span class="nc" id="L202">            assetInfo.transferred = false; // Set to true when file is received on phone</span>
<span class="nc" id="L203">            refreshAssets1();</span>
<span class="nc" id="L204">          }</span>
        @Override
          public void onFailure(Throwable ex) {
<span class="nc bnc" id="L207" title="All 2 branches missed.">          if (retryCount &gt; 0) {</span>
<span class="nc" id="L208">            retryCount--;</span>
<span class="nc" id="L209">            readIn(assetInfo);</span>
          } else {
<span class="nc" id="L211">            OdeLog.elog(&quot;Failed to load asset.&quot;);</span>
          }
<span class="nc" id="L213">        }</span>
      });
<span class="nc" id="L215">  }</span>

  private void refreshAssets1(JavaScriptObject callback) {
<span class="nc" id="L218">    assetsTransferredCallback = callback;</span>
<span class="nc" id="L219">    assetTransferProgress = 0;</span>
<span class="nc" id="L220">    refreshAssets1();</span>
<span class="nc" id="L221">  }</span>

  private void refreshAssets1() {
<span class="nc" id="L224">    boolean loadInProgress = false;</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">    for (AssetInfo a : assets.values()) {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">      if (!a.loaded) {</span>
<span class="nc" id="L227">        loadInProgress = true;</span>
<span class="nc bnc" id="L228" title="All 4 branches missed.">        if (a.fileContent == null &amp;&amp; !hasFetchAssets()) { // Need to fetch it from the server</span>
<span class="nc" id="L229">          retryCount = 3;</span>
<span class="nc" id="L230">          ConnectProgressBar.setProgress(100 * assetTransferProgress / (2 * assets.size()),</span>
<span class="nc" id="L231">            MESSAGES.loadingAsset(a.fileId));</span>
<span class="nc" id="L232">          readIn(a);          // Read it in asynchronously</span>
<span class="nc" id="L233">          break;                     // we'll resume when we have it</span>
        } else {
<span class="nc" id="L235">          ConnectProgressBar.setProgress(100 * assetTransferProgress / (2 * assets.size()),</span>
<span class="nc" id="L236">            MESSAGES.sendingAssetToCompanion(a.fileId));</span>
<span class="nc" id="L237">          boolean didit = doPutAsset(Long.toString(projectId), a.fileId, a.fileContent);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">          if (didit) {</span>
<span class="nc" id="L239">            assetTransferProgress++;</span>
<span class="nc" id="L240">            a.loaded = true;</span>
<span class="nc" id="L241">            a.fileContent = null; // Save memory</span>
          }
        }
      }
<span class="nc" id="L245">    }</span>
    // If no assets are in the project, close the Progress Bar and
    // perform the callback immediately.
<span class="nc bnc" id="L248" title="All 4 branches missed.">    if (assets.values().size() == 0 || !loadInProgress) {</span>
<span class="nc" id="L249">      ConnectProgressBar.hide();</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">      if (assetsTransferredCallback != null) {</span>
<span class="nc" id="L251">        doCallBack(assetsTransferredCallback);</span>
      }
    }
<span class="nc" id="L254">  }</span>

  public static void refreshAssets(JavaScriptObject callback) {
<span class="nc bnc" id="L257" title="All 2 branches missed.">    if (INSTANCE == null)</span>
<span class="nc" id="L258">      return;</span>
<span class="nc" id="L259">    INSTANCE.refreshAssets1(callback);</span>
<span class="nc" id="L260">  }</span>

  public static void reset(String formName) {
<span class="nc bnc" id="L263" title="All 2 branches missed.">    if (INSTANCE == null)</span>
<span class="nc" id="L264">      return;</span>
<span class="nc" id="L265">    INSTANCE.reset1(formName);</span>
<span class="nc" id="L266">  }</span>

  public void reset1(String formName) {
<span class="nc" id="L269">    OdeLog.log(&quot;AssetManager: formName = &quot; + formName + &quot; received reset.&quot;);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">    for (AssetInfo a: assets.values()) {</span>
<span class="nc" id="L271">      a.loaded = false;</span>
<span class="nc" id="L272">      a.transferred = false;</span>
<span class="nc" id="L273">    }</span>
<span class="nc" id="L274">  }</span>

  public static boolean markAssetTransferred(String transferredAsset) {
<span class="nc bnc" id="L277" title="All 2 branches missed.">    if (INSTANCE == null)</span>
<span class="nc" id="L278">      return false;</span>
<span class="nc" id="L279">    INSTANCE.markAssetTransferred1(transferredAsset);</span>
<span class="nc" id="L280">    return true;</span>
  }

  public boolean markAssetTransferred1(String transferredAsset) {
<span class="nc bnc" id="L284" title="All 2 branches missed.">    if (transferredAsset == null)</span>
<span class="nc" id="L285">      return false;</span>
<span class="nc" id="L286">    AssetInfo assetInfo = INSTANCE.assets.get(transferredAsset);</span>
<span class="nc" id="L287">    assetInfo.transferred = true;</span>
    // Let's see if all assets are transferred. If so, fire the
    // assetsTransferredCallback
<span class="nc bnc" id="L290" title="All 2 branches missed.">    for (AssetInfo a : assets.values()) {</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">      if (!a.transferred) {     // Something didn't get transferred</span>
<span class="nc" id="L292">        return true;</span>
      }
<span class="nc" id="L294">    }</span>
    // Dismiss the progress bar if showing
<span class="nc" id="L296">    ConnectProgressBar.hide();</span>
    // If we get here, then all assets have been transferred to the device
    // so we fire the assetsTransferredCallback
<span class="nc" id="L299">    doCallBack(assetsTransferredCallback);</span>
<span class="nc" id="L300">    return  true;</span>
  }

  public static JsArrayString getExtensionsToLoad() {
<span class="nc" id="L304">    JsArrayString result = JsArrayString.createArray().cast();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">    if (INSTANCE != null) {</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">      for (String s : INSTANCE.extensions) {</span>
<span class="nc" id="L307">        result.push(s);</span>
<span class="nc" id="L308">      }</span>
    }
<span class="nc" id="L310">    return result;</span>
  }

  @Override
  public void onProjectLoaded(Project project) {
<span class="nc bnc" id="L315" title="All 2 branches missed.">    if (DEBUG)</span>
<span class="nc" id="L316">      OdeLog.log(&quot;AssetManager: got onProjectLoaded for &quot; + project.getProjectId() + &quot;, current project is &quot; + projectId);</span>
<span class="nc" id="L317">    loadAssets(project.getProjectId());</span>
<span class="nc" id="L318">  }</span>

  @Override
  public void onProjectNodeAdded(Project project, ProjectNode node) {
<span class="nc bnc" id="L322" title="All 2 branches missed.">    if (DEBUG)</span>
<span class="nc" id="L323">      OdeLog.log(&quot;AssetManager: got projectNodeAdded for node &quot; + node.getFileId()</span>
<span class="nc" id="L324">        + &quot; and project &quot;  + project.getProjectId() + &quot;, current project is &quot; + projectId);</span>
<span class="nc bnc" id="L325" title="All 4 branches missed.">    if (node instanceof YoungAndroidAssetNode || node instanceof YoungAndroidComponentNode) {</span>
<span class="nc" id="L326">      loadAssets(project.getProjectId());</span>
    }
<span class="nc" id="L328">  }</span>

  @Override
  public void onProjectNodeRemoved(Project project, ProjectNode node) {
<span class="nc bnc" id="L332" title="All 2 branches missed.">    if (DEBUG)</span>
<span class="nc" id="L333">      OdeLog.log(&quot;AssetManager: got onProjectNodeRemoved for node &quot; + node.getFileId()</span>
<span class="nc" id="L334">        + &quot; and project &quot;  + project.getProjectId() + &quot;, current project is &quot; + projectId);</span>
<span class="nc bnc" id="L335" title="All 4 branches missed.">    if (node instanceof YoungAndroidAssetNode || node instanceof YoungAndroidComponentNode) {</span>
<span class="nc" id="L336">      loadAssets(project.getProjectId());</span>
    }
<span class="nc" id="L338">  }</span>

  private static native void exportMethodsToJavascript() /*-{
    $wnd.AssetManager_refreshAssets =
      $entry(@com.google.appinventor.client.AssetManager::refreshAssets(Lcom/google/gwt/core/client/JavaScriptObject;));
    $wnd.AssetManager_reset =
      $entry(@com.google.appinventor.client.AssetManager::reset(Ljava/lang/String;));
    $wnd.AssetManager_markAssetTransferred =
      $entry(@com.google.appinventor.client.AssetManager::markAssetTransferred(Ljava/lang/String;));
    $wnd.AssetManager_getExtensions =
      $entry(@com.google.appinventor.client.AssetManager::getExtensionsToLoad());
  }-*/;

  private static native boolean doPutAsset(String projectId, String filename, byte[] content) /*-{
    return Blockly.ReplMgr.putAsset(projectId, filename, content, function() { window.parent.AssetManager_markAssetTransferred(filename) });
  }-*/;

  private static native void doCallBack(JavaScriptObject callback) /*-{
    if (typeof callback === 'function') callback.call(null);
  }-*/;

  private static native boolean useWebRTC() /*-{
    return top.usewebrtc;
  }-*/;

  private static native boolean hasFetchAssets() /*-{
    return top.ReplState.hasfetchassets;
  }-*/;

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>