<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TopPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client</a> &gt; <span class="el_source">TopPanel.java</span></div><h1>TopPanel.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2012 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client;

import com.google.appinventor.client.boxes.MotdBox;
import com.google.appinventor.client.boxes.ProjectListBox;

import com.google.appinventor.client.explorer.commands.ChainableCommand;
import com.google.appinventor.client.explorer.commands.SaveAllEditorsCommand;

import com.google.appinventor.client.tracking.Tracking;

import com.google.appinventor.client.widgets.DropDownButton.DropDownItem;
import com.google.appinventor.client.widgets.DropDownButton;
import com.google.appinventor.client.widgets.TextButton;

import com.google.appinventor.shared.rpc.project.ProjectRootNode;
import com.google.appinventor.shared.rpc.user.Config;
import com.google.common.base.Strings;
import com.google.common.collect.Lists;
import com.google.gwt.core.client.GWT;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.http.client.UrlBuilder;

import com.google.gwt.i18n.client.Dictionary;
import com.google.gwt.i18n.client.LocaleInfo;
import com.google.gwt.resources.client.ClientBundle;
import com.google.gwt.resources.client.TextResource;
import com.google.gwt.user.client.Command;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.ui.Composite;
import com.google.gwt.user.client.ui.HorizontalPanel;
import com.google.gwt.user.client.ui.Image;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.VerticalPanel;

import java.util.List;
import java.util.MissingResourceException;

import static com.google.appinventor.client.Ode.MESSAGES;

/**
 * The top panel, which contains the main menu, various links plus ads.
 *
 */
public class TopPanel extends Composite {
  // Strings for links and dropdown menus:
  private final DropDownButton accountButton;
  public DropDownButton languageDropDown;

<span class="nc" id="L56">  private final String WIDGET_NAME_SIGN_OUT = &quot;Signout&quot;;</span>
<span class="nc" id="L57">  private final String WIDGET_NAME_USER = &quot;User&quot;;</span>
  private static final String WIDGET_NAME_LANGUAGE = &quot;Language&quot;;
<span class="nc" id="L59">  private final String WIDGET_NAME_DELETE_ACCOUNT = &quot;DeleteAccount&quot;;</span>

  private static final String SIGNOUT_URL = &quot;/ode/_logout&quot;;
  private static final String LOGO_IMAGE_URL = &quot;/static/images/codi_long.png&quot;;

  private static final String WINDOW_OPEN_FEATURES = &quot;menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yes&quot;;
  private static final String WINDOW_OPEN_LOCATION = &quot;_ai2&quot;;

  private final VerticalPanel rightPanel;  // remember this so we can add MOTD later if needed

<span class="nc" id="L69">  final Ode ode = Ode.getInstance();</span>

  interface Translations extends ClientBundle {
<span class="nc" id="L72">    Translations INSTANCE = GWT.create(Translations.class);</span>

    @Source(&quot;languages.json&quot;)
    TextResource languages();
  }

  static {
<span class="nc" id="L79">    loadLanguages(Translations.INSTANCE.languages().getText());</span>
<span class="nc" id="L80">    LANGUAGES = Dictionary.getDictionary(&quot;LANGUAGES&quot;);</span>
<span class="nc" id="L81">  }</span>

  private static native void loadLanguages(String resource)/*-{
    $wnd['LANGUAGES'] = JSON.parse(resource);
  }-*/;

  private static final Dictionary LANGUAGES;

  /**
   * Initializes and assembles all UI elements shown in the top panel.
   */
<span class="nc" id="L92">  public TopPanel() {</span>
    /*
     * The layout of the top panel is as follows:
     *
     *  +-- topPanel ------------------------------------+
     *  |+-- logo --++-----tools-----++--links/account--+|
     *  ||          ||               ||                 ||
     *  |+----------++---------------++-----------------+|
     *  +------------------------------------------------+
     */
<span class="nc" id="L102">    HorizontalPanel topPanel = new HorizontalPanel();</span>
<span class="nc" id="L103">    topPanel.setVerticalAlignment(HorizontalPanel.ALIGN_MIDDLE);</span>

    // Create the Tools
<span class="nc" id="L106">    TopToolbar tools = new TopToolbar();</span>
<span class="nc" id="L107">    ode.setTopToolbar(tools);</span>

    // Create the Links
<span class="nc" id="L110">    HorizontalPanel links = new HorizontalPanel();</span>
<span class="nc" id="L111">    links.setStyleName(&quot;ode-TopPanelLinks&quot;);</span>
<span class="nc" id="L112">    links.setVerticalAlignment(HorizontalPanel.ALIGN_MIDDLE);</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">    if (Ode.getInstance().isReadOnly()) {</span>
<span class="nc" id="L115">      Label readOnly = new Label(MESSAGES.readOnlyMode());</span>
<span class="nc" id="L116">      readOnly.setStyleName(&quot;ode-TopPanelWarningLabel&quot;);</span>
<span class="nc" id="L117">      links.add(readOnly);</span>
    }

    // My Projects Link
<span class="nc" id="L121">    TextButton myProjects = new TextButton(MESSAGES.myProjectsTabName());</span>
<span class="nc" id="L122">    myProjects.setStyleName(&quot;ode-TopPanelButton&quot;);</span>

<span class="nc" id="L124">    myProjects.addClickHandler(new ClickHandler() {</span>
      @Override
      public void onClick(ClickEvent event) {
<span class="nc" id="L127">        Ode.getInstance().getTopToolbar().updateMoveToTrash(&quot;Move To Trash&quot;);</span>
<span class="nc" id="L128">        ode.switchToProjectsView();</span>
<span class="nc" id="L129">      }</span>
    });

<span class="nc" id="L132">    myProjects.setStyleName(&quot;ode-TopPanelButton&quot;);</span>
<span class="nc" id="L133">    links.add(myProjects);</span>

    // View Trash Link
<span class="nc" id="L136">    TextButton viewTrash = new TextButton(MESSAGES.viewTrashTabName());</span>
<span class="nc" id="L137">    viewTrash.setStyleName(&quot;ode-TopPanelButton&quot;);</span>
<span class="nc" id="L138">    viewTrash.addClickHandler(new ClickHandler() {</span>
      @Override
      public void onClick(ClickEvent event) {
<span class="nc" id="L141">        ode.switchToTrash();</span>
<span class="nc" id="L142">      }</span>
    });
<span class="nc" id="L144">    links.add(viewTrash);</span>

<span class="nc" id="L146">    Config config = ode.getSystemConfig();</span>
<span class="nc" id="L147">    String guideUrl = config.getGuideUrl();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">    if (!Strings.isNullOrEmpty(guideUrl)) {</span>
<span class="nc" id="L149">      TextButton guideLink = new TextButton(MESSAGES.guideTabName());</span>
<span class="nc" id="L150">      guideLink.addClickHandler(new WindowOpenClickHandler(guideUrl));</span>
<span class="nc" id="L151">      guideLink.setStyleName(&quot;ode-TopPanelButton&quot;);</span>
<span class="nc" id="L152">      links.add(guideLink);</span>
    }

    // Feedback Link
<span class="nc" id="L156">    String feedbackUrl = config.getFeedbackUrl();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">    if (!Strings.isNullOrEmpty(feedbackUrl)) {</span>
<span class="nc" id="L158">      TextButton feedbackLink = new TextButton(MESSAGES.feedbackTabName());</span>
<span class="nc" id="L159">      feedbackLink.addClickHandler(</span>
        new WindowOpenClickHandler(feedbackUrl));
<span class="nc" id="L161">      feedbackLink.setStyleName(&quot;ode-TopPanelButton&quot;);</span>
<span class="nc" id="L162">      links.add(feedbackLink);</span>
    }

    // Create the Account Information
<span class="nc" id="L166">    rightPanel = new VerticalPanel();</span>
<span class="nc" id="L167">    rightPanel.setHeight(&quot;100%&quot;);</span>
<span class="nc" id="L168">    rightPanel.setVerticalAlignment(VerticalPanel.ALIGN_MIDDLE);</span>

<span class="nc" id="L170">    HorizontalPanel account = new HorizontalPanel();</span>
<span class="nc" id="L171">    account.setStyleName(&quot;ode-TopPanelAccount&quot;);</span>

    // Account Drop Down Button
<span class="nc" id="L174">    List&lt;DropDownItem&gt; userItems = Lists.newArrayList();</span>

    // Sign Out
<span class="nc" id="L177">    userItems.add(new DropDownItem(WIDGET_NAME_SIGN_OUT, MESSAGES.signOutLink(), new SignOutAction()));</span>
    // if we are allowed to delete accounts
<span class="nc bnc" id="L179" title="All 2 branches missed.">    if (ode.getDeleteAccountAllowed()) {</span>
<span class="nc" id="L180">      userItems.add(new DropDownItem(WIDGET_NAME_DELETE_ACCOUNT, MESSAGES.deleteAccountLink(), new DeleteAccountAction(), &quot;ode-ContextMenuItem-Red&quot;));</span>
    }

<span class="nc" id="L183">    accountButton = new DropDownButton(WIDGET_NAME_USER, &quot; &quot; , userItems, true);</span>
<span class="nc" id="L184">    accountButton.setStyleName(&quot;ode-TopPanelButton&quot;);</span>

    // Language
<span class="nc" id="L187">    List&lt;DropDownItem&gt; languageItems = Lists.newArrayList();</span>
<span class="nc" id="L188">    String[] localeNames = LocaleInfo.getAvailableLocaleNames();</span>
    String nativeName;
<span class="nc bnc" id="L190" title="All 2 branches missed.">    for (String localeName : localeNames) {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">      if (!localeName.equals(&quot;default&quot;)) {</span>
<span class="nc" id="L192">        SelectLanguage lang = new SelectLanguage();</span>
<span class="nc" id="L193">        lang.setLocale(localeName);</span>
<span class="nc" id="L194">        nativeName = getDisplayName(localeName);</span>
<span class="nc" id="L195">        languageItems.add(new DropDownItem(WIDGET_NAME_LANGUAGE, nativeName, lang));</span>
      }
    }
<span class="nc" id="L198">    String currentLang = LocaleInfo.getCurrentLocale().getLocaleName();</span>
<span class="nc" id="L199">    String nativeDisplayName = getDisplayName(currentLang);</span>
<span class="nc" id="L200">    languageDropDown = new DropDownButton(WIDGET_NAME_LANGUAGE, nativeDisplayName, languageItems, true);</span>
<span class="nc" id="L201">    languageDropDown.setStyleName(&quot;ode-TopPanelButton&quot;);</span>

<span class="nc" id="L203">    account.setVerticalAlignment(VerticalPanel.ALIGN_MIDDLE);</span>
<span class="nc" id="L204">    account.add(links);</span>
<span class="nc" id="L205">    account.add(languageDropDown);</span>
<span class="nc" id="L206">    account.add(accountButton);</span>

<span class="nc" id="L208">    rightPanel.add(account);</span>

    // Add the Logo, Tools, Links to the TopPanel
<span class="nc" id="L211">    addLogo(topPanel);</span>
<span class="nc" id="L212">    topPanel.add(tools);</span>
<span class="nc" id="L213">    topPanel.add(rightPanel);</span>
<span class="nc" id="L214">    topPanel.setCellVerticalAlignment(rightPanel, HorizontalPanel.ALIGN_MIDDLE);</span>
<span class="nc" id="L215">    rightPanel.setCellHorizontalAlignment(account, HorizontalPanel.ALIGN_RIGHT);</span>
<span class="nc" id="L216">    topPanel.setCellHorizontalAlignment(rightPanel, HorizontalPanel.ALIGN_RIGHT);</span>

<span class="nc" id="L218">    initWidget(topPanel);</span>

<span class="nc" id="L220">    setStyleName(&quot;ode-TopPanel&quot;);</span>
<span class="nc" id="L221">    setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L222">  }</span>

  private String getDisplayName(String localeName){
<span class="nc" id="L225">    String nativeName=LocaleInfo.getLocaleNativeDisplayName(localeName);</span>
    try {
<span class="nc" id="L227">      return LANGUAGES.get(localeName);</span>
<span class="nc" id="L228">    } catch (MissingResourceException e) {</span>
<span class="nc" id="L229">      return nativeName;</span>
    }
  }

  private void addLogo(HorizontalPanel panel) {
    // Logo is a link to App Inv homepage. Add timestamp to logo url
    // to get around browsers that agressively cache the image! This
    // same trick is used in StorageUtil.getFilePath().
<span class="nc" id="L237">    Image logo = new Image(LOGO_IMAGE_URL + &quot;?t=&quot; + System.currentTimeMillis());</span>
<span class="nc" id="L238">    logo.setSize(&quot;180px&quot;, &quot;40px&quot;);</span>
<span class="nc" id="L239">    logo.setStyleName(&quot;ode-Logo&quot;);</span>
<span class="nc" id="L240">    String logoUrl = ode.getSystemConfig().getLogoUrl();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">    if (!Strings.isNullOrEmpty(logoUrl)) {</span>
<span class="nc" id="L242">      logo.addClickHandler(new WindowOpenClickHandler(logoUrl));</span>
    }
<span class="nc" id="L244">    panel.add(logo);</span>
<span class="nc" id="L245">    panel.setCellWidth(logo, &quot;230px&quot;);</span>
<span class="nc" id="L246">    panel.setCellHorizontalAlignment(logo, HorizontalPanel.ALIGN_LEFT);</span>
<span class="nc" id="L247">    panel.setCellVerticalAlignment(logo, HorizontalPanel.ALIGN_MIDDLE);</span>
<span class="nc" id="L248">  }</span>

  private void addMotd(VerticalPanel panel) {
<span class="nc" id="L251">    MotdBox motdBox = MotdBox.getMotdBox();</span>
<span class="nc" id="L252">    panel.add(motdBox);</span>
<span class="nc" id="L253">    panel.setCellHorizontalAlignment(motdBox, HorizontalPanel.ALIGN_RIGHT);</span>
<span class="nc" id="L254">    panel.setCellVerticalAlignment(motdBox, HorizontalPanel.ALIGN_BOTTOM);</span>
<span class="nc" id="L255">  }</span>

  /**
   * Updates the UI to show the user's email address.
   *
   * @param email the email address
   */
  public void showUserEmail(String email) {
<span class="nc" id="L263">    accountButton.setCaption(email);</span>
<span class="nc" id="L264">  }</span>

  /**
   * Adds the MOTD box to the right panel. This should only be called once.
   */
  public void showMotd() {
<span class="nc" id="L270">    addMotd(rightPanel);</span>
<span class="nc" id="L271">  }</span>

  private static class WindowOpenClickHandler implements ClickHandler {
    private final String url;

<span class="nc" id="L276">    WindowOpenClickHandler(String url) {</span>
<span class="nc" id="L277">      this.url = url;</span>
<span class="nc" id="L278">    }</span>

    @Override
    public void onClick(ClickEvent clickEvent) {
<span class="nc" id="L282">      Window.open(url, WINDOW_OPEN_LOCATION, WINDOW_OPEN_FEATURES);</span>
<span class="nc" id="L283">    }</span>
  }

  private static class SignOutAction implements Command {
    @Override
    public void execute() {
      // Maybe take a screenshot
<span class="nc" id="L290">      Ode.getInstance().screenShotMaybe(new Runnable() {</span>
          @Override
          public void run() {
<span class="nc" id="L293">            Window.Location.replace(SIGNOUT_URL);</span>
<span class="nc" id="L294">          }</span>
        }, true);               // Wait for i/o
<span class="nc" id="L296">    }</span>
  }

  private static class DeleteAccountAction implements Command {
    @Override
    public void execute() {
<span class="nc bnc" id="L302" title="All 2 branches missed.">      if(ProjectListBox.getProjectListBox().getProjectList().getMyProjectsCount() &gt; 0) {</span>
<span class="nc" id="L303">        Ode.getInstance().genericWarning(MESSAGES.warnHasProjects());</span>
      } else {
<span class="nc" id="L305">        Ode.getInstance().getUserInfoService().deleteAccount(</span>
<span class="nc" id="L306">          new OdeAsyncCallback&lt;String&gt;(MESSAGES.accountDeletionFailed()) {</span>
            @Override
            public void onSuccess(String delAccountUrl) {
<span class="nc bnc" id="L309" title="All 2 branches missed.">              if (delAccountUrl.equals(&quot;&quot;)) {</span>
<span class="nc" id="L310">                Ode.getInstance().genericWarning(MESSAGES.warnHasProjects());</span>
              } else {
<span class="nc bnc" id="L312" title="All 2 branches missed.">                if (delAccountUrl.equals(&quot;NONE&quot;)) {</span>
<span class="nc" id="L313">                  Window.Location.replace(SIGNOUT_URL);</span>
                } else {
<span class="nc" id="L315">                  Window.Location.replace(delAccountUrl);</span>
                }
              }
<span class="nc" id="L318">            }</span>
          });
      }
<span class="nc" id="L321">      return;</span>
    }
  }

<span class="nc" id="L325">  private class SelectLanguage implements Command {</span>

    private String localeName;

    @Override
    public void execute() {
<span class="nc" id="L331">      final String queryParam = LocaleInfo.getLocaleQueryParam();</span>
<span class="nc" id="L332">      Command savecmd = new SaveAction();</span>
<span class="nc" id="L333">      savecmd.execute();</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">      if (queryParam != null) {</span>
<span class="nc" id="L335">        UrlBuilder builder = Window.Location.createUrlBuilder().setParameter(</span>
            queryParam, localeName);
<span class="nc" id="L337">        Window.Location.replace(builder.buildString());</span>
<span class="nc" id="L338">      } else {</span>
        // If we are using only cookies, just reload
<span class="nc" id="L340">        Window.Location.reload();</span>
      }
<span class="nc" id="L342">    }</span>

    public void setLocale(String nativeName) {
<span class="nc" id="L345">      localeName = nativeName;</span>
<span class="nc" id="L346">    }</span>

  }

<span class="nc" id="L350">  private class SaveAction implements Command {</span>
    @Override
    public void execute() {
<span class="nc" id="L353">      ProjectRootNode projectRootNode = Ode.getInstance().getCurrentYoungAndroidProjectRootNode();</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">      if (projectRootNode != null) {</span>
<span class="nc" id="L355">        ChainableCommand cmd = new SaveAllEditorsCommand(null);</span>
<span class="nc" id="L356">        cmd.startExecuteChain(Tracking.PROJECT_ACTION_SAVE_YA, projectRootNode);</span>
      }
<span class="nc" id="L358">    }</span>
  }

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>