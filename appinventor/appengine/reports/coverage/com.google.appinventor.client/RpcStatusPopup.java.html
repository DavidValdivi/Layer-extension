<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RpcStatusPopup.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client</a> &gt; <span class="el_source">RpcStatusPopup.java</span></div><h1>RpcStatusPopup.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2012 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client;

import static com.google.appinventor.client.Ode.MESSAGES;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.WindowResizeListener;
import com.google.gwt.user.client.WindowScrollListener;
import com.google.gwt.user.client.ui.DecoratedPopupPanel;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.PopupPanel;

import java.util.HashMap;
import java.util.Map;

/**
 * Popup that shows a status message while an asynchronous request is
 * happening.
 *
 */
public class RpcStatusPopup extends DecoratedPopupPanel implements RpcListener {
  // Map from method names to messages
<span class="nc" id="L27">  private static final Map&lt;String, String&gt; statusMessages = initMessages();</span>

  // Label that shows the message for the current RPC
<span class="nc" id="L30">  private final Label label = new Label();</span>

  // Number of active RPCs. The popup is shown iff this is positive.
<span class="nc" id="L33">  private int activeRPCs = 0;</span>

  /**
   * Initializes the LoadingPopup.
   */
  public RpcStatusPopup() {
<span class="nc" id="L39">    super(/* autoHide = */ false);</span>
<span class="nc" id="L40">    setStyleName(&quot;ode-RpcStatusMessage&quot;);</span>
<span class="nc" id="L41">    setWidget(label);</span>

    // Re-center the loading message when the window is resized.
    // TODO(halabelson): Replace the deprecated methods
<span class="nc" id="L45">    Window.addWindowResizeListener(new WindowResizeListener() {</span>
      @Override
      public void onWindowResized(int width, int height) {
<span class="nc" id="L48">        positionPopup(getOffsetWidth());</span>
<span class="nc" id="L49">      }</span>
    });

    // Reposition the message to the top of the screen when the
    // window is scrolled
    // TODO(halabelson): get rid of the flashing on vertical scrolling
<span class="nc" id="L55">    Window.addWindowScrollListener(new WindowScrollListener() {</span>
      @Override
      public void onWindowScrolled(int scrollLeft, int scrollTop) {
<span class="nc" id="L58">        positionPopup(getOffsetWidth());</span>
<span class="nc" id="L59">      }</span>
    });

    // Position the popup before showing it to prevent flashing.
<span class="nc" id="L63">    setPopupPositionAndShow(new PopupPanel.PositionCallback() {</span>
      @Override
      public void setPosition(int offsetWidth, int offsetHeight) {
<span class="nc" id="L66">        positionPopup(offsetWidth);</span>
<span class="nc" id="L67">      }</span>
    });
<span class="nc" id="L69">  }</span>

  /**
   * Register a service proxy with the loading popup. The loading popup will
   * listen to the RPCs on the service and show/hide itself automatically.
   *
   * @param service the service to monitor
   */
  public void register(ExtendedServiceProxy&lt;?&gt; service) {
<span class="nc" id="L78">    service.addRpcListener(this);</span>
<span class="nc" id="L79">  }</span>

  /**
   * Unregister a service proxy with the loading popup.
   *
   * @param service the service to monitor
   */
  public void unregister(ExtendedServiceProxy&lt;?&gt; service) {
<span class="nc" id="L87">    service.removeRpcListener(this);</span>
<span class="nc" id="L88">  }</span>

  // RpcListener implementation

  @Override
  public void onStart(String method, Object... params) {
    // TODO(user): This is very primitive in the case of multiple RPCs. The
    // message of the RPC started last succeeds. Its message will stay active
    // until all RPCs have finished or a new RPC starts.
<span class="nc" id="L97">    String message = statusMessages.get(method);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">    label.setText(message != null ? message : MESSAGES.defaultRpcMessage());</span>

    // Clear error display
<span class="nc" id="L101">    ErrorReporter.hide();</span>

<span class="nc" id="L103">    countRPCs(+1);</span>
<span class="nc" id="L104">  }</span>

  @Override
  public void onFailure(String method, Throwable caught) {
<span class="nc" id="L108">    countRPCs(-1);</span>
<span class="nc" id="L109">  }</span>

  @Override
  public void onSuccess(String method, Object result) {
<span class="nc" id="L113">    countRPCs(-1);</span>
<span class="nc" id="L114">  }</span>

  private void countRPCs(int i) {
<span class="nc" id="L117">    activeRPCs += i;</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">    if (activeRPCs &gt; 0) {</span>
<span class="nc" id="L119">      show();</span>
    } else {
<span class="nc" id="L121">      hide();</span>
    }
<span class="nc" id="L123">  }</span>

  private void positionPopup(int offsetWidth) {
    // make sure the popup is on-screen
    // if the top of the window is scrolled off the screen
<span class="nc" id="L128">    setPopupPosition(</span>
<span class="nc" id="L129">        (Window.getClientWidth() - offsetWidth) &gt;&gt; 1,</span>
<span class="nc" id="L130">        Window.getScrollTop());</span>
<span class="nc" id="L131">  }</span>

  private static Map&lt;String, String&gt; initMessages() {
<span class="nc" id="L134">    Map&lt;String, String&gt; msgs = new HashMap&lt;String, String&gt;();</span>

    // RPC methods that show a &quot;Saving...&quot; message
<span class="nc" id="L137">    String saving = MESSAGES.savingRpcMessage();</span>
<span class="nc" id="L138">    msgs.put(&quot;newProject&quot;, saving);</span>
<span class="nc" id="L139">    msgs.put(&quot;save&quot;, saving);</span>
<span class="nc" id="L140">    msgs.put(&quot;storeProjectSettings&quot;, saving);</span>
<span class="nc" id="L141">    msgs.put(&quot;storeUserSettings&quot;, saving);</span>

    // RPC methods that show a &quot;Copying...&quot; message
<span class="nc" id="L144">    msgs.put(&quot;copyProject&quot;, MESSAGES.copyingRpcMessage());</span>

    // RPC methods that show a &quot;Deleting...&quot; message
<span class="nc" id="L147">    String deleting = MESSAGES.deletingRpcMessage();</span>
<span class="nc" id="L148">    msgs.put(&quot;deleteFile&quot;, deleting);</span>
<span class="nc" id="L149">    msgs.put(&quot;deleteFiles&quot;, deleting);</span>
<span class="nc" id="L150">    msgs.put(&quot;deleteProject&quot;, deleting);</span>

    // RPC methods that show a &quot;Packaging...&quot; message
<span class="nc" id="L153">    msgs.put(&quot;build&quot;, MESSAGES.packagingRpcMessage());</span>

    // All other RPC methods will show the default &quot;Loading...&quot; message.

<span class="nc" id="L157">    return msgs;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>