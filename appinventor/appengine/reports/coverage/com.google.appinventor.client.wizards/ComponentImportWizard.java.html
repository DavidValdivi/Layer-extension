<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComponentImportWizard.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.wizards</a> &gt; <span class="el_source">ComponentImportWizard.java</span></div><h1>ComponentImportWizard.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2020 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.wizards;

import static com.google.appinventor.client.Ode.MESSAGES;

import com.google.appinventor.client.Ode;
import com.google.appinventor.client.OdeAsyncCallback;
import com.google.appinventor.client.editor.youngandroid.YaProjectEditor;
import com.google.appinventor.client.explorer.project.Project;
import com.google.appinventor.common.utils.StringUtils;
import com.google.appinventor.client.utils.Uploader;
import com.google.appinventor.shared.rpc.ServerLayout;
import com.google.appinventor.shared.rpc.UploadResponse;
import com.google.appinventor.shared.rpc.component.Component;
import com.google.appinventor.shared.rpc.component.ComponentImportResponse;
import com.google.appinventor.shared.rpc.project.ProjectNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidAssetsFolder;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidComponentsFolder;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidProjectNode;

import com.google.gwt.core.client.GWT;
import com.google.gwt.user.cellview.client.CellTable;
import com.google.gwt.user.cellview.client.Column;
import com.google.gwt.user.client.Command;
import com.google.gwt.cell.client.CheckboxCell;
import com.google.gwt.cell.client.NumberCell;
import com.google.gwt.cell.client.TextCell;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.ui.FileUpload;
import com.google.gwt.user.client.ui.Grid;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.TabPanel;
import com.google.gwt.user.client.ui.TextBox;
import com.google.gwt.user.client.ui.VerticalPanel;
import com.google.gwt.view.client.ListDataProvider;
import com.google.gwt.view.client.SingleSelectionModel;

import java.util.List;

public class ComponentImportWizard extends Wizard {

  final static String external_components = &quot;assets/external_comps/&quot;;

<span class="nc" id="L49">  public static class ImportComponentCallback extends OdeAsyncCallback&lt;ComponentImportResponse&gt; {</span>
    @Override
    public void onSuccess(ComponentImportResponse response) {
<span class="nc bnc" id="L52" title="All 2 branches missed.">      if (response.getStatus() == ComponentImportResponse.Status.FAILED){</span>
<span class="nc" id="L53">        Window.alert(MESSAGES.componentImportError() + &quot;\n&quot; + response.getMessage());</span>
<span class="nc" id="L54">        return;</span>
      }
<span class="nc bnc" id="L56" title="All 2 branches missed.">      else if (response.getStatus() != ComponentImportResponse.Status.IMPORTED &amp;&amp;</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">          response.getStatus() != ComponentImportResponse.Status.UPGRADED) {</span>
<span class="nc" id="L58">        Window.alert(MESSAGES.componentImportError());</span>
<span class="nc" id="L59">        return;</span>
      }
<span class="nc bnc" id="L61" title="All 2 branches missed.">      else if (response.getStatus() == ComponentImportResponse.Status.UNKNOWN_URL) {</span>
<span class="nc" id="L62">        Window.alert(MESSAGES.componentImportUnknownURLError());</span>
      }
<span class="nc bnc" id="L64" title="All 2 branches missed.">      else if (response.getStatus() == ComponentImportResponse.Status.UPGRADED) {</span>
<span class="nc" id="L65">        StringBuilder sb = new StringBuilder(MESSAGES.componentUpgradedAlert());</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        for (String name : response.getComponentTypes().values()) {</span>
<span class="nc" id="L67">          sb.append(&quot;\n&quot;);</span>
<span class="nc" id="L68">          sb.append(name);</span>
<span class="nc" id="L69">        }</span>
<span class="nc" id="L70">        Window.alert(sb.toString());</span>
      }

<span class="nc" id="L73">      List&lt;ProjectNode&gt; compNodes = response.getNodes();</span>
<span class="nc" id="L74">      long destinationProjectId = response.getProjectId();</span>
<span class="nc" id="L75">      long currentProjectId = ode.getCurrentYoungAndroidProjectId();</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">      if (currentProjectId != destinationProjectId) {</span>
<span class="nc" id="L77">        return; // User switched project early!</span>
      }
<span class="nc" id="L79">      Project project = ode.getProjectManager().getProject(destinationProjectId);</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">      if (project == null) {</span>
<span class="nc" id="L81">        return; // Project does not exist!</span>
      }
<span class="nc bnc" id="L83" title="All 2 branches missed.">      if (response.getStatus() == ComponentImportResponse.Status.UPGRADED ||</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">          response.getStatus() == ComponentImportResponse.Status.IMPORTED) {</span>
<span class="nc" id="L85">        YoungAndroidComponentsFolder componentsFolder = ((YoungAndroidProjectNode) project.getRootNode()).getComponentsFolder();</span>
<span class="nc" id="L86">        YaProjectEditor projectEditor = (YaProjectEditor) ode.getEditorManager().getOpenProjectEditor(destinationProjectId);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (projectEditor == null) {</span>
<span class="nc" id="L88">          return; // Project is not open!</span>
        }
<span class="nc bnc" id="L90" title="All 2 branches missed.">        for (ProjectNode node : compNodes) {</span>
<span class="nc" id="L91">          project.addNode(componentsFolder, node);</span>
<span class="nc bnc" id="L92" title="All 4 branches missed.">          if ((node.getName().equals(&quot;component.json&quot;) || node.getName().equals(&quot;components.json&quot;))</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">              &amp;&amp; StringUtils.countMatches(node.getFileId(), &quot;/&quot;) == 3) {</span>
<span class="nc" id="L94">            projectEditor.addComponent(node, null);</span>
          }
<span class="nc" id="L96">        }</span>
      }
<span class="nc" id="L98">    }</span>
  }

<span class="nc" id="L101">  private static int FROM_MY_COMPUTER_TAB = 0;</span>
<span class="nc" id="L102">  private static int URL_TAB = 1;</span>

  private static final String COMPONENT_ARCHIVE_EXTENSION = &quot;.aix&quot;;

<span class="nc" id="L106">  private static final Ode ode = Ode.getInstance();</span>

  public ComponentImportWizard() {
<span class="nc" id="L109">    super(MESSAGES.componentImportWizardCaption(), true, false);</span>

<span class="nc" id="L111">    final CellTable compTable = createCompTable();</span>
<span class="nc" id="L112">    final FileUpload fileUpload = createFileUpload();</span>
<span class="nc" id="L113">    final Grid urlGrid = createUrlGrid();</span>
<span class="nc" id="L114">    final TabPanel tabPanel = new TabPanel();</span>
<span class="nc" id="L115">    tabPanel.add(fileUpload, MESSAGES.componentImportFromComputer());</span>
<span class="nc" id="L116">    tabPanel.add(urlGrid, MESSAGES.componentImportFromURL());</span>
<span class="nc" id="L117">    tabPanel.selectTab(FROM_MY_COMPUTER_TAB);</span>
<span class="nc" id="L118">    tabPanel.addStyleName(&quot;ode-Tabpanel&quot;);</span>

<span class="nc" id="L120">    VerticalPanel panel = new VerticalPanel();</span>
<span class="nc" id="L121">    panel.add(tabPanel);</span>

<span class="nc" id="L123">    addPage(panel);</span>

<span class="nc" id="L125">    getConfirmButton().setText(&quot;Import&quot;);</span>

<span class="nc" id="L127">    setPagePanelHeight(150);</span>
<span class="nc" id="L128">    setPixelSize(200, 150);</span>
<span class="nc" id="L129">    setStylePrimaryName(&quot;ode-DialogBox&quot;);</span>

<span class="nc" id="L131">    initFinishCommand(new Command() {</span>
      @Override
      public void execute() {
<span class="nc" id="L134">        final long projectId = ode.getCurrentYoungAndroidProjectId();</span>
<span class="nc" id="L135">        final Project project = ode.getProjectManager().getProject(projectId);</span>
<span class="nc" id="L136">        final YoungAndroidAssetsFolder assetsFolderNode =</span>
<span class="nc" id="L137">            ((YoungAndroidProjectNode) project.getRootNode()).getAssetsFolder();</span>

<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (tabPanel.getTabBar().getSelectedTab() == URL_TAB) {</span>
<span class="nc" id="L140">          TextBox urlTextBox = (TextBox) urlGrid.getWidget(1, 0);</span>
<span class="nc" id="L141">          String url = urlTextBox.getText();</span>

<span class="nc bnc" id="L143" title="All 2 branches missed.">          if (url.trim().isEmpty()) {</span>
<span class="nc" id="L144">            Window.alert(MESSAGES.noUrlError());</span>
<span class="nc" id="L145">            return;</span>
          }

<span class="nc" id="L148">          ode.getComponentService().importComponentToProject(url, projectId,</span>
<span class="nc" id="L149">              assetsFolderNode.getFileId(), new ImportComponentCallback());</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        } else if (tabPanel.getTabBar().getSelectedTab() == FROM_MY_COMPUTER_TAB) {</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">          if (!fileUpload.getFilename().endsWith(COMPONENT_ARCHIVE_EXTENSION)) {</span>
<span class="nc" id="L152">            Window.alert(MESSAGES.notComponentArchiveError());</span>
<span class="nc" id="L153">            return;</span>
          }

<span class="nc" id="L156">          String url = GWT.getModuleBaseURL() +</span>
            ServerLayout.UPLOAD_SERVLET + &quot;/&quot; +
            ServerLayout.UPLOAD_COMPONENT + &quot;/&quot; +
<span class="nc" id="L159">            trimLeadingPath(fileUpload.getFilename());</span>

<span class="nc" id="L161">          Uploader.getInstance().upload(fileUpload, url,</span>
<span class="nc" id="L162">            new OdeAsyncCallback&lt;UploadResponse&gt;() {</span>
              @Override
              public void onSuccess(UploadResponse uploadResponse) {
<span class="nc" id="L165">                String toImport = uploadResponse.getInfo();</span>
<span class="nc" id="L166">                ode.getComponentService().importComponentToProject(toImport, projectId,</span>
<span class="nc" id="L167">                    assetsFolderNode.getFileId(), new ImportComponentCallback());</span>
<span class="nc" id="L168">              }</span>
            });
<span class="nc" id="L170">          return;</span>
        }
<span class="nc" id="L172">      }</span>

      private String trimLeadingPath(String filename) {
        // Strip leading path off filename.
        // We need to support both Unix ('/') and Windows ('\\') separators.
<span class="nc" id="L177">        return filename.substring(Math.max(filename.lastIndexOf('/'), filename.lastIndexOf('\\')) + 1);</span>
      }
    });
<span class="nc" id="L180">  }</span>

  private CellTable createCompTable() {
<span class="nc" id="L183">    final SingleSelectionModel&lt;Component&gt; selectionModel =</span>
        new SingleSelectionModel&lt;Component&gt;();

<span class="nc" id="L186">    CellTable&lt;Component&gt; compTable = new CellTable&lt;Component&gt;();</span>
<span class="nc" id="L187">    compTable.setSelectionModel(selectionModel);</span>

<span class="nc" id="L189">    Column&lt;Component, Boolean&gt; checkColumn =</span>
<span class="nc" id="L190">        new Column&lt;Component, Boolean&gt;(new CheckboxCell(true, false)) {</span>
          @Override
          public Boolean getValue(Component comp) {
<span class="nc" id="L193">            return selectionModel.isSelected(comp);</span>
          }
        };
<span class="nc" id="L196">    Column&lt;Component, String&gt; nameColumn =</span>
<span class="nc" id="L197">        new Column&lt;Component, String&gt;(new TextCell()) {</span>
          @Override
          public String getValue(Component comp) {
<span class="nc" id="L200">            return comp.getName();</span>
          }
        };
<span class="nc" id="L203">    Column&lt;Component, Number&gt; versionColumn =</span>
<span class="nc" id="L204">        new Column&lt;Component, Number&gt;(new NumberCell()) {</span>
          @Override
          public Number getValue(Component comp) {
<span class="nc" id="L207">            return comp.getVersion();</span>
          }
        };

<span class="nc" id="L211">    compTable.addColumn(checkColumn);</span>
<span class="nc" id="L212">    compTable.addColumn(nameColumn, &quot;Component&quot;);</span>
<span class="nc" id="L213">    compTable.addColumn(versionColumn, &quot;Version&quot;);</span>

<span class="nc" id="L215">    return compTable;</span>
  }

  private Grid createUrlGrid() {
<span class="nc" id="L219">    TextBox urlTextBox = new TextBox();</span>
<span class="nc" id="L220">    urlTextBox.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L221">    Grid grid = new Grid(2, 1);</span>
<span class="nc" id="L222">    grid.setWidget(0, 0, new Label(&quot;Url:&quot;));</span>
<span class="nc" id="L223">    grid.setWidget(1, 0, urlTextBox);</span>
<span class="nc" id="L224">    return grid;</span>
  }

  private FileUpload createFileUpload() {
<span class="nc" id="L228">    FileUpload upload = new FileUpload();</span>
<span class="nc" id="L229">    upload.setName(ServerLayout.UPLOAD_COMPONENT_ARCHIVE_FORM_ELEMENT);</span>
<span class="nc" id="L230">    upload.getElement().setAttribute(&quot;accept&quot;, COMPONENT_ARCHIVE_EXTENSION);</span>
<span class="nc" id="L231">    return upload;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>