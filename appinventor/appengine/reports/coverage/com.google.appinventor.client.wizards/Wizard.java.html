<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Wizard.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.wizards</a> &gt; <span class="el_source">Wizard.java</span></div><h1>Wizard.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2012 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.wizards;

import static com.google.appinventor.client.Ode.MESSAGES;
import com.google.gwt.user.client.Command;
import com.google.gwt.user.client.DOM;
import com.google.gwt.user.client.Element;
import com.google.gwt.user.client.Event;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.ui.AbsolutePanel;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.ClickListener;
import com.google.gwt.user.client.ui.DeckPanel;
import com.google.gwt.user.client.ui.DialogBox;
import com.google.gwt.user.client.ui.HorizontalPanel;
import com.google.gwt.user.client.ui.Panel;
import com.google.gwt.user.client.ui.ScrollPanel;
import com.google.gwt.user.client.ui.VerticalPanel;
import com.google.gwt.user.client.ui.Widget;

/**
 * A wizard controls a dialog box that cycles through a series of pages.
 * &lt;p&gt;
 * The user may decide to cancel the wizard before viewing or completing
 * all of the pages. In that case, the wizard is closed and no further
 * action is taken.
 * &lt;p&gt;
 * After all pages have been cycled through, the user may invoke
 * a finish command. Immediately before the command is invoked,
 * the wizard dialog will be closed automatically.
 *
 */
public abstract class Wizard extends DialogBox {
  // UI for button panel to switch between wizard pages
  private final HorizontalPanel buttonPanel;
  private final Button backButton;
  private final Button cancelButton;
  private final Button nextButton;
  private final Button okButton;

  // Wizard pages
  private final AbsolutePanel pagePanel;
  private final DeckPanel pageDeck;
  private int currentPageIndex;

  // Command to execute upon finishing the wizard (not executed on cancel)
  private Command finishCommand;

  // Command to execute upon canceling the wizard (can be null)
  private Command cancelCommand;

  // Indicates whether the browser area size should be considered when calculating the wizard size
  private final boolean adaptiveSizing;

  // Indicates modality of the wizard
  private final boolean modal;

  /**
   * Creates a new wizard.
   * &lt;p&gt;
   * Implementations are expected to build the wizard dialog in their
   * constructor. In particular, it is expected that
   * {@link #addPage(Panel)} and {@link #initFinishCommand(Command)}
   * will be called before the constructor terminates.
   *
   * @param title title displayed in wizard dialog box
   * @param modal indicates modality of the wizard
   * @param adaptiveSizing instead of using the minimal size for the
   *                       wizard also considers the size of the browser area
   */
  protected Wizard(String title, boolean modal, boolean adaptiveSizing) {
    // Initialize UI
    // TODO(lizlooney) - investigate using built-in modality support. The
    // reasons for not using it initially are no longer valid.
<span class="nc" id="L80">    super(false, false);</span>

<span class="nc" id="L82">    this.modal = modal;</span>
<span class="nc" id="L83">    this.adaptiveSizing = adaptiveSizing;</span>

<span class="nc" id="L85">    setStylePrimaryName(&quot;ode-DialogBox&quot;);</span>
<span class="nc" id="L86">    setText(title);</span>

<span class="nc" id="L88">    ClickListener buttonListener = new ClickListener() {</span>
      @Override
      public void onClick(Widget sender) {
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (sender == cancelButton) {</span>
<span class="nc" id="L92">          handleCancelClick();</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        } else if (sender == nextButton) {</span>
<span class="nc" id="L94">          showNextPage();</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        } else if (sender == backButton) {</span>
<span class="nc" id="L96">          showPreviousPage();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        } else if (sender == okButton) {</span>
<span class="nc" id="L98">          handleOkClick();</span>
        }
<span class="nc" id="L100">      }</span>
    };
<span class="nc" id="L102">    cancelButton = new Button(MESSAGES.cancelButton());</span>
<span class="nc" id="L103">    cancelButton.addClickListener(buttonListener);</span>
<span class="nc" id="L104">    backButton = new Button(MESSAGES.backButton());</span>
<span class="nc" id="L105">    backButton.addClickListener(buttonListener);</span>
<span class="nc" id="L106">    nextButton = new Button(MESSAGES.nextButton());</span>
<span class="nc" id="L107">    nextButton.addClickListener(buttonListener);</span>
<span class="nc" id="L108">    okButton = new Button(MESSAGES.okButton());</span>
<span class="nc" id="L109">    okButton.addClickListener(buttonListener);</span>

<span class="nc" id="L111">    buttonPanel = new HorizontalPanel();</span>
<span class="nc" id="L112">    buttonPanel.add(cancelButton);</span>
<span class="nc" id="L113">    buttonPanel.add(backButton);</span>
<span class="nc" id="L114">    buttonPanel.add(nextButton);</span>
<span class="nc" id="L115">    buttonPanel.add(okButton);</span>
<span class="nc" id="L116">    buttonPanel.setSize(&quot;100%&quot;, &quot;24px&quot;);</span>

<span class="nc" id="L118">    pageDeck = new DeckPanel();</span>
<span class="nc" id="L119">    pageDeck.setSize(&quot;100%&quot;, &quot;100%&quot;);</span>

<span class="nc" id="L121">    pagePanel = new AbsolutePanel();</span>
<span class="nc" id="L122">    pagePanel.add(pageDeck);</span>
<span class="nc" id="L123">    pagePanel.setWidth(&quot;100%&quot;);</span>

<span class="nc" id="L125">    VerticalPanel contentPanel = new VerticalPanel();</span>
<span class="nc" id="L126">    contentPanel.add(pagePanel);</span>
<span class="nc" id="L127">    contentPanel.add(buttonPanel);</span>
<span class="nc" id="L128">    contentPanel.setSize(&quot;100%&quot;, &quot;100%&quot;);</span>

<span class="nc" id="L130">    add(contentPanel);</span>
<span class="nc" id="L131">  }</span>

  @Override
  public boolean onEventPreview(Event event) {
    // Always allow event if capturing is enabled
<span class="nc bnc" id="L136" title="All 2 branches missed.">    if (DOM.getCaptureElement() != null) {</span>
<span class="nc" id="L137">      return true;</span>
    }

    // If this is a modal wizard then only allow it if the target element is a child of this wizard
<span class="nc bnc" id="L141" title="All 2 branches missed.">    if (modal) {</span>
<span class="nc" id="L142">      Element target = DOM.eventGetTarget(event);</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">      return (target != null &amp;&amp; DOM.isOrHasChild(getElement(), target));</span>
    } else {
<span class="nc" id="L145">      return super.onEventPreview(event);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * Subclasses may override this to perform additional actions
   * after the wizard is shown, such as explicitly setting the
   * initially focused widget. Remember to call {@code super.show()}
   * as the first action in such overriding methods.
   */
  @Override
  public void show() {
<span class="nc" id="L159">    ensureInited();</span>

    // Wizard size (having it resize between page changes is quite annoying)
<span class="nc" id="L162">    int width = 480;</span>
<span class="nc" id="L163">    int height = 320;</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">    if (adaptiveSizing) {</span>
<span class="nc" id="L165">      width = Math.max(width, Window.getClientWidth() / 3);</span>
<span class="nc" id="L166">      height = Math.max(height, Window.getClientHeight() / 2);</span>
    }
<span class="nc" id="L168">    setPixelSize(width, height);</span>

<span class="nc" id="L170">    super.show();</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">    if (pageDeck.getWidgetCount() == 1) {</span>
<span class="nc" id="L173">      buttonPanel.remove(backButton);</span>
<span class="nc" id="L174">      buttonPanel.remove(nextButton);</span>
    }

    // Show first wizard page
<span class="nc" id="L178">    currentPageIndex = 0;</span>
<span class="nc" id="L179">    showCurrentPage();</span>
<span class="nc" id="L180">  }</span>

  /**
   * Adds a new page to the end of the wizard.
   */
  protected void addPage(Panel page) {
<span class="nc" id="L186">    page = new ScrollPanel(page);</span>
<span class="nc" id="L187">    pageDeck.add(page);</span>
<span class="nc" id="L188">  }</span>

  public void setPagePanelHeight(int height){
<span class="nc" id="L191">    pagePanel.setHeight(height+&quot;px&quot;);</span>
<span class="nc" id="L192">  }</span>

  /**
   * Sets the command to be executed upon finish (not on cancel).
   * May only be invoked once.
   */
  protected void initFinishCommand(Command finishCommand) {
<span class="nc bnc" id="L199" title="All 2 branches missed.">    if (this.finishCommand != null) {</span>
<span class="nc" id="L200">      throw new IllegalStateException();</span>
    }
<span class="nc" id="L202">    this.finishCommand = finishCommand;</span>
<span class="nc" id="L203">  }</span>

  /**
   * Sets the command to be executed upon cancel.
   * May be invoked no more than once.
   */
  protected void initCancelCommand(Command cancelCommand) {
<span class="nc" id="L210">    this.cancelCommand = cancelCommand;</span>
<span class="nc" id="L211">  }</span>

  /**
   * Ensures that this class is fully initialized.
   */
  private void ensureInited() {
<span class="nc bnc" id="L217" title="All 4 branches missed.">    if (pageDeck.getWidgetCount() == 0 || finishCommand == null) {</span>
<span class="nc" id="L218">      throw new IllegalStateException();</span>
    }
<span class="nc" id="L220">  }</span>

  /**
   * Invoked immediately after showing a new page
   *
   * @param pageNumber  number of page to be shown
   */
  protected void onPageInit(int pageNumber) {
<span class="nc" id="L228">  }</span>

  /**
   * Invoked immediately before moving away from the current page.
   *
   * @param pageNumber  number of current page
   */
  protected void onPageFinish(int pageNumber) {
<span class="nc" id="L236">  }</span>

  /**
   * Invoked immediately before closing the wizard.
   */
  protected void onHide() {
<span class="nc" id="L242">  }</span>

  /**
   * Shows the previous page.
   */
  protected void showPreviousPage() {
<span class="nc" id="L248">    onPageFinish(currentPageIndex);</span>
<span class="nc" id="L249">    currentPageIndex--;</span>
<span class="nc" id="L250">    showCurrentPage();</span>
<span class="nc" id="L251">    onPageInit(currentPageIndex);</span>
<span class="nc" id="L252">  }</span>

  /**
   * Shows the next page.
   */
  protected void showNextPage() {
<span class="nc" id="L258">    onPageFinish(currentPageIndex);</span>
<span class="nc" id="L259">    currentPageIndex++;</span>
<span class="nc" id="L260">    showCurrentPage();</span>
<span class="nc" id="L261">    onPageInit(currentPageIndex);</span>
<span class="nc" id="L262">  }</span>

  protected final void handleCancelClick() {
<span class="nc" id="L265">    hideWizard();</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">    if (cancelCommand != null) {</span>
<span class="nc" id="L267">      cancelCommand.execute();</span>
    }
<span class="nc" id="L269">  }</span>

  protected final void handleOkClick() {
<span class="nc bnc" id="L272" title="All 2 branches missed.">    if (okButton.isEnabled()) {</span>
<span class="nc" id="L273">      hideWizard();</span>
<span class="nc" id="L274">      finishCommand.execute();</span>
    }
<span class="nc" id="L276">  }</span>

  protected final Button getConfirmButton() {
<span class="nc" id="L279">    return okButton;</span>
  }

  protected void disableOkButton() {
<span class="nc" id="L283">    okButton.setEnabled(false);</span>
<span class="nc" id="L284">  }</span>

  protected void enableOkButton() {
<span class="nc" id="L287">    okButton.setEnabled(true);</span>
<span class="nc" id="L288">  }</span>

  /*
   * Hides the wizard.
   * Note that we are not overriding hide() because it is called by center() which can some
   * ugliness!
   */
  private void hideWizard() {
<span class="nc" id="L296">    onPageFinish(currentPageIndex);</span>
<span class="nc" id="L297">    onHide();</span>
<span class="nc" id="L298">    hide();</span>
<span class="nc" id="L299">  }</span>

  /*
   * Shows the wizard page for the currentPageIndex in the dialog box.
   */
  private void showCurrentPage() {
    // Enable back button if the current page is not the first page
<span class="nc bnc" id="L306" title="All 2 branches missed.">    backButton.setEnabled(currentPageIndex &gt; 0);</span>

    // Enable next button if the current page is not the last page otherwise enable finish button
<span class="nc bnc" id="L309" title="All 2 branches missed.">    boolean isLastPage = currentPageIndex == pageDeck.getWidgetCount() - 1;</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">    nextButton.setEnabled(!isLastPage);</span>
<span class="nc" id="L311">    okButton.setEnabled(isLastPage);</span>

    // Show page
<span class="nc" id="L314">    pageDeck.showWidget(currentPageIndex);</span>

    // Because pages are embedded in scroll panels it is important to set the size of the page to
    // the current height of the content panel
<span class="nc" id="L318">    pageDeck.getWidget(currentPageIndex).setHeight(pagePanel.getOffsetHeight() + &quot;px&quot;);</span>
<span class="nc" id="L319">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>