<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TemplateUploadWizard.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.wizards</a> &gt; <span class="el_source">TemplateUploadWizard.java</span></div><h1>TemplateUploadWizard.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2013 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.wizards;

import static com.google.appinventor.client.Ode.MESSAGES;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;

import com.google.appinventor.client.Ode;
import com.google.appinventor.client.OdeAsyncCallback;
import com.google.appinventor.client.explorer.project.Project;
import com.google.appinventor.client.settings.user.UserSettings;
import com.google.appinventor.client.tracking.Tracking;
import com.google.appinventor.client.wizards.NewProjectWizard.NewProjectCommand;
import com.google.appinventor.client.youngandroid.TextValidators;
import com.google.appinventor.shared.properties.json.JSONUtil;
import com.google.appinventor.shared.rpc.project.UserProject;
import com.google.appinventor.shared.rpc.project.youngandroid.NewYoungAndroidProjectParameters;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidProjectNode;
import com.google.appinventor.shared.settings.SettingsConstants;
import com.google.gwt.cell.client.AbstractCell;
import com.google.gwt.dom.client.Style;
import com.google.gwt.event.dom.client.ChangeEvent;
import com.google.gwt.event.dom.client.ChangeHandler;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.http.client.Request;
import com.google.gwt.http.client.RequestBuilder;
import com.google.gwt.http.client.RequestCallback;
import com.google.gwt.http.client.RequestException;
import com.google.gwt.http.client.Response;
import com.google.gwt.json.client.JSONArray;
import com.google.gwt.json.client.JSONObject;
import com.google.gwt.json.client.JSONParser;
import com.google.gwt.json.client.JSONString;
import com.google.gwt.json.client.JSONValue;
import com.google.gwt.resources.client.ImageResource;
import com.google.gwt.safehtml.shared.SafeHtmlBuilder;
import com.google.gwt.user.cellview.client.CellList;
import com.google.gwt.user.cellview.client.HasKeyboardSelectionPolicy.KeyboardSelectionPolicy;
import com.google.gwt.user.client.Command;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.Composite;
import com.google.gwt.user.client.ui.HTML;
import com.google.gwt.user.client.ui.HorizontalPanel;
import com.google.gwt.user.client.ui.Image;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.ListBox;
import com.google.gwt.user.client.ui.SimplePanel;
import com.google.gwt.user.client.ui.VerticalPanel;
import com.google.gwt.view.client.ProvidesKey;
import com.google.gwt.view.client.SelectionChangeEvent;
import com.google.gwt.view.client.SingleSelectionModel;

/**
 * Wizard for importing AI2 project from a server.  A 'template' is
 * a partially built project that is designed to provide 'scaffolding' for  a
 * lesson or tutorial.  It could take various forms -- e.g., just the media that
 * makes up an app, or just the components but no blocks, or just a &quot;library&quot; of
 * certain blocks, etc.
 *
 * The repositories can be either 'built-in' (stored on the appengine server) or
 * 'external', stored on any other Web server -- provided it is stored in the
 *  format described below.
 *
 * Built-in template repositories are hosted in appengine/war/templates/
 * That entire directory will be copied during build to: appengine/build/war/templates/
 *
 * External templates must be placed at a reachable URL on a web server.
 *
 * If templates are stored on a static website. Your webserver must
 * implement &quot;Cross-origin Resource Sharing (CORS). With Apache you
 * can do this by using mod_headers placing a .htaccess file in the
 * templates directory that contains the one line:
 *
 * 'Header set Access-Control-Allow-Origin &quot;*&quot;'.
 *
 * External repositories can be added/removed by the user at runtime.
 *
 * To add a new repository, fill in the URL to the directory that
 * contains the templates direcory, for example
 * http://appinventor.cs.trincoll.edu/csp/week1/ where templates is
 * contained in week1.
 *
 * The Wizard assumes that the templates/ repository is organized as follows and uses
 * the naming conventions shown here, where 'HelloPurr' is a typical project.  If a
 * project is stored in /templates/Project it's .json and .asc and .aia files are
 * expected to be named Project.json, Project.aia, Project.asc:
 *
 *  /templates/HelloPurr/
 *  /templates/HelloPurr/HelloPurr.json  -- JSON description of the project
 *  /templates/HelloPurr/HelloPurr.aia -- the zip archive
 *  /templates/HelloPurr/HelloPurr.asc -- a base64 encoded version of the aia file
 *  /templates/HelloPurr/screenshot.png -- optional screenshot, specified in JSON file
 *  /templates/HelloPurr/thumbnail.png -- optional thumbnail, specified in JSON file
 *  /templates/SomeOtherProject/
 *  ...
 *
 * The .json file is used to construct the description of the project in the Wizard's
 * dialog:
 *
 *  {&quot;name&quot;: &quot;HelloPurr&quot;, &quot;subtitle&quot;: &quot;A purring kitty app&quot;, &quot;description&quot;:
      &quot;&lt;p&gt;This is App Inventor's version of the HelloWorld app. ...&quot;, &quot;screenshot&quot;:
      &quot;screenshot.png&quot;,  &quot;thumbnail&quot;:&quot;thumbnail.png&quot; }
 *
 * The images are used in the templates summary that is displayed in  dialog when
 * the use selects a repository.
 *
 * The base64 encoded file is the one that the Wizard imports.
 */

public class TemplateUploadWizard extends Wizard implements NewUrlDialogCallback {
  // Project archive extension
  private static final String PROJECT_ARCHIVE_EXTENSION = &quot;.zip&quot;;
  private static final String PROJECT_ARCHIVE_ENCODED_EXTENSION = &quot;.asc&quot;;
  public static final String TEMPLATES_ROOT_DIRECTORY =  &quot;templates/&quot;;
  public static final String URL_HOST = &quot;&quot;;  // Default uses server as host, i.e., relative addr
  public static final String EXTERNAL_JSON_FILE = &quot;templates.json&quot;;
  public static final String MIT_TEMPLATES = &quot;Built-in Templates&quot;;
  public static final int MIT_TEMPLATES_INDEX = 1;
  public static final int TIMEOUT = 3000;  // 3 seconds

  /**
   * Reference to the instantiated Wizard. Reset to null when dialog
   * 'Ok' or 'Cancel' buttons are clicked.
   */
  private static TemplateUploadWizard instance;

  /**
   * Needed to retrieve existing templates from user settings
   *
   */
  private static UserSettings userSettings;

  /**
   * The current template host Url.
   */
<span class="nc" id="L145">  private String templateHostUrl = &quot;&quot;;</span>

  public void setTemplateUrlHost(String host) {
<span class="nc" id="L148">    templateHostUrl = host;</span>
<span class="nc" id="L149">  }</span>

  public String getTemplateUrlHost() {
<span class="nc" id="L152">    return templateHostUrl;</span>
  }

  /**
   * Map of dynamic (i.e., not built-in) templates.
   */
<span class="nc" id="L158">  private static Map&lt;String, ArrayList&lt;TemplateInfo&gt;&gt; templatesMap =</span>
    new HashMap&lt;String, ArrayList&lt;TemplateInfo&gt;&gt;();

  /**
   * Json representation of a template repository consisting of
   * one or more App Inventor projects.
   * Set from ProjectService.retrieveTemplateData
   */
  private static String templateDataString;

  /**
   * Keeps track of user-created (not built-in) repositories.
   */
<span class="nc" id="L171">  private static ArrayList&lt;String&gt; dynamicTemplateUrls = new ArrayList&lt;String&gt;();</span>

  /**
   * Sets the dynamic template Urls from a jsonStr.  This method is
   * called during start up where jsonStr is retrieved from User
   * settings.
   *
   * @param jsonStr
   */
  public static void setStoredTemplateUrls(String jsonStr) {
<span class="nc bnc" id="L181" title="All 4 branches missed.">    if (jsonStr == null || jsonStr.length() == 0)</span>
<span class="nc" id="L182">      return;</span>
<span class="nc" id="L183">    JSONValue jsonVal = JSONParser.parseLenient(jsonStr);</span>
<span class="nc" id="L184">    JSONArray jsonArr = jsonVal.isArray();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">    for (int i = 0; i &lt; jsonArr.size(); i++) {</span>
<span class="nc" id="L186">      JSONValue value = jsonArr.get(i);</span>
<span class="nc" id="L187">      JSONString str = value.isString();</span>
<span class="nc" id="L188">      dynamicTemplateUrls.add(str.stringValue());</span>
    }
<span class="nc" id="L190">  }</span>

  /**
   * Retrieves a Json string representing the Urls of dynamic
   * template repositories.  Called when saving UserSettings
   * during shutdown or otherwise.
   *
   * @return a Json string of repository Urls
   */
  public static String getStoredTemplateUrls() {
<span class="nc" id="L200">    String[] arr = new String[dynamicTemplateUrls.size()];</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">    for (int k = 0; k &lt; arr.length; k++) {</span>
<span class="nc" id="L202">      arr[k] = dynamicTemplateUrls.get(k);</span>
    }
<span class="nc" id="L204">    return JSONUtil.toJson(arr);</span>
  }

  /**
   * Returns true if hostUrl is already part of the template library.
   *
   */
  public static boolean hasUrl(String hostUrl) {
<span class="nc bnc" id="L212" title="All 2 branches missed.">   return templatesMap.get(hostUrl) != null;</span>
  }

  /**
   * A list of built-in templates -- typically the MIT repository.
   */
  private static ArrayList&lt;TemplateInfo&gt; builtInTemplates;

  /**
   * Initializes the built-in template repositories.
   *
   * Called by ProjectService.retrieveTemplateData, which passes
   *  a Json string describing the template. This variable is read
   *  when the user selects 'Upload Template' from the Projects Toolbar
   * @param json takes the form of a string:
   *
   * {&quot;name&quot;: &quot;HelloPurr&quot;,   &quot;subtitle&quot;: &quot;A purring kitty app&quot;, &quot;description&quot;:
       &quot;&lt;p&gt;This is App Inventor's version of the HelloWorld app. For more information
        see the &lt;a href='http://appinventor.mit.edu/explore/content/hellopurr.html'
        target='_blank'&gt;HelloPurr tutorial&lt;/a&gt;.&quot;, &quot;screenshot&quot;: &quot;screenshot.png&quot;,
       &quot;thumbnail&quot;:&quot;thumbnail.png&quot; }
  */
  public static void initializeBuiltInTemplates(String json) {
<span class="nc" id="L235">    templateDataString = json;</span>
<span class="nc" id="L236">    builtInTemplates = getTemplates();</span>
<span class="nc" id="L237">    templatesMap.put(MIT_TEMPLATES, builtInTemplates);</span>
<span class="nc" id="L238">  }</span>

  /**
   * UI Panel holding the template list.
   */
  private HorizontalPanel templatePanel;

  /**
   * UI Listbox of template Urls.
   */
  private ListBox templatesMenu;

  /**
   * UI Button for removing a template Url.
   */
  private Button removeButton;

  /**
   * Remembers the last template library selected.
   */
<span class="nc" id="L258">  private int lastSelectedIndex = MIT_TEMPLATES_INDEX;</span>

  /**
   * Set to true when the user has selected an external template.
   */
<span class="nc" id="L263">  private boolean usingExternalTemplate = false;</span>

  /**
   * Set to true when the user is inputting a new Url.
   */
<span class="nc" id="L268">  private boolean newUrlTestIsPending = false;</span>

  /**
   * Stores the Url the user has input, which is not
   * added to the list of repositories until it is validated.
   */
<span class="nc" id="L274">  private String pendingUrl = &quot;&quot;;</span>

  /**
   * Stores the name of the template project selected by user.
   */
<span class="nc" id="L279">  private String selectedTemplateNAME = null;</span>

  /**
   * Returns a list of Template objects containing data needed
   *  to load a template from a zip file. Each non-null template object
   *  is created from its Json string
   *
   * @return ArrayList of TemplateInfo objects
   */
  protected static ArrayList&lt;TemplateInfo&gt; getTemplates() {
<span class="nc" id="L289">    JSONValue jsonVal = JSONParser.parseLenient(templateDataString);</span>
<span class="nc" id="L290">    JSONArray jsonArr = jsonVal.isArray();</span>
<span class="nc" id="L291">    ArrayList&lt;TemplateInfo&gt; templates = new ArrayList&lt;TemplateInfo&gt;();</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">    for (int i = 0; i &lt; jsonArr.size(); i++) {</span>
<span class="nc" id="L293">      JSONValue value = jsonArr.get(i);</span>
<span class="nc" id="L294">      JSONObject obj = value.isObject();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">      if (obj != null)</span>
<span class="nc" id="L296">        templates.add(new TemplateInfo(obj)); // Create TemplateInfo from Json</span>
    }
<span class="nc" id="L298">    return templates;</span>
  }

  /**
   * Creates a new project upload wizard. This is invoked either from ProjectToolbar,
   *  when the user chooses 'Import from repo' from the toolbar menu or from the
   *  retrieveExternalTemplateData's callback method, if an external template library
   *  is selected from the drop-down menu.
   *
   */
  public TemplateUploadWizard() {
<span class="nc" id="L309">    super(MESSAGES.templateUploadWizardCaption(), true, false); // modal, adaptive sizing</span>
<span class="nc" id="L310">    instance = this;</span>

    // Initialize the UI
<span class="nc" id="L313">    this.setStylePrimaryName(&quot;ode-DialogBox&quot;);</span>
<span class="nc" id="L314">    setUpUiAndFinishCommand();</span>
<span class="nc" id="L315">  }</span>

  /**
   * Callback from the InputTemplateUrlWizard.  Part of NewUrlDialogCallback.
   * When newUrl is received an attempt is made to retrieve template data
   * from that address.
   *
   * @param newUrl the possibly invalid Url entered by the user.
   */
  @Override
  public void updateTemplateOptions(String newUrl) {
<span class="nc bnc" id="L326" title="All 2 branches missed.">    if (newUrl.length() != 0) {</span>
<span class="nc" id="L327">      newUrlTestIsPending = true;</span>
<span class="nc" id="L328">      this.pendingUrl = newUrl;</span>
<span class="nc" id="L329">      retrieveSelectedTemplates(newUrl);</span>
    }
<span class="nc" id="L331">  }</span>

  /**
   * Sets up the UI and calls the initFinish() method passing it the
   *  Command that's done when 'Ok' is clicked on the Wizard dialog.
   */
  private void setUpUiAndFinishCommand() {
<span class="nc" id="L338">    this.addPage(createUI(builtInTemplates));</span>
<span class="nc" id="L339">    populateTemplateDialog(builtInTemplates);</span>

<span class="nc" id="L341">    initCancelCommand(new Command() {</span>
        @Override
        public void execute() {
<span class="nc" id="L344">          instance = null;</span>
<span class="nc" id="L345">        }</span>
      });

    // Create finish command (upload a project archive)
<span class="nc" id="L349">    initFinishCommand(new Command() {</span>
        @Override
        public void execute() {
          // Make sure the project name is legal and unique.
<span class="nc bnc" id="L353" title="All 2 branches missed.">          if (TextValidators.checkNewProjectName(selectedTemplateNAME, true) </span>
                  != TextValidators.ProjectNameStatus.SUCCESS) {
<span class="nc" id="L355">            center();</span>
  
<span class="nc" id="L357">            new RequestNewProjectNameWizard(new RequestProjectNewNameInterface() {</span>
              @Override
              public void getNewName(String name) {
<span class="nc" id="L360">                createProject(name);</span>
<span class="nc" id="L361">                hide();</span>
<span class="nc" id="L362">              }</span>
<span class="nc" id="L363">            }, selectedTemplateNAME, true);</span>
          } else {
<span class="nc" id="L365">            createProject(selectedTemplateNAME);  </span>
          }
<span class="nc" id="L367">        }</span>
      });
<span class="nc" id="L369">  }</span>

  /**
   * Create project with given project name.
   * @param projectNameInExplorer project name to be shown in file explorer
   */
  public void createProject(String projectNameInExplorer) {
<span class="nc" id="L376">    NewProjectCommand callbackCommand = new NewProjectCommand() {</span>
        @Override
        public void execute(Project project) {
<span class="nc" id="L379">          Ode.getInstance().openYoungAndroidProjectInDesigner(project);</span>
<span class="nc" id="L380">        }</span>
    };

<span class="nc" id="L383">    createProjectFromExistingZip(selectedTemplateNAME, callbackCommand, projectNameInExplorer);</span>

<span class="nc" id="L385">    Tracking.trackEvent(Tracking.PROJECT_EVENT, Tracking.PROJECT_ACTION_NEW_YA,</span>
        selectedTemplateNAME + PROJECT_ARCHIVE_EXTENSION);
<span class="nc" id="L387">    instance = null;  </span>
<span class="nc" id="L388">  }</span>
  
  /**
   * The UI consists of a vertical panel that holds a drop-down list box,
   *   a Horizontal panel that holds the templates list (cell list) plus
   *   the selected template. This is inserted in the Wizard dialog.
   *
   * @param templates should never be null
   * @return the main panel for Wizard dialog.
   */
  VerticalPanel createUI(final ArrayList&lt;TemplateInfo&gt; templates) {
<span class="nc" id="L399">    VerticalPanel panel = new VerticalPanel();</span>
<span class="nc" id="L400">    panel.setStylePrimaryName(&quot;gwt-SimplePanel&quot;);</span>
<span class="nc" id="L401">    panel.setVerticalAlignment(VerticalPanel.ALIGN_MIDDLE);</span>
<span class="nc" id="L402">    panel.setHorizontalAlignment(VerticalPanel.ALIGN_CENTER);</span>

<span class="nc" id="L404">    templatePanel = new HorizontalPanel();</span>
<span class="nc" id="L405">    templatePanel.add(makeTemplateSelector(templates));</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">    if (templates.size() &gt; 0)</span>
<span class="nc" id="L407">      templatePanel.add(new TemplateWidget(templates.get(0), templateHostUrl));</span>

<span class="nc" id="L409">    templatesMenu = makeTemplatesMenu();</span>

<span class="nc" id="L411">    HorizontalPanel hPanel = new HorizontalPanel();</span>
<span class="nc" id="L412">    hPanel.add(templatesMenu);</span>
<span class="nc" id="L413">    removeButton = new Button(&quot;Remove this repository&quot;, new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent arg0) {
<span class="nc" id="L416">          removeCurrentlySelectedRepository();</span>
<span class="nc" id="L417">        }</span>
      });
<span class="nc" id="L419">    removeButton.setVisible(false);</span>
<span class="nc" id="L420">    hPanel.add(removeButton);</span>
<span class="nc" id="L421">    panel.add(hPanel);</span>
<span class="nc" id="L422">    panel.add(templatePanel);</span>
<span class="nc" id="L423">    return panel;</span>
  }

  /**
   * Adds a new templates host to the list of available repositories.
   *
   * @param hostUrl
   * @param newTemplates
   */
  private static void addNewTemplateHost(String hostUrl, ArrayList&lt;TemplateInfo&gt; newTemplates) {
<span class="nc" id="L433">    templatesMap.put(hostUrl, newTemplates);</span>

    // Display the templates dialog
<span class="nc bnc" id="L436" title="All 2 branches missed.">    if (instance == null) {</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">      if (dynamicTemplateUrls.contains(hostUrl)) {</span>
// Don't alert because we may be invoked via repo=... approach which
// can happen multiple times.
//        Window.alert(&quot;We already have that host &quot; + hostUrl) ;
<span class="nc" id="L441">        instance = new TemplateUploadWizard();</span>
<span class="nc" id="L442">        instance.setTemplateUrlHost(hostUrl);</span>
<span class="nc" id="L443">        instance.populateTemplateDialog(newTemplates);</span>
<span class="nc" id="L444">        instance.center();</span>
<span class="nc" id="L445">        return;</span>
      }
<span class="nc" id="L447">      instance = new TemplateUploadWizard();</span>
<span class="nc" id="L448">      instance.setTemplateUrlHost(hostUrl);</span>
<span class="nc" id="L449">      instance.updateTemplateOptions(hostUrl);</span>
<span class="nc" id="L450">      instance.center();</span>
    } else {
<span class="nc" id="L452">      instance.populateTemplateDialog(newTemplates);</span>
    }

    // Update the user settings
<span class="nc" id="L456">    UserSettings settings = Ode.getUserSettings();</span>
<span class="nc" id="L457">    settings.getSettings(SettingsConstants.USER_GENERAL_SETTINGS).</span>
<span class="nc" id="L458">      changePropertyValue(SettingsConstants.USER_TEMPLATE_URLS,</span>
<span class="nc" id="L459">        TemplateUploadWizard.getStoredTemplateUrls());</span>
<span class="nc" id="L460">    settings.saveSettings(null);</span>
<span class="nc" id="L461">  }</span>

  /**
   * Removes a template repository.
   */
  private void removeCurrentlySelectedRepository() {
<span class="nc" id="L467">    boolean ok = Window.confirm(&quot;Are you sure you want to remove this repository? &quot; +</span>
      &quot;Click cancel to abort.&quot;);
<span class="nc bnc" id="L469" title="All 2 branches missed.">    if (ok) {</span>
<span class="nc" id="L470">      dynamicTemplateUrls.remove(templateHostUrl);</span>
<span class="nc" id="L471">      templatesMap.remove(templateHostUrl);</span>
<span class="nc" id="L472">      templatesMenu.removeItem(lastSelectedIndex);</span>
<span class="nc" id="L473">      templatesMenu.setSelectedIndex(1);</span>
<span class="nc" id="L474">      templatesMenu.setItemSelected(1, true);</span>
<span class="nc" id="L475">      removeButton.setVisible(false);</span>
<span class="nc" id="L476">      retrieveSelectedTemplates(templatesMenu.getValue(1));</span>

      // Update the user settings
<span class="nc" id="L479">      UserSettings settings = Ode.getUserSettings();</span>
<span class="nc" id="L480">      settings.getSettings(SettingsConstants.USER_GENERAL_SETTINGS).</span>
<span class="nc" id="L481">        changePropertyValue(SettingsConstants.USER_TEMPLATE_URLS,</span>
<span class="nc" id="L482">          TemplateUploadWizard.getStoredTemplateUrls());</span>
<span class="nc" id="L483">      settings.saveSettings(null);</span>
    }
<span class="nc" id="L485">  }</span>

  /**
   * Creates a drop down menu for selecting Template repositories.
   * @return the drop down menu of repository Urls.
   */
  private ListBox makeTemplatesMenu() {
<span class="nc" id="L492">    final ListBox templatesMenu = new ListBox();</span>
<span class="nc" id="L493">    templatesMenu.addItem(MESSAGES.templateUploadNewUrlCaption());</span>
<span class="nc" id="L494">    templatesMenu.addItem(MIT_TEMPLATES);</span>

<span class="nc bnc" id="L496" title="All 2 branches missed.">    for (int k = 0; k &lt; dynamicTemplateUrls.size(); k++) { // Dynamically added Urls</span>
<span class="nc" id="L497">      templatesMenu.addItem(dynamicTemplateUrls.get(k));</span>
    }
<span class="nc" id="L499">    templatesMenu.setSelectedIndex(MIT_TEMPLATES_INDEX);</span>
<span class="nc" id="L500">    templatesMenu.addChangeHandler(new ChangeHandler() {</span>
        public void onChange(ChangeEvent event) {
<span class="nc" id="L502">          int selectedIndex = templatesMenu.getSelectedIndex();</span>

<span class="nc bnc" id="L504" title="All 2 branches missed.">          if (selectedIndex == 0) {</span>
<span class="nc" id="L505">            templatesMenu.setSelectedIndex(lastSelectedIndex);</span>
<span class="nc" id="L506">            usingExternalTemplate = true; // MIT templates at index 1</span>
<span class="nc" id="L507">            removeButton.setVisible(false);</span>
<span class="nc" id="L508">            new InputTemplateUrlWizard(instance).center();     // This will do a callback</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">          } else if (selectedIndex == 1) {</span>
<span class="nc" id="L510">            removeButton.setVisible(false);          lastSelectedIndex = selectedIndex;</span>
<span class="nc" id="L511">            usingExternalTemplate = false; // MIT templates at index 1</span>
<span class="nc" id="L512">            templateHostUrl = &quot;&quot;;</span>
<span class="nc" id="L513">            retrieveSelectedTemplates(templatesMenu.getValue(selectedIndex));  // may do callback</span>
          } else {
<span class="nc" id="L515">            removeButton.setVisible(true);         lastSelectedIndex = selectedIndex;</span>
<span class="nc" id="L516">            usingExternalTemplate = true; // MIT templates at index 1</span>
<span class="nc" id="L517">            templateHostUrl = templatesMenu.getValue(selectedIndex);</span>
<span class="nc" id="L518">            retrieveSelectedTemplates(templatesMenu.getValue(selectedIndex));  // may do callback</span>
          }
<span class="nc" id="L520">        }</span>
      });
<span class="nc" id="L522">    templatesMenu.setVisibleItemCount(1);  // Turns menu into a drop-down list).</span>
<span class="nc" id="L523">    return templatesMenu;</span>
  }

  /**
   * Retrieves the templates associated with a particular template repository.
   * Called when the user selects a template library from the drop-down box.
   * If the templates are already stored in the templates map, we just
   * refresh the Wizard's dialog. Otherwise we retrieve the templates
   * from the external hostUrl.
   *
   * @param hostUrl url of an external templates host -- e.g., 'http://localhost:85/'
   */
  void retrieveSelectedTemplates(String hostUrl) {
<span class="nc" id="L536">    ArrayList&lt;TemplateInfo&gt; templates = templatesMap.get(hostUrl);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">    if (templates == null) {</span>
<span class="nc" id="L538">      TemplateUploadWizard.retrieveExternalTemplateData(hostUrl);</span>
    } else {
<span class="nc" id="L540">      populateTemplateDialog(templates);</span>
    }
<span class="nc" id="L542">  }</span>

  /**
   * Loads templates into the templatePanel, which consists of a
   *  clickable list widget of templates and a widget that displays
   *  a summary of the list's current selection.
   *
   * @param templates
   */
  void populateTemplateDialog(ArrayList&lt;TemplateInfo&gt; templates) {
<span class="nc" id="L552">    String hostUrl = &quot;&quot;;</span>

    // Validity check for user-entered Url.
<span class="nc bnc" id="L555" title="All 2 branches missed.">    if (this.newUrlTestIsPending) {</span>
<span class="nc" id="L556">      newUrlTestIsPending = false;</span>
<span class="nc" id="L557">      hostUrl = pendingUrl;</span>
<span class="nc" id="L558">      pendingUrl = &quot;&quot;;</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">      if (templates != null) {</span>
<span class="nc" id="L560">        dynamicTemplateUrls.add(hostUrl);</span>
<span class="nc" id="L561">        templatesMenu.addItem(hostUrl);</span>
<span class="nc" id="L562">        templatesMenu.setSelectedIndex(templatesMenu.getItemCount()-1);  // Last item</span>
<span class="nc" id="L563">        lastSelectedIndex = templatesMenu.getSelectedIndex();</span>
<span class="nc" id="L564">        usingExternalTemplate = true;</span>
<span class="nc" id="L565">        templateHostUrl = templatesMenu.getValue(lastSelectedIndex);</span>
      } else {
<span class="nc" id="L567">        return;</span>
      }
    }

<span class="nc bnc" id="L571" title="All 2 branches missed.">    if (templates == null)</span>
<span class="nc" id="L572">      return;</span>

    // Display the templates for the the selected Url.
<span class="nc bnc" id="L575" title="All 2 branches missed.">    for (int k = 0; k &lt; templatePanel.getWidgetCount(); k++) {</span>
<span class="nc" id="L576">      templatePanel.getWidget(k).removeFromParent();</span>
    }
<span class="nc" id="L578">    VerticalPanel parent = (VerticalPanel) templatePanel.getParent();</span>
<span class="nc" id="L579">    templatePanel.removeFromParent();</span>
<span class="nc" id="L580">    templatePanel = new HorizontalPanel();</span>
    // Add the new templates
<span class="nc" id="L582">    templatePanel.add(makeTemplateSelector(templates));</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">    if (templates.size() &gt; 0)</span>
<span class="nc" id="L584">      templatePanel.add(new TemplateWidget(templates.get(0), templateHostUrl));</span>
<span class="nc" id="L585">    parent.add(templatePanel);</span>
<span class="nc" id="L586">  }</span>

  /**
   * Creates a new project from a Zip file and lists it in the ProjectView.
   *
   * @param projectName project name
   * @param onSuccessCommand command to be executed after process creation
   *   succeeds (can be {@code null})
   */
  public void createProjectFromExistingZip(final String projectName,
      final NewProjectCommand onSuccessCommand, final String projectNameInExplorer) {

    // Callback for updating the project explorer after the project is created on the back-end
<span class="nc" id="L599">    final Ode ode = Ode.getInstance();</span>
<span class="nc" id="L600">    final OdeAsyncCallback&lt;UserProject&gt; callback = new OdeAsyncCallback&lt;UserProject&gt;(</span>
        // failure message
<span class="nc" id="L602">        MESSAGES.createProjectError()) {</span>
      @Override
      public void onSuccess(UserProject projectInfo) {
        // Update project explorer -- i.e., display in project view
<span class="nc bnc" id="L606" title="All 2 branches missed.">        if (projectInfo == null) {</span>

<span class="nc" id="L608">          Window.alert(&quot;This template has no aia file. Creating a new project with name = &quot; </span>
              + projectName);
<span class="nc" id="L610">          ode.getProjectService().newProject(</span>
              YoungAndroidProjectNode.YOUNG_ANDROID_PROJECT_TYPE,
              projectName,
              new NewYoungAndroidProjectParameters(projectName),
              this);
<span class="nc" id="L615">          return;</span>
        }
<span class="nc" id="L617">        Project project = ode.getProjectManager().addProject(projectInfo);</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (onSuccessCommand != null) {</span>
<span class="nc" id="L619">          onSuccessCommand.execute(project);</span>
        }
<span class="nc" id="L621">      }</span>
    };

    // Use project RPC service to create the project on back end using
<span class="nc" id="L625">    String pathToZip = &quot;&quot;;</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">    if (usingExternalTemplate) {</span>
<span class="nc" id="L627">      String zipUrl = templateHostUrl + TEMPLATES_ROOT_DIRECTORY + projectName + &quot;/&quot; +</span>
          projectName + PROJECT_ARCHIVE_ENCODED_EXTENSION;
<span class="nc" id="L629">      RequestBuilder builder = new RequestBuilder(RequestBuilder.GET, zipUrl);</span>
      try {
<span class="nc" id="L631">        Request response = builder.sendRequest(null, new RequestCallback() {</span>
            @Override
            public void onError(Request request, Throwable exception) {
<span class="nc" id="L634">              Window.alert(&quot;Unable to load Project Template Data&quot;);</span>
<span class="nc" id="L635">            }</span>

            @Override
            public void onResponseReceived(Request request, Response response) {
<span class="nc" id="L639">              ode.getProjectService().newProjectFromExternalTemplate(projectNameInExplorer,</span>
<span class="nc" id="L640">                      response.getText(), callback);</span>
<span class="nc" id="L641">            }</span>

          });
<span class="nc" id="L644">      } catch (RequestException e) {</span>
<span class="nc" id="L645">        Window.alert(&quot;Error fetching project zip file template.&quot;);</span>
<span class="nc" id="L646">      }</span>
<span class="nc" id="L647">    } else {</span>
<span class="nc" id="L648">      pathToZip = TEMPLATES_ROOT_DIRECTORY + projectName + &quot;/&quot; + projectName +</span>
        PROJECT_ARCHIVE_EXTENSION;
<span class="nc" id="L650">      ode.getProjectService().newProjectFromTemplate(projectNameInExplorer, pathToZip, callback);</span>
    }
<span class="nc" id="L652">  }</span>

  private static boolean isTemplateName(String name) {
<span class="nc bnc" id="L655" title="All 2 branches missed.">    for (TemplateInfo template : builtInTemplates) {</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">      if (template.name.equals(name)) {</span>
<span class="nc" id="L657">        return true;</span>
      }
<span class="nc" id="L659">    }</span>
<span class="nc" id="L660">    return false;</span>
  }

  /**
   * Called from Ode when a template Url is passed as GET parameter.
   *  The Url could take two forms:
   *  1. appinventor.cs.trincoll.edu/templates/Project/Project.asc
   *     This is a Base64 encoded AI project. In this case the project should be opened.
   *  2. appinventor.cs.trincoll.edu/templates/  or .../templates
   *     This is a repository with 0 or more templates. They should be
   *     loaded into the client and displaye in the Templates Dialog.
   * @param url the template's Url
   * @param onSuccessCommand command to open the project
   */
  public static void openProjectFromTemplate(String url, final NewProjectCommand onSuccessCommand) {
<span class="nc bnc" id="L675" title="All 2 branches missed.">    if (isTemplateName(url)) {</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">      if (TextValidators.checkNewProjectName(url) </span>
              == TextValidators.ProjectNameStatus.SUCCESS) {
<span class="nc" id="L678">        new TemplateUploadWizard().createProjectFromExistingZip(url, new NewProjectCommand() {</span>
          @Override
          public void execute(Project project) {
<span class="nc" id="L681">            Ode.getInstance().openYoungAndroidProjectInDesigner(project);</span>
<span class="nc" id="L682">          }</span>
        }, url);
      }
<span class="nc" id="L685">      return;</span>
    }
<span class="nc bnc" id="L687" title="All 2 branches missed.">    if(!url.startsWith(&quot;http&quot;)) {</span>
<span class="nc" id="L688">      url = Window.Location.getProtocol() + &quot;//&quot; + url;</span>
    }
<span class="nc bnc" id="L690" title="All 2 branches missed.">    if (url.endsWith(&quot;.asc&quot;)) {</span>
<span class="nc" id="L691">      openTemplateProject(url, onSuccessCommand);</span>
    } else  {
<span class="nc" id="L693">      retrieveExternalTemplateData(url);</span>
    }
<span class="nc" id="L695">  }</span>

  /**
   * Helper method for opening a project given its Url
   * @param url A string of the form &quot;http://... .asc
   * @param onSuccessCommand
   */
  private static void openTemplateProject(final String url, final NewProjectCommand onSuccessCommand) {
<span class="nc" id="L703">    final Ode ode = Ode.getInstance();</span>

    // This Async callback is called after the project is input and created
<span class="nc" id="L706">    final OdeAsyncCallback&lt;UserProject&gt; callback = new OdeAsyncCallback&lt;UserProject&gt;(</span>
        // failure message
<span class="nc" id="L708">        MESSAGES.createProjectError()) {</span>
      @Override
      public void onSuccess(UserProject projectInfo) {
        // This just adds the new project to the project manager, not to AppEngine
<span class="nc" id="L712">        Project project = ode.getProjectManager().addProject(projectInfo);</span>
        // And this opens the project
<span class="nc bnc" id="L714" title="All 2 branches missed.">        if (onSuccessCommand != null) {</span>
<span class="nc" id="L715">          onSuccessCommand.execute(project);</span>
        }
<span class="nc" id="L717">      }</span>
    };

    final String projectName;
<span class="nc bnc" id="L721" title="All 2 branches missed.">    if (url.endsWith(&quot;.asc&quot;)) {</span>
<span class="nc" id="L722">      projectName = url.substring(1 + url.lastIndexOf(&quot;/&quot;), url.lastIndexOf(&quot;.&quot;));</span>
    } else {
<span class="nc" id="L724">      return;</span>
    }

    // If project of the same name already exists, just open it
<span class="nc bnc" id="L728" title="All 2 branches missed.">    if (TextValidators.checkNewProjectName(projectName) </span>
              != TextValidators.ProjectNameStatus.SUCCESS) {
<span class="nc" id="L730">      Project project = ode.getProjectManager().getProject(projectName);</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">      if (onSuccessCommand != null) {</span>
<span class="nc" id="L732">        onSuccessCommand.execute(project);</span>
      }
<span class="nc" id="L734">     return;   // Don't retrieve the template if the project is a duplicate</span>
    }

    // Here's where we retrieve the template data
    // Do a GET to retrieve data at url
<span class="nc" id="L739">    RequestBuilder builder = new RequestBuilder(RequestBuilder.GET, url);</span>
    try {
<span class="nc" id="L741">      Request response = builder.sendRequest(null, new RequestCallback() {</span>
        @Override
        public void onError(Request request, Throwable exception) {
<span class="nc" id="L744">          Window.alert(&quot;Unable to load Project Template Data&quot;);</span>
<span class="nc" id="L745">        }</span>

        // Response received from the GET
        @Override
        public void onResponseReceived(Request request, Response response) {
          // The response.getText is the zip data used to create a new project.
          // The callback opens the project
<span class="nc bnc" id="L752" title="All 8 branches missed.">          if (response != null &amp;&amp; response.getStatusCode() == 200 &amp;&amp; response.getText() != null &amp;&amp; !response.getText().isEmpty()) {</span>
<span class="nc" id="L753">            ode.getProjectService().newProjectFromExternalTemplate(projectName, response.getText(), callback);</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">          } else if (url.startsWith(&quot;http:&quot;)) {</span>
<span class="nc" id="L755">            openTemplateProject(url.replaceFirst(&quot;http:&quot;, &quot;https:&quot;), onSuccessCommand);</span>
          }
<span class="nc" id="L757">        }</span>
      });
<span class="nc" id="L759">    } catch (RequestException e) {</span>
<span class="nc" id="L760">      Window.alert(&quot;Error fetching template file.&quot;);</span>
<span class="nc" id="L761">    }</span>
<span class="nc" id="L762">  }</span>

  /**
   * A class to stores template details.
   *
   */
  public static class TemplateInfo { // implements Comparable&lt;TemplateInfo&gt; {
    public String name;
    public String subtitle;
    public String description;
    public String thumbStr;        // thumbStr and/or screenshotStr can be &quot;&quot;
    public String screenshotStr;
    public ImageResource thumbnail;
    public ImageResource screenshot;

    /**
     * The key provider that provides the unique ID of a template, its name.
     */
<span class="nc" id="L780">    public static final ProvidesKey&lt;TemplateInfo&gt; KEY_PROVIDER = new ProvidesKey&lt;TemplateInfo&gt;() {</span>
      @Override
      public Object getKey(TemplateInfo item) {
<span class="nc bnc" id="L783" title="All 2 branches missed.">        return item == null ? null : item.name;</span>
      }
    };

    /**
     * Default constructor
     */
<span class="nc" id="L790">    public TemplateInfo() {</span>
<span class="nc" id="L791">    }</span>

<span class="nc" id="L793">    public TemplateInfo(String name, String subtitle, String description, String screenshot, String thumbnail) {</span>
<span class="nc" id="L794">      this.name = name;</span>
<span class="nc" id="L795">      this.subtitle = subtitle;</span>
<span class="nc" id="L796">      this.description = description;</span>
<span class="nc" id="L797">      this.screenshotStr = screenshot;</span>
<span class="nc" id="L798">      this.thumbStr = thumbnail;</span>
<span class="nc" id="L799">    }</span>

    /**
     * Builds the TemplateInfo object from JSON
     * @param value
     */
<span class="nc" id="L805">    public TemplateInfo(JSONObject value) {</span>
<span class="nc" id="L806">      this.name = value.get(&quot;name&quot;).toString();</span>
<span class="nc" id="L807">      this.name = this.name.substring(1, this.name.length() -1);</span>
<span class="nc" id="L808">      this.subtitle = value.get(&quot;subtitle&quot;).toString();</span>
<span class="nc" id="L809">      this.subtitle = this.subtitle.substring(1, this.subtitle.length() -1);</span>
<span class="nc" id="L810">      this.description = value.get(&quot;description&quot;).toString();</span>
<span class="nc" id="L811">      this.description = this.description.substring(1, this.description.length() -1);</span>
<span class="nc" id="L812">      this.thumbStr = value.get(&quot;thumbnail&quot;).toString();</span>
<span class="nc" id="L813">      this.thumbStr = this.thumbStr.substring(1, this.thumbStr.length() -1);</span>
<span class="nc" id="L814">      this.screenshotStr = value.get(&quot;screenshot&quot;).toString();</span>
<span class="nc" id="L815">      this.screenshotStr = this.screenshotStr.substring(1, this.screenshotStr.length() -1);</span>
<span class="nc" id="L816">    };</span>
  }

  /**
   * A composite widget for displaying a template.
   */
  public static class TemplateWidget extends Composite {
<span class="nc" id="L823">    private static Label title = new Label();</span>
<span class="nc" id="L824">    private static Label subtitle = new Label();</span>
<span class="nc" id="L825">    private static Image image = new Image();</span>
<span class="nc" id="L826">    private static HTML descriptionHtml = new HTML();</span>
    private VerticalPanel panel;

<span class="nc" id="L829">    public TemplateWidget(TemplateInfo info, String hostUrl) {</span>
<span class="nc" id="L830">      setTemplate(info, hostUrl);</span>

<span class="nc" id="L832">      panel = new VerticalPanel();</span>
<span class="nc" id="L833">      panel.add(title);</span>
<span class="nc" id="L834">      title.getElement().getStyle().setFontWeight(Style.FontWeight.BOLD);</span>
<span class="nc" id="L835">      panel.add(subtitle);</span>
<span class="nc" id="L836">      descriptionHtml.setHTML(info.description);</span>
<span class="nc" id="L837">      panel.add(descriptionHtml);</span>
<span class="nc" id="L838">      panel.add(image);</span>
<span class="nc" id="L839">      SimplePanel wrapper = new SimplePanel();</span>
<span class="nc" id="L840">      wrapper.getElement().getStyle().setOverflowY(Style.Overflow.SCROLL);</span>
<span class="nc" id="L841">      wrapper.add(panel);</span>
<span class="nc" id="L842">      initWidget(wrapper);</span>
<span class="nc" id="L843">      setStylePrimaryName(&quot;ode-ContextMenu&quot;);</span>
<span class="nc" id="L844">      setHeight(&quot;355px&quot;);</span>
<span class="nc" id="L845">    }</span>

    public static void setTemplate(TemplateInfo info, String hostUrl) {
<span class="nc" id="L848">      title.setText(info.name);</span>
<span class="nc" id="L849">      subtitle.setText(info.subtitle);</span>
<span class="nc" id="L850">      descriptionHtml.setHTML(info.description);</span>

<span class="nc bnc" id="L852" title="All 2 branches missed.">      if (! info.screenshotStr.equals(&quot;&quot;)) {</span>
<span class="nc" id="L853">        String url = hostUrl + TEMPLATES_ROOT_DIRECTORY + info.name + &quot;/&quot; + info.screenshotStr;</span>
<span class="nc" id="L854">        image.setUrl(url);</span>
<span class="nc" id="L855">      } else {</span>
<span class="nc" id="L856">        TemplateWidget.image.setResource(Ode.getImageBundle().appInventorLogo());</span>
      }
<span class="nc" id="L858">      image.setWidth(&quot;240px&quot;);</span>
<span class="nc" id="L859">      image.setHeight(&quot;400px&quot;);</span>

      // Display the screenshot if available
<span class="nc bnc" id="L862" title="All 2 branches missed.">      if (! info.screenshotStr.equals(&quot;&quot;)) {</span>
<span class="nc" id="L863">        String url = hostUrl + TEMPLATES_ROOT_DIRECTORY + info.name + &quot;/&quot; + info.screenshotStr;</span>
<span class="nc" id="L864">        image.setUrl(url);</span>
      }
<span class="nc" id="L866">    }</span>
  }

  /**
   * A Cell widget for displaying a summary of a template.
   *
   */
  public static class TemplateCell extends AbstractCell&lt;TemplateInfo&gt; {

    public TemplateInfo info;
    private String hostUrl;

<span class="nc" id="L878">    public TemplateCell(TemplateInfo info, String hostUrl) {</span>
<span class="nc" id="L879">      this.info = info;</span>
<span class="nc" id="L880">      this.hostUrl = hostUrl;</span>
<span class="nc" id="L881">    }</span>

    @Override
      public void render(Context context, TemplateInfo template, SafeHtmlBuilder sb) {
<span class="nc bnc" id="L885" title="All 2 branches missed.">      if (template == null)</span>
<span class="nc" id="L886">        return;</span>
<span class="nc" id="L887">      sb.appendHtmlConstant(&quot;&lt;table style='margin: 4pt 0;'&gt;&quot;);</span>

      // Add the thumbnail image, if available, or a default image.
<span class="nc" id="L890">      sb.appendHtmlConstant(&quot;&lt;tr&gt;&lt;td rowspan='3' width=\&quot;32px\&quot;&gt;&quot;);</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">      if ( !template.thumbStr.equals(&quot;&quot;) )   {</span>
<span class="nc" id="L892">        String src = hostUrl + TEMPLATES_ROOT_DIRECTORY +   template.name + &quot;/&quot; + template.thumbStr;</span>
<span class="nc" id="L893">        sb.appendHtmlConstant(&quot;&lt;img style='width:32px' src='&quot; + src + &quot;'&gt;&quot;);</span>
<span class="nc" id="L894">      } else {</span>
<span class="nc" id="L895">        ImageResource imgResource = Ode.getImageBundle().appInventorLogo();</span>
<span class="nc" id="L896">        Image img = new Image(imgResource);</span>
<span class="nc" id="L897">        String url = img.getUrl();</span>
<span class="nc" id="L898">        sb.appendHtmlConstant(&quot;&lt;img style='width:32px' src='&quot; + url + &quot;'&gt;&quot;);</span>
      }
<span class="nc" id="L900">      sb.appendHtmlConstant(&quot;&lt;/td&gt;&quot;);</span>

      // Add the name and description.
<span class="nc" id="L903">      sb.appendHtmlConstant(&quot;&lt;td style='font-size:95%;'&gt;&lt;b&gt;&quot;);</span>
<span class="nc" id="L904">      sb.appendEscaped(template.name);</span>
<span class="nc" id="L905">      sb.appendHtmlConstant(&quot;&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot;);</span>
<span class="nc" id="L906">      sb.appendEscaped(template.subtitle);</span>
<span class="nc" id="L907">      sb.appendHtmlConstant(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<span class="nc" id="L908">    }</span>
  }

  /**
   * Creates the scrollable list of cells each of which serves as a link to a template.
   *
   * @param list an ArrayList of TemplateInfo
   * @return A CellList widget
   */
  public CellList&lt;TemplateInfo&gt; makeTemplateSelector(ArrayList&lt;TemplateInfo&gt; list) {
<span class="nc" id="L918">    TemplateCell templateCell = new TemplateCell(list.get(0), templateHostUrl);</span>

<span class="nc" id="L920">    CellList&lt;TemplateInfo&gt; templateCellList = new CellList&lt;TemplateInfo&gt;(templateCell,TemplateInfo.KEY_PROVIDER);</span>
<span class="nc" id="L921">    templateCellList.setPageSize(list.size() + 10);</span>
<span class="nc" id="L922">    templateCellList.setKeyboardSelectionPolicy(KeyboardSelectionPolicy.ENABLED);</span>
<span class="nc" id="L923">    templateCellList.setWidth(&quot;250px&quot;);</span>
<span class="nc" id="L924">    templateCellList.setHeight(&quot;355px&quot;);</span>
<span class="nc" id="L925">    templateCellList.setVisible(true);</span>
<span class="nc" id="L926">    templateCellList.getElement().getStyle().setOverflowY(Style.Overflow.SCROLL);</span>

    // Add a selection model to handle user selection.
<span class="nc" id="L929">    final SingleSelectionModel&lt;TemplateInfo&gt; selectionModel =</span>
      new SingleSelectionModel&lt;TemplateInfo&gt;(TemplateInfo.KEY_PROVIDER);
<span class="nc" id="L931">    templateCellList.setSelectionModel(selectionModel);</span>
<span class="nc" id="L932">    selectionModel.setSelected(list.get(0), true);</span>
<span class="nc" id="L933">    final TemplateUploadWizard wizard = this;</span>
<span class="nc" id="L934">    selectionModel.addSelectionChangeHandler(new SelectionChangeEvent.Handler() {</span>
        public void onSelectionChange(SelectionChangeEvent event) {
<span class="nc" id="L936">          TemplateInfo selected = selectionModel.getSelectedObject();</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">          if (selected != null) {</span>
<span class="nc" id="L938">            selectedTemplateNAME = selected.name;</span>
<span class="nc" id="L939">            TemplateWidget.setTemplate(selected, wizard.getTemplateUrlHost());</span>
          }
<span class="nc" id="L941">        }</span>
      });

    // Set the total row count. This isn't strictly necessary, but it affects
    // paging calculations, so its good habit to keep the row count up to date.
<span class="nc" id="L946">    templateCellList.setRowCount(list.size(), true);</span>

    // Push the data into the widget.
<span class="nc" id="L949">    templateCellList.setRowData(0, list);</span>
<span class="nc" id="L950">    return templateCellList;</span>
  }

  /**
   * Display the UploadTemplate dialog.
   */
  @Override
  public void show() {
<span class="nc" id="L958">    super.show();</span>
    // Wizard size (having it resize between page changes is quite annoying)
<span class="nc" id="L960">    int width = 640;</span>
<span class="nc" id="L961">    int height = 458;</span>
<span class="nc" id="L962">    this.center();</span>

<span class="nc" id="L964">    setPixelSize(width, height);</span>
<span class="nc" id="L965">    super.setPagePanelHeight(400);</span>
<span class="nc" id="L966">  }</span>

  /**
   * Called from ProjectToolbar when user selects a set of external templates. It uses
   *  JsonP to retrieve a json file from an external server.
   *
   * @param hostUrl, Url of the host -- e.g., http://localhost:85/
   */
  public static void retrieveExternalTemplateData(final String hostUrl) {
<span class="nc" id="L975">    String url = hostUrl +  TEMPLATES_ROOT_DIRECTORY + EXTERNAL_JSON_FILE;</span>

<span class="nc" id="L977">    RequestBuilder builder = new RequestBuilder(RequestBuilder.GET, url);</span>
    try {
<span class="nc" id="L979">      Request response = builder.sendRequest(null, new RequestCallback() {</span>
          @Override
          public void onError(Request request, Throwable exception) {
<span class="nc" id="L982">            Window.alert(&quot;Unable to load Project Template Data.&quot;);</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">            if (instance != null) {</span>
<span class="nc" id="L984">              instance.populateTemplateDialog(null);</span>
            }
<span class="nc" id="L986">          }</span>
          @Override
          public void onResponseReceived(Request request, Response response) {
<span class="nc bnc" id="L989" title="All 2 branches missed.">            if (response.getStatusCode() != Response.SC_OK) {</span>
<span class="nc" id="L990">              Window.alert(&quot;Unable to load Project Template Data.&quot;);</span>
<span class="nc" id="L991">              return;</span>
            }

<span class="nc" id="L994">            ArrayList&lt;TemplateInfo&gt; externalTemplates = new ArrayList&lt;TemplateInfo&gt;();</span>

<span class="nc" id="L996">            JSONValue jsonVal = JSONParser.parseLenient(response.getText());</span>
<span class="nc" id="L997">            JSONArray jsonArr = jsonVal.isArray();</span>

<span class="nc bnc" id="L999" title="All 2 branches missed.">            for(int i = 0; i &lt; jsonArr.size(); i++) {</span>
<span class="nc" id="L1000">              JSONValue entry1 = jsonArr.get(i);</span>
<span class="nc" id="L1001">              JSONObject entry = entry1.isObject();</span>
<span class="nc" id="L1002">              externalTemplates.add(</span>
<span class="nc" id="L1003">                new TemplateInfo(entry.get(&quot;name&quot;).isString().stringValue(),</span>
<span class="nc" id="L1004">                  entry.get(&quot;subtitle&quot;).isString().stringValue(),</span>
<span class="nc" id="L1005">                  entry.get(&quot;description&quot;).isString().stringValue(),</span>
<span class="nc" id="L1006">                  entry.get(&quot;screenshot&quot;).isString().stringValue(),</span>
<span class="nc" id="L1007">                  entry.get(&quot;thumbnail&quot;).isString().stringValue()));</span>
            }
<span class="nc bnc" id="L1009" title="All 2 branches missed.">            if (externalTemplates.size() == 0) {</span>
<span class="nc" id="L1010">              Window.alert(&quot;Unable to retrieve templates for host = &quot; + hostUrl + &quot;.&quot;);</span>
<span class="nc" id="L1011">              return;</span>
            }
<span class="nc" id="L1013">            addNewTemplateHost(hostUrl, externalTemplates);</span>
<span class="nc" id="L1014">          }</span>
        });
<span class="nc" id="L1016">    } catch (RequestException e) {</span>
<span class="nc" id="L1017">      Window.alert(&quot;Error fetching external template.&quot;);</span>
<span class="nc" id="L1018">    }</span>
<span class="nc" id="L1019">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>