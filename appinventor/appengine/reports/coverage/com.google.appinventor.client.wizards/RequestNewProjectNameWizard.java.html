<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RequestNewProjectNameWizard.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.wizards</a> &gt; <span class="el_source">RequestNewProjectNameWizard.java</span></div><h1>RequestNewProjectNameWizard.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2021 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.wizards;

import static com.google.appinventor.client.Ode.MESSAGES;

import com.google.appinventor.client.Ode;
import com.google.appinventor.client.explorer.project.Project;
import com.google.appinventor.client.widgets.LabeledTextBox;
import com.google.appinventor.client.widgets.Validator;
import com.google.appinventor.client.youngandroid.TextValidators;

import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.event.dom.client.KeyCodes;
import com.google.gwt.event.dom.client.KeyDownEvent;
import com.google.gwt.event.dom.client.KeyDownHandler;
import com.google.gwt.event.dom.client.KeyUpEvent;
import com.google.gwt.event.dom.client.KeyUpHandler;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.DialogBox;
import com.google.gwt.user.client.ui.HorizontalPanel;
import com.google.gwt.user.client.ui.VerticalPanel;

/**
 * Wizard for renaming projects.
 *
 */
public class RequestNewProjectNameWizard extends Wizard {

  private LabeledTextBox projectNameTextBox;
  private RequestProjectNewNameInterface newName;
<span class="nc" id="L36">  private String suggestedName = &quot;&quot;;</span>
  private String title;

  /**
   * Shows dialog box to enter a new project name.
   * @param newName entered new project name
   * @param filename original project name
   * @param doSuggestName whether to suggest name or not
   */
  public RequestNewProjectNameWizard(RequestProjectNewNameInterface newName,
      String filename, boolean doSuggestName) {
<span class="nc" id="L47">    super(MESSAGES.requestNewProjectNameLabel(), true, false); </span>
<span class="nc" id="L48">    this.newName = newName;</span>
    
<span class="nc" id="L50">    title = MESSAGES.requestNewProjectNameLabel();</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">    if (doSuggestName) {</span>
<span class="nc" id="L52">      suggestName(filename);</span>
    }
<span class="nc" id="L54">    final DialogBox db = new DialogBox(false, true);              </span>
<span class="nc" id="L55">    db.setText(title);                                                   // title of the dialog box</span>
<span class="nc" id="L56">    db.setStyleName(&quot;ode-DialogBox&quot;);</span>
<span class="nc" id="L57">    db.setHeight(&quot;40px&quot;);</span>
<span class="nc" id="L58">    db.setWidth(&quot;360px&quot;);</span>
    
<span class="nc" id="L60">    projectNameTextBox = </span>
<span class="nc" id="L61">        new LabeledTextBox(MESSAGES.requestNewProjectNameLabel(), new Validator() {</span>
          @Override
          public boolean validate(String value) {
<span class="nc" id="L64">            errorMessage = TextValidators.getErrorMessage(value);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (errorMessage.length() &gt; 0) {</span>
<span class="nc" id="L66">              disableOkButton();</span>
<span class="nc" id="L67">              return false;</span>
            }
<span class="nc" id="L69">            errorMessage = TextValidators.getWarningMessages(value);</span>
<span class="nc" id="L70">            enableOkButton();</span>
<span class="nc" id="L71">            return true;</span>
          }

          @Override
          public String getErrorMessage() {
<span class="nc" id="L76">            return errorMessage;</span>
          }
        });
       
<span class="nc" id="L80">    projectNameTextBox.setText(suggestedName);</span>
    
<span class="nc" id="L82">    projectNameTextBox.getTextBox().addKeyDownHandler(new KeyDownHandler() {</span>
      @Override
      public void onKeyDown(KeyDownEvent event) {
<span class="nc" id="L85">        int keyCode = event.getNativeKeyCode();</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (keyCode == KeyCodes.KEY_ENTER) {</span>
<span class="nc" id="L87">          handleOkClick(db);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        } else if (keyCode == KeyCodes.KEY_ESCAPE) {</span>
          //handleCancelClick();
<span class="nc" id="L90">          db.hide();</span>
        }
<span class="nc" id="L92">      }</span>
    });

<span class="nc" id="L95">    projectNameTextBox.getTextBox().addKeyUpHandler(new KeyUpHandler() {</span>
      @Override
      public void onKeyUp(KeyUpEvent event) { //Validate the text each time a key is lifted
<span class="nc" id="L98">        projectNameTextBox.validate();</span>
<span class="nc" id="L99">      }</span>
    });

<span class="nc" id="L102">    Button okButton = new Button(MESSAGES.okButton());</span>
<span class="nc" id="L103">    Button cancelButton = new Button(MESSAGES.cancelButton());</span>
      
<span class="nc" id="L105">    cancelButton.addClickHandler(new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent event) {
<span class="nc" id="L108">          db.hide();</span>
<span class="nc" id="L109">        }</span>
      });
    
<span class="nc" id="L112">    okButton.addClickHandler(new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent event) {
<span class="nc" id="L115">          handleOkClick(db);</span>
<span class="nc" id="L116">        }</span>
      });
<span class="nc" id="L118">    VerticalPanel page = new VerticalPanel();</span>
<span class="nc" id="L119">    page.add(projectNameTextBox);   </span>
<span class="nc" id="L120">    HorizontalPanel hp = new HorizontalPanel();</span>
               
<span class="nc" id="L122">    hp.add(cancelButton);</span>
<span class="nc" id="L123">    hp.add(okButton);</span>
<span class="nc" id="L124">    page.add(hp); </span>
            
<span class="nc" id="L126">    db.setWidget(page);</span>
<span class="nc" id="L127">    db.center();</span>
<span class="nc" id="L128">    db.show();</span>
<span class="nc" id="L129">  }</span>
  
  /**
   * Initialize dialog box title and suggest name.
   * 
   * @param filename existing name of the project
   */
  private void suggestName(String filename) {

<span class="nc" id="L138">    TextValidators.ProjectNameStatus status = TextValidators</span>
<span class="nc" id="L139">            .checkNewProjectName(filename, true);</span>
<span class="nc" id="L140">    title = getErrorMessage(status, filename);</span>
<span class="nc" id="L141">    filename = filename.replace(&quot; &quot;, &quot;_&quot;).replaceAll(&quot;[^a-zA-Z0-9_]&quot;, &quot;&quot;);</span>
<span class="nc" id="L142">    suggestedName = getSuggestedName(filename);    </span>

<span class="nc bnc" id="L144" title="All 5 branches missed.">    switch (status) {</span>
      case RESERVED :
<span class="nc" id="L146">        suggestedName = &quot;&quot;;</span>
<span class="nc" id="L147">        break;</span>
      
      case INVALIDFORMAT :
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (TextValidators.checkNewProjectName(suggestedName, true) </span>
                != TextValidators.ProjectNameStatus.SUCCESS) {
<span class="nc" id="L152">          suggestedName = &quot;&quot;;</span>
        } else {
<span class="nc" id="L154">          title += MESSAGES.suggestNameTitleCaption(suggestedName);</span>
        }
<span class="nc" id="L156">        break;</span>
      
      case DUPLICATE :
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (TextValidators.checkNewProjectName(suggestedName, true)</span>
                  != TextValidators.ProjectNameStatus.SUCCESS) {
<span class="nc" id="L161">          suggestedName = &quot;&quot;;</span>
        } else {
<span class="nc" id="L163">          title += MESSAGES.suggestNameTitleCaption(suggestedName);</span>
        }
<span class="nc" id="L165">        break;</span>
      
      case DUPLICATEINTRASH :
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (TextValidators.checkNewProjectName(suggestedName, true)</span>
                != TextValidators.ProjectNameStatus.SUCCESS) {
<span class="nc" id="L170">          suggestedName = &quot;&quot;;</span>
        } else {
<span class="nc" id="L172">          title += MESSAGES.suggestNameTitleCaption(suggestedName);</span>
        }
<span class="nc" id="L174">        break;</span>
      
      default :
        break;
    }
<span class="nc" id="L179">  }</span>
  
  private String getErrorMessage(TextValidators.ProjectNameStatus status, String filename) {
<span class="nc bnc" id="L182" title="All 5 branches missed.">    switch (status) {</span>
      case RESERVED :
<span class="nc" id="L184">        return MESSAGES.reservedTitleFormatError(filename);</span>
      case INVALIDFORMAT :
<span class="nc" id="L186">        return MESSAGES.invalidTitleFormatError(filename);</span>
      case DUPLICATE :
<span class="nc" id="L188">        return MESSAGES.duplicateTitleFormatError(filename);</span>
      case DUPLICATEINTRASH :
<span class="nc" id="L190">        return MESSAGES.duplicateTitleInTrashFormatError(filename);</span>
      default :
<span class="nc" id="L192">        return MESSAGES.successfulTitleFormat();</span>
    }
  }

  /**
   * Suggests a project name based on existing project names
   * if hello,hello4 are in project list and user tries to upload
   * another project hello.aia then it suggests hello5 or if user uploads
   * hello4.aia then it suggests hello5.
   * 
   * @param filename initial filename
   * @return suggested name
   */
  private String getSuggestedName(String filename) {
<span class="nc" id="L206">    int max = 0;</span>
<span class="nc" id="L207">    int len = filename.length();</span>
<span class="nc" id="L208">    int lastInt = filename.charAt(len - 1);</span>
<span class="nc" id="L209">    int splitPosition = len;</span>
<span class="nc bnc" id="L210" title="All 4 branches missed.">    if (lastInt &lt;= 57 &amp;&amp; lastInt &gt;= 48) {</span>
<span class="nc" id="L211">      splitPosition = len - 1;</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">      for (int i = len - 2; i &gt;= 0; i--) {</span>
<span class="nc" id="L213">        int cur = filename.charAt(i);</span>
<span class="nc bnc" id="L214" title="All 4 branches missed.">        if (cur &lt;= 57 &amp;&amp; cur &gt;= 48) {</span>
<span class="nc" id="L215">          splitPosition--; </span>
        } else {
          break;
        }
      }
  
<span class="nc bnc" id="L221" title="All 2 branches missed.">      if (splitPosition == 0) {</span>
<span class="nc" id="L222">        return filename;</span>
      }
<span class="nc" id="L224">      filename = filename.substring(0, splitPosition);</span>
    }
<span class="nc bnc" id="L226" title="All 2 branches missed.">    for (Project proj : Ode.getInstance().getProjectManager().getProjects(filename)) {</span>
<span class="nc" id="L227">      String sub = proj.getProjectName().substring(splitPosition);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">      if (sub.length() &gt; 0) { </span>
        try {
<span class="nc" id="L230">          lastInt = Integer.parseInt(sub);</span>
<span class="nc" id="L231">        } catch (Exception e) {</span>
<span class="nc" id="L232">          lastInt = -1;</span>
<span class="nc" id="L233">        }</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (lastInt &gt; max) {</span>
<span class="nc" id="L235">          max = lastInt;</span>
        }
      } else {
<span class="nc" id="L238">        max++;</span>
      }
<span class="nc" id="L240">    }</span>
<span class="nc" id="L241">    max++;</span>
<span class="nc" id="L242">    return filename + max;</span>
  }
  
  /**
   * When user enters new project name it checks whether it is valid or not
   * and then Callbacks with new Project name when it is valid.
   * 
   * @param db Dialogbox shown to user
   */
  public void handleOkClick(DialogBox db) {
<span class="nc" id="L252">    String newEnteredName = projectNameTextBox.getText();</span>
<span class="nc" id="L253">    newEnteredName = newEnteredName.replaceAll(&quot;( )+&quot;, &quot; &quot;).replace(&quot; &quot;, &quot;_&quot;);</span>
<span class="nc" id="L254">    TextValidators.ProjectNameStatus status </span>
<span class="nc" id="L255">        = TextValidators.checkNewProjectName(newEnteredName, true);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">    if (status == TextValidators.ProjectNameStatus.SUCCESS) {</span>
<span class="nc" id="L257">      db.hide();</span>
<span class="nc" id="L258">      newName.getNewName(newEnteredName);</span>
    } else {
<span class="nc" id="L260">      projectNameTextBox.setFocus(true);</span>
<span class="nc" id="L261">      projectNameTextBox.selectAll();</span>
<span class="nc" id="L262">      db.setText(getErrorMessage(status, newEnteredName));</span>
    }
<span class="nc" id="L264">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>