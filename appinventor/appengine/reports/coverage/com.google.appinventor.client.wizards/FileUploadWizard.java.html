<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileUploadWizard.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.wizards</a> &gt; <span class="el_source">FileUploadWizard.java</span></div><h1>FileUploadWizard.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2020 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.wizards;

import static com.google.appinventor.client.Ode.MESSAGES;

import com.google.appinventor.client.ErrorReporter;
import com.google.appinventor.client.Ode;
import com.google.appinventor.client.OdeAsyncCallback;
import com.google.appinventor.client.explorer.project.Project;
import com.google.appinventor.client.utils.Uploader;
import com.google.appinventor.client.youngandroid.TextValidators;
import com.google.appinventor.shared.rpc.ServerLayout;
import com.google.appinventor.shared.rpc.UploadResponse;
import com.google.appinventor.shared.rpc.project.FileNode;
import com.google.appinventor.shared.rpc.project.FolderNode;
import com.google.appinventor.shared.rpc.project.ProjectNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidAssetNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidAssetsFolder;
import com.google.gwt.core.client.GWT;
import com.google.gwt.user.client.Command;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.ui.FileUpload;
import com.google.gwt.user.client.ui.VerticalPanel;
import com.google.gwt.user.client.ui.DialogBox;
import com.google.gwt.user.client.ui.HTML;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.ClickListener;
import com.google.gwt.user.client.ui.Widget;
import com.google.gwt.user.client.ui.FlowPanel;
import java.util.Collection;


/**
 * Wizard for uploading individual files.
 *
 */
public class FileUploadWizard extends Wizard {
  /**
   * Interface for callback to execute after a file is uploaded.
   */
  public interface FileUploadedCallback {
    /**
     * Will be invoked after a file is uploaded.
     *
     * @param folderNode the upload destination folder
     * @param fileNode the file just uploaded
     */
    void onFileUploaded(FolderNode folderNode, FileNode fileNode);
  }

  /**
   * Creates a new file upload wizard.
   *
   * @param folderNode the upload destination folder
   */
  public FileUploadWizard(FolderNode folderNode) {
<span class="nc" id="L62">    this(folderNode, null);</span>
<span class="nc" id="L63">  }</span>

  /**
   * Creates a new file upload wizard.
   *
   * @param folderNode the upload destination folder
   * @param fileUploadedCallback callback to be executed after upload
   */
  public FileUploadWizard(FolderNode folderNode, FileUploadedCallback fileUploadedCallback) {
<span class="nc" id="L72">    this(folderNode, null, fileUploadedCallback);</span>
<span class="nc" id="L73">  }</span>

  /**
   * Creates a new file upload wizard.
   *
   * @param folderNode the upload destination folder
   * @param acceptableTypes a collection of acceptable types, or null.
   * @param fileUploadedCallback callback to be executed after upload
   */
  public FileUploadWizard(final FolderNode folderNode,
      final Collection&lt;String&gt; acceptableTypes,
      final FileUploadedCallback fileUploadedCallback) {
<span class="nc" id="L85">    super(MESSAGES.fileUploadWizardCaption(), true, false);</span>

    // Initialize UI
<span class="nc" id="L88">    final FileUpload upload = new FileUpload();</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">    if (acceptableTypes != null) {</span>
<span class="nc" id="L90">      upload.getElement().setAttribute(&quot;accept&quot;, String.join(&quot;,&quot;, acceptableTypes));</span>
    }
<span class="nc" id="L92">    upload.setName(ServerLayout.UPLOAD_FILE_FORM_ELEMENT);</span>
<span class="nc" id="L93">    setStylePrimaryName(&quot;ode-DialogBox&quot;);</span>
<span class="nc" id="L94">    VerticalPanel panel = new VerticalPanel();</span>
<span class="nc" id="L95">    panel.setVerticalAlignment(VerticalPanel.ALIGN_MIDDLE);</span>
<span class="nc" id="L96">    panel.add(upload);</span>
<span class="nc" id="L97">    addPage(panel);</span>

    // Create finish command (upload a file)
<span class="nc" id="L100">    initFinishCommand(new Command() {</span>
      @Override
      public void execute() {
<span class="nc" id="L103">        String uploadFilename = upload.getFilename();</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!uploadFilename.isEmpty()) {</span>
<span class="nc" id="L105">          final String filename = makeValidFilename(uploadFilename);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">          if(!TextValidators.isValidCharFilename(filename)){</span>
<span class="nc" id="L107">            createErrorDialog(MESSAGES.malformedFilenameTitle(), MESSAGES.malformedFilename(),</span>
              Error.NOFILESELECETED, folderNode, acceptableTypes, fileUploadedCallback);
<span class="nc" id="L109">            return;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">          } else if (!TextValidators.isValidLengthFilename(filename)){</span>
<span class="nc" id="L111">            createErrorDialog(MESSAGES.filenameBadSizeTitle(), MESSAGES.filenameBadSize(),</span>
              Error.FILENAMEBADSIZE, folderNode, acceptableTypes, fileUploadedCallback);
<span class="nc" id="L113">            return;</span>
          }
<span class="nc" id="L115">          int nameLength = uploadFilename.length();</span>
<span class="nc" id="L116">          String fileEnd = uploadFilename.substring(nameLength-4, nameLength);</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">          if (&quot;.aia&quot;.equals(fileEnd.toLowerCase())) {</span>
<span class="nc" id="L119">            createErrorDialog(MESSAGES.aiaMediaAssetTitle(), MESSAGES.aiaMediaAsset(),</span>
              Error.AIAMEDIAASSET, folderNode, acceptableTypes, fileUploadedCallback);
<span class="nc" id="L121">            return;</span>
          }
<span class="nc" id="L123">          String fn = conflictingExistingFile(folderNode, filename);</span>
<span class="nc bnc" id="L124" title="All 4 branches missed.">          if (fn != null &amp;&amp; !confirmOverwrite(folderNode, fn, filename)) {</span>
<span class="nc" id="L125">            return;</span>
          } else {
<span class="nc" id="L127">            String fileId = folderNode.getFileId() + &quot;/&quot; + filename;</span>
            // We delete all the conflicting files.
<span class="nc bnc" id="L129" title="All 2 branches missed.">            for (ProjectNode child : folderNode.getChildren()) {</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">              if (fileId.equalsIgnoreCase(child.getFileId()) &amp;&amp; !fileId.equals(child.getFileId())) {</span>
<span class="nc" id="L131">                final ProjectNode node = child;</span>
<span class="nc" id="L132">                String filesToClose [] = { node.getFileId()};</span>
<span class="nc" id="L133">                Ode ode = Ode.getInstance();</span>
<span class="nc" id="L134">                ode.getEditorManager().closeFileEditors(node.getProjectId(), filesToClose);</span>
<span class="nc" id="L135">                ode.getProjectService().deleteFile(ode.getSessionId(),</span>
<span class="nc" id="L136">                    node.getProjectId(), node.getFileId(),</span>
                    new OdeAsyncCallback&lt;Long&gt;(
                        // message on failure
<span class="nc" id="L139">                        MESSAGES.deleteFileError()) {</span>
                      @Override
                      public void onSuccess(Long date) {
<span class="nc" id="L142">                        Ode.getInstance().getProjectManager().getProject(node).deleteNode(node);</span>
<span class="nc" id="L143">                        Ode.getInstance().updateModificationDate(node.getProjectId(), date);</span>

<span class="nc" id="L145">                      }</span>
                    });
              }
<span class="nc" id="L148">            }</span>
          }
<span class="nc" id="L150">          ErrorReporter.reportInfo(MESSAGES.fileUploadingMessage(filename));</span>

          // Use the folderNode's project id and file id in the upload URL so that the file is
          // uploaded into that project and that folder in our back-end storage.
<span class="nc" id="L154">          String uploadUrl = GWT.getModuleBaseURL() + ServerLayout.UPLOAD_SERVLET + &quot;/&quot; +</span>
<span class="nc" id="L155">              ServerLayout.UPLOAD_FILE + &quot;/&quot; + folderNode.getProjectId() + &quot;/&quot; +</span>
<span class="nc" id="L156">              folderNode.getFileId() + &quot;/&quot; + filename;</span>
<span class="nc" id="L157">          Uploader.getInstance().upload(upload, uploadUrl,</span>
<span class="nc" id="L158">              new OdeAsyncCallback&lt;UploadResponse&gt;(MESSAGES.fileUploadError()) {</span>
            @Override
            public void onSuccess(UploadResponse uploadResponse) {
<span class="nc bnc" id="L161" title="All 3 branches missed.">              switch (uploadResponse.getStatus()) {</span>
              case SUCCESS:
<span class="nc" id="L163">                ErrorReporter.hide();</span>
<span class="nc" id="L164">                onUploadSuccess(folderNode, filename, uploadResponse.getModificationDate(),</span>
                    fileUploadedCallback);
<span class="nc" id="L166">                break;</span>
              case FILE_TOO_LARGE:
                // The user can resolve the problem by
                // uploading a smaller file.
<span class="nc" id="L170">                ErrorReporter.reportInfo(MESSAGES.fileTooLargeError());</span>
<span class="nc" id="L171">                break;</span>
              default:
<span class="nc" id="L173">                ErrorReporter.reportError(MESSAGES.fileUploadError());</span>
                break;
              }
<span class="nc" id="L176">            }</span>
          });
<span class="nc" id="L178">        } else {</span>
<span class="nc" id="L179">          createErrorDialog(MESSAGES.noFileSelectedTitle(), MESSAGES.noFileSelected(),</span>
              Error.NOFILESELECETED, folderNode, acceptableTypes, fileUploadedCallback);
        }
<span class="nc" id="L182">      }</span>
    });
<span class="nc" id="L184">  }</span>

  @Override
  public void show() {
<span class="nc" id="L188">    super.show();</span>
<span class="nc" id="L189">    int width = 320;</span>
<span class="nc" id="L190">    int height = 40;</span>
<span class="nc" id="L191">    this.center();</span>

<span class="nc" id="L193">    setPixelSize(width, height);</span>
<span class="nc" id="L194">    super.setPagePanelHeight(40);</span>
<span class="nc" id="L195">  }</span>

  private String makeValidFilename(String uploadFilename) {
    // Strip leading path off filename.
    // We need to support both Unix ('/') and Windows ('\\') separators.
<span class="nc" id="L200">    String filename = uploadFilename.substring(</span>
<span class="nc" id="L201">        Math.max(uploadFilename.lastIndexOf('/'), uploadFilename.lastIndexOf('\\')) + 1);</span>
    // We need to strip out whitespace from the filename.
<span class="nc" id="L203">    filename = filename.replaceAll(&quot;\\s&quot;, &quot;&quot;);</span>
<span class="nc" id="L204">    return filename;</span>
  }

  private String conflictingExistingFile(FolderNode folderNode, String filename) {
<span class="nc" id="L208">    String fileId = folderNode.getFileId() + &quot;/&quot; + filename;</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">    for (ProjectNode child : folderNode.getChildren()) {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">      if (fileId.equalsIgnoreCase(child.getFileId())) {</span>
        // we want to return kitty.png rather than assets/kitty.png
<span class="nc" id="L212">        return lastPathComponent(child.getFileId());</span>
      }
<span class="nc" id="L214">    }</span>
<span class="nc" id="L215">    return null;</span>
  }

  private String lastPathComponent (String path) {
<span class="nc" id="L219">    String [] pieces = path.split(&quot;/&quot;);</span>
<span class="nc" id="L220">    return pieces[pieces.length - 1];</span>
  }

  private boolean confirmOverwrite(FolderNode folderNode, String newFile, String existingFile) {
<span class="nc" id="L224">    return Window.confirm(MESSAGES.confirmOverwrite(newFile, existingFile));</span>
  }

  private void onUploadSuccess(final FolderNode folderNode, final String filename,
      long modificationDate, final FileUploadedCallback fileUploadedCallback) {
<span class="nc" id="L229">    Ode.getInstance().updateModificationDate(folderNode.getProjectId(), modificationDate);</span>
<span class="nc" id="L230">    finishUpload(folderNode, filename, fileUploadedCallback);</span>
<span class="nc" id="L231">  }</span>

  private void finishUpload(FolderNode folderNode, String filename,
      FileUploadedCallback fileUploadedCallback) {
<span class="nc" id="L235">    String uploadedFileId = folderNode.getFileId() + &quot;/&quot; + filename;</span>
    FileNode uploadedFileNode;
<span class="nc bnc" id="L237" title="All 2 branches missed.">    if (folderNode instanceof YoungAndroidAssetsFolder) {</span>
<span class="nc" id="L238">      uploadedFileNode = new YoungAndroidAssetNode(filename, uploadedFileId);</span>
    } else {
<span class="nc" id="L240">      uploadedFileNode = new FileNode(filename, uploadedFileId);</span>
    }

<span class="nc" id="L243">    Project project = Ode.getInstance().getProjectManager().getProject(folderNode);</span>
<span class="nc" id="L244">    uploadedFileNode = (FileNode) project.addNode(folderNode, uploadedFileNode);</span>

<span class="nc bnc" id="L246" title="All 2 branches missed.">    if (fileUploadedCallback != null) {</span>
<span class="nc" id="L247">      fileUploadedCallback.onFileUploaded(folderNode, uploadedFileNode);</span>
    }
<span class="nc" id="L249">  }</span>

  private void createErrorDialog(String title, String body, Error e,
      final FolderNode folderNode, final Collection&lt;String&gt; acceptableTypes,
      final FileUploadedCallback fileUploadedCallback) {
<span class="nc" id="L254">    final DialogBox dialogBox = new DialogBox(false,true);</span>
    HTML message;
<span class="nc" id="L256">    dialogBox.setStylePrimaryName(&quot;ode-DialogBox&quot;);</span>
<span class="nc" id="L257">    dialogBox.setHeight(&quot;150px&quot;);</span>
<span class="nc" id="L258">    dialogBox.setWidth(&quot;350px&quot;);</span>
<span class="nc" id="L259">    dialogBox.setGlassEnabled(true);</span>
<span class="nc" id="L260">    dialogBox.setAnimationEnabled(true);</span>
<span class="nc" id="L261">    dialogBox.center();</span>
<span class="nc" id="L262">    VerticalPanel DialogBoxContents = new VerticalPanel();</span>
<span class="nc" id="L263">    FlowPanel holder = new FlowPanel();</span>
<span class="nc" id="L264">    Button ok = new Button (&quot;OK&quot;);</span>
<span class="nc" id="L265">    ok.addClickListener(new ClickListener() {</span>
      public void onClick(Widget sender) {
<span class="nc" id="L267">        dialogBox.hide();</span>
<span class="nc" id="L268">        new FileUploadWizard(folderNode, acceptableTypes, fileUploadedCallback).show();</span>
<span class="nc" id="L269">      }</span>
    });
<span class="nc" id="L271">    holder.add(ok);</span>
<span class="nc" id="L272">    dialogBox.setText(title);</span>
<span class="nc" id="L273">    message = new HTML(body);</span>

<span class="nc bnc" id="L275" title="All 2 branches missed.">    switch(e) {</span>
      case AIAMEDIAASSET:
<span class="nc" id="L277">        Button info = new Button (&quot;More Info&quot;);</span>
<span class="nc" id="L278">        info.addClickListener(new ClickListener() {</span>
          public void onClick(Widget sender) {
<span class="nc" id="L280">            Window.open(MESSAGES.aiaMediaAssetHelp(), &quot;AIA Help&quot;, &quot;&quot;);</span>
<span class="nc" id="L281">          }</span>
        });
<span class="nc" id="L283">        holder.add(info);</span>
      case NOFILESELECETED:
      case MALFORMEDFILENAME:
      case FILENAMEBADSIZE:
      default:
        break;
    }

<span class="nc" id="L291">    message.setStyleName(&quot;DialogBox-message&quot;);</span>
<span class="nc" id="L292">    DialogBoxContents.add(message);</span>
<span class="nc" id="L293">    DialogBoxContents.add(holder);</span>
<span class="nc" id="L294">    dialogBox.setWidget(DialogBoxContents);</span>
<span class="nc" id="L295">    dialogBox.show();</span>
<span class="nc" id="L296">  }</span>

}

<span class="nc" id="L300">enum Error {</span>
<span class="nc" id="L301">  AIAMEDIAASSET, NOFILESELECETED, MALFORMEDFILENAME, FILENAMEBADSIZE</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>