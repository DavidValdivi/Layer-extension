<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DropDownButton.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.widgets</a> &gt; <span class="el_source">DropDownButton.java</span></div><h1>DropDownButton.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright Â© 2013-2017 Massachusetts Institute of Technology, All rights reserved.
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.widgets;

import com.google.appinventor.client.utils.PZAwarePositionCallback;
import com.google.gwt.dom.client.Element;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.user.client.Command;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.ui.MenuItem;

import com.google.gwt.user.client.ui.Image;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Class representing a drop-down button with its associated menu. Note
 * that all items in the menu should have unique captions for removeItem
 * and setItemEnabled to work properly.
 */
public class DropDownButton extends TextButton {

  private final ContextMenu menu;
<span class="nc" id="L31">  private final Map&lt;String, MenuItem&gt; itemsById = new HashMap&lt;&gt;();</span>
  private final List&lt;MenuItem&gt; items;
  private final boolean rightAlign;

  public static class DropDownItem {
    private final String widgetName;
    private String caption;
    private final Command command;
    private final String style;

<span class="nc" id="L41">    public DropDownItem(String widgetName, String caption, Command command) {</span>
<span class="nc" id="L42">      this.widgetName = widgetName;</span>
<span class="nc" id="L43">      this.caption = caption;</span>
<span class="nc" id="L44">      this.command = command;</span>
<span class="nc" id="L45">      this.style = null;</span>
<span class="nc" id="L46">    }</span>

<span class="nc" id="L48">    public DropDownItem(String widgetName, String caption, Command command, String style) {</span>
<span class="nc" id="L49">      this.widgetName = widgetName;</span>
<span class="nc" id="L50">      this.caption = caption;</span>
<span class="nc" id="L51">      this.command = command;</span>
<span class="nc" id="L52">      this.style = style;</span>
<span class="nc" id="L53">    }</span>

  }

  /**
   * A subclass of PZAwarePositionCallback designed to position the ContextMenu
   * of a DropDownButton.
   */
  private class DropDownPositionCallback extends PZAwarePositionCallback {
<span class="nc" id="L62">    public DropDownPositionCallback(Element elem) {</span>
<span class="nc" id="L63">      super(elem);</span>
<span class="nc" id="L64">    }</span>

    /**
     * @param offsetWidth width of the ContextMenu being positioned on the parent element
     * @param offsetHeight height of the ContextMenu being positioned on the parent element
     * Sets the position of the ContextMenu on the screen given it's dimensions
     */
    @Override
    public void setPosition(int offsetWidth, int offsetHeight) {

      // getAbsoluteLeft/Right() gives the top coordinate of the parent element
      // getOffsetWidth/Height() gives the width/height of the parent element
<span class="nc bnc" id="L76" title="All 4 branches missed.">      int left = Window.Navigator.getUserAgent().contains(&quot;Chrome&quot;) &amp;&amp; isPinchZoomed()</span>
<span class="nc" id="L77">              ? getTrueAbsoluteLeft() : getAbsoluteLeft();</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">      if (rightAlign) {</span>
<span class="nc" id="L80">        left += getOffsetWidth() - offsetWidth;</span>
      }

<span class="nc bnc" id="L83" title="All 4 branches missed.">      int top = Window.Navigator.getUserAgent().contains(&quot;Chrome&quot;) &amp;&amp; isPinchZoomed()</span>
<span class="nc" id="L84">              ? getTrueAbsoluteTop() + getOffsetHeight()</span>
<span class="nc" id="L85">              : getAbsoluteTop() + getOffsetHeight();</span>

      // Values to determine how to display the ContextMenu - above or below

<span class="nc" id="L89">      int dropDownBottom = top + offsetHeight;</span>
<span class="nc" id="L90">      int screenBottom  = Window.getScrollTop()+Window.getClientHeight();</span>

      // if the bottom will go off the current browser screen, display
      // the dropdown as a 'dropup' where the ContextMenu appears
      // above instead

<span class="nc bnc" id="L96" title="All 2 branches missed.">      if(dropDownBottom &gt; screenBottom) {</span>
<span class="nc bnc" id="L97" title="All 4 branches missed.">          int newTop = Window.Navigator.getUserAgent().contains(&quot;Chrome&quot;) &amp;&amp; isPinchZoomed()</span>
<span class="nc" id="L98">            ? getTrueAbsoluteTop() -offsetHeight</span>
<span class="nc" id="L99">            : getAbsoluteTop() - offsetHeight;</span>

          // account for the extreeeemely unlikely case where newTop
          // also goes off the screen in this case, it makes more
          // sense to just go off the bottom of the screen (the screen
          // won't grow up, and so the menu would get completely cut
          // off at the top

<span class="nc bnc" id="L107" title="All 2 branches missed.">          if(newTop &gt;= 0) {</span>
<span class="nc" id="L108">              top = newTop;</span>
          }
      }

<span class="nc" id="L112">      menu.setPopupPosition(left, top);</span>

<span class="nc" id="L114">    }</span>
  }

  // Create a new drop-down menu button (with text), initially populated with items. Null
  // items in the list cause a separator to be added at that position.
  public DropDownButton(String widgetName, String caption, List&lt;DropDownItem&gt; toolbarItems,
                        boolean rightAlign) {
<span class="nc" id="L121">    super(caption + &quot; \u25BE &quot;);  // drop down triangle</span>

<span class="nc" id="L123">    this.menu = new ContextMenu();</span>
<span class="nc" id="L124">    this.items = new ArrayList&lt;MenuItem&gt;();</span>
<span class="nc" id="L125">    this.rightAlign = rightAlign;</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">    for (DropDownItem item : toolbarItems) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">      if (item != null) {</span>
<span class="nc" id="L129">        this.items.add(menu.addItem(item.caption, true, item.command, item.style));</span>
      } else {
<span class="nc" id="L131">        menu.addSeparator();</span>
      }
<span class="nc" id="L133">    }</span>

<span class="nc" id="L135">    addClickHandler(new ClickHandler() {</span>
      @Override
      public void onClick(ClickEvent event) {
<span class="nc" id="L138">        menu.setPopupPositionAndShow(new DropDownPositionCallback(getElement()));</span>
<span class="nc" id="L139">      }</span>
    });
<span class="nc" id="L141">  }</span>

  public DropDownButton(String widgetName, String caption, List&lt;DropDownItem&gt; toolbarItems,
                        boolean rightAlign, boolean hasTriangle) {
<span class="nc" id="L145">    this(widgetName, caption, toolbarItems, rightAlign);</span>

<span class="nc bnc" id="L147" title="All 2 branches missed.">    if (!hasTriangle) {</span>
<span class="nc" id="L148">      setText(caption);</span>
    }
<span class="nc" id="L150">  }</span>

  public DropDownButton(String widgetName, String caption, List&lt;DropDownItem&gt; toolbarItems,
                        boolean rightAlign, boolean hasTriangle, boolean hasHtmlCaption) {
<span class="nc" id="L154">    this(widgetName, caption, toolbarItems, rightAlign);</span>

<span class="nc bnc" id="L156" title="All 2 branches missed.">    if (hasHtmlCaption) {</span>

      // Set the button's caption as an HTML String with or without a dropdown triangle
<span class="nc bnc" id="L159" title="All 2 branches missed.">      if (hasTriangle)</span>
<span class="nc" id="L160">        setCaption(caption);</span>
      else
<span class="nc" id="L162">        setHTML(caption);</span>
    }
<span class="nc" id="L164">  }</span>

  // Create a new drop-down menu button (with image), initially populated with items. Null
  // items in the list cause a separator to be added at that position.
  public DropDownButton(String widgetName, Image icon, List&lt;DropDownItem&gt; toolbarItems,
                        boolean rightAlign) {
<span class="nc" id="L170">    super(icon);  // icon for button</span>

<span class="nc" id="L172">    this.menu = new ContextMenu();</span>
<span class="nc" id="L173">    this.items = new ArrayList&lt;MenuItem&gt;();</span>
<span class="nc" id="L174">    this.rightAlign = rightAlign;</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">    for (DropDownItem item : toolbarItems) {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">      if (item != null) {</span>
<span class="nc" id="L178">        addItem(item);</span>
      } else {
<span class="nc" id="L180">        menu.addSeparator();</span>
      }
<span class="nc" id="L182">    }</span>

<span class="nc" id="L184">    addClickHandler(new ClickHandler() {</span>
      @Override
      public void onClick(ClickEvent event) {
<span class="nc" id="L187">        menu.setPopupPositionAndShow(new DropDownPositionCallback(getElement()));</span>
<span class="nc" id="L188">      }</span>
    });
<span class="nc" id="L190">  }</span>

  public void clearAllItems() {
<span class="nc bnc" id="L193" title="All 2 branches missed.">    for (MenuItem item : items) {</span>
<span class="nc" id="L194">      menu.removeItem(item);</span>
<span class="nc" id="L195">    }</span>
<span class="nc" id="L196">    items.clear();</span>
<span class="nc" id="L197">  }</span>

  public void addItem(DropDownItem item) {
<span class="nc bnc" id="L200" title="All 2 branches missed.">    if (item == null) {</span>
<span class="nc" id="L201">      menu.addSeparator();</span>
    } else {
<span class="nc" id="L203">      MenuItem menuItem = menu.addItem(item.caption, true, item.command);</span>
<span class="nc" id="L204">      itemsById.put(item.widgetName, menuItem);</span>
<span class="nc" id="L205">      items.add(menuItem);</span>
    }
<span class="nc" id="L207">  }</span>

  /**
   * Removes a menu item identified by {@code id} if it exists.
   *
   * @param id the identifier of the menu item
   */
  public void removeItemById(String id) {
<span class="nc bnc" id="L215" title="All 2 branches missed.">    if (itemsById.containsKey(id)) {</span>
<span class="nc" id="L216">      MenuItem item = itemsById.remove(id);</span>
<span class="nc" id="L217">      items.remove(item);</span>
<span class="nc" id="L218">      menu.removeItem(item);</span>
    }
<span class="nc" id="L220">  }</span>

  public void removeItem(String itemName) {
<span class="nc bnc" id="L223" title="All 2 branches missed.">    for (MenuItem item : items) {</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">      if (item.getText().equals(itemName)) {</span>
<span class="nc" id="L225">        menu.removeItem(item);</span>
<span class="nc" id="L226">        items.remove(item);</span>
<span class="nc" id="L227">        break;</span>
      }
<span class="nc" id="L229">    }</span>
<span class="nc" id="L230">  }</span>

  /**
   * Enables or disables a menu item identified by {@code id}.
   *
   * @param id the identifier of the menu item
   * @param enabled true if the menu item should be enabled, false for disabled
   */
  public void setItemEnabledById(String id, boolean enabled) {
<span class="nc" id="L239">    MenuItem item = itemsById.get(id);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">    if (item != null) {</span>
<span class="nc" id="L241">      item.setEnabled(enabled);</span>
    }
<span class="nc" id="L243">  }</span>

  public void setItemEnabled(String itemName, boolean enabled) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">    for (MenuItem item : items) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">      if (item.getText().equals(itemName)) {</span>
<span class="nc" id="L248">        item.setEnabled(enabled);</span>
<span class="nc" id="L249">        break;</span>
      }
<span class="nc" id="L251">    }</span>
<span class="nc" id="L252">  }</span>

  public void setItemVisible(String itemName, boolean enabled) {
<span class="nc bnc" id="L255" title="All 2 branches missed.">    for (MenuItem item : items) {</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">      if (item.getText().equals(itemName)) {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (enabled == true) {</span>
<span class="nc" id="L258">    	  item.setVisible(true);</span>
        }
        else{
<span class="nc" id="L261">    	  item.setVisible(false);</span>
        }
<span class="nc" id="L263">        break;</span>
      }
<span class="nc" id="L265">    }</span>
<span class="nc" id="L266">  }</span>

  public void replaceLastItem(DropDownItem item) {
<span class="nc" id="L269">    menu.removeItem(items.get(items.size()-1));</span>
<span class="nc" id="L270">    items.remove(items.size()-1);</span>
<span class="nc" id="L271">    items.add(menu.addItem(item.caption, true, item.command));</span>
<span class="nc" id="L272">  }</span>

  /**
   * Sets the HTML content of a menu item, identified by {@code id}, to the given {@code html}.
   *
   * @param id the identifier of the menu item
   * @param html the HTML content to use for the menu item
   */
  public void setItemHtmlById(String id, String html) {
<span class="nc" id="L281">    MenuItem item = itemsById.get(id);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">    if (item != null) {</span>
<span class="nc" id="L283">      item.setHTML(html);</span>
    }
<span class="nc" id="L285">  }</span>

  public void setCaption(String caption) {
<span class="nc" id="L288">    this.setText(caption + &quot; \u25BE &quot;);</span>
<span class="nc" id="L289">  }</span>

  public ContextMenu getContextMenu() {
<span class="nc" id="L292">    return menu;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>