<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommonProjectService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.server.project</a> &gt; <span class="el_source">CommonProjectService.java</span></div><h1>CommonProjectService.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2017 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.server.project;

import com.google.appinventor.server.storage.StorageIo;
import com.google.appinventor.shared.rpc.BlocksTruncatedException;
import com.google.appinventor.shared.rpc.RpcResult;
import com.google.appinventor.shared.rpc.project.ChecksumedLoadFile;
import com.google.appinventor.shared.rpc.project.ChecksumedFileException;
import com.google.appinventor.shared.rpc.project.NewProjectParameters;
import com.google.appinventor.shared.rpc.project.ProjectRootNode;
import com.google.appinventor.shared.rpc.project.TextFile;
import com.google.appinventor.shared.rpc.project.UserProject;
import com.google.appinventor.shared.rpc.user.User;
import com.google.appinventor.shared.storage.StorageUtil;
import com.google.appinventor.shared.util.Base64Util;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.List;

/**
 * The base class for classes that provide project services for a specific
 * project type.
 *
 * @author lizlooney@google.com (Liz Looney)
 */
public abstract class CommonProjectService {
  protected final String projectType;
  protected final StorageIo storageIo;

<span class="fc" id="L39">  protected CommonProjectService(String projectType, StorageIo storageIo) {</span>
<span class="fc" id="L40">    this.projectType = projectType;</span>
<span class="fc" id="L41">    this.storageIo = storageIo;</span>
<span class="fc" id="L42">  }</span>

  /**
   * Stores the project settings.
   *
   * @param userId the user id
   * @param projectId  project ID
   * @param settings  project settings
   */
  public void storeProjectSettings(String userId, long projectId, String settings) {
<span class="fc" id="L52">    storageIo.storeProjectSettings(userId, projectId, settings);</span>
<span class="fc" id="L53">  }</span>

  /**
   * Creates a new project.
   *
   * @param userId the user id
   * @param projectName project name
   * @param params optional parameters (project type dependent)
   *
   * @return new project ID
   */
  public abstract long newProject(String userId, String projectName, NewProjectParameters params);

  /**
   * Copies a project with a new name.
   *
   * @param userId the user id
   * @param oldProjectId  old project ID
   * @param newName new project name
   */
  public abstract long copyProject(String userId, long oldProjectId, String newName);

  /**
   * Deletes a project.
   *
   * @param userId the user id
   * @param projectId  project ID as received by
   */
  public void deleteProject(String userId, long projectId) {
<span class="fc" id="L82">    storageIo.deleteProject(userId, projectId);</span>
<span class="fc" id="L83">  }</span>

  /**
   * Send a project to the new Gallery
   *
   * @param userId the user id
   * @param projectId the project ID to send
   */
  public abstract RpcResult sendToGallery(String userId, long projectId);

  /**
   * loadFromGallery -- Load a project from the gallery
   *
   * @param userId the userId to load the project into
   * @param galleryId the unique gallery ID for this project
   */

  public abstract UserProject loadFromGallery(String userId, String galleryId) throws IOException;

  /**
   * Returns the project root node for the requested project.
   *
   * @param userId the user id
   * @param projectId  project ID as received by {@link
   *                   com.google.appinventor.shared.rpc.project.ProjectService#getProjects()}
   *
   * @return  root node of project
   */
  public abstract ProjectRootNode getRootNode(String userId, long projectId);

  /**
   * Adds a file to the given project.
   *
   * @param userId the user id
   * @param projectId  project ID
   * @param fileId  ID of file to delete
   * @return modification date for project
   */
  public long addFile(String userId, long projectId, String fileId) {
<span class="nc" id="L122">    List&lt;String&gt; sourceFiles = storageIo.getProjectSourceFiles(userId, projectId);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">    if (!sourceFiles.contains(fileId)) {</span>
<span class="nc" id="L124">      storageIo.addSourceFilesToProject(userId, projectId, false, fileId);</span>
    }
<span class="nc" id="L126">    return storageIo.uploadRawFileForce(projectId, fileId, userId, new byte[0]);</span>
  }

  /**
   * Deletes a file in the given project.
   *
   * @param userId the user id
   * @param projectId  project ID
   * @param fileId  ID of file to delete
   * @return modification date for project
   */
  public long deleteFile(String userId, long projectId, String fileId) {
<span class="nc" id="L138">    final long date = storageIo.deleteFile(userId, projectId, fileId);</span>
<span class="nc" id="L139">    storageIo.removeSourceFilesFromProject(userId, projectId, false, fileId);</span>
<span class="nc" id="L140">    return date;</span>
  }

  /**
   * Deletes all files that are contained directly in the given directory. Files
   * in sub-packages are not deleted.
   *
   * @param userId the user id
   * @param projectId project ID
   * @param directory path of the directory
   */
  public long deleteFiles(String userId, long projectId, String directory) {
    // TODO(user): This is not efficient.
<span class="nc bnc" id="L153" title="All 2 branches missed.">    for (String fileId : storageIo.getProjectSourceFiles(userId, projectId)) {</span>
<span class="nc bnc" id="L154" title="All 4 branches missed.">      if (fileId.startsWith(directory + '/') &amp;&amp; fileId.indexOf('/', directory.length() + 1) == -1) {</span>
<span class="nc" id="L155">        storageIo.deleteFile(userId, projectId, fileId);</span>
<span class="nc" id="L156">        storageIo.removeSourceFilesFromProject(userId, projectId, false, fileId);</span>
      }
<span class="nc" id="L158">    }</span>
<span class="nc" id="L159">    return storageIo.getProjectDateModified(userId, projectId);</span>
  }

  /**
   * Deletes all files and folders that are inside the given directory. The given directory itself is deleted.
   * @param userId the user Id
   * @param projectId project ID
   * @param directoy path of the directory
   */
  public long deleteFolder(String userId, long projectId, String directory) {
    // TODO(user) : This is also not efficient
<span class="nc bnc" id="L170" title="All 2 branches missed.">    for (String fileId : storageIo.getProjectSourceFiles(userId, projectId)) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">      if (fileId.startsWith(directory)) {</span>
<span class="nc" id="L172">        storageIo.deleteFile(userId, projectId, fileId);</span>
<span class="nc" id="L173">        storageIo.removeSourceFilesFromProject(userId, projectId, false, fileId);</span>
      }
<span class="nc" id="L175">    }</span>
<span class="nc" id="L176">    return storageIo.getProjectDateCreated(userId, projectId);</span>
  }

  /**
   * Loads the file information associated with a node in the project tree. The
   * actual return value depends on the file kind. Source (text) files should
   * typically return their contents. Image files will be more likely to return
   * the URL that the browser can find them at.
   *
   * @param userId the user id
   * @param projectId  project root node ID
   * @param fileId  project node whose source should be loaded
   *
   * @return  implementation dependent
   */
  public String load(String userId, long projectId, String fileId) {
<span class="fc" id="L192">    return storageIo.downloadFile(userId, projectId, fileId, StorageUtil.DEFAULT_CHARSET);</span>
  }

  /**
   * Loads the file information associated with a node in the project tree. The
   * actual return value depends on the file kind. Source (text) files should
   * typically return their contents. Image files will be more likely to return
   * the URL that the browser can find them at.
   *
   * This version returns a ChecksumedLoadFile object which includes the file
   * content and a SHA-1 hash to validate file integrity accross the network.
   *
   * @param userId the user id
   * @param projectId  project root node ID
   * @param fileId  project node whose source should be loaded
   *
   * @return  ChecksumedLoadFile object
   */
  public ChecksumedLoadFile load2(String userId, long projectId, String fileId) throws ChecksumedFileException {
<span class="nc" id="L211">    ChecksumedLoadFile retval = new ChecksumedLoadFile();</span>
<span class="nc" id="L212">    retval.setContent(storageIo.downloadFile(userId, projectId, fileId, StorageUtil.DEFAULT_CHARSET));</span>
<span class="nc" id="L213">    return retval;</span>
  }

  /**
   * Attempt to record the project Id and error message when we detect a corruption
   * while loading a project.
   *
   * @param userId user id
   * @param projectId project id
   * @param message Error message from the thrown exception
   *
   */
  public void recordCorruption(String userId, long projectId, String fileId, String message) {
<span class="nc" id="L226">    storageIo.recordCorruption(userId, projectId, fileId, message);</span>
<span class="nc" id="L227">  }</span>

  /**
   * Loads the raw content of the associated file.
   *
   * @param userId the userid
   * @param projectId the project root node ID
   * @param fileId project node whose content is to be downloaded
   * @return the file contents
   */

  public byte[] loadraw(String userId, long projectId, String fileId) {
<span class="nc" id="L239">    return storageIo.downloadRawFile(userId, projectId, fileId);</span>
  }

  /**
   * Loads the raw content of the associated file, base 64 encodes it
   * and returns the resulting base64 encoded string.
   *
   * @param userId the userid
   * @param projectId the project root node ID
   * @param fileId project node whose content is to be downloaded
   * @param the file contents encoded in base64
   */
  public String loadraw2(String userId, long projectId, String fileId) {
<span class="nc" id="L252">    byte [] filedata = storageIo.downloadRawFile(userId, projectId, fileId);</span>
<span class="nc" id="L253">    return Base64Util.encodeLines(filedata);</span>
  }

  /**
   * Saves the content of the file associated with a node in the project tree.
   * This is a backwards compatible version that always sets force to true
   * Its primary purpose is to ease the release transition. People running an
   * older Ode at release time won't lose. At some point this function should go
   * away and save2 renamed back to save (through stages).
   *
   * @param userId the user id
   * @param projectId  project root node ID
   * @param fileId  project node whose source should be loaded
   * @param content  content to be saved
   * @return modification date for project
   *
   * @see com.google.appinventor.shared.rpc.project.ProjectService#save(String, long, String, String)
   */
  public long save(String userId, long projectId, String fileId, String content) {
    try {
<span class="fc" id="L273">      return save2(userId, projectId, fileId, true, content);</span>
<span class="nc" id="L274">    } catch (BlocksTruncatedException e) {</span>
      // Won't happen because it isn't thrown when the force argument is true
      // This is here just to keep the Java compiler happy. It isn't smart enough
      // to know that the exception won't be thrown in this case.
<span class="nc" id="L278">      return 0;</span>
    }
  }

  /**
   * Saves the content of the file associated with a node in the project tree.
   * if force is false, an error is thrown if an attempt is made to save a
   * trivial (empty) blocks file workspace that had previously had contents.
   *
   * @param userId the user id
   * @param projectId  project root node ID
   * @param fileId  project node whose source should be loaded
   * @param content  content to be saved
   * @return modification date for project
   *
   * @see com.google.appinventor.shared.rpc.project.ProjectService#save(String, long, String, String)
   */
  public long save2(String userId, long projectId, String fileId, boolean force, String content) throws BlocksTruncatedException {
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">    if (force) {</span>
<span class="fc" id="L297">      return storageIo.uploadFileForce(projectId, fileId, userId,</span>
          content, StorageUtil.DEFAULT_CHARSET);
    } else {
<span class="nc" id="L300">      return storageIo.uploadFile(projectId, fileId, userId,</span>
          content, StorageUtil.DEFAULT_CHARSET);
    }
  }

  /**
   * Saves a screenshot of a current blocks editor. This is called from the client side
   * whenever the user leaves a blocks editor. The data is shipped to us in base64 encoding
   * which we decode and then store in the project.
   *
   * @param userId user who owns the projectId
   * @param projectId project id for the project
   * @param fileId the filename to store the screenshot in
   * @param content the base64 encoded content
   */

  public RpcResult screenshot(String userId, long projectId, String fileId, String content) {
<span class="nc" id="L317">    byte [] binContent = Base64Util.decodeLines(content);</span>
    try {
<span class="nc" id="L319">      storageIo.uploadRawFile(projectId, fileId, userId, true, binContent);</span>
<span class="nc" id="L320">    } catch (BlocksTruncatedException e) {</span>
      // should never happen because force is set to true
<span class="nc" id="L322">    }</span>
<span class="nc" id="L323">    return RpcResult.createSuccessfulRpcResult(&quot;&quot;, &quot;&quot;);</span>
  }


  /**
   * Invokes a build command for the project.
   *
   * @param user the User that owns the {@code projectId}.
   * @param projectId  project id to be built
   * @param nonce -- random string used to find finished APK
   * @param target  build target (optional, implementation dependent)
   * @param secondBuildserver use second buildserver
   *
   * @return  build results
   */
  public abstract RpcResult build(User user, long projectId, String nonce, String target, boolean secondBuildserver, boolean isAab);

  /**
   * Gets the result of a build command for the project.
   *
   * @param user the User that owns the {@code projectId}.
   * @param projectId  project id to be built
   * @param target  build target (optional, implementation dependent.
   * @return  build results.  The following values may be in RpcResult.result:
   *            0: Build is done and was successful
   *            1: Build is done and was unsuccessful
   *           -1: Build is not yet done.
   */
  public abstract RpcResult getBuildResult(User user, long projectId, String target);

  public TextFile importMedia(String userId, long projectId, String urlString, boolean save) throws IOException {
<span class="nc" id="L354">    InputStream is = null;</span>
    try {
<span class="nc" id="L356">      final int BUFSIZE = 4096;</span>
<span class="nc" id="L357">      URL url = new URL(urlString);</span>
<span class="nc" id="L358">      byte[] buffer = new byte[BUFSIZE];</span>
<span class="nc" id="L359">      int read = 0;</span>
<span class="nc" id="L360">      ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L361">      is = url.openStream();</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">      while ( ( read = is.read(buffer) ) &gt; 0 ) {</span>
<span class="nc" id="L363">        baos.write(buffer, 0, read);</span>
      }
<span class="nc" id="L365">      byte[] bytes = baos.toByteArray();</span>
<span class="nc" id="L366">      baos.flush();</span>
<span class="nc" id="L367">      String filename = null;</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">      if (save) {</span>
<span class="nc" id="L369">        String[] parts = url.getPath().split(&quot;/&quot;);</span>
<span class="nc" id="L370">        filename = parts[parts.length - 1];</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">        if (filename.length() == 0) {</span>
<span class="nc" id="L372">          throw new IOException(&quot;Cannot determine name when saving media resource.&quot;);</span>
        }
<span class="nc" id="L374">        filename = &quot;assets/&quot; + filename;</span>
<span class="nc" id="L375">        storageIo.uploadRawFileForce(projectId, filename, userId, bytes);</span>
      }
<span class="nc" id="L377">      return new TextFile(filename, Base64Util.encodeLines(bytes));</span>
<span class="nc" id="L378">    } catch(MalformedURLException e) {</span>
<span class="nc" id="L379">      throw new IOException(&quot;Unable to import from malformed URL&quot;, e);</span>
    } finally {
<span class="nc bnc" id="L381" title="All 2 branches missed.">      if (is != null) {</span>
        try {
<span class="nc" id="L383">          is.close();</span>
<span class="nc" id="L384">        } catch(IOException e) {</span>
          // suppress error on close
<span class="nc" id="L386">        }</span>
      }
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>