<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeleteFileCommand.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.explorer.commands</a> &gt; <span class="el_source">DeleteFileCommand.java</span></div><h1>DeleteFileCommand.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2020 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.explorer.commands;

import static com.google.appinventor.client.Ode.MESSAGES;

import com.google.appinventor.client.Ode;
import com.google.appinventor.client.OdeAsyncCallback;
import com.google.appinventor.client.explorer.project.Project;
import com.google.appinventor.client.tracking.Tracking;
import com.google.appinventor.client.widgets.LabeledTextBox;
import com.google.appinventor.shared.rpc.project.ProjectNode;
import com.google.appinventor.shared.rpc.project.ProjectRootNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidBlocksNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidFormNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidSourceNode;
import com.google.appinventor.shared.rpc.project.youngandroid.YoungAndroidYailNode;
import com.google.gwt.core.client.Scheduler;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.event.dom.client.KeyUpEvent;
import com.google.gwt.event.dom.client.KeyUpHandler;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.CheckBox;
import com.google.gwt.user.client.ui.DialogBox;
import com.google.gwt.user.client.ui.HorizontalPanel;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.VerticalPanel;

/**
 * Command for deleting files.
 */
public class DeleteFileCommand extends ChainableCommand {

  /**
   * Creates a new command for deleting a file.
   */
  public DeleteFileCommand() {
<span class="nc" id="L44">    super(null); // no next command</span>
<span class="nc" id="L45">  }</span>

  @Override
  public boolean willCallExecuteNextCommand() {
<span class="nc" id="L49">    return true;</span>
  }

  @Override
  public void execute(final ProjectNode node) {
<span class="nc bnc" id="L54" title="All 2 branches missed.">    if (node instanceof YoungAndroidSourceNode) {</span>
<span class="nc" id="L55">      new DeleteFormDialog((YoungAndroidSourceNode) node).center();</span>
<span class="nc" id="L56">      return;</span>
    }

<span class="nc bnc" id="L59" title="All 2 branches missed.">    if (deleteConfirmation()) {</span>
      // Asset files
<span class="nc" id="L61">      final Ode ode = Ode.getInstance();</span>
<span class="nc" id="L62">      ode.getProjectService().deleteFile(ode.getSessionId(),</span>
<span class="nc" id="L63">          node.getProjectId(), node.getFileId(),</span>
          new OdeAsyncCallback&lt;Long&gt;(
              // message on failure
<span class="nc" id="L66">              MESSAGES.deleteFileError()) {</span>
            @Override
            public void onSuccess(Long date) {
<span class="nc" id="L69">              getProject(node).deleteNode(node);</span>
<span class="nc" id="L70">              ode.updateModificationDate(node.getProjectId(), date);</span>
<span class="nc" id="L71">              executeNextCommand(node);</span>
<span class="nc" id="L72">            }</span>

            @Override
            public void onFailure(Throwable caught) {
<span class="nc" id="L76">              super.onFailure(caught);</span>
<span class="nc" id="L77">              executionFailedOrCanceled();</span>
<span class="nc" id="L78">            }</span>
          });
<span class="nc" id="L80">    } else {</span>
<span class="nc" id="L81">      executionFailedOrCanceled();</span>
    }
<span class="nc" id="L83">  }</span>

  /**
   * Shows a confirmation dialog.
   *
   * @return {@code true} if the delete file command should be executed or
   *         {@code false} if it should be canceled
   */
  protected boolean deleteConfirmation() {
<span class="nc" id="L92">    return Window.confirm(MESSAGES.reallyDeleteFile());</span>
  }

  private class DeleteFormDialog extends DialogBox {
    // UI elements
<span class="nc" id="L97">    private final LabeledTextBox nameTextBox  = new LabeledTextBox(MESSAGES.formNameLabel());</span>
<span class="nc" id="L98">    private final CheckBox cb = new CheckBox(MESSAGES.checkBoxButton());</span>
    private final YoungAndroidSourceNode node;
    private final String formName;

<span class="nc" id="L102">    DeleteFormDialog(final YoungAndroidSourceNode node) {</span>
<span class="nc" id="L103">      super(false, true);</span>

<span class="nc" id="L105">      this.node = node;</span>
<span class="nc" id="L106">      formName = node.getFormName();</span>

<span class="nc" id="L108">      setStylePrimaryName(&quot;ode-DialogBox&quot;);</span>
<span class="nc" id="L109">      setText(MESSAGES.removeFormButton());</span>

<span class="nc" id="L111">      Button cancelButton = new Button(MESSAGES.cancelButton());</span>
<span class="nc" id="L112">      cancelButton.addClickHandler(new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent event) {
<span class="nc" id="L115">          hide();</span>
<span class="nc" id="L116">          executionFailedOrCanceled();</span>
<span class="nc" id="L117">        }</span>
      });

<span class="nc" id="L120">      cb.setValue(true);</span>
<span class="nc" id="L121">      final Button deleteButton = new Button(MESSAGES.deleteButton());</span>
<span class="nc" id="L122">      deleteButton.addClickHandler(new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent event) {
<span class="nc" id="L125">          handleOkClick();</span>
<span class="nc" id="L126">        }</span>
      });
<span class="nc" id="L128">      deleteButton.addStyleName(&quot;destructive-action&quot;);</span>

<span class="nc" id="L130">      VerticalPanel contentPanel = new VerticalPanel();</span>
<span class="nc" id="L131">      HorizontalPanel labelPanel = new HorizontalPanel();</span>
<span class="nc" id="L132">      Label warnmsg = new Label(MESSAGES.reallyDeleteWarning(formName));</span>
<span class="nc" id="L133">      labelPanel.add(warnmsg);</span>
<span class="nc" id="L134">      labelPanel.setSize(&quot;100%&quot;, &quot;22px&quot;);</span>
<span class="nc" id="L135">      contentPanel.add(labelPanel);</span>
<span class="nc" id="L136">      contentPanel.add(nameTextBox);</span>
<span class="nc" id="L137">      HorizontalPanel buttonPanel = new HorizontalPanel();</span>
<span class="nc" id="L138">      HorizontalPanel checkboxPanel = new HorizontalPanel();</span>
<span class="nc" id="L139">      buttonPanel.add(cancelButton);</span>
<span class="nc" id="L140">      buttonPanel.add(deleteButton);</span>
<span class="nc" id="L141">      checkboxPanel.add(cb);</span>
<span class="nc" id="L142">      checkboxPanel.setSize(&quot;100%&quot;, &quot;20px&quot;);</span>
<span class="nc" id="L143">      contentPanel.add(checkboxPanel);</span>
<span class="nc" id="L144">      buttonPanel.setSize(&quot;100%&quot;, &quot;24px&quot;);</span>
<span class="nc" id="L145">      contentPanel.add(buttonPanel);</span>
<span class="nc" id="L146">      contentPanel.setSize(&quot;320px&quot;, &quot;100%&quot;);</span>
<span class="nc" id="L147">      deleteButton.setEnabled(false);</span>
<span class="nc" id="L148">      nameTextBox.getTextBox().addKeyUpHandler(new KeyUpHandler() {</span>
        @Override
        public void onKeyUp(KeyUpEvent event) {
<span class="nc bnc" id="L151" title="All 2 branches missed.">          if (nameTextBox.getText().equals(formName)) {</span>
<span class="nc" id="L152">            deleteButton.setEnabled(true);</span>
<span class="nc" id="L153">            nameTextBox.setColor(&quot;#00c8ff&quot;);</span>
          } else {
<span class="nc" id="L155">            deleteButton.setEnabled(false);</span>
<span class="nc" id="L156">            nameTextBox.setColor(&quot;red&quot;);</span>
          }
<span class="nc" id="L158">        }</span>
      });
<span class="nc" id="L160">      add(contentPanel);</span>
<span class="nc" id="L161">    }</span>

    private void handleOkClick() {
<span class="nc bnc" id="L164" title="All 2 branches missed.">      if (validate(nameTextBox.getText())) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (cb.getValue()) {</span>
<span class="nc" id="L166">          checkpointThenDelete();</span>
        } else {
<span class="nc" id="L168">          removeForm(false);</span>
        }
<span class="nc" id="L170">        hide();</span>
      } else {
<span class="nc" id="L172">        nameTextBox.setFocus(true);</span>
      }
<span class="nc" id="L174">    }</span>

    private boolean validate(String formName) {
<span class="nc" id="L177">      return formName.equals(this.formName);</span>
    }

    /**
     * Removes a form from the project.
     *
     * @param confirmed true if the user has already confirmed removal, otherwise false, in which
     *                  case one final confirmation message will be displayed.
     */
    private void removeForm(boolean confirmed) {
<span class="nc bnc" id="L187" title="All 4 branches missed.">      if (!confirmed &amp;&amp; !deleteConfirmation()) {</span>
<span class="nc" id="L188">        executionFailedOrCanceled();</span>
<span class="nc" id="L189">        return;</span>
      }
<span class="nc" id="L191">      final Ode ode = Ode.getInstance();</span>

      // Before we delete the form, we need to close both the form editor and the blocks editor
      // (in the browser).
<span class="nc" id="L195">      final String qualifiedFormName = node.getQualifiedName();</span>
<span class="nc" id="L196">      final String formFileId = YoungAndroidFormNode.getFormFileId(qualifiedFormName);</span>
<span class="nc" id="L197">      final String blocksFileId = YoungAndroidBlocksNode.getBlocklyFileId(qualifiedFormName);</span>
<span class="nc" id="L198">      final String yailFileId = YoungAndroidYailNode.getYailFileId(qualifiedFormName);</span>
<span class="nc" id="L199">      final long projectId = node.getProjectId();</span>
<span class="nc" id="L200">      String[] fileIds = new String[2];</span>
<span class="nc" id="L201">      fileIds[0] = formFileId;</span>
<span class="nc" id="L202">      fileIds[1] = blocksFileId;</span>
<span class="nc" id="L203">      ode.getEditorManager().closeFileEditors(projectId, fileIds);</span>

      // When we tell the project service to delete either the form (.scm) file or the blocks
      // (.bky) file, it will delete both of them, and also the yail (.yail) file.
<span class="nc" id="L207">      ode.getProjectService().deleteFile(ode.getSessionId(), projectId, node.getFileId(),</span>
          new OdeAsyncCallback&lt;Long&gt;(
              // message on failure
<span class="nc" id="L210">              MESSAGES.deleteFileError()) {</span>
            @Override
            public void onSuccess(Long date) {
              // Remove all related nodes (form, blocks, yail) from the project.
<span class="nc" id="L214">              Project project = getProject(node);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">              for (ProjectNode sourceNode : node.getProjectRoot().getAllSourceNodes()) {</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                if (sourceNode.getFileId().equals(formFileId)</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                    || sourceNode.getFileId().equals(blocksFileId)</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    || sourceNode.getFileId().equals(yailFileId)) {</span>
<span class="nc" id="L219">                  project.deleteNode(sourceNode);</span>
                }
<span class="nc" id="L221">              }</span>
<span class="nc" id="L222">              ode.getDesignToolbar().removeScreen(project.getProjectId(), formName);</span>
<span class="nc" id="L223">              ode.updateModificationDate(projectId, date);</span>
<span class="nc" id="L224">              executeNextCommand(node);</span>
<span class="nc" id="L225">            }</span>

            @Override
            public void onFailure(Throwable caught) {
<span class="nc" id="L229">              super.onFailure(caught);</span>
<span class="nc" id="L230">              executionFailedOrCanceled();</span>
<span class="nc" id="L231">            }</span>
          });
<span class="nc" id="L233">    }</span>

    @Override
    public void show() {
<span class="nc" id="L237">      super.show();</span>
<span class="nc" id="L238">      Scheduler.get().scheduleDeferred(new Scheduler.ScheduledCommand() {</span>
        @Override
        public void execute() {
<span class="nc" id="L241">          nameTextBox.setFocus(true);</span>
<span class="nc" id="L242">        }</span>
      });
<span class="nc" id="L244">    }</span>

    private void checkpointThenDelete() {
<span class="nc bnc" id="L247" title="All 2 branches missed.">      if (deleteConfirmation()) {</span>
<span class="nc" id="L248">        ProjectRootNode root = node.getProjectRoot();</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (root != null) {</span>
<span class="nc" id="L250">          ChainableCommand cmd = new SaveAllEditorsCommand(</span>
<span class="nc" id="L251">              new SaveScreenCheckpointCommand(true, new ChainableCommand() {</span>
                @Override
                protected boolean willCallExecuteNextCommand() {
<span class="nc" id="L254">                  return false;</span>
                }

                @Override
                protected void execute(ProjectNode node) {
<span class="nc" id="L259">                  removeForm(true);</span>
<span class="nc" id="L260">                }</span>
              }));
<span class="nc" id="L262">          cmd.startExecuteChain(Tracking.PROJECT_ACTION_CHECKPOINT_YA, root);</span>
        }
      }
<span class="nc" id="L265">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>