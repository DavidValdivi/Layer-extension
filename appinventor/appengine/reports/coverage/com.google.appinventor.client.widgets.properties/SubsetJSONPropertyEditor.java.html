<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SubsetJSONPropertyEditor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.widgets.properties</a> &gt; <span class="el_source">SubsetJSONPropertyEditor.java</span></div><h1>SubsetJSONPropertyEditor.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2019 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.widgets.properties;

import com.google.appinventor.client.Ode;
import com.google.appinventor.client.editor.simple.SimpleComponentDatabase;
import static com.google.appinventor.client.Ode.MESSAGES;
import com.google.appinventor.client.ComponentsTranslation;
import com.google.appinventor.client.editor.youngandroid.YaProjectEditor;
import com.google.appinventor.client.explorer.project.Project;
import com.google.appinventor.client.explorer.project.ProjectChangeListener;
import com.google.appinventor.client.widgets.DropDownButton;
import com.google.appinventor.client.youngandroid.TextValidators;
import com.google.appinventor.common.utils.StringUtils;
import com.google.appinventor.components.common.ComponentCategory;
import com.google.appinventor.shared.rpc.project.ProjectNode;
import com.google.appinventor.shared.simple.ComponentDatabaseInterface;
import com.google.common.collect.Lists;
import com.google.gwt.core.client.JavaScriptObject;
import com.google.gwt.core.client.JsArray;
import com.google.gwt.dom.client.Element;
import com.google.gwt.dom.client.Style;
import com.google.gwt.event.dom.client.ChangeEvent;
import com.google.gwt.event.dom.client.ChangeHandler;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.event.logical.shared.ValueChangeEvent;
import com.google.gwt.event.logical.shared.ValueChangeHandler;
import com.google.gwt.json.client.JSONArray;
import com.google.gwt.json.client.JSONObject;
import com.google.gwt.json.client.JSONParser;
import com.google.gwt.json.client.JSONString;
import com.google.gwt.json.client.JSONValue;
import com.google.gwt.user.client.Command;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.CheckBox;
import com.google.gwt.user.client.ui.ClickListener;
import com.google.gwt.user.client.ui.DialogBox;
import com.google.gwt.user.client.ui.DockLayoutPanel;
import com.google.gwt.user.client.ui.FileUpload;
import com.google.gwt.user.client.ui.HorizontalPanel;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.PopupPanel;
import com.google.gwt.user.client.ui.ScrollPanel;
import com.google.gwt.user.client.ui.TextBox;
import com.google.gwt.user.client.ui.Tree;
import com.google.gwt.user.client.ui.TreeItem;
import com.google.gwt.user.client.ui.VerticalPanel;
import com.google.gwt.user.client.ui.Widget;

import java.util.HashMap;
import java.util.List;
import java.util.Set;

public class SubsetJSONPropertyEditor  extends PropertyEditor
        implements ProjectChangeListener {

  private static SubsetJSONPropertyEditor INSTANCE;
  Tree componentTree;
  Tree blockTree;
  DropDownButton dropDownButton;
<span class="nc" id="L66">  final FileUpload file = new FileUpload();</span>
<span class="nc" id="L67">  final PopupPanel customPopup = new PopupPanel(true, true);</span>
<span class="nc" id="L68">  boolean customPopupShowing = false;</span>

<span class="nc" id="L70">  public SubsetJSONPropertyEditor() {</span>
<span class="nc" id="L71">    buildTrees();</span>
<span class="nc" id="L72">    file.addChangeHandler(new ChangeHandler() {</span>
      @Override
      public void onChange(ChangeEvent changeEvent) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (customPopupShowing) {</span>
<span class="nc" id="L76">          loadJSONfile(file, false);</span>
        }
        else {
<span class="nc" id="L79">          loadJSONfile(file, true);</span>
        }
<span class="nc" id="L81">      }</span>
    });

    // This is an invisible panel holding a FileUpload button. It exists because we want to access
    // the file selection dialog from the subset editor dropdown menu item. There may be a better way
    // to do this.
<span class="nc" id="L87">    PopupPanel invisibleFilePanel = new PopupPanel();</span>
<span class="nc" id="L88">    invisibleFilePanel.add(file);</span>
<span class="nc" id="L89">    invisibleFilePanel.setVisible(false);</span>
<span class="nc" id="L90">    invisibleFilePanel.show();</span>

<span class="nc" id="L92">    List&lt;DropDownButton.DropDownItem&gt; items = Lists.newArrayList();</span>
<span class="nc" id="L93">    items.add(new DropDownButton.DropDownItem(&quot;Subset Property Editor&quot;, MESSAGES.allButton(), new Command() {</span>
      @Override
      public void execute() {
<span class="nc" id="L96">        property.setValue(&quot;&quot;);</span>
<span class="nc" id="L97">        updateValue();</span>
<span class="nc" id="L98">      }}));</span>
<span class="nc" id="L99">    items.add(new DropDownButton.DropDownItem(&quot;Subset Property Editor&quot;, MESSAGES.matchProjectButton(), new Command() {</span>
      @Override
      public void execute() {
<span class="nc" id="L102">        matchProject();</span>
<span class="nc" id="L103">        property.setValue(createJSONString());</span>
<span class="nc" id="L104">        updateValue();</span>
<span class="nc" id="L105">      }}));</span>
<span class="nc" id="L106">    items.add(new DropDownButton.DropDownItem(&quot;Subset Property Editor&quot;, MESSAGES.fileUploadWizardCaption(), new Command() {</span>
      @Override
      public void execute() {
<span class="nc" id="L109">        file.click();</span>
<span class="nc" id="L110">      }}));</span>

<span class="nc" id="L112">    items.add(new DropDownButton.DropDownItem(&quot;Subset Property Editor&quot;, MESSAGES.viewAndModifyButton(), new Command() {</span>
      @Override
      public void execute() {
<span class="nc" id="L115">        showCustomSubsetPanel();</span>
<span class="nc" id="L116">      }}));</span>
<span class="nc" id="L117">    dropDownButton = new DropDownButton(&quot;Subset Property Editor&quot;, &quot;&quot;, items, false);</span>
<span class="nc" id="L118">    dropDownButton.setStylePrimaryName(&quot;ode-ChoicePropertyEditor&quot;);</span>
<span class="nc" id="L119">    initWidget(dropDownButton);</span>
<span class="nc" id="L120">    INSTANCE = this;</span>
<span class="nc" id="L121">    exportJavaMethods();</span>
<span class="nc" id="L122">  }</span>

  protected void showCustomSubsetPanel() {
<span class="nc bnc" id="L125" title="All 2 branches missed.">    if (property.getValue() != &quot;&quot;) {</span>
<span class="nc" id="L126">      JSONObject jsonSet = JSONParser.parseStrict(property.getValue()).isObject();</span>
<span class="nc" id="L127">      loadComponents(jsonSet);</span>
<span class="nc" id="L128">      loadGlobalBlocks(jsonSet);</span>
<span class="nc" id="L129">    } else {</span>
<span class="nc" id="L130">      clearSelections();</span>
    }

<span class="nc bnc" id="L133" title="All 2 branches missed.">    if (customPopup.getTitle() != MESSAGES.blocksToolkitTitle()) {</span>
<span class="nc" id="L134">      final DockLayoutPanel treePanel = new DockLayoutPanel(Style.Unit.PCT);</span>
<span class="nc" id="L135">      VerticalPanel componentPanel = new VerticalPanel();</span>
<span class="nc" id="L136">      VerticalPanel blockPanel = new VerticalPanel();</span>
<span class="nc" id="L137">      HorizontalPanel buttonPanel = new HorizontalPanel();</span>
<span class="nc" id="L138">      final ScrollPanel componentScroll = new ScrollPanel(componentPanel);</span>
<span class="nc" id="L139">      ScrollPanel blockScroll = new ScrollPanel(blockPanel);</span>

<span class="nc" id="L141">      componentPanel.add(new Label(MESSAGES.sourceStructureBoxCaption()));</span>
<span class="nc" id="L142">      componentPanel.add(componentTree);</span>
<span class="nc" id="L143">      blockPanel.add(new Label(MESSAGES.builtinBlocksLabel()));</span>
<span class="nc" id="L144">      blockPanel.add(blockTree);</span>

<span class="nc" id="L146">      Button loadButton = new Button(MESSAGES.fileUploadWizardCaption());</span>
<span class="nc" id="L147">      loadButton.addClickHandler(new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent event) {
<span class="nc" id="L150">          file.click();</span>
<span class="nc" id="L151">        }</span>
      });
<span class="nc" id="L153">      Button saveButton = new Button(MESSAGES.saveAsButton());</span>
<span class="nc" id="L154">      saveButton.addClickHandler(new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent event) {
<span class="nc" id="L157">          saveFile();</span>
<span class="nc" id="L158">        }</span>
      });
<span class="nc" id="L160">      Button clearButton = new Button(MESSAGES.clearButton());</span>
<span class="nc" id="L161">      Button initializeButton = new Button(MESSAGES.matchProjectButton());</span>
<span class="nc" id="L162">      clearButton.addClickHandler(new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent event) {
<span class="nc" id="L165">          clearSelections();</span>
<span class="nc" id="L166">        }</span>
      });
<span class="nc" id="L168">      initializeButton.addClickHandler(new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent event) {
<span class="nc" id="L171">          matchProject();</span>
<span class="nc" id="L172">        }</span>
      });
<span class="nc" id="L174">      Button cancelButton = new Button(MESSAGES.cancelButton());</span>
<span class="nc" id="L175">      Button okButton = new Button(MESSAGES.okButton());</span>
<span class="nc" id="L176">      buttonPanel.add(saveButton);</span>
<span class="nc" id="L177">      buttonPanel.add(loadButton);</span>
<span class="nc" id="L178">      buttonPanel.add(clearButton);</span>
<span class="nc" id="L179">      buttonPanel.add(initializeButton);</span>
<span class="nc" id="L180">      cancelButton.addClickHandler(new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent event) {
<span class="nc" id="L183">          customPopup.hide();</span>
<span class="nc" id="L184">        }</span>
      });
<span class="nc" id="L186">      okButton.addClickHandler(new ClickHandler() {</span>
        @Override
        public void onClick(ClickEvent event) {
<span class="nc" id="L189">          property.setValue(createJSONString());</span>
<span class="nc" id="L190">          updateValue();</span>
<span class="nc" id="L191">          customPopupShowing = false;</span>
<span class="nc" id="L192">          customPopup.hide();</span>
<span class="nc" id="L193">        }</span>
      });
<span class="nc" id="L195">      buttonPanel.add(okButton);</span>
<span class="nc" id="L196">      buttonPanel.add(cancelButton);</span>
<span class="nc" id="L197">      Label customTitle = new Label(MESSAGES.blocksToolkitTitle());</span>
<span class="nc" id="L198">      treePanel.addNorth(customTitle, 5);</span>
<span class="nc" id="L199">      treePanel.addSouth(buttonPanel, 5);</span>
<span class="nc" id="L200">      treePanel.addWest(componentScroll, 50);</span>
<span class="nc" id="L201">      treePanel.addEast(blockScroll, 50);</span>
<span class="nc" id="L202">      customPopup.setTitle(MESSAGES.blocksToolkitTitle());</span>
<span class="nc" id="L203">      customPopup.add(treePanel);</span>
<span class="nc" id="L204">      customPopup.setHeight(&quot;600px&quot;);</span>
<span class="nc" id="L205">      customPopup.setWidth(&quot;600px&quot;);</span>
<span class="nc" id="L206">      customPopup.center();</span>
    }
<span class="nc" id="L208">    customPopupShowing = true;</span>
<span class="nc" id="L209">    customPopup.show();</span>
<span class="nc" id="L210">  }</span>

  private void buildTrees() {
<span class="nc" id="L213">    componentTree = new Tree();</span>
<span class="nc" id="L214">    blockTree = new Tree();</span>
    // Build tree of components and their related property/event/method blocks
<span class="nc" id="L216">    SimpleComponentDatabase db = SimpleComponentDatabase.getInstance();</span>
<span class="nc" id="L217">    HashMap&lt;String, TreeItem&gt; categoryItems = new HashMap&lt;String, TreeItem&gt;();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">    for (ComponentCategory cat : ComponentCategory.values()) {</span>
<span class="nc bnc" id="L219" title="All 4 branches missed.">      if (cat != ComponentCategory.INTERNAL &amp;&amp; cat != ComponentCategory.UNINITIALIZED) {</span>
<span class="nc" id="L220">        CheckBox cb = new CheckBox(ComponentsTranslation.getCategoryName(cat.getName()));</span>
<span class="nc" id="L221">        cb.setName(cat.getDocName());</span>
<span class="nc" id="L222">        categoryItems.put(cat.getDocName(), createCascadeCheckboxItem(cb));</span>
      }
    }
<span class="nc bnc" id="L225" title="All 2 branches missed.">    for (String cname : db.getComponentNames()) {</span>
<span class="nc" id="L226">      ComponentDatabaseInterface.ComponentDefinition cd = db.getComponentDefinition(cname);</span>
<span class="nc bnc" id="L227" title="All 4 branches missed.">      if (categoryItems.containsKey(cd.getCategoryDocUrlString()) &amp;&amp; db.getShowOnPalette(cname) ) {</span>
<span class="nc" id="L228">        final CheckBox subcb = new CheckBox(ComponentsTranslation.getComponentName(cname));</span>
<span class="nc" id="L229">        final TreeItem subTree = createCascadeCheckboxItem(subcb);</span>
<span class="nc" id="L230">        subcb.setName(cname);</span>
        // Event, Method, Property order needs to match Blockly.Drawer.prototype.instanceRecordToXMLArray
        // so that component blocks are displayed in the same order with or without a subset defined.
<span class="nc bnc" id="L233" title="All 2 branches missed.">        for (ComponentDatabaseInterface.EventDefinition edef : cd.getEvents()) {</span>
<span class="nc" id="L234">          CheckBox eventcb = new CheckBox(ComponentsTranslation.getEventName(edef.getName()));</span>
<span class="nc" id="L235">          eventcb.setName(&quot;events&quot;);</span>
<span class="nc" id="L236">          eventcb.setFormValue(&quot;none&quot;);</span>
<span class="nc" id="L237">          subTree.addItem(createCascadeCheckboxItem(eventcb));</span>
<span class="nc" id="L238">        }</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">        for (ComponentDatabaseInterface.MethodDefinition mdef : cd.getMethods()) {</span>
<span class="nc" id="L240">          CheckBox methcb = new CheckBox(ComponentsTranslation.getMethodName(mdef.getName()));</span>
<span class="nc" id="L241">          methcb.setName(&quot;methods&quot;);</span>
<span class="nc" id="L242">          methcb.setFormValue(&quot;none&quot;);</span>
<span class="nc" id="L243">          subTree.addItem(createCascadeCheckboxItem(methcb));</span>
<span class="nc" id="L244">        }</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        for (ComponentDatabaseInterface.BlockPropertyDefinition pdef : cd.getBlockProperties()) {</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">          if (pdef.getRW() != &quot;invisible&quot;) {</span>
<span class="nc" id="L247">            CheckBox propcb = new CheckBox(ComponentsTranslation.getPropertyName(pdef.getName()));</span>
<span class="nc" id="L248">            propcb.setName(&quot;blockProperties&quot;);</span>
<span class="nc" id="L249">            propcb.setFormValue(pdef.getRW());</span>
<span class="nc" id="L250">            subTree.addItem(createCascadeCheckboxItem(propcb));</span>
          }
<span class="nc" id="L252">        }</span>
<span class="nc" id="L253">        TreeItem t = categoryItems.get(cd.getCategoryDocUrlString());</span>
<span class="nc" id="L254">        t.addItem(subTree);</span>
      }
<span class="nc" id="L256">    }</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">    for (TreeItem t : categoryItems.values()) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">      if (t.getChildCount() &gt; 0) {</span>
<span class="nc" id="L259">        componentTree.addItem(t);</span>
      }
<span class="nc" id="L261">    }</span>

    // Build tree of global blocks by category
<span class="nc" id="L264">    JSONObject blockDict = new JSONObject(getBlockDict());</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">    for (String blockCategory:blockDict.keySet()) {</span>

      // There appears to be no centralized method for internationalizing the built-in block category names.
      // Fix if I'm wrong.
      String blockCategoryTranslated;
<span class="nc bnc" id="L270" title="All 2 branches missed.">      if (blockCategory.equals(&quot;Control&quot;)) {</span>
<span class="nc" id="L271">        blockCategoryTranslated = MESSAGES.builtinControlLabel();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">      } else if (blockCategory.equals(&quot;Logic&quot;)) {</span>
<span class="nc" id="L273">        blockCategoryTranslated = MESSAGES.builtinLogicLabel();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">      } else if (blockCategory.equals(&quot;Math&quot;)) {</span>
<span class="nc" id="L275">        blockCategoryTranslated = MESSAGES.builtinMathLabel();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">      } else if (blockCategory.equals(&quot;Text&quot;)) {</span>
<span class="nc" id="L277">        blockCategoryTranslated = MESSAGES.builtinTextLabel();</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">      } else if (blockCategory.equals(&quot;Lists&quot;)) {</span>
<span class="nc" id="L279">        blockCategoryTranslated = MESSAGES.builtinListsLabel();</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">      } else if (blockCategory.equals(&quot;Colors&quot;)) {</span>
<span class="nc" id="L281">        blockCategoryTranslated = MESSAGES.builtinColorsLabel();</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">      } else if (blockCategory.equals(&quot;Variables&quot;)) {</span>
<span class="nc" id="L283">        blockCategoryTranslated = MESSAGES.builtinVariablesLabel();</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">      } else if (blockCategory.equals(&quot;Procedures&quot;)) {</span>
<span class="nc" id="L285">        blockCategoryTranslated = MESSAGES.builtinProceduresLabel();</span>
      } else {
<span class="nc" id="L287">        blockCategoryTranslated = blockCategory;</span>
      }

<span class="nc" id="L290">      CheckBox blockCatCb = new CheckBox(blockCategoryTranslated);</span>
<span class="nc" id="L291">      blockCatCb.setName(blockCategory);</span>
<span class="nc" id="L292">      TreeItem blockCatItem = createCascadeCheckboxItem(blockCatCb);</span>
<span class="nc" id="L293">      JSONValue blockCatDictVal = blockDict.get(blockCategory);</span>
<span class="nc" id="L294">      JSONObject blockCatDict = blockCatDictVal.isObject();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">      for (String blockID:blockCatDict.keySet()) {</span>
<span class="nc" id="L296">        CheckBox blockCb = new CheckBox(blockCatDict.get(blockID).isString().stringValue());</span>
<span class="nc" id="L297">        blockCb.setWordWrap(true);</span>
<span class="nc" id="L298">        blockCb.setName(blockID);</span>
<span class="nc" id="L299">        blockCatItem.addItem(createCascadeCheckboxItem(blockCb));</span>
<span class="nc" id="L300">      }</span>
<span class="nc" id="L301">      blockTree.addItem(blockCatItem);</span>
<span class="nc" id="L302">    }</span>
<span class="nc" id="L303">  }</span>

  private void loadComponents(JSONObject jsonObj) {
    // TODO: Review JSON format. There has to be a better way to store and retrieve this info.
<span class="nc" id="L307">    JSONObject shownComponents = jsonObj.get(&quot;shownComponentTypes&quot;).isObject();</span>
<span class="nc" id="L308">    JSONObject shownComponentBlocks = jsonObj.get(&quot;shownBlockTypes&quot;).isObject().get(&quot;ComponentBlocks&quot;).isObject();</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">    for (int i = 0; i &lt; componentTree.getItemCount(); ++i) {</span>
<span class="nc" id="L310">      TreeItem componentCatItem = componentTree.getItem(i);</span>
<span class="nc" id="L311">      CheckBox componentCatCb = (CheckBox)componentCatItem.getWidget();</span>
<span class="nc" id="L312">      String catName = componentCatCb.getName().toUpperCase();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">      if (shownComponents.containsKey(catName)) {</span>
<span class="nc" id="L314">        JSONArray jsonComponentCat = shownComponents.get(catName).isArray();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (jsonComponentCat.size() &gt; 0) {</span>
<span class="nc" id="L316">          componentCatCb.setValue(true, false);</span>
<span class="nc" id="L317">          HashMap&lt;String, String&gt; jsonComponentHash = new HashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">          for (int j = 0; j &lt; jsonComponentCat.size(); ++j) {</span>
<span class="nc" id="L319">            JSONValue jsonComponentHashCat = jsonComponentCat.get(j);</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (jsonComponentHashCat != null) {</span>
<span class="nc" id="L321">              jsonComponentHash.put(jsonComponentHashCat.isObject().get(&quot;type&quot;).isString().stringValue(), &quot;type&quot;);</span>
            }
          }
<span class="nc bnc" id="L324" title="All 2 branches missed.">          for (int j = 0; j &lt; componentCatItem.getChildCount(); ++j) {</span>
<span class="nc" id="L325">            TreeItem componentItem = componentCatItem.getChild(j);</span>
<span class="nc" id="L326">            CheckBox componentCb = (CheckBox) componentItem.getWidget();</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">            if (jsonComponentHash.get(componentCb.getName()) != null) {</span>
<span class="nc" id="L328">              componentCb.setValue(true, false);</span>
<span class="nc" id="L329">              JSONArray jsonComponentBlockProps = shownComponentBlocks.get(componentCb.getName()).isArray();</span>
<span class="nc" id="L330">              HashMap&lt;String, String&gt; componentPropHash = new HashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">              for (int k = 0; k &lt; jsonComponentBlockProps.size(); ++k) {</span>
<span class="nc" id="L332">                JSONObject jsonComponentBlockType = jsonComponentBlockProps.get(k).isObject();</span>
<span class="nc" id="L333">                String componentBlockType = jsonComponentBlockType.get(&quot;type&quot;).isString().stringValue();</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                if (&quot;component_set_get&quot;.equals(componentBlockType)) {</span>
<span class="nc" id="L335">                  componentPropHash.put(jsonComponentBlockType.get(&quot;mutatorNameToValue&quot;).isObject().get(&quot;property_name&quot;).isString().stringValue(), &quot;PROP&quot;);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">                } else if (&quot;component_event&quot;.equals(componentBlockType)) {</span>
<span class="nc" id="L337">                  JSONValue mutatorValue = jsonComponentBlockType.get(&quot;mutatorNameToValue&quot;);</span>
<span class="nc" id="L338">                  JSONValue event_name = mutatorValue.isObject().get(&quot;event_name&quot;);</span>
<span class="nc" id="L339">                  componentPropHash.put(event_name.isString().stringValue(), &quot;EVENT&quot;);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                } else if (&quot;component_method&quot;.equals(componentBlockType)) {</span>
<span class="nc" id="L341">                  componentPropHash.put(jsonComponentBlockType.get(&quot;mutatorNameToValue&quot;).isObject().get(&quot;method_name&quot;).isString().stringValue(), &quot;METHOD&quot;);</span>
                }
              }
<span class="nc bnc" id="L344" title="All 2 branches missed.">              for (int k = 0; k &lt; componentItem.getChildCount(); ++k) {</span>
<span class="nc" id="L345">                TreeItem componentPropItem = componentItem.getChild(k);</span>
<span class="nc" id="L346">                CheckBox componentPropCb = (CheckBox) componentPropItem.getWidget();</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                if (componentPropHash.get(componentPropCb.getText()) != null) {</span>
<span class="nc" id="L348">                  componentPropCb.setValue(true, false);</span>
                } else {
<span class="nc" id="L350">                  componentPropCb.setValue(false, false);</span>
                }
              }

<span class="nc" id="L354">            } else {</span>
<span class="nc" id="L355">              componentCb.setValue(false, false);</span>
<span class="nc" id="L356">              toggleChildren(componentItem, false);</span>
            }
          }
<span class="nc" id="L359">        } else {</span>
<span class="nc" id="L360">          componentCatCb.setValue(false, false);</span>
<span class="nc" id="L361">          toggleChildren(componentCatItem, false);</span>
        }
<span class="nc" id="L363">      } else {</span>
<span class="nc" id="L364">        componentCatCb.setValue(false, false);</span>
<span class="nc" id="L365">        toggleChildren(componentCatItem, false);</span>
      }
    }
<span class="nc" id="L368">  }</span>

  private void loadGlobalBlocks(JSONObject jsonObj) {
<span class="nc" id="L371">    JSONObject shownBlocks = jsonObj.get(&quot;shownBlockTypes&quot;).isObject();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">    for (int i = 0; i &lt; blockTree.getItemCount(); ++i) {</span>
<span class="nc" id="L373">      TreeItem catTree = blockTree.getItem(i);</span>
<span class="nc" id="L374">      CheckBox catCb = (CheckBox)catTree.getWidget();</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">      if (shownBlocks.containsKey(catCb.getName())) {</span>
<span class="nc" id="L376">        JSONArray jsonBlockArr = shownBlocks.get(catCb.getName()).isArray();</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if (jsonBlockArr.size() &gt; 0) {</span>
<span class="nc" id="L378">          catCb.setValue(true, false);</span>
<span class="nc" id="L379">          HashMap&lt;String, String&gt; blockHash = new HashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">          for (int j = 0; j &lt; jsonBlockArr.size(); ++j) {</span>
<span class="nc" id="L381">            blockHash.put(jsonBlockArr.get(j).isObject().get(&quot;type&quot;).isString().stringValue(), &quot;type&quot;);</span>
          }
<span class="nc bnc" id="L383" title="All 2 branches missed.">          for (int j = 0; j &lt; catTree.getChildCount(); ++j) {</span>
<span class="nc" id="L384">            TreeItem blockTree = catTree.getChild(j);</span>
<span class="nc" id="L385">            CheckBox blockCb = (CheckBox) blockTree.getWidget();</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">            if (blockHash.get(blockCb.getName()) != null) {</span>
<span class="nc" id="L387">              blockCb.setValue(true, false);</span>
            } else {
<span class="nc" id="L389">              blockCb.setValue(false, false);</span>
            }
          }
        }
<span class="nc" id="L393">      } else {</span>
<span class="nc" id="L394">        catCb.setValue(false, false);</span>
<span class="nc" id="L395">        toggleChildren(catTree, false);</span>
      }
    }
<span class="nc" id="L398">  }</span>

  private void clearSelections() {
<span class="nc bnc" id="L401" title="All 2 branches missed.">    for (int i = 0; i &lt; componentTree.getItemCount(); ++i) {</span>
<span class="nc" id="L402">      TreeItem checkboxItem = componentTree.getItem(i);</span>
<span class="nc" id="L403">      ((CheckBox)checkboxItem.getWidget()).setValue(false, false);</span>
<span class="nc" id="L404">      toggleChildren(checkboxItem, false);</span>
    }
<span class="nc bnc" id="L406" title="All 2 branches missed.">    for (int i = 0; i &lt; blockTree.getItemCount(); ++i) {</span>
<span class="nc" id="L407">      TreeItem checkboxItem = blockTree.getItem(i);</span>
<span class="nc" id="L408">      ((CheckBox)checkboxItem.getWidget()).setValue(false, false);</span>
<span class="nc" id="L409">      toggleChildren(checkboxItem, false);</span>
    }
<span class="nc" id="L411">  }</span>

  private void matchProject() {
<span class="nc" id="L414">    long projID = Ode.getInstance().getCurrentYoungAndroidProjectId();</span>
<span class="nc" id="L415">    YaProjectEditor projEditor = (YaProjectEditor)Ode.getInstance().getEditorManager().getOpenProjectEditor(projID);</span>
<span class="nc" id="L416">    Set&lt;String&gt; componentTypes = projEditor.getUniqueComponentTypes();</span>
<span class="nc" id="L417">    HashMap&lt;String, Set&lt;String&gt;&gt; componentBlockTypes = projEditor.getUniqueComponentBlockTypes();</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">    for (int i = 0; i &lt; componentTree.getItemCount(); ++i) {</span>
<span class="nc" id="L419">      TreeItem catItem = componentTree.getItem(i);</span>
<span class="nc" id="L420">      CheckBox catCb = (CheckBox)catItem.getWidget();</span>
<span class="nc" id="L421">      catCb.setValue(false,false);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">      for (int j = 0; j &lt; catItem.getChildCount(); ++j) {</span>
<span class="nc" id="L423">        TreeItem compItem = catItem.getChild(j);</span>
<span class="nc" id="L424">        CheckBox compCb = (CheckBox)compItem.getWidget();</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">        if (componentTypes.contains(compCb.getName())) {</span>
<span class="nc" id="L426">          compCb.setValue(true,false);</span>
<span class="nc" id="L427">          catCb.setValue(true, false);</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">          for (int k = 0; k &lt; compItem.getChildCount(); ++k) {</span>
<span class="nc" id="L429">            TreeItem compBlockItem = compItem.getChild(k);</span>
<span class="nc" id="L430">            CheckBox compBlockCb = (CheckBox)compBlockItem.getWidget();</span>
            // If the key (component name) does not exist in the HashMap at all, this should check
            // against the null key, which is a valid key that should have no values associated with it
<span class="nc bnc" id="L433" title="All 4 branches missed.">            if (componentBlockTypes.containsKey(compCb.getName()) &amp;&amp; (componentBlockTypes.get(compCb.getName())).contains(compBlockCb.getText()) ) {</span>
<span class="nc" id="L434">              compBlockCb.setValue(true, true);</span>
            }
          }
        } else {
<span class="nc" id="L438">          compCb.setValue(false, true);</span>
        }
      }
    }
<span class="nc" id="L442">    Set&lt;String&gt; blockTypes = projEditor.getUniqueBuiltInBlockTypes();</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">    for (int i = 0; i &lt; blockTree.getItemCount(); ++i) {</span>
<span class="nc" id="L444">      TreeItem catItem = blockTree.getItem(i);</span>
<span class="nc" id="L445">      CheckBox catCb = (CheckBox)catItem.getWidget();</span>
<span class="nc" id="L446">      catCb.setValue(false,false);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">      for (int j = 0; j &lt; catItem.getChildCount(); ++j) {</span>
<span class="nc" id="L448">        TreeItem compItem = catItem.getChild(j);</span>
<span class="nc" id="L449">        CheckBox compCb = (CheckBox)compItem.getWidget();</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">        if (blockTypes.contains(compCb.getName())) {</span>
<span class="nc" id="L451">          compCb.setValue(true, true);</span>
<span class="nc" id="L452">          catCb.setValue(true,false);</span>
        } else {
<span class="nc" id="L454">          compCb.setValue(false, false);</span>
        }
      }
    }
<span class="nc" id="L458">  }</span>

  private void loadJSONfile(FileUpload filePath, Boolean doUpdate) {
<span class="nc" id="L461">    String uploadFilename = filePath.getFilename();</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">    if (!uploadFilename.isEmpty()) {</span>
<span class="nc" id="L463">      final String filename = makeValidFilename(uploadFilename);</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">      if (!TextValidators.isValidCharFilename(filename)) {</span>
<span class="nc" id="L465">        Window.alert(MESSAGES.malformedFilename());</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">      } else if (!TextValidators.isValidLengthFilename(filename)) {</span>
<span class="nc" id="L467">        Window.alert(MESSAGES.malformedFilename());</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">      } else if (!filename.endsWith(&quot;.json&quot;)){</span>
<span class="nc" id="L469">        Window.alert(MESSAGES.malformedFilenameTitle());</span>
      } else {
<span class="nc" id="L471">        loadJSONfileNative(filePath.getElement(), doUpdate);</span>
      }
    }
<span class="nc" id="L474">  }</span>

  public void callLoadGlobalBlocks(String jsonStr) {
<span class="nc" id="L477">    JSONObject jsonObj = JSONParser.parseStrict(jsonStr).isObject();</span>
<span class="nc" id="L478">    INSTANCE.loadComponents(jsonObj);</span>
<span class="nc" id="L479">    INSTANCE.loadGlobalBlocks(jsonObj);</span>
<span class="nc" id="L480">  }</span>

  public void callUpdateValue(String jsonStr) {
<span class="nc" id="L483">    INSTANCE.property.setValue(jsonStr);</span>
<span class="nc" id="L484">    INSTANCE.updateValue();</span>
<span class="nc" id="L485">  }</span>

  public native void exportJavaMethods() /*-{
    var that = this;
    $wnd.load_trees = $entry(that.@com.google.appinventor.client.widgets.properties.SubsetJSONPropertyEditor::callLoadGlobalBlocks(Ljava/lang/String;));
    $wnd.update_value = $entry(that.@com.google.appinventor.client.widgets.properties.SubsetJSONPropertyEditor::callUpdateValue(Ljava/lang/String;));
  }-*/;


  private native void loadJSONfileNative(Element fileElement, boolean doUpdate) /*-{
    var selectedFile = fileElement.files[0];
    if (selectedFile.type == &quot;application/json&quot;) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var loadedstr = reader.result;
        $wnd.load_trees(loadedstr);
        if (doUpdate) {
          $wnd.update_value(loadedstr);
        }
      }
      reader.readAsText(selectedFile);
    } else {
      alert(&quot;Please select a JSON file&quot;);
    }
  }-*/;

  // TODO: This is a copy of a private method in FileUploadWizard. Seems like it should be moved someplace
  // usable outside that one class
  private String makeValidFilename(String uploadFilename) {
    // Strip leading path off filename.
    // We need to support both Unix ('/') and Windows ('\\') separators.
<span class="nc" id="L516">    String filename = uploadFilename.substring(</span>
<span class="nc" id="L517">            Math.max(uploadFilename.lastIndexOf('/'), uploadFilename.lastIndexOf('\\')) + 1);</span>
    // We need to strip out whitespace from the filename.
<span class="nc" id="L519">    filename = filename.replaceAll(&quot;\\s&quot;, &quot;&quot;);</span>
<span class="nc" id="L520">    return filename;</span>
  }

  private void saveFile() {
    // Prompt user for file name, generate the JSON, and save the file
<span class="nc" id="L525">    final DialogBox dialogBox = new DialogBox(false, true);</span>
<span class="nc" id="L526">    dialogBox.setStylePrimaryName(&quot;ode-DialogBox&quot;);</span>
<span class="nc" id="L527">    dialogBox.setText(MESSAGES.saveAsButton());</span>
<span class="nc" id="L528">    final Label saveNameLabel = new Label(&quot;Save as file:&quot;);  // Todo: Internationalize</span>
<span class="nc" id="L529">    final TextBox saveName = new TextBox();</span>
<span class="nc" id="L530">    final HorizontalPanel savePanel = new HorizontalPanel();</span>
<span class="nc" id="L531">    savePanel.add(saveNameLabel);</span>
<span class="nc" id="L532">    savePanel.add(saveName);</span>
<span class="nc" id="L533">    Button cancelButton = new Button(&quot;Cancel&quot;);</span>
<span class="nc" id="L534">    cancelButton.addClickListener(new ClickListener() {</span>
      @Override
      public void onClick(Widget sender) {
<span class="nc" id="L537">        dialogBox.hide();</span>
<span class="nc" id="L538">      }</span>
    });
<span class="nc" id="L540">    savePanel.add(cancelButton);</span>
<span class="nc" id="L541">    Button okButton = new Button(&quot;OK&quot;);</span>
<span class="nc" id="L542">    okButton.addClickListener(new ClickListener() {</span>
      @Override
      public void onClick(Widget sender) {
<span class="nc" id="L545">        String jsonString = createJSONString();</span>
<span class="nc" id="L546">        String saveFileText = saveName.getText();</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (saveFileText.length() &gt; 0) {</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">          if (!saveFileText.endsWith(&quot;.json&quot;)) {</span>
<span class="nc" id="L549">            saveFileText = saveFileText + &quot;.json&quot;;</span>
          }
<span class="nc" id="L551">        saveFileNative(saveFileText, jsonString);</span>
        }
<span class="nc" id="L553">        dialogBox.hide();</span>
<span class="nc" id="L554">      }</span>
    });
<span class="nc" id="L556">    savePanel.add(okButton);</span>
<span class="nc" id="L557">    dialogBox.setWidget(savePanel);</span>
<span class="nc" id="L558">    dialogBox.center();</span>
<span class="nc" id="L559">    dialogBox.show();</span>
<span class="nc" id="L560">  }</span>


  private void toggleChildren(TreeItem item, Boolean checked) {
<span class="nc bnc" id="L564" title="All 2 branches missed.">    for (int i = 0; i &lt;item.getChildCount(); ++i) {</span>
<span class="nc" id="L565">      TreeItem childItem = item.getChild(i);</span>
<span class="nc" id="L566">      ((CheckBox)childItem.getWidget()).setValue(checked, false);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">      if (childItem.getChildCount() &gt; 0) {</span>
<span class="nc" id="L568">        toggleChildren(childItem, checked);</span>
      }
    }
<span class="nc" id="L571">  }</span>

  private TreeItem createCascadeCheckboxItem(CheckBox cb) {
<span class="nc" id="L574">    final TreeItem newItem = new TreeItem();</span>
<span class="nc" id="L575">    cb.addValueChangeHandler(new ValueChangeHandler&lt;Boolean&gt;() {</span>
      @Override
      public void onValueChange(ValueChangeEvent&lt;Boolean&gt; valueChangeEvent) {
<span class="nc bnc" id="L578" title="All 2 branches missed.">        if (newItem.getChildCount() &gt; 0) {</span>
<span class="nc" id="L579">          toggleChildren(newItem, valueChangeEvent.getValue());</span>
        }
<span class="nc bnc" id="L581" title="All 2 branches missed.">        if (valueChangeEvent.getValue() == true) {</span>
<span class="nc" id="L582">          TreeItem parentItem = newItem.getParentItem();</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">          while (parentItem != null) {</span>
<span class="nc" id="L584">            ((CheckBox)parentItem.getWidget()).setValue(true, false);</span>
<span class="nc" id="L585">            parentItem = parentItem.getParentItem();</span>
          }
        }
<span class="nc" id="L588">      }</span>
    });
<span class="nc" id="L590">    newItem.setWidget(cb);</span>
<span class="nc" id="L591">    return newItem;</span>
  }

  protected void updateValue() {
<span class="nc bnc" id="L595" title="All 2 branches missed.">    if (StringUtils.isNullOrEmpty(property.getValue())) {</span>
<span class="nc" id="L596">      dropDownButton.setCaption(&quot;All&quot;);</span>
<span class="nc" id="L597">      dropDownButton.setWidth(&quot;&quot;);</span>
    } else {
<span class="nc" id="L599">      dropDownButton.setCaption(&quot;Toolkit Defined&quot;);</span>
    }
<span class="nc" id="L601">  }</span>

  private String createJSONString() {
<span class="nc" id="L604">    JSONObject jsonObj = new JSONObject();</span>
<span class="nc" id="L605">    JSONObject jsonShownComponents = new JSONObject();</span>
<span class="nc" id="L606">    JSONObject jsonShownBlockTypes = new JSONObject();</span>
<span class="nc" id="L607">    JSONObject jsonComponents = new JSONObject();</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">    for (int i = 0; i &lt; componentTree.getItemCount(); ++i) {</span>
<span class="nc" id="L609">      JSONArray jsonBlocks = new JSONArray();</span>
<span class="nc" id="L610">      TreeItem catItem = componentTree.getItem(i);</span>
<span class="nc" id="L611">      CheckBox cbcat = (CheckBox)catItem.getWidget();</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">      for (int j = 0; j &lt; catItem.getChildCount(); ++j) {</span>
<span class="nc" id="L613">        TreeItem compItem = catItem.getChild(j);</span>
<span class="nc" id="L614">        CheckBox cbcomp = (CheckBox)compItem.getWidget();</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">        if (cbcomp.getValue()) {</span>
<span class="nc" id="L616">          JSONArray jsonComponentBlocks = new JSONArray();</span>
<span class="nc" id="L617">          JSONObject jsonSingleComp = new JSONObject();</span>
<span class="nc" id="L618">          jsonSingleComp.put(&quot;type&quot;, new JSONString(cbcomp.getName()));</span>
<span class="nc" id="L619">          jsonBlocks.set(jsonBlocks.size(), jsonSingleComp);</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">          for (int k = 0; k &lt; compItem.getChildCount(); ++k) {</span>
<span class="nc" id="L621">            CheckBox cbprop = (CheckBox) compItem.getChild(k).getWidget();</span>
<span class="nc" id="L622">            int blockCount = jsonComponentBlocks.size();</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">            if (cbprop.getValue()) {</span>
<span class="nc" id="L624">              JsArray&lt;JavaScriptObject&gt; jsonConvert = convertToJSONObjects(cbprop.getName(), cbcomp.getText(), cbprop.getText(), cbprop.getFormValue());</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">              for(int l = 0; l &lt; jsonConvert.length(); ++l) {</span>
<span class="nc" id="L626">                JSONObject jsonCompBlockObj = new JSONObject(jsonConvert.get(l));</span>
<span class="nc" id="L627">                jsonComponentBlocks.set(blockCount++, jsonCompBlockObj);</span>
              }
            }
          }
<span class="nc" id="L631">          jsonComponents.put(cbcomp.getText(), jsonComponentBlocks);</span>
        }
      }
<span class="nc" id="L634">      jsonShownComponents.put(cbcat.getName().toUpperCase(), jsonBlocks);</span>
<span class="nc" id="L635">      jsonShownBlockTypes.put(&quot;ComponentBlocks&quot;, jsonComponents);</span>
    }
<span class="nc" id="L637">    jsonObj.put(&quot;shownComponentTypes&quot;, jsonShownComponents);</span>

    // Add Blocks for the blocks editor that are not associated with components
<span class="nc bnc" id="L640" title="All 2 branches missed.">    for (int i = 0; i &lt; blockTree.getItemCount(); ++i){</span>
<span class="nc" id="L641">      TreeItem blockCatItem = blockTree.getItem(i);</span>
<span class="nc" id="L642">      CheckBox cbcat = (CheckBox)blockCatItem.getWidget();</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">      if (cbcat.getValue()) {</span>
<span class="nc" id="L644">        JSONArray jsonBlockCat = new JSONArray();</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">        for (int j = 0; j &lt; blockCatItem.getChildCount(); ++j) {</span>
<span class="nc" id="L646">          TreeItem blockItem = blockCatItem.getChild(j);</span>
<span class="nc" id="L647">          CheckBox blockCb = (CheckBox) blockItem.getWidget();</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">          if (blockCb.getValue()) {</span>
<span class="nc" id="L649">            JSONObject jsonSingleBlock = new JSONObject();</span>
<span class="nc" id="L650">            jsonSingleBlock.put(&quot;type&quot;, new JSONString(blockCb.getName()));</span>
<span class="nc" id="L651">            jsonBlockCat.set(jsonBlockCat.size(), jsonSingleBlock);</span>
<span class="nc" id="L652">            jsonShownBlockTypes.put(cbcat.getText(), jsonBlockCat);</span>
          }
        }
      }
    }
<span class="nc" id="L657">    jsonObj.put(&quot;shownBlockTypes&quot;, jsonShownBlockTypes);</span>

<span class="nc bnc" id="L659" title="All 4 branches missed.">    if (jsonShownBlockTypes.size() &gt; 1 || jsonComponents.size() &gt; 0) {</span>
<span class="nc" id="L660">      return jsonObj.toString();</span>
    } else {
<span class="nc" id="L662">      return &quot;&quot; ;</span>
    }
  }

  private native void saveFileNative(String fileName, String jsonString) /*-{
    var blob = new Blob([jsonString], {type: &quot;text/plain;charset=utf-8&quot;});
    var anchor = document.createElement('a');
    anchor.href = window.URL.createObjectURL(blob);
    anchor.target = '_blank';
    anchor.download = fileName;
    anchor.click();
  }-*/;


  private native JavaScriptObject getBlockDict()/*-{
    var blockCatDict = {};
    for (var blockName in Blockly.Blocks) {
      if (!Blockly.Blocks.hasOwnProperty(blockName)) continue;
      var block = Blockly.Blocks[blockName];
      // Component blocks are handled in the component tree and don't behave the same as the others
      if (block.category &amp;&amp; (block.category !== &quot;Component&quot;) &amp;&amp; (typeof block.typeblock !== 'undefined')) {
        if (!blockCatDict[block.category]) {
          blockCatDict[block.category] = {};
        }
        var arrTranslatedNames = new Array();
        for (i = 0; i &lt; block.typeblock.length; ++i) {
          arrTranslatedNames[i] = block.typeblock[i].translatedName;
          // Have not found a way to genericize code where multiple blocks have the exact same translated name.
          // If there's a better way, please fix.
          if (blockName == 'controls_forRange') {
            arrTranslatedNames[i] += Blockly.Msg.LANG_CONTROLS_FORRANGE_INPUT_COLLAPSED_SUFFIX;
          } else if (blockName == 'controls_forEach') {
            arrTranslatedNames[i] += Blockly.Msg.LANG_CONTROLS_FOREACH_INPUT_COLLAPSED_SUFFIX;
          }
        }
        // List all variations on a block, separated by commas
        blockCatDict[block.category][blockName] = arrTranslatedNames.join(&quot;, &quot;);
      }
    }
    return blockCatDict;
  }-*/;

  private native JsArray&lt;JavaScriptObject&gt; convertToJSONObjects(String type, String component, String blockName, String rw)/*-{
    var jsonObjList = [];
    switch(type) {
      case &quot;events&quot;:
        var obj = {};
        obj[&quot;type&quot;] = &quot;component_event&quot;;
        var mutator = {};
        mutator[&quot;component_type&quot;] = component;
        mutator[&quot;event_name&quot;] = blockName;
        obj[&quot;mutatorNameToValue&quot;] = mutator;
        obj[&quot;fieldNameToValue&quot;] = {};
        // params??
        jsonObjList[0] = obj;
        break;
      case &quot;blockProperties&quot;:
        if (rw != &quot;invisible&quot;) {
          var obj = {};
          obj[&quot;type&quot;] = &quot;component_set_get&quot;;
          var mutator = {};
          mutator[&quot;component_type&quot;] = component;
          mutator[&quot;property_name&quot;] = blockName;
          var fields = {};
          fields[&quot;PROP&quot;] = blockName;
          obj[&quot;fieldNameToValue&quot;] = fields;
          if (rw == &quot;read-only&quot;) {
            mutator[&quot;set_or_get&quot;] = &quot;get&quot;;
            obj[&quot;mutatorNameToValue&quot;] = mutator;
            jsonObjList[0] = obj;
          } else if (rw == &quot;write-only&quot;) {
            mutator[&quot;set_or_get&quot;] = &quot;set&quot;;
            obj[&quot;mutatorNameToValue&quot;] = mutator;
            jsonObjList[0] = obj;
          } else if (rw == &quot;read-write&quot;) {
            var mutator_get = JSON.parse(JSON.stringify(mutator));
            var obj_get = JSON.parse(JSON.stringify(obj));
            mutator[&quot;set_or_get&quot;] = &quot;set&quot;;
            mutator_get[&quot;set_or_get&quot;] = &quot;get&quot;;
            obj[&quot;mutatorNameToValue&quot;] = mutator;
            obj_get[&quot;mutatorNameToValue&quot;] = mutator_get;
            jsonObjList[0] = obj;
            jsonObjList[1] = obj_get;
          }
        }
        break;
      case &quot;methods&quot;:
        var obj = {};
        obj[&quot;type&quot;] = &quot;component_method&quot;;
        var mutator = {};
        mutator[&quot;component_type&quot;] = component;
        mutator[&quot;method_name&quot;] = blockName;
        obj[&quot;mutatorNameToValue&quot;] = mutator;
        obj[&quot;fieldNameToValue&quot;] = {};
        // params??
        jsonObjList[0] = obj;
        break;
    }
    return jsonObjList;
  }-*/;

  // ProjectChangeListener implementation
  @Override
  public void onProjectLoaded(Project project) {
<span class="nc" id="L766">  }</span>

  public void onProjectNodeAdded(Project project, ProjectNode node) {
<span class="nc" id="L769">  }</span>

  @Override
  public void onProjectNodeRemoved(Project project, ProjectNode node) {
<span class="nc" id="L773">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>