<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OdeLog.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.google.appinventor.client.output</a> &gt; <span class="el_source">OdeLog.java</span></div><h1>OdeLog.java</h1><pre class="source lang-java linenums">// -*- mode: java; c-basic-offset: 2; -*-
// Copyright 2009-2011 Google, All Rights reserved
// Copyright 2011-2018 MIT, All rights reserved
// Released under the Apache License, Version 2.0
// http://www.apache.org/licenses/LICENSE-2.0

package com.google.appinventor.client.output;

import com.google.appinventor.client.BugReport;
import com.google.appinventor.client.Ode;
import static com.google.appinventor.client.Ode.MESSAGES;
import com.google.appinventor.common.utils.StringUtils;
import com.google.appinventor.common.version.AppInventorFeatures;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.event.shared.UmbrellaException;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.Composite;
import com.google.gwt.user.client.ui.HTML;
import com.google.gwt.user.client.ui.VerticalPanel;

import java.util.Set;

/**
 * Output panel for displaying ODE internal logging messages.
 *
 * &lt;p&gt;Note that logging is only active in hosted mode.
 *
 */
// TODO(user): Make this mesh with the new Logger interface.
public final class OdeLog extends Composite {

  // Singleton logging instance
  private static class SingletonHolder {
<span class="nc" id="L35">    private static final OdeLog INSTANCE = new OdeLog();</span>
  }

  // UI elements
  private final HTML text;

  /**
   * Returns singleton ODE logging instance.
   *
   * @return  ODE logging instance
   */
  public static OdeLog getOdeLog() {
<span class="nc bnc" id="L47" title="All 2 branches missed.">    if (isLogAvailable()) {</span>
<span class="nc" id="L48">      return SingletonHolder.INSTANCE;</span>
    }

<span class="nc" id="L51">    throw new UnsupportedOperationException(&quot;logging not available&quot;);</span>
  }

  /**
   * Creates a new output panel for displaying internal messages.
   */
<span class="nc" id="L57">  private OdeLog() {</span>
    // Initialize UI
<span class="nc" id="L59">    Button clearButton = new Button(MESSAGES.clearButton());</span>
<span class="nc" id="L60">    clearButton.addClickHandler(new ClickHandler() {</span>
      @Override
      public void onClick(ClickEvent event) {
<span class="nc" id="L63">        clear();</span>
<span class="nc" id="L64">      }</span>
    });

<span class="nc" id="L67">    text = new HTML();</span>
<span class="nc" id="L68">    text.setWidth(&quot;100%&quot;);</span>

<span class="nc" id="L70">    VerticalPanel panel = new VerticalPanel();</span>
<span class="nc" id="L71">    panel.add(clearButton);</span>
<span class="nc" id="L72">    panel.add(text);</span>
<span class="nc" id="L73">    panel.setSize(&quot;100%&quot;, &quot;100%&quot;);</span>
<span class="nc" id="L74">    panel.setCellHeight(text, &quot;100%&quot;);</span>
<span class="nc" id="L75">    panel.setCellWidth(text, &quot;100%&quot;);</span>

<span class="nc" id="L77">    initWidget(panel);</span>
<span class="nc" id="L78">  }</span>

  /**
   * Indicates whether logging is available.
   *
   * @return  logging availability
   */
  public static final boolean isLogAvailable() {
<span class="nc bnc" id="L86" title="All 2 branches missed.">    return AppInventorFeatures.hasDebuggingView() &amp;&amp;</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">      (Ode.getInstance().getUser() == null || Ode.getInstance().getUser().getIsAdmin());</span>
  }

  /**
   * Prints a log message.
   *
   * @param message  message to print
   */
  public static void log(String message) {
<span class="nc bnc" id="L96" title="All 4 branches missed.">    if (isLogAvailable() &amp;&amp; !Ode.isWindowClosing()) {</span>
<span class="nc" id="L97">      consoleInfo(message);</span>
<span class="nc" id="L98">      getOdeLog().println(StringUtils.escape(message));</span>
    }
<span class="nc" id="L100">  }</span>

  /**
   * Prints a log warning message.
   *
   * @param message  message to print
   */
  public static void wlog(String message) {
<span class="nc bnc" id="L108" title="All 4 branches missed.">    if (isLogAvailable() &amp;&amp; !Ode.isWindowClosing()) {</span>
<span class="nc" id="L109">      consoleWarn(message);</span>
<span class="nc" id="L110">      getOdeLog().wprintln(StringUtils.escape(message));</span>
    }
<span class="nc" id="L112">  }</span>

  /**
   * Prints a log error message.
   *
   * @param message  message to print
   */
  public static void elog(String message) {
<span class="nc bnc" id="L120" title="All 4 branches missed.">    if (isLogAvailable() &amp;&amp; !Ode.isWindowClosing()) {</span>
<span class="nc" id="L121">      consoleError(message);</span>
<span class="nc" id="L122">      getOdeLog().eprintln(StringUtils.escape(message));</span>
    }
<span class="nc" id="L124">  }</span>

  /**
   * Prints a log message for an exception.
   *
   * @param throwable  exception thrown
   */
  public static void xlog(Throwable throwable) {
<span class="nc bnc" id="L132" title="All 4 branches missed.">    if (isLogAvailable() &amp;&amp; !Ode.isWindowClosing()) {</span>
<span class="nc" id="L133">      getOdeLog().eprintln(StringUtils.escape(throwable.toString()) + prepareStackTrace(throwable));</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">      if (AppInventorFeatures.sendBugReports()) {</span>
        // For this message, we don't escape. We want the bug report link to show as a link.
<span class="nc" id="L136">        getOdeLog().eprintln(&quot;File a &lt;a href=\&quot;&quot; + BugReport.getBugReportLink(throwable)</span>
            + &quot;\&quot; target=\&quot;_blank\&quot;&gt;bug report&lt;/a&gt; for this error.&quot;);
      }
    }
<span class="nc" id="L140">  }</span>

  private static String prepareStackTrace(Throwable throwable) {
<span class="nc" id="L143">    StringBuilder html = new StringBuilder();</span>
<span class="nc" id="L144">    html.append(&quot;&lt;ul&gt;&quot;);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">    for (StackTraceElement element : throwable.getStackTrace()) {</span>
<span class="nc" id="L146">      html.append(&quot;&lt;li&gt;&quot;).append(StringUtils.escape(element.toString())).append(&quot;&lt;/li&gt;&quot;);</span>
    }

<span class="nc" id="L149">    html.append(prepareCause(throwable.getCause()));</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">    if (throwable instanceof UmbrellaException) {</span>
<span class="nc" id="L152">      Set&lt;Throwable&gt; causes = ((UmbrellaException) throwable).getCauses();</span>
<span class="nc bnc" id="L153" title="All 4 branches missed.">      if (causes != null &amp;&amp; !causes.isEmpty()) {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        for (Throwable cause : causes) {</span>
<span class="nc" id="L155">          html.append(prepareCause(cause));</span>
<span class="nc" id="L156">        }</span>
      }
    }

<span class="nc" id="L160">    html.append(&quot;&lt;/ul&gt;&quot;);</span>
<span class="nc" id="L161">    return html.toString();</span>
  }

  private static String prepareCause(Throwable cause) {
<span class="nc" id="L165">    StringBuilder html = new StringBuilder();</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">    if (cause != null) {</span>
<span class="nc" id="L167">      html.append(&quot;&lt;li&gt;Caused by &quot;).append(StringUtils.escape(cause.toString())).append(&quot;&lt;/li&gt;&quot;)</span>
<span class="nc" id="L168">          .append(prepareStackTrace(cause));</span>
    }
<span class="nc" id="L170">    return html.toString();</span>
  }

  /*
   * Prints a log message.
   */
  private void println(String message) {
<span class="nc" id="L177">    doPrintln(&quot;INFO&quot;, &quot;green&quot;, message);</span>
<span class="nc" id="L178">  }</span>

  /*
   * Prints a log warning message.
   */
  private void wprintln(String message) {
<span class="nc" id="L184">    doPrintln(&quot;WARNING&quot;, &quot;orange&quot;, message);</span>
<span class="nc" id="L185">  };</span>

  /*
   * Prints a log error message.
   */
  private void eprintln(String message) {
<span class="nc" id="L191">    doPrintln(&quot;ERROR&quot;, &quot;red&quot;, message);</span>
<span class="nc" id="L192">  }</span>

  private native void doPrintln(String level, String color, String message)/*-{
      var el = this.@com.google.appinventor.client.output.OdeLog::text
          .@com.google.gwt.user.client.ui.UIObject::getElement()();
    var div = $doc.createElement('div');
    div.style.fontSize = 'small';
    var span = $doc.createElement('span');
    span.style.color = color;
    span.appendChild($doc.createTextNode('[' + level + '] '));
    div.appendChild(span);
    // The better thing would be to use $doc.createTextNode, but the exception logger includes a link...
    div.innerHTML += message;
    el.appendChild(div);
  }-*/;

  /*
   * Clears all messages.
   */
  private void clear() {
<span class="nc bnc" id="L212" title="All 2 branches missed.">    if (!Ode.isWindowClosing()) {</span>
<span class="nc" id="L213">      text.setText(&quot;&quot;);</span>
    }
<span class="nc" id="L215">  }</span>

  static native void consoleLog(String message) /*-{
    console.log(message);
  }-*/;

  static native void consoleInfo(String message) /*-{
    console.info(message);
  }-*/;

  static native void consoleWarn(String message) /*-{
    console.warn(message);
  }-*/;

  static native void consoleError(String message) /*-{
    console.error(message);
  }-*/;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>